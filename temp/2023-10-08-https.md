---
layout: post
title:  "浅析 HTTPS 的 TLS 握手流程"
categories: network
author: wenfh2020
---

通过 wireshark 抓取 HTTPS 包，理解 TLS 1.2 安全通信协议的握手流程。

重点理解几个点：

1. TLS 握手流程：通过 wireshark 抓取 HTTPS 包理解。
2. 协商加密：通信双方通过 ECDHE 非对称加密算法协商出相同的 `对称会话秘钥` 进行内容，避免传输会话秘钥被中间人窃取。
3. CA 证书：证书用来验证服务端的合法性。证书类似于身份证，可以证明某人是某人，当然身份证可以伪造，一般人可能识别不出来，但是政府相关部门可以验证你的身份合法性。同理，服务端可以通过 CA 证书识别自身身份，客户端接收服务端发送的证书，并通过 `证书链` 验证证书是否合法。





---

* content
{:toc}

---

## 1. 概念

### 1.1. HTTPS

HTTPS 协议是一种基于 HTTP 协议的安全通信协议。

它通过使用 TLS/SSL 协议对通信进行加密，确保数据在传输过程中的安全性和完整性。HTTPS 协议使用了公钥加密和对称加密的组合，可以防止第三方窃听、篡改或伪造数据。通过使用 HTTPS 协议，网站可以保护用户的隐私和敏感信息，提供更安全的网络通信环境。

> 文字来源：ChatGPT

---

### 1.2. SSL/TLS

SSL/TLS 是一种用于保护网络通信安全的（应用层）协议。SSL 代表 Secure Sockets Layer，而 TLS 代表 Transport Layer Security。它们都是加密协议，用于在客户端和服务器之间建立安全的通信连接。

这些协议使用公钥加密和私钥解密的方式来保护数据的机密性和完整性.它们还提供身份验证，确保通信双方的身份是可信的。
SSL/TLS 广泛用于保护网站、电子邮件、即时通讯和其他网络应用程序的安全。有了 SSL/TLS，通信过程中的数据可以被加密，防止被未经授权的人窃听或篡改。

> 文字来源：ChatGPT

<div align=center><img src="/images/2023/2023-10-08-16-01-04.png" data-action="zoom"/></div>

> 图片来源：《图解 TCP_IP》

---

### 1.3. ECDHE 算法

TLS 的 ECDHE 算法是一种基于椭圆曲线的密钥交换算法，全称为 Elliptic Curve Diffie-Hellman Ephemeral。

> 详细算法原理请参考：【[ECC加密算法】\| ECC加密原理详解\| 椭圆曲线加密\| 密码学\| 信息安全](https://www.bilibili.com/video/BV1v44y1b7Fd/?spm_id_from=333.337.search-card.all.click&vd_source=a2a56cf0a934465d3945d595a71e68dc)

它的工作流程如下：

1. 客户端和服务器各自选择一个私钥，并使用椭圆曲线的公钥算法生成对应的公钥。
2. 在握手阶段，客户端和服务器互相交换公钥。这个过程通常在 ClientHello 和 ServerHello 消息中完成（抓包可以看到详细的信息）。
3. 客户端和服务器各自使用对方的公钥和自己的私钥，通过椭圆曲线的点运算生成一个共享密钥。由于椭圆曲线的数学性质，这个共享密钥在双方都知道，但是不能被第三方计算出来。
4. 客户端和服务器使用这个共享密钥进行对称加密通信。

ECDHE 算法的优点是每次握手都会生成一个新的密钥，即使有人能够破解一个会话的密钥，也无法用这个密钥破解其他会话的通信。这就是所谓的前向保密性。

> 文字来源：ChatGPT

---

## 2. 工作流程

理解了一些基本概念之后，下面我们将在浏览器访问某些 HTTPS 域名，使用抓包工具，抓包分析 TLS 的工作流程。

* TCP 三次握手。TLS 是应用层协议，使用传输层的 TCP 进行通信，通信双方在进行 TLS 握手前，需要先进行 TCP 三次握手建立链接。
* TLS 握手。双方加密通信，避免秘钥传递过程中被中间人截取，不能直接传递秘钥；双方的秘钥获得方式是：双方通过非对称加密方式，相互通信协商出一个对称密钥。
* 对称加密通信。因为非对称协商加密性能损耗大，所以通信双方需要通过 TLS 握手协商出对称秘钥，可以通过该秘钥对通信传输内容进行加密解密，既安全又高效。

---

### 2.1. TLS 握手过程

通信双方通过 `非对称加密` 方式，协商出一个 `对称的会话秘钥`，然后使用这个秘钥，使得通信过程中的数据可以被加密，防止被未经授权的人窃听或篡改。

1. 客户端发送 **第 1 随机数** 给服务端。
2. 服务端发送 **第 2 随机数** 给客户端。
3. 服务端发送 CA 证书（`公钥` + 其它信息）给客户端。
4. 客户端通过本地系统的 **CA 根证书** 验证服务端发送的 CA 证书是否合法。
5. 客户端通过服务端发送的公钥加密 **第 3 随机数（预主秘钥）**，发送给服务端。当前客户端：第 1 随机数 + 第 2 随机数 + 第 3 随机数 ==> 对称的会话秘钥。
6. 服务端接收到公钥加密的 第三随机数，通过私钥解密，至此服务端：第 1 随机数 + 第 2 随机数 + 第 3 随机数  ==> 对称的会话秘钥。

---

接着通过下图详细理解 TLS 握手的各个阶段。

<div align=center><img src="/images/2023/2023-10-10-09-45-04.png" data-action="zoom"/></div>

|序号|方向|阶段|描述|
|:----:|:--------------:|:--:|:--|
|<span style="display:inline-block;width:40px">1</span>|<span style="display:inline-block;width:50px">C --> S </span>|<span style="display:inline-block;width:200px">Client Hello</span>|客户端向服务器发送的第一个消息，包含客户端支持的 **TLS版本**、**加密套件列表** 和 **随机数等信息**。|
|2|S --> C|Server Hello|服务器向客户端发送的消息，包含服务器选择的 **TLS 版本**、**加密套件** 和 **随机数等信息**。|
|3|S --> C|Certificate|服务器发送 **证书** 给客户端，证书包含服务器的 **公钥** 和相关信息。|
|4|S --> C|Server Key Exchange（可选）|如果服务器选择的加密套件需要，服务器会发送一个 Server Key Exchange 消息，包含服务器的临时公钥。|
|5|S --> C|Server Hello Done|服务器向客户端发送的消息，表示服务器已完成Hello阶段。|
|6|C --> S|Client Key Exchange|客户端生成一个 **随机数** 作为 PreMaster Secret（预主秘钥），并使用服务器的公钥加密这个随机数，然后发送给服务器。|
|7|C --> S|Change Cipher Spec|确认握手过程中的加密算法和密钥已经生效。|
|8|C --> S|Encrypted Handshake Message|客户端和服务器交换加密的握手消息，包括密钥协商确认和其他握手相关信息。|
|9|S --> C|New Session Ticket（可选）|服务器发送该消息给客户端，包含一个新的会话票据，用于快速恢复会话。|
|10|S --> C|Change Cipher Spec|确认握手过程中的加密算法和密钥已经生效。|
|11|S --> C|Encrypted Handshake Message|客户端和服务器再次交换加密的握手消息，确认握手过程的完成。|

> 文字来源：ChatGPT

---

### 2.2. ECDHE 算法

ECDHE（Elliptic Curve Diffie-Hellman Ephemeral）是一种非对称加密算法。它使用椭圆曲线密码学来生成临时的公私钥对，并通过 Diffie-Hellman 密钥交换协议来实现安全的密钥交换。

它的的工作原理如下：

1. 客户端和服务器都选择一个椭圆曲线作为基础，这个曲线上的点被用作加密算法的参数。
2. 客户端生成一个临时的私钥，并计算出对应的公钥。同样，服务器也生成一个临时的私钥和公钥。
3. 客户端将自己的公钥发送给服务器。
4. 服务器收到客户端的公钥后，使用自己的私钥和客户端的公钥计算出一个共享的密钥。
5. 客户端收到服务器的公钥后，使用自己的私钥和服务器的公钥计算出同样的共享密钥。
6. 客户端和服务器现在都有了相同的共享密钥，可以用于加密和解密通信数据。

ECDHE 算法的优点是安全性高，计算量相对较小，适用于移动设备等资源受限的环境。它通过椭圆曲线密码学提供了一种快速、安全的密钥交换方法。

> 文字来源：ChatGPT

---

在 TLS 1.2 版本中，ECDHE 算法的握手阶段如下：

1. 客户端发送 ClientHello 消息，其中包含支持的加密算法列表，包括 ECDHE 算法。
2. 服务器收到 ClientHello 消息后，选择一个与客户端支持的算法相匹配的椭圆曲线和一个临时的 Diffie-Hellman 公私钥对。
3. 服务器生成一个 ServerKeyExchange 消息，其中包含选定的椭圆曲线和临时公钥，并将其发送给客户端。
4. 客户端收到 ServerKeyExchange 消息后，验证服务器的身份，并使用服务器提供的椭圆曲线和临时公钥生成自己的临时公私钥对。
5. 客户端生成一个 PreMasterSecret（预主密钥），并使用服务器的临时公钥加密该密钥。
6. 客户端将加密后的 PreMasterSecret 发送给服务器。
7. 服务器收到加密后的 PreMasterSecret 后，使用自己的私钥解密该密钥。
8. 服务器和客户端使用各自的临时私钥和对方的临时公钥计算出共享的主密钥。
9. 握手过程继续进行，使用共享的主密钥进行加密和解密通信。

---

讲的不对吧，这里用了 ECDH 秘钥交换，你都没结合 Client Key Exchange 报文里的 pubkey 是作为 ECDH 的参数传过去的。

预主秘钥相当于 ECDH 秘钥交换中的生成的随机数 n，n 点 G 得到 ECDH 公钥，再将 ECDH 公钥使用证书中服务器的私钥签名防止被篡改。

服务器收到后使用公钥解签，得到客户端的 ECDH 公钥与自己的 ECDH 私钥一乘才是 ECDH 交换的秘钥，再将两个随机数和 ECDH 交换的秘钥作为对称加密的秘钥使用吧。

---

### 2.3. 抓包

通过 wireshark 抓包，抓取 TLS 握手阶段。

* Client Hello。

<div align=center><img src="/images/2023/2023-10-08-15-43-33.png" width="70%" data-action="zoom"/></div>

* Server Hello。

<div align=center><img src="/images/2023/2023-10-08-16-24-35.png" width="70%" data-action="zoom"/></div>

<div align=center><img src="/images/2023/2023-10-10-11-29-21.png" data-action="zoom"/></div>

> 图片来源：[TLS/1.2和TLS/1.3的核心区别 \| HTTPS有哪些不安全因素](https://www.bilibili.com/video/BV12X4y197Pr/?spm_id_from=333.788&vd_source=a2a56cf0a934465d3945d595a71e68dc)


* Certificate。

<div align=center><img src="/images/2023/2023-10-08-16-31-00.png" width="70%" data-action="zoom"/></div>

* Server key Exchange，Server Hello Done。

<div align=center><img src="/images/2023/2023-10-08-16-33-00.png" width="70%"  data-action="zoom"/></div>

* Client Key Exchange, Change Cipher Spec, Encrypted Handshake Message。

<div align=center><img src="/images/2023/2023-10-08-17-14-14.png" width="70%" data-action="zoom"/></div>

* New Session Ticket, Change Cipher Spec, Encrypted Handshake Message。

<div align=center><img src="/images/2023/2023-10-08-17-22-25.png" width="70%" data-action="zoom"/></div>

---

## 3. CA 证书

### 3.1. 概念

CA 证书是由权威的证书颁发机构（Certificate Authority）签发的数字证书。

CA证书用于验证网站的身份，并确保通信的安全性。它包含了网站的公钥和其他相关信息，并由 CA 机构对其进行数字签名。用户在访问网站时，可以通过验证CA证书来确认网站的真实性和可信度。

---

### 3.2. 证书作用

1. 验证网站的身份：CA 证书包含了网站的公钥和其他相关信息，由权威的证书颁发机构签发。当用户访问一个网站时，浏览器会检查网站的证书是否由可信的CA机构签发，以验证网站的身份是否可信。

2. 加密通信数据：CA 证书使用了公钥加密和对称加密的组合，可以加密传输的数据。这样可以防止第三方窃听、篡改或伪造数据，确保通信的安全性和完整性。

3. 建立信任关系：由于 CA 证书是由可信的证书颁发机构签发的，浏览器会预先内置一些受信任的CA机构的根证书。当浏览器检查到网站的证书由受信任的CA机构签发时，会建立起对该网站的信任关系，显示安全的锁标志。

> 文字来源：ChatGPT

---

### 3.3. 证书来源

权威的证书颁发机构 CA（Certificate Authority）签发的，可以通过相关平台付费购买或者免费申请获得。

<div align=center><img src="/images/2021/2021-12-21-23-00-52.png" data-action="zoom"/></div>

---

### 3.4. HTTPS 服务配置

例如 nginx 服务端 https 通信配置。

```shell
# /etc/nginx/vhost/blog.conf
server {
    listen       443 ssl; # 监听 HTTPS 443 端口。
    server_name  xxx.com www.xxx.com;
    ssl_certificate /usr/local/nginx/ssl/blog/3515736_xxx.com.pem;
    ssl_certificate_key /usr/local/nginx/ssl/blog/3515736_xxx.com.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers AESGCM:ALL:!DH:!EXPORT:!RC4:+HIGH:!MEDIUM:!LOW:!aNULL:!eNULL;
    ssl_prefer_server_ciphers on;
}
```

|配置项|描述|
|:---|:---|
|ssl_certificate|指定服务器证书的路径。服务器证书是由 CA 机构签发的，用于 **验证服务器的身份**。它包含了服务器的公钥和其他相关信息。|
|ssl_certificate_key|指定服务器证书的私钥的路径。私钥用于对传输的数据进行加密和解密。|
|ssl_session_timeout|指定 SSL 会话的超时时间。SSL 会话是在客户端和服务器之间建立的安全连接，超过超时时间后会自动关闭。|
|ssl_protocols|指定支持的 SSL/TLS 协议版本。常见的协议版本包括 SSLv2、SSLv3、TLSv1.0、TLSv1.1 和 TLSv1.2。|
|ssl_ciphers|指定支持的加密算法和密钥长度。常见的加密算法包括 AES、DES 和 RC4，密钥长度包括 128 位和 256 位。|
|ssl_prefer_server_ciphers|指定是否优先使用服务器端的加密算法和密钥长度。如果设置为 "on"，则服务器端的加密算法和密钥长度优先级高于客户端。|

> 文字来源：ChatGPT

---

### 3.5. 客户端证书

终端通过 TLS 安全协议从服务端获得的 CA 证书，它包含了服务器的 `公钥` 和其他相关信息。（该证书可以通过计算机本地的 `根证书` 验证是否安全合法。）

<div align=center><img src="/images/2023/2023-10-08-18-24-19.png" data-action="zoom"/></div>

---

### 3.6. 证书工作原理

---

## 4. 参考

* 《半小时漫画计算机》
* [HTTPS RSA 握手解析](https://www.xiaolincoding.com/network/2_http/https_rsa.html)
* [HTTPS ECDHE 握手解析](https://www.xiaolincoding.com/network/2_http/https_ecdhe.html)
* [tls长连接实现](https://www.5axxw.com/questions/simple/0fk05y)
* [TLS/1.2和TLS/1.3的核心区别 \| HTTPS有哪些不安全因素](https://www.bilibili.com/video/BV12X4y197Pr/?spm_id_from=333.788&vd_source=a2a56cf0a934465d3945d595a71e68dc)
* [HTTPS是什么？加密原理和证书。SSL/TLS握手过程](https://www.bilibili.com/video/BV1KY411x7Jp/?spm_id_from=333.788&vd_source=a2a56cf0a934465d3945d595a71e68dc)
* [测试成长之根证书，怎么保障了HTTPS的安全](https://www.bilibili.com/video/BV1hs4y167Qc/?spm_id_from=333.999.0.0&vd_source=a2a56cf0a934465d3945d595a71e68dc)
* 【[ECC加密算法】\| ECC加密原理详解\| 椭圆曲线加密\| 密码学\| 信息安全](https://www.bilibili.com/video/BV1v44y1b7Fd/?spm_id_from=333.337.search-card.all.click&vd_source=a2a56cf0a934465d3945d595a71e68dc)