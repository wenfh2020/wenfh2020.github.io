<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>[nginx 源码走读] 内存池</title>
    <meta name="description" content="nginx 内存池(源码)通过大小内存块的链式管理逻辑大致如下图(部分内存对齐的细节没有添加进去)：">

    <link rel="shortcut icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="icon" href="/favicon.ico?" type="image/x-icon">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://at.alicdn.com/t/font_8v3czwksspqlg14i.css">
    <link rel="stylesheet" href="/css/main.css ">
    <link rel="canonical" href="http://localhost:4000/2020/01/21/nginx-pool/">
    <link rel="alternate" type="application/rss+xml" title=" " href="http://localhost:4000/feed.xml ">


    <script>
    // 百度统计代码
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?c0731ae90724efee0af2c272a7bd1594";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>


    <script>
    // google analytics
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-158372315-1', 'auto');
      ga('send', 'pageview');

    </script>



<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
    tex2jax: { inlineMath: [["$","$"],["\\(","\\)"]] },
    "HTML-CSS": {
      linebreaks: { automatic: true, width: "container" }
    }
});
</script>
<script type="text/javascript"
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand"> </a>
        <small> </small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                
                    
                    <li>
                        
                        <a href="/tag/">
                        
                            <i class="fa fa-tags"></i>Tags
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/collection/">
                        
                            <i class="fa fa-bookmark"></i>Collections
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/about/">
                        
                            <i class="fa fa-heart"></i>About
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <h1>[nginx 源码走读] 内存池</h1>
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2020-01-21
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>wenfh2020
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#nginx" title="Category: nginx" rel="category">nginx</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
            
<!-- <span class="point">•</span> -->
<span class="pageTag">
  <i class="fa fa-tags"></i>
  
    
        <!--a href="/tag/#nginx" title="Tag: nginx" rel="tag">nginx</a-->
        <a href="/tag/#nginx" title="Tag: nginx" rel="tag">nginx</a>&nbsp;
    
        <!--a href="/tag/#c" title="Tag: c" rel="tag">c</a-->
        <a href="/tag/#c" title="Tag: c" rel="tag">c</a>
    
  

</span>

            </div>

        </div>
        <hr>
        <article itemscope itemtype="http://schema.org/BlogPosting">
        <p>nginx 内存池(<a href="https://github.com/nginx/nginx/blob/master/src/core/ngx_palloc.c">源码</a>)通过大小内存块的链式管理逻辑大致如下图(部分<strong>内存对齐</strong>的细节没有添加进去)：</p>

<p><img src="https://raw.githubusercontent.com/wenfh2020/imgs_for_blog/master/md20200215163135.png" alt="内存池" /></p>

<ul id="markdown-toc">
  <li><a href="#内存池数据结构" id="markdown-toc-内存池数据结构">内存池数据结构</a>    <ul>
      <li><a href="#小内存块" id="markdown-toc-小内存块">小内存块</a></li>
      <li><a href="#大内存块" id="markdown-toc-大内存块">大内存块</a></li>
      <li><a href="#内存文件" id="markdown-toc-内存文件">内存文件</a></li>
      <li><a href="#内存池" id="markdown-toc-内存池">内存池</a></li>
    </ul>
  </li>
  <li><a href="#接口" id="markdown-toc-接口">接口</a>    <ul>
      <li><a href="#创建内存池" id="markdown-toc-创建内存池">创建内存池</a></li>
      <li><a href="#内存对齐申请空间" id="markdown-toc-内存对齐申请空间">内存对齐申请空间</a></li>
      <li><a href="#释放内存池" id="markdown-toc-释放内存池">释放内存池</a></li>
      <li><a href="#分配内存" id="markdown-toc-分配内存">分配内存</a></li>
      <li><a href="#分配小内存" id="markdown-toc-分配小内存">分配小内存</a></li>
      <li><a href="#分配小内存块" id="markdown-toc-分配小内存块">分配小内存块</a></li>
      <li><a href="#申请大块内存" id="markdown-toc-申请大块内存">申请大块内存</a></li>
      <li><a href="#释放大内存块" id="markdown-toc-释放大内存块">释放大内存块</a></li>
      <li><a href="#重置内存池" id="markdown-toc-重置内存池">重置内存池</a></li>
    </ul>
  </li>
  <li><a href="#问题" id="markdown-toc-问题">问题</a></li>
  <li><a href="#测试" id="markdown-toc-测试">测试</a></li>
  <li><a href="#参考" id="markdown-toc-参考">参考</a></li>
</ul>

<hr />

<h2 id="内存池数据结构">内存池数据结构</h2>

<h3 id="小内存块">小内存块</h3>

<p>小内存块是通过链表进行管理，内存分配过程，涉及到结点上空闲内存匹配是链表的遍历，复杂度是 $O(n)$，为了提高效率，增加了<code class="highlighter-rouge">failed</code> 分配内存失败次数统计（具体逻辑在分配函数里）</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">u_char</span>               <span class="o">*</span><span class="n">last</span><span class="p">;</span>
    <span class="n">u_char</span>               <span class="o">*</span><span class="n">end</span><span class="p">;</span>
    <span class="n">ngx_pool_t</span>           <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>            <span class="n">failed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ngx_pool_data_t</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="大内存块">大内存块</h3>

<p>大内存块没有复杂的空闲空间管理逻辑，都是直接分配单独的结点，需要销毁时直接释放。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_pool_large_s</span>  <span class="n">ngx_pool_large_t</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ngx_pool_large_s</span> <span class="p">{</span>
    <span class="n">ngx_pool_large_t</span>     <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="kt">void</span>                 <span class="o">*</span><span class="n">alloc</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="内存文件">内存文件</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">ngx_chain_s</span> <span class="p">{</span>
    <span class="n">ngx_buf_t</span>    <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
    <span class="n">ngx_chain_t</span>  <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="内存池">内存池</h3>

<p>nginx 内存池，主要通过大小空闲内存块两个链表进行维护， 内存池主要是对小块内存（<code class="highlighter-rouge">max</code>）进行逻辑管理达到重复利用。</p>

<ol>
  <li>小内存分配，在小内存块<code class="highlighter-rouge">ngx_pool_data_t</code>链表进行分配。</li>
  <li>大内存分配，在大内存块<code class="highlighter-rouge">ngx_pool_large_t</code>链表分配。</li>
</ol>

<p>可能因为大块内存长度比较大，重复利用率比较低，而且占用空间比较大，不宜长期留存在物理内存空间上，所以作者不对大块内存进行复杂大内存空间管理。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">ngx_pool_s</span> <span class="n">ngx_pool_t</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ngx_pool_s</span> <span class="p">{</span>
    <span class="n">ngx_pool_data_t</span>       <span class="n">d</span><span class="p">;</span>      <span class="c1">// 小内存块数据链表</span>
    <span class="kt">size_t</span>                <span class="n">max</span><span class="p">;</span>    <span class="c1">// 小内存块最大空间长度</span>
    <span class="n">ngx_pool_t</span>           <span class="o">*</span><span class="n">current</span><span class="p">;</span><span class="c1">// 当前小内存块</span>
    <span class="n">ngx_chain_t</span>          <span class="o">*</span><span class="n">chain</span><span class="p">;</span>  <span class="c1">// 内存缓冲区链表（不详细分析）</span>
    <span class="n">ngx_pool_large_t</span>     <span class="o">*</span><span class="n">large</span><span class="p">;</span>  <span class="c1">// 大内存块数据链表</span>
    <span class="n">ngx_pool_cleanup_t</span>   <span class="o">*</span><span class="n">cleanup</span><span class="p">;</span><span class="c1">// 释放内存池回调链表</span>
    <span class="n">ngx_log_t</span>            <span class="o">*</span><span class="n">log</span><span class="p">;</span>    <span class="c1">// 日志</span>
<span class="p">};</span>
</code></pre></div></div>

<hr />

<h2 id="接口">接口</h2>

<h3 id="创建内存池">创建内存池</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ngx_int_t</span>
<span class="nf">ngx_os_init</span><span class="p">(</span><span class="n">ngx_log_t</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ngx_pagesize</span> <span class="o">=</span> <span class="n">getpagesize</span><span class="p">();</span>
<span class="p">}</span>

<span class="cp">#define NGX_MAX_ALLOC_FROM_POOL  (ngx_pagesize - 1)
#define NGX_POOL_ALIGNMENT       16
</span>
<span class="n">ngx_pool_t</span> <span class="o">*</span>
<span class="nf">ngx_create_pool</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">ngx_log_t</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ngx_pool_t</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="c1">// 分配 16 字节对齐的内存。</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">log</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 小内存块内存空间结构 (数据结构信息头 + 已分配内存 + 空闲内存)。</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 小块内存大小，空闲内存最大小于 page size。</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>

    <span class="c1">// 起始位置，指向初始结点。</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">large</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">cleanup</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="内存对齐申请空间">内存对齐申请空间</h3>

<p>内存对齐，涉及到 cpu 工作效率，是高性能系统不可缺少的一环，有空可以深入研究。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#if (NGX_HAVE_POSIX_MEMALIGN)
</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_memalign</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">alignment</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">ngx_log_t</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="kt">int</span>    <span class="n">err</span><span class="p">;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">posix_memalign</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
                      <span class="s">"posix_memalign(%uz, %uz) failed"</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
        <span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">ngx_log_debug3</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s">"posix_memalign: %p:%uz @%uz"</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#elif (NGX_HAVE_MEMALIGN)
</span>
<span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_memalign</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">alignment</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">ngx_log_t</span> <span class="o">*</span><span class="n">log</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">memalign</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_log_error</span><span class="p">(</span><span class="n">NGX_LOG_EMERG</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">ngx_errno</span><span class="p">,</span>
                      <span class="s">"memalign(%uz, %uz) failed"</span><span class="p">,</span> <span class="n">alignment</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">ngx_log_debug3</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                   <span class="s">"memalign: %p:%uz @%uz"</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">alignment</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#else
</span>
<span class="cp">#define ngx_memalign(alignment, size, log)  ngx_alloc(size, log)
</span>
<span class="cp">#endif
</span>
<span class="cp">#ifndef NGX_ALIGNMENT
#define NGX_ALIGNMENT   sizeof(unsigned long)    </span><span class="cm">/* platform word */</span><span class="cp">
#endif
</span></code></pre></div></div>

<h3 id="释放内存池">释放内存池</h3>

<p>除了对大小内存块数据进行释放，还增加了回调操作的设计，方便开发者进行部分具体的业务处理。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">ngx_destroy_pool</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ngx_pool_t</span>          <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
    <span class="n">ngx_pool_large_t</span>    <span class="o">*</span><span class="n">l</span><span class="p">;</span>
    <span class="n">ngx_pool_cleanup_t</span>  <span class="o">*</span><span class="n">c</span><span class="p">;</span>

    <span class="c1">// 释放回调处理。</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">cleanup</span><span class="p">;</span> <span class="n">c</span><span class="p">;</span> <span class="n">c</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">"run cleanup: %p"</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 释放大内存块</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span> <span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 释放小内存块</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="cm">/* void */</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="分配内存">分配内存</h3>

<p>如果分配的内存在小内存块空间范围内，就通过小内存块空闲链表中分配，否则直接分配到大内存块链表中。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_palloc</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if !(NGX_DEBUG_PALLOC)
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
<span class="cp">#endif
</span>    <span class="k">return</span> <span class="n">ngx_palloc_large</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><code class="highlighter-rouge">pool-&gt;max</code> 查看 <code class="highlighter-rouge">ngx_create_pool</code> 的实现：</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
<span class="n">p</span><span class="o">-&gt;</span><span class="n">max</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">)</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="n">NGX_MAX_ALLOC_FROM_POOL</span><span class="p">;</span>
</code></pre></div></div>

<h3 id="分配小内存">分配小内存</h3>

<p>满足条件 <code class="highlighter-rouge">size &lt;= pool-&gt;max</code> 的小内存的空间分配，遍历小内存块链表，从已分配的空间中查找合适的空闲空间进行分配，否则再创建新的小内存块进行匹配。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">ngx_inline</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_palloc_small</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">ngx_uint_t</span> <span class="n">align</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">u_char</span>      <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="n">ngx_pool_t</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="c1">// 遍历查找起始位置。</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span>

    <span class="k">do</span> <span class="p">{</span>
        <span class="c1">// 从小内存块中，查找剩余空间，检查是否有足够的剩余空间分配。</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">align</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// 从 m 开始，计算以NGX_ALIGNMENT对齐的偏移位置指针。</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">NGX_ALIGNMENT</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// 如果有足够空间，就返回分配的空间，空闲内存减少 size 大小</span>
        <span class="k">if</span> <span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="n">m</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 检查下一个结点</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="c1">// 遍历链表后找不到合适的，申请新的内存块。</span>
    <span class="k">return</span> <span class="n">ngx_palloc_block</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="分配小内存块">分配小内存块</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_palloc_block</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">u_char</span>      <span class="o">*</span><span class="n">m</span><span class="p">;</span>
    <span class="kt">size_t</span>       <span class="n">psize</span><span class="p">;</span>
    <span class="n">ngx_pool_t</span>  <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

    <span class="c1">// 获取小内存块链表第一个块内存空间大小。</span>
    <span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="p">(</span><span class="n">pool</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span> <span class="o">-</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pool</span><span class="p">);</span>

    <span class="c1">// 分配 16字节对齐的空间。</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ngx_memalign</span><span class="p">(</span><span class="n">NGX_POOL_ALIGNMENT</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 设置新结点信息。</span>
    <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">m</span><span class="p">;</span>
    <span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">psize</span><span class="p">;</span>
    <span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 数据结构信息头后存储空闲数据</span>
    <span class="n">m</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_data_t</span><span class="p">);</span>

    <span class="c1">// 从 m 开始，计算以NGX_ALIGNMENT对齐的偏移位置指针</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">ngx_align_ptr</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">NGX_ALIGNMENT</span><span class="p">);</span>

    <span class="c1">// 分配 size 大小的空闲空间出去</span>
    <span class="n">new</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>

    <span class="c1">// 原来的内存块结点均分配失败，要将失败的分配记录下来。</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 新的空闲内存块结点添加到链表末尾</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="申请大块内存">申请大块内存</h3>

<p>大块内存已分配的大块数据，除了内存块头部信息是可以重复利用的，数据不会重复利用，不用将被 ngx_pfree 释放掉。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">ngx_palloc_large</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">void</span>              <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_uint_t</span>         <span class="n">n</span><span class="p">;</span>
    <span class="n">ngx_pool_large_t</span>  <span class="o">*</span><span class="n">large</span><span class="p">;</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">ngx_alloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// 重复利用已分配的大内存块结点信息</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">large</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span> <span class="n">large</span><span class="p">;</span> <span class="n">large</span> <span class="o">=</span> <span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 防止大量的链表遍历降低效率（粒度那么小，会不会造成大量碎片？）</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 为数据结构申请空间</span>
    <span class="n">large</span> <span class="o">=</span> <span class="n">ngx_palloc_small</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_large_t</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">large</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">ngx_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// 新结点插入到表头，有点像 lru，将活跃数据放到前面去。</span>
    <span class="n">large</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
    <span class="n">large</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span> <span class="o">=</span> <span class="n">large</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">p</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="释放大内存块">释放大内存块</h3>

<p>只是释放数据，没有释放块的数据结构头。为了重复利用数据结构头信息，所以释放数据并没有删除链表结点，这里通过链表遍历进行删除，效率会不会很低。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ngx_int_t</span>
<span class="nf">ngx_pfree</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ngx_pool_large_t</span>  <span class="o">*</span><span class="n">l</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span> <span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_log_debug1</span><span class="p">(</span><span class="n">NGX_LOG_DEBUG_ALLOC</span><span class="p">,</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">log</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                           <span class="s">"free: %p"</span><span class="p">,</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
            <span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
            <span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
            <span class="k">return</span> <span class="n">NGX_OK</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">NGX_DECLINED</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="重置内存池">重置内存池</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span>
<span class="nf">ngx_reset_pool</span><span class="p">(</span><span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">ngx_pool_t</span>        <span class="o">*</span><span class="n">p</span><span class="p">;</span>
    <span class="n">ngx_pool_large_t</span>  <span class="o">*</span><span class="n">l</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span><span class="p">;</span> <span class="n">l</span><span class="p">;</span> <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">ngx_free</span><span class="p">(</span><span class="n">l</span><span class="o">-&gt;</span><span class="n">alloc</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 每个小内存块空闲内存指针，指向数据结构头后面</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span> <span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ngx_pool_t</span><span class="p">);</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">.</span><span class="n">failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">current</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">pool</span><span class="o">-&gt;</span><span class="n">large</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<hr />

<h2 id="问题">问题</h2>

<p>nginx 的内存池实现足够精简高效，但是依然有些问题不能兼顾到：</p>

<ul>
  <li>链表管理：
链表的查找遍历时间复杂度是 $O(n)$。<code class="highlighter-rouge">ngx_pfree</code> 效率不高。</li>
  <li>小内存块链表，current 问题：
当遇到密集地分配比较大的小内存场景时，导致已分配结点，分配失败，failed 次数增加。current 指向新的结点，由于是单向链表，前面的结点其实还有足够的空闲空间分配给其它小内存的，导致空闲空间利用率不高。</li>
  <li>大内存块链表，重复利用已分配的信息头问题：
遍历粒度很小，是否会产生大量内存碎片。</li>
  <li>小内存回收问题：
内存池只对大内存块进行内存回收，并没有小内存块的内存回收管理。只有 <code class="highlighter-rouge">ngx_reset_pool</code>， <code class="highlighter-rouge">ngx_destroy_pool</code> 是对其进行销毁处理的。</li>
</ul>

<hr />

<p>所以综合以上问题，这个内存池只适合于轻量级的内存管理。</p>

<hr />

<h2 id="测试">测试</h2>

<p>nginx 代码耦合不是很大，可以扣出来调试跟踪一下工作流程。（<a href="https://github.com/wenfh2020/c_test/blob/master/nginx/pool/pool.cpp">源码</a>）</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">ngx_pool_t</span> <span class="o">*</span><span class="n">pool</span> <span class="o">=</span> <span class="n">ngx_create_pool</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p3</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p4</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p5</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p6</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p7</span> <span class="o">=</span> <span class="n">ngx_palloc</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>

    <span class="n">ngx_pool_cleanup_t</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">ngx_pool_cleanup_t</span> <span class="o">*</span><span class="p">)</span><span class="n">ngx_pool_cleanup_add</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">"hello world!"</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">"hello world!"</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">test_cleanup</span><span class="p">;</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

    <span class="n">ngx_destroy_pool</span><span class="p">(</span><span class="n">pool</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="参考">参考</h2>

<p><a href="https://www.cnblogs.com/jzhlin/archive/2012/06/07/ngx_palloc.html">Nginx 源码分析– 内存池(pool)的分析 三</a></p>

<p><a href="https://blog.csdn.net/unix21/article/details/12913287">nginx源码分析–内存对齐处理</a></p>

<p><a href="https://cloud.tencent.com/developer/article/1449440">利用cpu缓存实现高性能程序</a></p>

<p><a href="https://blog.csdn.net/mangobar/article/details/52668859">ngx_align_ptr</a></p>

        </article>
        <hr>

        
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                        
                        <h2 id="similar_posts">Similar Posts</h2>
                        <ul>
                        
                        <li class="relatedPost">
                            <a href="/2020/02/15/c-asm/">比较宏和宏函数的工作效率
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2020/02/08/ngx_align_ptr/">nginx 地址对齐(ngx_align_ptr)
                            
                            </a>
                        </li>
                        
                        
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2020/02/05/redis-obj/">[redis 源码走读] 对象(redisObject)
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2020/02/04/redis-inset/">[redis 源码走读] 整数集合(inset)
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2020/02/03/redis-skiplist/">[redis 源码走读] 跳跃表(skiplist)
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                        
                        <li class="relatedPost">
                            <a href="/2020/01/30/redis-ziplist/">[redis 源码走读] 压缩列表(ziplist)
                            
                            </a>
                        </li>
                        
                        
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
            
            
                
                    
                
                    
                
            
                
                    
                
                    
                
            
        
        
            </ul>
        

        <div class="post-recent">
    <div class="pre">
        
        <p><strong>上一篇</strong> <a href="/2020/01/19/redis-zmalloc/">[redis 源码走读] zmalloc</a></p>
        
    </div>
    <div class="nex">

        
        <p><strong>下一篇</strong> <a href="/2020/01/21/redis-list/">[redis 源码走读] 链表</a></p>
        
    </div>
</div>


        <h2 id="comments">Comments</h2>
        


<div id="disqus_thread"></div>
<script>
    /**
     * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */

    var disqus_config = function() {
        this.page.url = 'http://localhost:4000/2020/01/21/nginx-pool/'; // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://localhost:4000/2020/01/21/nginx-pool/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };

    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document,
            s = d.createElement('script');

        s.src = '//wenfh2020.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>




    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>
    <div class="right">
        <div class="wrap">

            <!-- Content -->
            <div class="side content">
                <div>
                    Content
                </div>
                <ul id="content-side" class="content-ul">
                    
                    <li><a href="#similar_posts">Similar Posts</a></li>
                    
                    <li><a href="#comments">Comments</a></li>
                </ul>
            </div>
            <!-- 其他div框放到这里 -->
            <!-- <div class="side">bbbb</div> -->
        </div>
    </div>
</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
            
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/wenfh2020" title="GitHub"><i class="fa fa-github"
                    aria-hidden="true"></i></a>  
            <a href="mailto:wenfh2020@126.com" title="email"><i class="fa fa-envelope-o" aria-hidden="true"></i></a>
             
            <a href="http://weibo.com/wenfh2020" title="Weibo"><i class="fa fa-weibo"
                    aria-hidden="true"></i></a>  
            <a href="https://www.zhihu.com/people/wenfh2020" title="Zhihu"><i
                    class="iconfont icon-daoruzhihu"></i></a>   
             
        </p>
        <p>
            本站总访问量<span id="busuanzi_value_site_pv"></span>次，本站访客数<span
                id="busuanzi_value_site_uv"></span>人次，本文总阅读量<span id="busuanzi_value_page_pv"></span>次
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a> & <a href="https://pages.github.com/">Github
                    Pages</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/wenfh2020">wenfh2020</a>.
            </span>
        </p>
    </div>
</footer>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <div class="back-to-top">
    <a href="#top" data-scroll>
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/smooth-scroll.min.js " charset="utf-8"></script>
    <script type="text/javascript">
      smoothScroll.init({
        speed: 500, // Integer. How fast to complete the scroll in milliseconds
        easing: 'easeInOutCubic', // Easing pattern to use
        offset: 20, // Integer. How far to offset the scrolling anchor location in pixels
      });
    </script>
    <!-- <script src=" /js/scroll.min.js " charset="utf-8"></script> -->
  </body>

</html>
