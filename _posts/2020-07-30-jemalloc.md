---
layout: post
title:  "jemalloc æ€§èƒ½æµ‹è¯•"
categories: c/c++
tags: jemalloc test performance
author: wenfh2020
---

`jemalloc` æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å†…å­˜åˆ†é…å™¨ï¼Œé€šè¿‡ç³»ç»Ÿé»˜è®¤çš„å†…å­˜åˆ†é…è¿›è¡Œæ¯”è¾ƒï¼š`jemalloc` å†…å­˜åˆ†é…æ€§èƒ½æ¯”ç³»ç»Ÿé»˜è®¤çš„åˆ†é…å™¨å¿« 50%ã€‚




* content
{:toc}

---

## 1. å®‰è£…

* MacOS

```shell
brew install jemalloc
```

* Centos

```shell
yum install jemalloc
yum install jemalloc-devel
```

---

## 2. æµ‹è¯•

### 2.1. æºç  ï¼ˆ[github æµ‹è¯•æºç ](https://github.com/wenfh2020/c_test/blob/master/jemalloc/test_jemalloc.cpp)ï¼‰

æµ‹è¯• 10,000,000 æ¬¡ï¼Œéšæœºå¤§å°çš„å†…å­˜å—åˆ†é…å’Œå›æ”¶ï¼ŒæŸ¥çœ‹å®ƒä»¬çš„å·¥ä½œæ•ˆç‡ã€‚

```c++
#include <stdlib.h>
#include <string.h>
#include <sys/time.h>

#include <iostream>

#ifdef USE_JEMALLOC
#include <jemalloc/jemalloc.h>
#endif

#define MALLOC_CNT 10000000

long long mstime() {
    long long mst;
    struct timeval tv;
    gettimeofday(&tv, NULL);
    mst = ((long long)tv.tv_sec) * 1000;
    mst += tv.tv_usec / 1000;
    return mst;
}

int main() {
    srand((unsigned)time(NULL));
    long long begin = mstime();
    for (int i = 0; i < MALLOC_CNT; i++) {
        int size = 1024 * 4 + rand() % 1024;
        char* p = (char*)malloc(size);
        memset(p, rand() % 128, size);
        free(p);
    }
    long long end = mstime();

    std::cout << "begin: " << begin << std::endl
              << "end: " << end << std::endl
              << "val: " << end - begin << std::endl;
    return 0;
}
```

---

### 2.2. æµ‹è¯•ç»“æœ

æµ‹è¯•æ—¶é—´å•ä½ï¼šå¾®ç§’ï¼Œjemalloc å†…å­˜ç®¡ç†è€—æ—¶å¤§çº¦æ˜¯ç³»ç»Ÿé»˜è®¤å†…å­˜ç®¡ç†çš„ä¸€åŠ **ï¼ˆ605 vs 1253ï¼‰**ã€‚

```shell
# normal mem test.
$ g++ -std='c++11' -g test_jemalloc.cpp -o tjemalloc  && ./tjemalloc
begin: 1596078974122
end: 1596078975375
val: 1253

# jemalloc mem test.
$ g++ -std='c++11' -g test_jemalloc.cpp -o tjemalloc -DUSE_JEMALLOC -ljemalloc && ./tjemalloc
begin: 1596078980303
end: 1596078980908
val: 605
```

---

> ğŸ”¥æ–‡ç« æ¥æºï¼š[wenfh2020.com](https://wenfh2020.com/2020/07/30/jemalloc/)
