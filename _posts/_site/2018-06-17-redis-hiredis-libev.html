<p>用 <code class="highlighter-rouge">hiredis</code> 测试写命令 <code class="highlighter-rouge">set key value</code>，几个字节的 value，轻松 10 万+ 并发；1024 个字节的 value，10w 请求需要耗时 1.5 秒左右。所以 <code class="highlighter-rouge">hiredis</code> 的异步使用性能非常给力的，而且程序的性能损耗也不高。只是异步使用有点反人类，业务都要在 callback 里面处理，没有同步调用那么直观。<code class="highlighter-rouge">libev</code> 是一个不错的事件驱动库，在这里就不展开了。</p>

<p><img src="/images/2020-02-20-16-56-08.png" alt="本地性能" data-action="zoom" /></p>

<ul id="markdown-toc">
  <li><a href="#1-测试" id="markdown-toc-1-测试">1. 测试</a></li>
</ul>

<hr />

<h2 id="1-测试">1. 测试</h2>

<p><code class="highlighter-rouge">hiredis</code> 代码提供了 <code class="highlighter-rouge">libev</code> 的 I/O 回调。只要绑定相关 libev 的相关回调，即可使用，代码也相对比较精简。(<a href="https://github.com/wenfh2020/mytest/blob/master/c%2B%2B/hiredis_test/async/main.cpp">测试源码</a>)</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">RdsCbConnect</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span><span class="o">*</span> <span class="n">pRdsContext</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iStatus</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">RdsCbDisConnect</span><span class="p">(</span><span class="k">const</span> <span class="n">redisAsyncContext</span><span class="o">*</span> <span class="n">pRdsContext</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iStatus</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">RdsCbCmd</span><span class="p">(</span><span class="n">redisAsyncContext</span><span class="o">*</span> <span class="n">pRdsContext</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pReply</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pData</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">RdsCbCmd</span><span class="p">(</span><span class="n">redisAsyncContext</span><span class="o">*</span> <span class="n">pRdsContext</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pReply</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">pData</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pReply</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"call back repplay null!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">redisReply</span><span class="o">*</span> <span class="n">pRdsReply</span> <span class="o">=</span> <span class="p">(</span><span class="n">redisReply</span><span class="o">*</span><span class="p">)</span><span class="n">pReply</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">REDIS_REPLY_NIL</span> <span class="o">==</span> <span class="n">pRdsReply</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"reply nil</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//printf("%d, redis reply info: type = %d, string = %s\n", ++g_iCmdCallback, pRdsReply-&gt;type, pRdsReply-&gt;str);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">g_iCmdCallback</span> <span class="o">&gt;=</span> <span class="n">TEST_CMD_COUNT</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullEndTime</span> <span class="o">=</span> <span class="n">GetMicrosecond</span><span class="p">();</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"test end time: %s, %llu, interval: %llu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
               <span class="n">GetCurrentTime</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">ullEndTime</span><span class="p">,</span> <span class="n">ullEndTime</span> <span class="o">-</span> <span class="n">g_ullBeginTime</span><span class="p">);</span>
        <span class="n">redisAsyncDisconnect</span><span class="p">((</span><span class="n">redisAsyncContext</span><span class="o">*</span><span class="p">)</span><span class="n">pRdsContext</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">redisAsyncContext</span><span class="o">*</span> <span class="n">pRdsContext</span> <span class="o">=</span> <span class="n">redisAsyncConnect</span><span class="p">(</span><span class="n">IP</span><span class="p">,</span> <span class="n">PORT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pRdsContext</span><span class="o">-&gt;</span><span class="n">err</span> <span class="o">!=</span> <span class="n">REDIS_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"async redis connect failed! err code = %d, err msg = %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">pRdsContext</span><span class="o">-&gt;</span><span class="n">err</span><span class="p">,</span> <span class="n">pRdsContext</span><span class="o">-&gt;</span><span class="n">errstr</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">ev_loop</span><span class="o">*</span> <span class="n">pLoop</span> <span class="o">=</span> <span class="n">EV_DEFAULT</span><span class="p">;</span>
    <span class="n">redisLibevAttach</span><span class="p">(</span><span class="n">pLoop</span><span class="p">,</span> <span class="n">pRdsContext</span><span class="p">);</span>
    <span class="n">redisAsyncSetConnectCallback</span><span class="p">(</span><span class="n">pRdsContext</span><span class="p">,</span> <span class="n">RdsCbConnect</span><span class="p">);</span>
    <span class="n">redisAsyncSetDisconnectCallback</span><span class="p">(</span><span class="n">pRdsContext</span><span class="p">,</span> <span class="n">RdsCbDisConnect</span><span class="p">);</span>
    <span class="n">ev_run</span><span class="p">(</span><span class="n">pLoop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>测试结果(interval 是微妙为单位的时间差)</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>connect call back, status <span class="o">=</span> 0
<span class="nb">test </span>write cmd count <span class="o">=</span> 100000
<span class="nb">test </span>begin <span class="nb">time</span>: 2018-06-17 08:17:43, 1529194663712890
<span class="nb">test </span>end <span class="nb">time</span>: 2018-06-17 08:17:44, 1529194664952655, interval: 1239765  
disconnect call back, status <span class="o">=</span> 0
</code></pre></div></div>
