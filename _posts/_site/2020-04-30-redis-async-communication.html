<table>
  <thead>
    <tr>
      <th style="text-align: left">é‡ç‚¹</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">æœåŠ¡å¼‚æ­¥é€šä¿¡æ ¸å¿ƒ</td>
      <td style="text-align: left">éé˜»å¡ + å¼‚æ­¥äº‹ä»¶é©±åŠ¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">äº‹ä»¶é©±åŠ¨æ ¸å¿ƒæºç </td>
      <td style="text-align: left">ae.c</td>
    </tr>
    <tr>
      <td style="text-align: left">ç½‘ç»œé€šä¿¡æ ¸å¿ƒæºç </td>
      <td style="text-align: left">connection.h / connection.cï¼Œnetworking.h / connection.c</td>
    </tr>
    <tr>
      <td style="text-align: left">è¯»/å†™æ•°æ®æ ¸å¿ƒå‡½æ•°</td>
      <td style="text-align: left">readQueryFromClient / writeToClient</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>æœ¬æ–‡ä¸»è¦è®²è¿° Linux å¹³å°ä¸‹çš„ redis å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¼‚æ­¥é€šä¿¡ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä¸åŒ…æ‹¬ redis é›†ç¾¤é—´çš„é€šä¿¡ã€‚</p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹" id="markdown-toc-1-å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹">1. å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹</a></li>
  <li><a href="#2-éé˜»å¡" id="markdown-toc-2-éé˜»å¡">2. éé˜»å¡</a>    <ul>
      <li><a href="#21-socket-éå¡è®¾ç½®" id="markdown-toc-21-socket-éå¡è®¾ç½®">2.1. socket éå¡è®¾ç½®</a></li>
      <li><a href="#22-ç½‘ç»œé€šä¿¡å‡½æ•°" id="markdown-toc-22-ç½‘ç»œé€šä¿¡å‡½æ•°">2.2. ç½‘ç»œé€šä¿¡å‡½æ•°</a></li>
    </ul>
  </li>
  <li><a href="#3-äº‹ä»¶é©±åŠ¨" id="markdown-toc-3-äº‹ä»¶é©±åŠ¨">3. äº‹ä»¶é©±åŠ¨</a>    <ul>
      <li><a href="#31-epoll-æ¥å£" id="markdown-toc-31-epoll-æ¥å£">3.1. epoll æ¥å£</a></li>
      <li><a href="#32-epoll-ä½¿ç”¨é€»è¾‘" id="markdown-toc-32-epoll-ä½¿ç”¨é€»è¾‘">3.2. epoll ä½¿ç”¨é€»è¾‘</a></li>
      <li><a href="#33-å¼‚æ­¥å›è°ƒ" id="markdown-toc-33-å¼‚æ­¥å›è°ƒ">3.3. å¼‚æ­¥å›è°ƒ</a>        <ul>
          <li><a href="#331-è·¨å¹³å°" id="markdown-toc-331-è·¨å¹³å°">3.3.1. è·¨å¹³å°</a></li>
          <li><a href="#332-äº‹ä»¶å›è°ƒå¼‚æ­¥é€»è¾‘" id="markdown-toc-332-äº‹ä»¶å›è°ƒå¼‚æ­¥é€»è¾‘">3.3.2. äº‹ä»¶å›è°ƒå¼‚æ­¥é€»è¾‘</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#4-æœåŠ¡æ•°æ®ç»“æ„" id="markdown-toc-4-æœåŠ¡æ•°æ®ç»“æ„">4. æœåŠ¡æ•°æ®ç»“æ„</a>    <ul>
      <li><a href="#41-æœåŠ¡ç«¯ç»“æ„" id="markdown-toc-41-æœåŠ¡ç«¯ç»“æ„">4.1. æœåŠ¡ç«¯ç»“æ„</a></li>
      <li><a href="#42-å®¢æˆ·ç«¯ç»“æ„" id="markdown-toc-42-å®¢æˆ·ç«¯ç»“æ„">4.2. å®¢æˆ·ç«¯ç»“æ„</a></li>
    </ul>
  </li>
  <li><a href="#5-å‚è€ƒ" id="markdown-toc-5-å‚è€ƒ">5. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹">1. å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹</h2>

<p>redis å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å¼‚æ­¥é€šä¿¡æµç¨‹ï¼Œæ•´ä½“é€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå…ˆçœ‹çœ‹æµç¨‹å›¾ï¼Œåé¢å†æŠ“æŠ“é‡ç‚¹ã€‚</p>

<blockquote>
  <p>çœ‹ä¸æ¸…æ¥šå›¾ç‰‡ï¼Œå¯ä»¥å°†å…¶ä¸‹è½½åˆ°ç”µè„‘æœ¬åœ°æ‰“å¼€æŸ¥çœ‹ã€‚</p>
</blockquote>

<p><img src="/images/2020-05-04-01-19-51.png" alt="å¼‚æ­¥æœåŠ¡å·¥ä½œæµç¨‹" data-action="zoom" /></p>

<hr />

<h2 id="2-éé˜»å¡">2. éé˜»å¡</h2>

<h3 id="21-socket-éå¡è®¾ç½®">2.1. socket éå¡è®¾ç½®</h3>

<p>redis å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šè¿‡ TCP åè®®è¿›è¡Œé€šä¿¡ã€‚æœåŠ¡ç›‘å¬ç«¯å£åˆ›å»ºçš„ socketï¼Œå®¢æˆ·ç«¯æ¥å…¥æœåŠ¡çš„ socketï¼Œéƒ½éœ€è¦è®¾ç½®éé˜»å¡ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">anetNonBlock</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">anetSetBlock</span><span class="p">(</span><span class="n">err</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">anetSetBlock</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">non_block</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">anetSetError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"fcntl(F_GETFL): %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">ANET_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">non_block</span><span class="p">)</span>
        <span class="n">flags</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">O_NONBLOCK</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">anetSetError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"fcntl(F_SETFL,O_NONBLOCK): %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">ANET_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ANET_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="22-ç½‘ç»œé€šä¿¡å‡½æ•°">2.2. ç½‘ç»œé€šä¿¡å‡½æ•°</h3>

<p>socket éé˜»å¡è®¾ç½®åï¼Œéƒ¨åˆ†é»˜è®¤é˜»å¡çš„å‡½æ•°ï¼Œå˜æˆéé˜»å¡ï¼Œæ•°æ®ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œçš„æƒ…å†µä¸‹ï¼Œå‡½æ•°è¿”å›ç»“æœ <code class="highlighter-rouge">-1</code>ï¼Œé”™è¯¯ <code class="highlighter-rouge">errno</code> æ˜¯ <code class="highlighter-rouge">EAGAIN</code> æˆ– <code class="highlighter-rouge">EWOULDBLOCK</code>ã€‚</p>

<ul>
  <li>accept</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">acceptTcpHandler</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">(</span><span class="n">max</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">cfd</span> <span class="o">=</span> <span class="n">anetTcpAccept</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">neterr</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">cip</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cip</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cport</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cfd</span> <span class="o">==</span> <span class="n">ANET_ERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">EWOULDBLOCK</span><span class="p">)</span>
                <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span>
                    <span class="s">"Accepting client connection: %s"</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">neterr</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">anetGenericAccept</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">err</span><span class="p">,</span> <span class="kt">int</span> <span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">sa</span><span class="p">,</span> <span class="n">socklen_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">sa</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EINTR</span><span class="p">)</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="n">anetSetError</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="s">"accept: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
                <span class="k">return</span> <span class="n">ANET_ERR</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>read</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">connSocketRead</span><span class="p">(</span><span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CONN_STATE_CLOSED</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">last_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CONN_STATE_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>write</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">connSocketWrite</span><span class="p">(</span><span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">data_len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">conn</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">errno</span> <span class="o">!=</span> <span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">last_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
        <span class="n">conn</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">CONN_STATE_ERROR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-äº‹ä»¶é©±åŠ¨">3. äº‹ä»¶é©±åŠ¨</h2>

<p>redis æœåŠ¡é€šè¿‡äº‹ä»¶é©±åŠ¨ç›‘æ§ fd è¯»å†™äº‹ä»¶ã€‚redis åœ¨ Linux ç³»ç»Ÿäº‹ä»¶é©±åŠ¨é»˜è®¤é€‰æ‹© <code class="highlighter-rouge">epoll</code>ã€‚</p>

<h3 id="31-epoll-æ¥å£">3.1. epoll æ¥å£</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æ¥å£</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">epoll_create</td>
      <td style="text-align: left">åˆ›å»º epoll äº‹ä»¶é©±åŠ¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">epoll_ctl</td>
      <td style="text-align: left">äº‹ä»¶é©±åŠ¨å¯¹ fd å¯¹åº”äº‹ä»¶è¿›è¡Œå¢åˆ æ”¹ç®¡ç†ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">epoll_wait</td>
      <td style="text-align: left">é˜»å¡ä»å†…æ ¸è·å–å°±ç»ªäº‹ä»¶ã€‚æ¥å£æœ‰æ—¶é—´å‚æ•°ï¼Œå¯ä»¥è®¾ç½®é˜»å¡ç­‰å¾…æ—¶é—´ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="32-epoll-ä½¿ç”¨é€»è¾‘">3.2. epoll ä½¿ç”¨é€»è¾‘</h3>

<p>socket è®¾ç½®éé˜»å¡åï¼Œwrite / readï¼Œæœ‰å¯èƒ½ä¸æ˜¯ä¸€æ¬¡æ€§å°†æ•°æ®è¯»å†™å®Œæˆå†è¿”å›ï¼ˆå‚è€ƒ 2.2 ç« èŠ‚ï¼‰ã€‚redis é‡‡ç”¨ <code class="highlighter-rouge">epoll</code> é»˜è®¤æ¨¡å¼æ˜¯ <code class="highlighter-rouge">LT</code>ï¼Œå½“æ•°æ®æ²¡å¤„ç†å®Œï¼Œå†…æ ¸é‡å¤é€šçŸ¥äº‹ä»¶ç»™æœåŠ¡å¤„ç†ã€‚</p>

<ul>
  <li>read æ•°æ®ï¼Œåªè¦æ²¡æœ‰è¯»å–å®Œæˆ fd å¯¹åº”çš„æ‰€æœ‰æ¥æ”¶æ•°æ®ï¼Œå†…æ ¸ä¼šä¸åœé€šçŸ¥ <code class="highlighter-rouge">EPOLLIN</code> è¯»äº‹ä»¶ã€‚å³ <code class="highlighter-rouge">epoll_wait</code> ä¸åœå–å‡ºè¯»äº‹ä»¶è¦æ±‚è¯»æ•°æ®ï¼Œç›´åˆ° read æ‰€æœ‰æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œæ‰ä¼šåœæ­¢ <code class="highlighter-rouge">EPOLLIN</code> è¯»äº‹ä»¶é€šçŸ¥ã€‚</li>
  <li>write æ•°æ®ï¼ŒæœåŠ¡ä¸€æ¬¡å‘é€ä¸å®Œï¼Œé‚£ä¹ˆéœ€è¦æœåŠ¡ä¸»åŠ¨è°ƒç”¨ <code class="highlighter-rouge">epoll_ctl</code> ç›‘æ§å†™äº‹ä»¶ï¼Œä¸‹æ¬¡ <code class="highlighter-rouge">epoll_wait</code> ä¼šé€šçŸ¥ <code class="highlighter-rouge">EPOLLOUT</code> äº‹ä»¶ï¼ŒæœåŠ¡ç»§ç»­å¤„ç†å†™äº‹ä»¶ï¼Œç›´åˆ°å°†æ•°æ®å‘é€å®Œæ¯•ä¸ºæ­¢ã€‚æ•°æ®å‘é€å®Œæ¯•åï¼Œå†é€šè¿‡ <code class="highlighter-rouge">epoll_ctl</code> å–æ¶ˆç›‘æ§ <code class="highlighter-rouge">EPOLLOUT</code> å†™äº‹ä»¶ã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">sendReplyToClient</code>æºç å®ç°é€»è¾‘ï¼‰</li>
</ul>

<hr />

<h3 id="33-å¼‚æ­¥å›è°ƒ">3.3. å¼‚æ­¥å›è°ƒ</h3>

<p>redis å¯¹äº‹ä»¶é©±åŠ¨å°è£…äº†ä¸€å±‚ï¼Œæ ¸å¿ƒä»£ç åœ¨ <code class="highlighter-rouge">ae.c</code>ï¼Œç›®çš„æœ‰ä¸¤ä¸ªï¼šè·¨å¹³å°ï¼Œå¼‚æ­¥å›è°ƒã€‚</p>

<h4 id="331-è·¨å¹³å°">3.3.1. è·¨å¹³å°</h4>

<p>è·¨å¹³å°ï¼Œä¸åŒå¹³å°å¯ä»¥æ ¹æ®é¢„ç¼–è¯‘å®ï¼Œé€‰æ‹©å¯¹åº”å¹³å°çš„äº‹ä»¶é©±åŠ¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#ifdef HAVE_EVPORT
#include "ae_evport.c"
#else
</span>    <span class="cp">#ifdef HAVE_EPOLL
</span>    <span class="cp">#include "ae_epoll.c"
</span>    <span class="cp">#else
</span>        <span class="cp">#ifdef HAVE_KQUEUE
</span>        <span class="cp">#include "ae_kqueue.c"
</span>        <span class="cp">#else
</span>        <span class="cp">#include "ae_select.c"
</span>        <span class="cp">#endif
</span>    <span class="cp">#endif
#endif
</span></code></pre></div></div>

<hr />

<h4 id="332-äº‹ä»¶å›è°ƒå¼‚æ­¥é€»è¾‘">3.3.2. äº‹ä»¶å›è°ƒå¼‚æ­¥é€»è¾‘</h4>

<p>äº‹ä»¶é©±åŠ¨å¼‚æ­¥å›è°ƒçš„æ ¸å¿ƒé€»è¾‘æ˜¯ fd + äº‹ä»¶ + äº‹ä»¶å¯¹åº”å¤„ç†å‡½æ•°ã€‚å‚è€ƒæºç ï¼š</p>

<ol>
  <li>æ•°æ®ç»“æ„ï¼š<code class="highlighter-rouge">aeFileEvent</code>ï¼Œ<code class="highlighter-rouge">client</code>ï¼Œ <code class="highlighter-rouge">connection</code>ã€‚</li>
  <li>å›è°ƒå‡½æ•°ï¼š<code class="highlighter-rouge">acceptTcpHandler</code>ï¼Œ<code class="highlighter-rouge">readQueryFromClient</code>ï¼Œ <code class="highlighter-rouge">sendReplyToClient</code>ã€‚</li>
</ol>

<ul>
  <li>æœåŠ¡ç«¯å›è°ƒæµç¨‹</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aeEventLoop -&gt; epoll_wait<span class="o">(</span>fd + events<span class="o">)</span> -&gt; aeFileEvent.rfileProc -&gt; acceptTcpHandler
</code></pre></div></div>

<ul>
  <li>å®¢æˆ·ç«¯å›è°ƒæµç¨‹</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>aeEventLoop -&gt; epoll_wait<span class="o">(</span>fd + events<span class="o">)</span> -&gt; aeFileEvent.rfileProc/wfileProc -&gt; client.connection.ae_handler
</code></pre></div></div>

<ul>
  <li>äº‹ä»¶ç»“æ„</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// events æ˜¯ä¸€ä¸ªä»¥ fd ä¸ºä¸‹æ ‡çš„äº‹ä»¶æ•°ç»„ã€‚</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span> <span class="c1">// äº‹ä»¶æ•°ç»„ã€‚</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>

<span class="cm">/* File event structure */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeFileEvent</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span> <span class="cm">/* one of AE_(READABLE|WRITABLE|BARRIER) */</span>
    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">rfileProc</span><span class="p">;</span> <span class="c1">// è¯»å›è°ƒå‡½æ•°ã€‚</span>
    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">wfileProc</span><span class="p">;</span> <span class="c1">// å†™å›è°ƒå‡½æ•°ã€‚</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">;</span> <span class="c1">// client çš„ connection æŒ‡é’ˆã€‚</span>
<span class="p">}</span> <span class="n">aeFileEvent</span><span class="p">;</span>
</code></pre></div></div>

<blockquote>
  <p>fd æ–‡ä»¶æè¿°ç¬¦åœ¨å†…æ ¸é‡Œä¹Ÿç›¸å½“äºä¸€ä¸ªä¸‹æ ‡ï¼Œé€’å¢çš„ï¼Œå®ƒå¯¹åº”çš„æ˜¯æ–‡ä»¶ã€‚Linux ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œæ‰€ä»¥ socket æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// file.c</span>
<span class="kt">void</span> <span class="nf">fd_install</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__fd_install</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">files</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-æœåŠ¡æ•°æ®ç»“æ„">4. æœåŠ¡æ•°æ®ç»“æ„</h2>

<p>redis çš„å¼‚æ­¥é€»è¾‘æŒºå¤šç»†èŠ‚çš„ï¼Œç»“åˆä¸Šå›¾ï¼Œé‡ç‚¹ç†è§£ä¸€ä¸‹ä¸‹åˆ—æ•°æ®ç»“æ„çš„ä¸€äº›æˆå‘˜ã€‚</p>

<h3 id="41-æœåŠ¡ç«¯ç»“æ„">4.1. æœåŠ¡ç«¯ç»“æ„</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients</span><span class="p">;</span>              <span class="cm">/* List of active clients */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_to_close</span><span class="p">;</span>     <span class="cm">/* Clients to close asynchronously */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_pending_write</span><span class="p">;</span> <span class="cm">/* There is to write or install handler. */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_pending_read</span><span class="p">;</span>  <span class="cm">/* Client has pending read socket buffers. */</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">clients</td>
      <td style="text-align: left">å®¢æˆ·ç«¯é“¾è¡¨ï¼Œå®¢æˆ·ç«¯æ–°è¿æ¥ä¼šå­˜å‚¨åœ¨é“¾è¡¨é‡Œã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">clients_to_close</td>
      <td style="text-align: left">å®¢æˆ·ç«¯å…³é—­é“¾è¡¨ï¼Œ æ”¾åœ¨ <code class="highlighter-rouge">beforeSleep</code> é‡Œè¿›è¡Œå¼‚æ­¥å…³é—­ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">clients_pending_write</td>
      <td style="text-align: left">å»¶è¿Ÿå†™æ•°æ®å®¢æˆ·ç«¯é“¾è¡¨ï¼Œå¼‚æ­¥æ“ä½œï¼Œæ•°æ®å¹¶ä¸æ˜¯è¯»å‡ºæ¥è¿›è¡Œå¤„ç†åå°±é©¬ä¸Šå‘é€çš„ï¼ŒæœåŠ¡å¤„ç†å®Œé€»è¾‘åä¼šå°†å›å¤æ•°æ®å†™å…¥ client çš„å†™å…¥ç¼“å†²åŒºï¼ˆbuf/replyï¼‰ï¼Œå¹¶è®°å½•ä¸‹å½“å‰å®¢æˆ·ç«¯ï¼Œåœ¨ <code class="highlighter-rouge">beforeSleep</code> é‡Œè¿›è¡Œç»Ÿä¸€å‘é€ã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">clientInstallWriteHandler</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">clients_pending_read</td>
      <td style="text-align: left">å»¶è¿Ÿè¯»æ•°æ®å®¢æˆ·ç«¯é“¾è¡¨ï¼Œå¼‚æ­¥è¯»æ•°æ®ï¼ŒæœåŠ¡å¼€å¯å¤šçº¿ç¨‹å¤„ç†è¯»æ•°æ®å¤„ç†æ–¹å¼æ‰ä¼šç”¨åˆ°ã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">postponeClientRead</code> æºç ï¼‰</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="42-å®¢æˆ·ç«¯ç»“æ„">4.2. å®¢æˆ·ç«¯ç»“æ„</h3>

<p>å½“å®¢æˆ·ç«¯è¿æ¥ redis æœåŠ¡ï¼Œredis æœåŠ¡ç”¨ <code class="highlighter-rouge">client</code> ç»“æ„ä¿å­˜äº†å®¢æˆ·ç«¯é€šä¿¡çš„ç›¸å…³ä¿¡æ¯ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// server.h</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">client</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">id</span><span class="p">;</span>            <span class="cm">/* Client incremental unique ID. */</span>
    <span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">sds</span> <span class="n">querybuf</span><span class="p">;</span>           <span class="cm">/* Buffer we use to accumulate client queries. */</span>
    <span class="kt">size_t</span> <span class="n">qb_pos</span><span class="p">;</span>          <span class="cm">/* The position we have read in querybuf. */</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>               <span class="cm">/* Num of arguments of current command. */</span>
    <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>            <span class="cm">/* Arguments of current command. */</span>
    <span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">lastcmd</span><span class="p">;</span>  <span class="cm">/* Last command executed. */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>            <span class="cm">/* List of reply objects to send to the client. */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">reply_bytes</span><span class="p">;</span> <span class="cm">/* Tot bytes of objects in reply list. */</span>
    <span class="p">...</span>
    <span class="cm">/* Response buffer */</span>
    <span class="kt">int</span> <span class="n">bufpos</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PROTO_REPLY_CHUNK_BYTES</span><span class="p">];</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">id</td>
      <td style="text-align: left">redis æœåŠ¡åˆ†é…çš„é€’å¢ idã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">createClient</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">conn</td>
      <td style="text-align: left">å®¢æˆ·ç«¯é“¾æ¥å¯¹è±¡ï¼Œå°è£…äº†ç½‘ç»œç›¸å…³æ“ä½œï¼šè¯»å†™æ•°æ®ï¼Œäº‹ä»¶é©±åŠ¨æ¥å£è°ƒç”¨ï¼Œç½‘ç»œäº‹ä»¶å›è°ƒé€»è¾‘ç­‰ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">querybuf</td>
      <td style="text-align: left">è¯»ç¼“å­˜ï¼ŒæœåŠ¡è¯»å–å®¢æˆ·ç«¯å‘é€çš„æ•°æ®ç„¶åå†™å…¥ client.querybuf ç¼“å­˜ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">qb_pos</td>
      <td style="text-align: left">è¯»ç¼“å­˜å¤„ç†ä½ç½®ï¼Œå®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡çš„å¯èƒ½æ˜¯å‘½ä»¤ï¼Œredis æœåŠ¡è¯»å–æ•°æ®åï¼Œéœ€è¦è¿›è¡Œé€»è¾‘å¤„ç†ï¼Œå› ä¸ºæ˜¯éé˜»å¡æ“ä½œï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡ read éƒ½èƒ½æŠŠå®¢æˆ·ç«¯å‘é€çš„æ•°æ®å…¨éƒ¨è¯»å–å‡ºæ¥ï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸º tcp é€šä¿¡ï¼Œé‡åˆ°ç²˜åŒ…é—®é¢˜ï¼Œå¾ˆå¯èƒ½å®¢æˆ·ç«¯è¿ç»­å‘äº† 2 ä¸ªå‘½ä»¤ï¼ŒæœåŠ¡ç«¯åª read å‡ºäº† 1 ä¸ªåŠå‘½ä»¤ï¼Œå¦å¤–ä¸€éƒ¨åˆ†ä¸‹æ¬¡å† readã€‚è¿™æ—¶å€™æœåŠ¡ç«¯å¯ä»¥å…ˆå¤„ç†å®Œä¸€ä¸ªå‘½ä»¤ï¼Œæ ‡è®° querybuf å¤„ç†çš„ä½ç½® qb_posï¼Œç„¶åå¯¹ querybuf æ•°æ®æ‰€åœ¨ qb_pos ä½ç½®è¿›è¡Œæˆªæ–­ï¼Œå‰©ä¸‹é‚£åŠä¸ªå‘½ä»¤ï¼Œä¸‹æ¬¡è¯»å‡ºå®Œæ•´çš„å‘½ä»¤åå†è¿›è¡Œé€»è¾‘å¤„ç†ã€‚ ï¼ˆå‚è€ƒ <code class="highlighter-rouge">processInputBuffer</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">argc</td>
      <td style="text-align: left">å½“å‰å‘½ä»¤å‚æ•°ä¸ªæ•°ã€‚ redis æœ‰è‡ªå·±çš„é€šä¿¡åè®® RESPï¼ŒæœåŠ¡è¯»å–æ•°æ®åï¼Œéœ€è¦å°† RESP åè®®å‚æ•°è§£æå‡ºæ¥ã€‚argc å­˜æ”¾äº†å‘½ä»¤ç”±å¤šå°‘ä¸ªå­—ç¬¦ä¸²ç»„æˆçš„ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">argv</td>
      <td style="text-align: left">å½“å‰å‘½ä»¤å‚æ•°æ•°ç»„ã€‚å‚è€ƒ argc è§£æã€‚ä¾‹å¦‚å‘½ä»¤ <code class="highlighter-rouge">set key123 value123</code>ï¼Œargc å‘½ä»¤å‚æ•°ä¸ªæ•°æ˜¯ 3ï¼Œargv å­—ç¬¦ä¸²æ•°ç»„åˆ†åˆ«ä¸º [â€œsetâ€,â€key123â€,â€123â€]ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">cmd</td>
      <td style="text-align: left">å½“å‰å‘½ä»¤å¯¹è±¡æŒ‡é’ˆã€‚redis è§£æ RESP åè®®æ•°æ®åï¼Œè§£æå‡ºå¯¹åº”çš„å‘½ä»¤å‚æ•°ï¼Œé‚£ä¹ˆéœ€è¦è¿›è¡Œ redis å¯¹åº”å‘½ä»¤çš„é€»è¾‘å¤„ç†ï¼Œä¾‹å¦‚ <code class="highlighter-rouge">set</code> å‘½ä»¤å¯¹åº” <code class="highlighter-rouge">setCommnad</code> å‘½ä»¤å¤„ç†å‡½æ•°ã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">struct redisCommand</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">reply</td>
      <td style="text-align: left">å›å¤æ•°æ®é“¾è¡¨ï¼Œè¿™æ˜¯ä¸€ä¸ªåŠ¨æ€å†…å­˜ç»“æ„ï¼Œä¸€èˆ¬å›å¤æ•°æ®æ¯”è¾ƒçŸ­( &lt; 16k )çš„æƒ…å†µä¸‹ï¼Œä¸ä¼šç”¨åˆ°å®ƒï¼Œç”¨ buf å¤„ç†å°±å¤Ÿäº†ï¼Œä½†æ˜¯æ•°æ®å¾ˆå¤šçš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå°±è¦åˆ†é…åŠ¨æ€å†…å­˜å»ç®¡ç†è¿™äº›æ•°æ®ã€‚æ¯æ¬¡ç”³è¯·ä¸€ä¸ªè¿ç»­å†…å­˜çš„æ•°æ®å—ï¼Œè¿›è¡Œå­˜å‚¨ï¼Œç”¨å®Œäº†ï¼Œå†ç”³è¯·ä¸€ä¸ªæ–°çš„æ•°æ®å—ï¼Œç„¶åè¿™äº›æ•°æ®å—é€šè¿‡é“¾è¡¨é¡ºåºä¸²è”èµ·æ¥ç®¡ç†ã€‚ï¼ˆå‚è€ƒ <code class="highlighter-rouge">_addReplyProtoToList</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">reply_bytes</td>
      <td style="text-align: left">reply é“¾è¡¨ä¸Šçš„å›å¤æ•°æ®å ç”¨å†…å­˜æ€»å’Œã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">bufpos</td>
      <td style="text-align: left">buf å›å¤ç¼“å­˜æ•°æ®ä½ç½®ï¼Œè®°å½• buf çš„æ•°æ®é•¿åº¦ã€‚ï¼ˆ å‚è€ƒ <code class="highlighter-rouge">_addReplyToBuffer</code> æºç ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">buf</td>
      <td style="text-align: left">å›å¤æ•°æ®ç¼“å­˜ï¼Œä¸€èˆ¬å›å¤æ•°æ®é•¿åº¦å°äº 16k ä¼šä¿å­˜åœ¨ bufã€‚ï¼ˆ<code class="highlighter-rouge">#define PROTO_REPLY_CHUNK_BYTES (16*1024)</code>ï¼‰ï¼Œå›å¤æ•°æ® 16k ä»¥å†…çš„ä½¿ç”¨é¢‘ç‡æ¯”è¾ƒé«˜ã€‚buf å’Œ reply åˆ†å¼€å¤„ç†ï¼Œæ¯”è¾ƒé«˜æ•ˆã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="5-å‚è€ƒ">5. å‚è€ƒ</h2>

<ul>
  <li>redis 6.0 æºç </li>
  <li><a href="https://wenfh2020.com/2020/04/09/redis-ae-file/">[redis æºç èµ°è¯»] äº‹ä»¶ - æ–‡ä»¶äº‹ä»¶</a></li>
  <li><a href="https://wenfh2020.com/2020/04/14/epoll-workflow/">epoll å¤šè·¯å¤ç”¨ I/Oå·¥ä½œæµç¨‹</a></li>
  <li><a href="https://wenfh2020.com/2020/04/06/ae-timer/">[redis æºç èµ°è¯»] äº‹ä»¶ - å®šæ—¶å™¨</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/04/30/redis-async-communication/">wenfh2020.com</a></p>
</blockquote>
