<p>rdb æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä¸Šä¸€ç« è®²äº† <a href="https://wenfh2020.com/2020/03/19/redis-rdb-application/">rdb æŒä¹…åŒ– - åº”ç”¨åœºæ™¯</a>ï¼Œæœ¬ç« ä¸»è¦è®²è¿° rdb æ–‡ä»¶çš„ç»“æ„ç»„æˆåŒ…å«äº†å“ªäº›æ•°æ®ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-rdb-ä¸´æ—¶æ–‡ä»¶" id="markdown-toc-1-rdb-ä¸´æ—¶æ–‡ä»¶">1. rdb ä¸´æ—¶æ–‡ä»¶</a></li>
  <li><a href="#2-é€æ­¥æŒä¹…åŒ–" id="markdown-toc-2-é€æ­¥æŒä¹…åŒ–">2. é€æ­¥æŒä¹…åŒ–</a></li>
  <li><a href="#3-ç»“æ„" id="markdown-toc-3-ç»“æ„">3. ç»“æ„</a>    <ul>
      <li><a href="#31-æ•°æ®ä¿å­˜æ—¶åº" id="markdown-toc-31-æ•°æ®ä¿å­˜æ—¶åº">3.1. æ•°æ®ä¿å­˜æ—¶åº</a></li>
      <li><a href="#32-ä¿å­˜é›†ç¾¤å¤åˆ¶ä¿¡æ¯" id="markdown-toc-32-ä¿å­˜é›†ç¾¤å¤åˆ¶ä¿¡æ¯">3.2. ä¿å­˜é›†ç¾¤å¤åˆ¶ä¿¡æ¯</a></li>
      <li><a href="#33-ä¿å­˜å±æ€§ä¿¡æ¯" id="markdown-toc-33-ä¿å­˜å±æ€§ä¿¡æ¯">3.3. ä¿å­˜å±æ€§ä¿¡æ¯</a></li>
      <li><a href="#34-ä¿å­˜-key-value" id="markdown-toc-34-ä¿å­˜-key-value">3.4. ä¿å­˜ key-value</a></li>
    </ul>
  </li>
  <li><a href="#4-å‚è€ƒ" id="markdown-toc-4-å‚è€ƒ">4. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-rdb-ä¸´æ—¶æ–‡ä»¶">1. rdb ä¸´æ—¶æ–‡ä»¶</h2>

<p>redis å†…å­˜æ•°æ®å¼‚æ­¥è½åœ°åˆ°ä¸´æ—¶ rdb æ–‡ä»¶ï¼ŒæˆåŠŸå­˜å‚¨åï¼Œä¸´æ—¶æ–‡ä»¶è¦†ç›–åŸæœ‰æ–‡ä»¶ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* flags on the purpose of rdb save or load */</span>
<span class="cp">#define RDBFLAGS_NONE 0
#define RDBFLAGS_AOF_PREAMBLE (1&lt;&lt;0)
#define RDBFLAGS_REPLICATION (1&lt;&lt;1)
#define REDIS_AUTOSYNC_BYTES (1024*1024*32) </span><span class="cm">/* fdatasync every 32MB */</span><span class="cp">
</span>
<span class="c1">// ä¸»è¿›ç¨‹ fork å­è¿›ç¨‹å­˜ç›˜</span>
<span class="kt">int</span> <span class="nf">rdbSaveBackground</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">redisFork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="cm">/* Child */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">rdbSave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">rsi</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// å†…å­˜æ•°æ® -&gt; ä¸´æ—¶ rdb æ–‡ä»¶ -&gt; è¦†ç›–åŸ rdb æ–‡ä»¶</span>
<span class="kt">int</span> <span class="nf">rdbSave</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆå§‹åŒ– rdb æ–‡ä»¶ç»“æ„</span>
    <span class="n">rioInitWithFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdb</span><span class="p">,</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">startSaving</span><span class="p">(</span><span class="n">RDBFLAGS_NONE</span><span class="p">);</span>

    <span class="c1">// å†™æ–‡ä»¶ç¼“å­˜ï¼Œç¼“å­˜æ»¡ REDIS_AUTOSYNC_BYTESï¼Œç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_save_incremental_fsync</span><span class="p">)</span>
        <span class="n">rioSetAutoSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdb</span><span class="p">,</span><span class="n">REDIS_AUTOSYNC_BYTES</span><span class="p">);</span>

    <span class="c1">// å°†å†…å­˜æ•°æ®å†™å…¥ rio æ–‡ä»¶</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span><span class="n">RDBFLAGS_NONE</span><span class="p">,</span><span class="n">rsi</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* fflush æ˜¯ libc æä¾›çš„æ–¹æ³•ï¼Œè°ƒç”¨ write å‡½æ•°å†™åˆ°ç£ç›˜[å…¶å®æ˜¯å†™åˆ°å†…æ ¸çš„ç¼“å†²åŒº]ã€‚
     * fsync æ˜¯ç³»ç»Ÿæä¾›çš„ç³»ç»Ÿè°ƒç”¨ï¼ŒæŠŠå†…æ ¸ç¼“å†²åˆ·åˆ°ç£ç›˜ä¸Šã€‚*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fflush</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fsync</span><span class="p">(</span><span class="n">fileno</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{...}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="2-é€æ­¥æŒä¹…åŒ–">2. é€æ­¥æŒä¹…åŒ–</h2>

<p>å†…å­˜å¯ä»¥é€æ­¥æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œç¼“å­˜æ»¡ REDIS_AUTOSYNC_BYTES ï¼ˆ32MBï¼‰ï¼Œç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜ã€‚è¿™æ ·å°†å¤§æ•°æ®åˆ†æ•£å¼€æ¥ï¼Œå‡å°‘ç³»ç»Ÿå‹åŠ›ï¼Œé¿å…ä¸€æ¬¡å†™ç›˜å¸¦æ¥çš„é—®é¢˜ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
rdb-save-incremental-fsync <span class="nb">yes</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">rioSetAutoSync</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">bytes</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">!=</span> <span class="n">rioFileIO</span><span class="p">.</span><span class="n">write</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">autosync</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span> <span class="nf">rioFileWrite</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">retval</span><span class="p">;</span>

    <span class="n">retval</span> <span class="o">=</span> <span class="n">fwrite</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">buffered</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">autosync</span> <span class="o">&amp;&amp;</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">buffered</span> <span class="o">&gt;=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">autosync</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fflush</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">fp</span><span class="p">);</span>
        <span class="n">redis_fsync</span><span class="p">(</span><span class="n">fileno</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">fp</span><span class="p">));</span>
        <span class="n">r</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">.</span><span class="n">file</span><span class="p">.</span><span class="n">buffered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-ç»“æ„">3. ç»“æ„</h2>

<p>ç²—ç•¥å°† rdb æ–‡ä»¶çš„ç»“æ„å…ƒç´ æ·»åŠ åˆ°å›¾è¡¨ï¼Œå¯ä»¥çœ‹ä½œæ˜¯â€œä¼ªä»£ç â€å§ï¼Œæœ‰äº›å…ƒç´ æ˜¯å»ºç«‹åœ¨ä¸€å®šæ¡ä»¶ä¸‹æ‰ä¼šæ·»åŠ è¿›å»ã€‚</p>

<p><img src="/images/2020-03-19-13-57-01.png" alt="rdb æ–‡ä»¶ç»“æ„" data-action="zoom" /></p>

<blockquote>
  <p>æœ‰å…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¸–å­ï¼š<a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a>ï¼Œä¸‹ä¸ªæ–­ç‚¹ï¼Œèµ°ä¸€ä¸‹ redis ä¿å­˜å’ŒåŠ è½½ rdb æ–‡ä»¶çš„å·¥ä½œæµç¨‹ã€‚</p>
</blockquote>

<hr />

<h3 id="31-æ•°æ®ä¿å­˜æ—¶åº">3.1. æ•°æ®ä¿å­˜æ—¶åº</h3>

<p>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹åˆ° rdb æ–‡ä»¶çš„ç»“æ„ã€‚æ•´ä¸ªæ–‡ä»¶æ˜¯ç”±ä¸åŒç±»å‹çš„æ•°æ®å•å…ƒç»„æˆçš„(<code class="highlighter-rouge">type + value</code>) ã€‚å†…å­˜æŒä¹…åŒ–ä¸º rdb æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒ <code class="highlighter-rouge">rdbSaveRio</code>ã€‚</p>

<blockquote>
  <p>redis åŠ è½½ rdb æ–‡ä»¶æ—¶ï¼ˆ<code class="highlighter-rouge">rdbLoadRio</code>ï¼‰ï¼Œä¹Ÿæ˜¯å…ˆè¯»å‡ºæ•°æ®ç±»å‹ (<code class="highlighter-rouge">type</code>)ï¼Œå†æ ¹æ®æ•°æ®ç±»å‹ï¼ŒåŠ è½½å¯¹åº”çš„æ•°æ®â€”â€”è¿™æ ·é¡ºåºå°† rdb æ–‡ä»¶æ•°æ®åŠ è½½åˆ°å†…å­˜ã€‚</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Produces a dump of the database in RDB format sending it to the specified
 * Redis I/O channel. */</span>
<span class="kt">int</span> <span class="nf">rdbSaveRio</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">error</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rdbflags</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">magic</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">magic</span><span class="p">),</span><span class="s">"REDIS%04d"</span><span class="p">,</span><span class="n">RDB_VERSION</span><span class="p">);</span>
    <span class="c1">// å†™å…¥ rdb ç‰ˆæœ¬å·</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbWriteRaw</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">magic</span><span class="p">,</span><span class="mi">9</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="c1">// å†™å…¥ redis å±æ€§ä¿¡æ¯</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveInfoAuxFields</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">rdbflags</span><span class="p">,</span><span class="n">rsi</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="c1">// å†™å…¥æ‰©å±•æ’ä»¶â€˜beforeâ€™æ•°æ®</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveModulesAux</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span> <span class="n">REDISMODULE_AUX_BEFORE_RDB</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// éå†æ•°æ®åº“ï¼Œè½åœ°æ•°æ®ã€‚</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">db</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>
        <span class="n">dict</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dictSize</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetSafeIterator</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

        <span class="c1">// ä¿å­˜æ•°æ®åº“ id</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_SELECTDB</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveLen</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

        <span class="c1">// ä¿å­˜æ•°æ®åº“å­—å…¸å¤§å°ï¼ˆdb-&gt;dictï¼‰ï¼Œè¿‡æœŸå­—å…¸å¤§å°ï¼ˆdb-&gt;expiresï¼‰ã€‚</span>
        <span class="kt">uint64_t</span> <span class="n">db_size</span><span class="p">,</span> <span class="n">expires_size</span><span class="p">;</span>
        <span class="n">db_size</span> <span class="o">=</span> <span class="n">dictSize</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">);</span>
        <span class="n">expires_size</span> <span class="o">=</span> <span class="n">dictSize</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_RESIZEDB</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveLen</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">db_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveLen</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">expires_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

        <span class="c1">// éå†æ•°æ®åº“æ•°æ®ã€‚</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sds</span> <span class="n">keystr</span> <span class="o">=</span> <span class="n">dictGetKey</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="n">robj</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">o</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="kt">long</span> <span class="kt">long</span> <span class="n">expire</span><span class="p">;</span>

            <span class="n">initStaticStringObject</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">keystr</span><span class="p">);</span>
            <span class="n">expire</span> <span class="o">=</span> <span class="n">getExpire</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
            <span class="c1">// ä¿å­˜ keyï¼Œvalueï¼Œexpireã€‚</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveKeyValuePair</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">key</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">expire</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

            <span class="cm">/* When this RDB is produced as part of an AOF rewrite, move
             * accumulated diff from parent to child while rewriting in
             * order to have a smaller final write. */</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rdbflags</span> <span class="o">&amp;</span> <span class="n">RDBFLAGS_AOF_PREAMBLE</span> <span class="o">&amp;&amp;</span>
                <span class="n">rdb</span><span class="o">-&gt;</span><span class="n">processed_bytes</span> <span class="o">&gt;</span> <span class="n">processed</span><span class="o">+</span><span class="n">AOF_READ_DIFF_INTERVAL_BYTES</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">processed</span> <span class="o">=</span> <span class="n">rdb</span><span class="o">-&gt;</span><span class="n">processed_bytes</span><span class="p">;</span>
                <span class="n">aofReadDiffFromParent</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
        <span class="n">di</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* So that we don't release it again on error. */</span>
    <span class="p">}</span>

    <span class="cm">/* If we are storing the replication information on disk, persist
     * the script cache as well: on successful PSYNC after a restart, we need
     * to be able to process any EVALSHA inside the replication backlog the
     * master will send us. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rsi</span> <span class="o">&amp;&amp;</span> <span class="n">dictSize</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">lua_scripts</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">di</span> <span class="o">=</span> <span class="n">dictGetIterator</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">lua_scripts</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictNext</span><span class="p">(</span><span class="n">di</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">robj</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxField</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"lua"</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">dictReleaseIterator</span><span class="p">(</span><span class="n">di</span><span class="p">);</span>
        <span class="n">di</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* So that we don't release it again on error. */</span>
    <span class="p">}</span>

    <span class="c1">// å†™å…¥æ‰©å±•æ’ä»¶â€˜afterâ€™æ•°æ®ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveModulesAux</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span> <span class="n">REDISMODULE_AUX_AFTER_RDB</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// ä¿å­˜ rdb æ–‡ä»¶ç»“æŸç¬¦ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_EOF</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// å†™å…¥ crc64 æ£€éªŒç ã€‚</span>
    <span class="n">cksum</span> <span class="o">=</span> <span class="n">rdb</span><span class="o">-&gt;</span><span class="n">cksum</span><span class="p">;</span>
    <span class="n">memrev64ifbe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cksum</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rioWrite</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cksum</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="32-ä¿å­˜é›†ç¾¤å¤åˆ¶ä¿¡æ¯">3.2. ä¿å­˜é›†ç¾¤å¤åˆ¶ä¿¡æ¯</h3>

<p>rdb å®ç°é™„åŠ åŠŸèƒ½ï¼Œä¿å­˜æœåŠ¡æ•°æ®å¤åˆ¶çš„ç›¸å…³ä¿¡æ¯ã€‚å½“æœåŠ¡åœ¨æŸäº›æ•°æ®å¤åˆ¶åœºæ™¯ä¸‹ï¼Œéœ€è¦ redis è¿›ç¨‹çš„å†…å­˜å¤åˆ¶ idï¼Œå¤åˆ¶ä½ç½®ï¼Œå¯ä»¥ç›´æ¥ä¿å­˜åœ¨ rdb ä¸­ï¼Œå³ä¾¿redis æœåŠ¡é‡å¯æˆ–è€…æœåŠ¡è§’è‰²å‘ç”Ÿè½¬ç§»(ç”±ä¸»æœåŠ¡å˜æˆä»æœåŠ¡)ï¼Œä¹Ÿå¯ä»¥ä» rdb æ–‡ä»¶ä¸­ï¼Œè·å¾—ç›¸åº”çš„å¤åˆ¶æ•°æ®ä¿¡æ¯ï¼Œä¸è‡³äºä»€ä¹ˆä¿¡æ¯éƒ½æ²¡æœ‰ï¼Œéœ€è¦é‡æ–°å…¨é‡åŒæ­¥ã€‚</p>

<hr />

<p>å¯ä»¥å‚è€ƒ redis è¿™ä¸¤ä¸ªæºç æ”¹åŠ¨ï¼š</p>

<ul>
  <li><a href="https://github.com/antirez/redis/commit/28c96d73b2e157a37465560bc421280d17005708?diff=unified">PSYNC2: Save replication ID/offset on RDB file.</a></li>
  <li><a href="https://github.com/antirez/redis/commit/2669fb8364c4c4080b7b75809ca94fc8022151de?diff=unified">PSYNC2: different improvements to Redis replication.</a></li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* This structure can be optionally passed to RDB save/load functions in
 * order to implement additional functionalities, by storing and loading
 * metadata to the RDB file.
 *
 * Currently the only use is to select a DB at load time, useful in
 * replication in order to make sure that chained slaves (slaves of slaves)
 * select the correct DB and are able to accept the stream coming from the
 * top-level master. */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">rdbSaveInfo</span> <span class="p">{</span>
    <span class="cm">/* Used saving and loading. */</span>
    <span class="kt">int</span> <span class="n">repl_stream_db</span><span class="p">;</span>  <span class="cm">/* DB to select in server.master client. */</span>

    <span class="cm">/* Used only loading. */</span>
    <span class="kt">int</span> <span class="n">repl_id_is_set</span><span class="p">;</span>  <span class="cm">/* True if repl_id field is set. */</span>
    <span class="kt">char</span> <span class="n">repl_id</span><span class="p">[</span><span class="n">CONFIG_RUN_ID_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>     <span class="cm">/* Replication ID. */</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">repl_offset</span><span class="p">;</span>                  <span class="cm">/* Replication offset. */</span>
<span class="p">}</span> <span class="n">rdbSaveInfo</span><span class="p">;</span>

<span class="c1">// ä¿å­˜å¤åˆ¶å‰¯æœ¬ç›¸å…³ä¿¡æ¯ã€‚</span>
<span class="kt">int</span> <span class="nf">rdbSaveInfoAuxFields</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rdbflags</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-stream-db"</span><span class="p">,</span><span class="n">rsi</span><span class="o">-&gt;</span><span class="n">repl_stream_db</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrStr</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-id"</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">replid</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-offset"</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">master_repl_offset</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="33-ä¿å­˜å±æ€§ä¿¡æ¯">3.3. ä¿å­˜å±æ€§ä¿¡æ¯</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å†™å…¥ redis å±æ€§ä¿¡æ¯</span>
<span class="kt">int</span> <span class="nf">rdbSaveInfoAuxFields</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rdbflags</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">redis_bits</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">aof_preamble</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdbflags</span> <span class="o">&amp;</span> <span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/* Add a few fields about the state when the RDB was created. */</span>
    <span class="c1">// å†™å…¥ redis ç‰ˆæœ¬å·</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrStr</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"redis-ver"</span><span class="p">,</span><span class="n">REDIS_VERSION</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// å†™å…¥redis å·¥ä½œçš„æœºå™¨å¤šå°‘ä½ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"redis-bits"</span><span class="p">,</span><span class="n">redis_bits</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// rdb å†™å…¥æ•°æ®æ—¶é—´</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"ctime"</span><span class="p">,</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// å½“å‰ä½¿ç”¨å†…å­˜å¤§å°</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"used-mem"</span><span class="p">,</span><span class="n">zmalloc_used_memory</span><span class="p">())</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="c1">// å­˜å‚¨ä»åº“ä¿¡æ¯ï¼Œæ–¹ä¾¿ (slaves of slaves) æ•°æ®åŒæ­¥</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-stream-db"</span><span class="p">,</span><span class="n">rsi</span><span class="o">-&gt;</span><span class="n">repl_stream_db</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrStr</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-id"</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">replid</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"repl-offset"</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">master_repl_offset</span><span class="p">)</span>
            <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"aof-preamble"</span><span class="p">,</span><span class="n">aof_preamble</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="34-ä¿å­˜-key-value">3.4. ä¿å­˜ key-value</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define RDB_OPCODE_IDLE          248   </span><span class="cm">/* LRU idle time. */</span><span class="cp">
#define RDB_OPCODE_FREQ          249   </span><span class="cm">/* LFU frequency. */</span><span class="cp">
#define RDB_OPCODE_AUX           250   </span><span class="cm">/* RDB aux field. */</span><span class="cp">
#define RDB_OPCODE_EXPIRETIME_MS 252   </span><span class="cm">/* Expire time in milliseconds. */</span><span class="cp">
</span>

<span class="cm">/* Save a key-value pair, with expire time, type, key, value.
 * On error -1 is returned.
 * On success if the key was actually saved 1 is returned, otherwise 0
 * is returned (the key was already expired). */</span>
<span class="kt">int</span> <span class="nf">rdbSaveKeyValuePair</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">expiretime</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">savelru</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory_policy</span> <span class="o">&amp;</span> <span class="n">MAXMEMORY_FLAG_LRU</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">savelfu</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">maxmemory_policy</span> <span class="o">&amp;</span> <span class="n">MAXMEMORY_FLAG_LFU</span><span class="p">;</span>

    <span class="c1">// ä¿å­˜æ•°æ®åˆ°æœŸæ—¶é—´ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">expiretime</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_EXPIRETIME_MS</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveMillisecondTime</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">expiretime</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¿å­˜æ•°æ® lru æ—¶é—´ï¼Œç²¾åº¦æ˜¯ç§’ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å­˜å‚¨çš„ç©ºé—´ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">savelru</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint64_t</span> <span class="n">idletime</span> <span class="o">=</span> <span class="n">estimateObjectIdleTime</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
        <span class="n">idletime</span> <span class="o">/=</span> <span class="mi">1000</span><span class="p">;</span> <span class="cm">/* Using seconds is enough and requires less space.*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_IDLE</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveLen</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">idletime</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¿å­˜æ•°æ®ä½¿ç”¨é¢‘ç‡ä¿¡æ¯ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">savelfu</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LFUDecrAndReturn</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
        <span class="c1">// ä½¿ç”¨é¢‘ç‡æ˜¯ä¸€ä¸ª 0 - 255 çš„è®¡æ•°ï¼Œåªç”¨ä¸€ä¸ªå­—èŠ‚ä¿å­˜å³å¯ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDB_OPCODE_FREQ</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbWriteRaw</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¿å­˜æ•°æ®ç±»å‹ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveObjectType</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// ä¿å­˜é”®æ•°æ®ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveStringObject</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// ä¿å­˜é”®å¯¹åº”æ•°æ®ä¿¡æ¯ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveObject</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ•°æ®å¯¹è±¡ï¼Œæ ¹æ®ä¸åŒçš„ç»“æ„ç±»å‹ï¼Œè¿›è¡Œä¿å­˜ã€‚</span>
<span class="kt">ssize_t</span> <span class="nf">rdbSaveObject</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">o</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_STRING</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_LIST</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_SET</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_ZSET</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_HASH</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_STREAM</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">OBJ_MODULE</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-å‚è€ƒ">4. å‚è€ƒ</h2>

<ul>
  <li><a href="https://github.com/menwengit/redis_source_annotation">redis 3.2.8 çš„æºç æ³¨é‡Š</a></li>
  <li><a href="https://blog.csdn.net/mishifangxiangdefeng/article/details/50032357">redisé…ç½®æ–‡ä»¶æ ·ä¾‹(äºŒ)</a></li>
  <li><a href="https://github.com/sripathikrishnan/redis-rdb-tools/wiki/Redis-RDB-Dump-File-Format">Redis RDB Dump File Format</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
