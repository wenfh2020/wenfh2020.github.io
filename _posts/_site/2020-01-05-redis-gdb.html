<p>可以通过 gdb / vscode 调试 redis 源码，理解 redis 工作流程。</p>

<ul id="markdown-toc">
  <li><a href="#1-视频" id="markdown-toc-1-视频">1. 视频</a></li>
  <li><a href="#2-gdb-常用命令" id="markdown-toc-2-gdb-常用命令">2. gdb 常用命令</a></li>
  <li><a href="#3-安装编译-redis" id="markdown-toc-3-安装编译-redis">3. 安装编译 redis</a></li>
  <li><a href="#4-gdb-调试流程" id="markdown-toc-4-gdb-调试流程">4. gdb 调试流程</a></li>
  <li><a href="#5-vscode-调试流程" id="markdown-toc-5-vscode-调试流程">5. vscode 调试流程</a>    <ul>
      <li><a href="#51-启动-vscode" id="markdown-toc-51-启动-vscode">5.1. 启动 vscode</a></li>
      <li><a href="#52-vscode-项目配置" id="markdown-toc-52-vscode-项目配置">5.2. vscode 项目配置</a></li>
      <li><a href="#53-vscode-调试" id="markdown-toc-53-vscode-调试">5.3. vscode 调试</a></li>
    </ul>
  </li>
  <li><a href="#6-参考" id="markdown-toc-6-参考">6. 参考</a></li>
</ul>

<hr />

<h2 id="1-视频">1. 视频</h2>

<ul>
  <li>bilibili  (<a href="https://www.bilibili.com/video/av83070640">Debug Redis in VsCode with Gdb</a>)</li>
  <li>youtube (<a href="https://www.youtube.com/watch?v=QltK3vV5Slw">Debug Redis in VsCode with Gdb</a> )</li>
  <li>对应操作文档： <a href="https://github.com/wenfh2020/youtobe/blob/master/redis-debug.md">github</a></li>
</ul>

<hr />

<h2 id="2-gdb-常用命令">2. gdb 常用命令</h2>

<p>详细文档通过命令 <code class="highlighter-rouge">man gdb</code> 查看。</p>

<table>
  <thead>
    <tr>
      <th>命令</th>
      <th>操作</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>r</td>
      <td>运行调试</td>
    </tr>
    <tr>
      <td>n</td>
      <td>下一步</td>
    </tr>
    <tr>
      <td>c</td>
      <td>继续运行</td>
    </tr>
    <tr>
      <td>ctrl + c</td>
      <td>中断信号</td>
    </tr>
    <tr>
      <td>c/continue</td>
      <td>中断后继续运行</td>
    </tr>
    <tr>
      <td>s</td>
      <td>进入一个函数</td>
    </tr>
    <tr>
      <td>finish</td>
      <td>退出函数</td>
    </tr>
    <tr>
      <td>l</td>
      <td>列出代码行</td>
    </tr>
    <tr>
      <td>b</td>
      <td>断点<br />显示断点列表 info b<br />删除断点 delete number<br />清除断点 clear</td>
    </tr>
    <tr>
      <td>n</td>
      <td>下一步</td>
    </tr>
    <tr>
      <td>until</td>
      <td>跳至行号<br />until <number></number></td>
    </tr>
    <tr>
      <td>p</td>
      <td>打印<br />打印数组信息 p *array@len<br />p/x 按十六进制格式显示变量</td>
    </tr>
    <tr>
      <td>bt/backtrace</td>
      <td>堆栈bt &lt;-n&gt;<br />-n表一个负整数，表示只打印栈底下n层的栈信息。</td>
    </tr>
    <tr>
      <td>f/frame</td>
      <td>进入指定堆栈层<br /> f <number></number></td>
    </tr>
    <tr>
      <td>thread apply all bt</td>
      <td>显示线程所有堆栈</td>
    </tr>
    <tr>
      <td>attach</td>
      <td>绑定进程调试<br />attach &lt;-p pid&gt;</td>
    </tr>
    <tr>
      <td>detach</td>
      <td>取消绑定调试进程</td>
    </tr>
    <tr>
      <td>disassemble</td>
      <td>看二进制数据<br />disassemble <func></func></td>
    </tr>
    <tr>
      <td>x</td>
      <td>查看内存</td>
    </tr>
    <tr>
      <td>focus</td>
      <td>显示源码界面</td>
    </tr>
    <tr>
      <td>display</td>
      <td>显示变量</td>
    </tr>
    <tr>
      <td>info registers</td>
      <td>查看寄存器</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-安装编译-redis">3. 安装编译 redis</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget http://download.redis.io/releases/redis-3.2.8.tar.gz
<span class="nb">tar </span>xzf redis-3.2.8.tar.gz
<span class="nb">cd </span>redis-3.2.8
</code></pre></div></div>

<p>更新 Makefile，修改相应编译项</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim src/Makefile
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># OPTIMIZATION?=-O2</span>
OPTIMIZATION?<span class="o">=</span><span class="nt">-O0</span>
<span class="c"># REDIS_LD=$(QUIET_LINK)$(CC) $(FINAL_LDFLAGS)</span>
<span class="nv">REDIS_LD</span><span class="o">=</span><span class="si">$(</span>QUIET_LINK<span class="si">)$(</span>CC<span class="si">)</span> <span class="si">$(</span>FINAL_LDFLAGS<span class="si">)</span> <span class="si">$(</span>OPTIMIZATION<span class="si">)</span>
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make clean<span class="p">;</span> make
</code></pre></div></div>

<hr />

<h2 id="4-gdb-调试流程">4. gdb 调试流程</h2>

<table>
  <thead>
    <tr>
      <th>步骤</th>
      <th>命令</th>
      <th>描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>sudo gdb –args ./src/redis-server redis.conf</td>
      <td>启动调试</td>
    </tr>
    <tr>
      <td>2</td>
      <td>r</td>
      <td>运行程序</td>
    </tr>
    <tr>
      <td>3</td>
      <td>ctrl + c（键盘操作）</td>
      <td>中断程序</td>
    </tr>
    <tr>
      <td>4</td>
      <td>b dict.c:dictAdd</td>
      <td>对应代码下断点</td>
    </tr>
    <tr>
      <td>5</td>
      <td>c</td>
      <td>继续运行程序</td>
    </tr>
    <tr>
      <td>6</td>
      <td>redis-cli<br />set k5 v5</td>
      <td>启动 client 连接redis-server测试（redis 默认端口 6379）</td>
    </tr>
    <tr>
      <td>7</td>
      <td>focus</td>
      <td>进入源码窗口调试</td>
    </tr>
    <tr>
      <td>8</td>
      <td>bt</td>
      <td>程序堆栈(查看接口调用流程)</td>
    </tr>
    <tr>
      <td>9</td>
      <td>f 0</td>
      <td>进入堆栈第 0 层</td>
    </tr>
    <tr>
      <td>10</td>
      <td>n</td>
      <td>单步调试</td>
    </tr>
  </tbody>
</table>

<p><img src="/images/2020-02-20-16-51-07.png" alt="命令窗口调试" data-action="zoom" /></p>

<p><img src="/images/2020-02-20-16-51-21.png" alt="源码窗口调试" data-action="zoom" /></p>

<h2 id="5-vscode-调试流程">5. vscode 调试流程</h2>

<h3 id="51-启动-vscode">5.1. 启动 vscode</h3>

<p>因为 gdb 在 macOS 下需要 sudo 提升权限，vscode 配置貌似没有这个选项设置。所以只能用下面这个命令启动 vscode 项目</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis 源码本地目录</span>
<span class="nb">cd</span> ~/src/other/redis-3.2.8

<span class="c">#  vscode 打开 redis 源码目录</span>
<span class="nb">sudo </span>code <span class="nt">--user-data-dir</span><span class="o">=</span><span class="s2">"~/.vscode-root"</span> <span class="nb">.</span>
</code></pre></div></div>

<h3 id="52-vscode-项目配置">5.2. vscode 项目配置</h3>

<ul>
  <li>launch.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"0.2.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"configurations"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gcc build and debug active file"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"cppdbg"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"request"</span><span class="p">:</span><span class="w"> </span><span class="s2">"launch"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"program"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}/src/redis-server"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                </span><span class="s2">"redis.conf"</span><span class="w">
            </span><span class="p">],</span><span class="w">
            </span><span class="nl">"stopAtEntry"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
            </span><span class="nl">"cwd"</span><span class="p">:</span><span class="w"> </span><span class="s2">"${workspaceFolder}"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"environment"</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span><span class="w">
            </span><span class="nl">"externalConsole"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
            </span><span class="nl">"MIMode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gdb"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"preLaunchTask"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<ul>
  <li>tasks.json</li>
</ul>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="nl">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2.0.0"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"tasks"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="nl">"label"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"command"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/usr/bin/make"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="53-vscode-调试">5.3. vscode 调试</h3>

<p><img src="/images/2020-02-20-16-51-48.png" alt="调试" data-action="zoom" /></p>

<hr />

<h2 id="6-参考">6. 参考</h2>

<ul>
  <li><a href="https://blog.csdn.net/men_wen/article/details/75220102">gdb 调试工具 — 使用方法浅析</a></li>
  <li><a href="https://blog.csdn.net/suxinpingtao51/article/details/12072559">Linux中gdb 查看core堆栈信息</a></li>
  <li><a href="https://www.jianshu.com/p/692d1cd27e9b">linux上用gdb调试redis源码</a></li>
</ul>

<hr />

<blockquote>
  <p>🔥文章来源：<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
