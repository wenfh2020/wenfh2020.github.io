<p>redis æœåŠ¡åº•å±‚é‡‡ç”¨äº†<code class="highlighter-rouge">å¼‚æ­¥äº‹ä»¶</code>ç®¡ç†ï¼ˆ<code class="highlighter-rouge">aeEventLoop</code>ï¼‰ï¼šç®¡ç†æ—¶é—´äº‹ä»¶å’Œæ–‡ä»¶äº‹ä»¶ã€‚å¯¹äºå¤§é‡ç½‘ç»œæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰çš„äº‹ä»¶ç®¡ç†ï¼Œredis å»ºç«‹åœ¨å®‰è£…ç³»ç»Ÿå¯¹åº”çš„äº‹ä»¶é©±åŠ¨åŸºç¡€ä¸Šï¼ˆä¾‹å¦‚ Linux çš„ <code class="highlighter-rouge">epoll</code>ï¼‰ã€‚</p>

<blockquote>
  <ul>
    <li>å…³äºäº‹ä»¶é©±åŠ¨ï¼Œæœ¬ç« ä¸»è¦è®²è¿° Linux ç³»ç»Ÿçš„ epoll äº‹ä»¶é©±åŠ¨ã€‚</li>
    <li>å…³äºäº‹ä»¶å¤„ç†ï¼Œæœ¬ç« ä¸»è¦è®²è¿°æ–‡ä»¶äº‹ä»¶ï¼Œæ—¶é—´äº‹ä»¶å¯ä»¥å‚è€ƒå¸–å­ <a href="https://wenfh2020.com/2020/04/06/ae-timer/">[redis æºç èµ°è¯»] äº‹ä»¶ - å®šæ—¶å™¨</a>ã€‚</li>
  </ul>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-äº‹ä»¶é©±åŠ¨" id="markdown-toc-1-äº‹ä»¶é©±åŠ¨">1. äº‹ä»¶é©±åŠ¨</a></li>
  <li><a href="#2-å¼‚æ­¥äº‹ä»¶ç®¡ç†" id="markdown-toc-2-å¼‚æ­¥äº‹ä»¶ç®¡ç†">2. å¼‚æ­¥äº‹ä»¶ç®¡ç†</a>    <ul>
      <li><a href="#21-æ•°æ®ç»“æ„" id="markdown-toc-21-æ•°æ®ç»“æ„">2.1. æ•°æ®ç»“æ„</a></li>
      <li><a href="#22-åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡" id="markdown-toc-22-åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡">2.2. åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡</a></li>
      <li><a href="#23-äº‹ä»¶å¤„ç†æµç¨‹" id="markdown-toc-23-äº‹ä»¶å¤„ç†æµç¨‹">2.3. äº‹ä»¶å¤„ç†æµç¨‹</a></li>
      <li><a href="#24-äº‹ä»¶å¤„ç†é€»è¾‘" id="markdown-toc-24-äº‹ä»¶å¤„ç†é€»è¾‘">2.4. äº‹ä»¶å¤„ç†é€»è¾‘</a></li>
      <li><a href="#25-è·å–å¾…å¤„ç†äº‹ä»¶" id="markdown-toc-25-è·å–å¾…å¤„ç†äº‹ä»¶">2.5. è·å–å¾…å¤„ç†äº‹ä»¶</a></li>
    </ul>
  </li>
  <li><a href="#3-æ€»ç»“" id="markdown-toc-3-æ€»ç»“">3. æ€»ç»“</a></li>
  <li><a href="#4-å‚è€ƒ" id="markdown-toc-4-å‚è€ƒ">4. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-äº‹ä»¶é©±åŠ¨">1. äº‹ä»¶é©±åŠ¨</h2>

<p>redis æ ¹æ®å®‰è£…ç³»ç»Ÿé€‰æ‹©å¯¹åº”çš„äº‹ä»¶é©±åŠ¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae.c</span>
<span class="cm">/* Include the best multiplexing layer supported by this system.
 * The following should be ordered by performances, descending. */</span>
<span class="cp">#ifdef HAVE_EVPORT
#include "ae_evport.c"
#else
</span>    <span class="cp">#ifdef HAVE_EPOLL
</span>    <span class="cp">#include "ae_epoll.c"
</span>    <span class="cp">#else
</span>        <span class="cp">#ifdef HAVE_KQUEUE
</span>        <span class="cp">#include "ae_kqueue.c"
</span>        <span class="cp">#else
</span>        <span class="cp">#include "ae_select.c"
</span>        <span class="cp">#endif
</span>    <span class="cp">#endif
#endif
</span></code></pre></div></div>

<hr />

<h2 id="2-å¼‚æ­¥äº‹ä»¶ç®¡ç†">2. å¼‚æ­¥äº‹ä»¶ç®¡ç†</h2>

<p><code class="highlighter-rouge">epoll</code> æ˜¯å¼‚æ­¥äº‹ä»¶é©±åŠ¨ï¼Œä¸Šå±‚é€»è¾‘æ“ä½œå’Œä¸‹å±‚äº‹ä»¶é©±åŠ¨è¦é€šè¿‡ fd æ–‡ä»¶æè¿°ç¬¦ä¸²è”èµ·æ¥ã€‚å¼‚æ­¥äº‹ä»¶ç®¡ç†ï¼ˆ<code class="highlighter-rouge">aeEventLoop</code>ï¼‰ï¼Œå¯¹ epoll åšäº†ä¸€äº›å°è£…ï¼Œæ–¹ä¾¿å¼‚æ­¥äº‹ä»¶å›è°ƒå¤„ç†ã€‚</p>

<blockquote>
  <p>æœ‰å…³ epoll å·¥ä½œæµç¨‹ï¼Œå¯ä»¥å‚è€ƒæˆ‘çš„å¸–å­ï¼š<a href="https://wenfh2020.com/2020/04/14/epoll-workflow/">epoll å¤šè·¯å¤ç”¨ I/Oå·¥ä½œæµç¨‹</a></p>
</blockquote>

<p><img src="/images/2020-04-09-22-04-00.png" alt="redis æ–‡ä»¶äº‹ä»¶å°è£…" data-action="zoom" /></p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å±‚æ¬¡</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">ae.c</td>
      <td style="text-align: left">å…³è”å¼‚æ­¥ä¸šåŠ¡äº‹ä»¶å’Œ epoll æ¥å£ï¼Œå¤„ç† fd å¯¹åº”äº‹ä»¶é€»è¾‘ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ae_epoll.c</td>
      <td style="text-align: left">å¯¹ epoll æ¥å£è¿›è¡Œå°è£…ï¼Œæ–¹ä¾¿ä¸Šå±‚æ“ä½œã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">epoll</td>
      <td style="text-align: left">Linux å†…æ ¸å¤šè·¯å¤ç”¨ I/O æ¨¡å‹ï¼Œä¸»è¦ä¸ºäº†é«˜æ•ˆå¤„ç†å¤§æ‰¹é‡æ–‡ä»¶æè¿°ç¬¦äº‹ä»¶ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="21-æ•°æ®ç»“æ„">2.1. æ•°æ®ç»“æ„</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae.c</span>

<span class="c1">// æ–‡ä»¶äº‹ä»¶ç»“æ„</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeFileEvent</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span> <span class="c1">// äº‹ä»¶ç±»å‹ç»„åˆï¼ˆone of AE_(READABLE|WRITABLE|BARRIER)ï¼‰</span>
    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">rfileProc</span><span class="p">;</span> <span class="c1">// è¯»äº‹ä»¶å›è°ƒæ“ä½œã€‚</span>
    <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">wfileProc</span><span class="p">;</span> <span class="c1">// å†™äº‹ä»¶å›è°ƒæ“ä½œã€‚</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">;</span>      <span class="c1">// ä¸šåŠ¡ä¼ å…¥çš„ç§æœ‰æ•°æ®ã€‚æ–¹ä¾¿å›è°ƒä½¿ç”¨ã€‚</span>
<span class="p">}</span> <span class="n">aeFileEvent</span><span class="p">;</span>

<span class="c1">// å°±ç»ªäº‹ä»¶</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeFiredEvent</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>   <span class="c1">// æ–‡ä»¶æè¿°ç¬¦ã€‚</span>
    <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span> <span class="c1">// äº‹ä»¶ç±»å‹ç»„åˆã€‚</span>
<span class="p">}</span> <span class="n">aeFiredEvent</span><span class="p">;</span>

<span class="c1">// äº‹ä»¶ç®¡ç†ç»“æ„</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">maxfd</span><span class="p">;</span>   <span class="c1">// ç›‘æ§çš„æœ€å¤§æ–‡ä»¶æè¿°ç¬¦ã€‚</span>
    <span class="kt">int</span> <span class="n">setsize</span><span class="p">;</span> <span class="c1">// å¤„ç†æ–‡ä»¶æè¿°ç¬¦ä¸ªæ•°ã€‚</span>
    <span class="p">...</span>
    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span> <span class="c1">// æ ¹æ® fd ç›‘å¬äº‹ä»¶ã€‚</span>
    <span class="n">aeFiredEvent</span> <span class="o">*</span><span class="n">fired</span><span class="p">;</span> <span class="c1">// ä»å†…æ ¸å–å‡ºçš„å°±ç»ªäº‹ä»¶ã€‚</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ç»“æ„</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">aeEventLoop</td>
      <td style="text-align: left">æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ç®¡ç†ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">aeFileEvent</td>
      <td style="text-align: left">æ–‡ä»¶äº‹ä»¶ç»“æ„ï¼Œæ–¹ä¾¿å¼‚æ­¥å›è°ƒé€»è¾‘è°ƒç”¨ã€‚aeEventLoop ä¼šåˆ›å»ºä¸€ä¸ª aeFileEvent æ•°ç»„ï¼Œæ•°ç»„ä¸‹æ ‡æ˜¯ fdï¼Œfd å¯¹åº” aeFileEvent æ•°æ®ç»“æ„ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">aeFiredEvent</td>
      <td style="text-align: left">ä»å†…æ ¸è·å–çš„å°±ç»ªäº‹ä»¶ã€‚ï¼ˆä¾‹å¦‚ Linux ç³»ç»Ÿé€šè¿‡ epoll_wait æ¥å£è·å–å°±ç»ªäº‹ä»¶ï¼Œæ¯ä¸ªäº‹ä»¶åˆ†åˆ«å­˜å‚¨åœ¨ aeFiredEvent æ•°ç»„ä¸­ï¼‰</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="22-åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡">2.2. åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡</h3>

<p>åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡ï¼Œå¯¹ç›‘æ§çš„æ–‡ä»¶æ•°é‡è®¾ç½®äº†ä¸Šé™ã€‚</p>

<ul>
  <li>æ–‡ä»¶ç›‘æ§ä¸Šé™é…ç½®ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
<span class="c">#</span>
<span class="c"># Set the max number of connected clients at the same time. By default</span>
<span class="c"># this limit is set to 10000 clients, however if the Redis server is not</span>
<span class="c"># able to configure the process file limit to allow for the specified limit</span>
<span class="c"># the max number of allowed clients is set to the current file limit</span>
<span class="c"># minus 32 (as Redis reserves a few file descriptors for internal uses).</span>
<span class="c">#</span>
<span class="c"># Once the limit is reached Redis will close all the new connections sending</span>
<span class="c"># an error 'max number of clients reached'.</span>
<span class="c">#</span>
<span class="c"># maxclients 10000</span>
</code></pre></div></div>

<ul>
  <li>åˆ›å»ºäº‹ä»¶ç®¡ç†å¯¹è±¡ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define CONFIG_MIN_RESERVED_FDS 32
#define CONFIG_FDSET_INCR (CONFIG_MIN_RESERVED_FDS+96)
</span>
<span class="c1">// server.c</span>
<span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="n">aeCreateEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxclients</span><span class="o">+</span><span class="n">CONFIG_FDSET_INCR</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">initServer</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="23-äº‹ä»¶å¤„ç†æµç¨‹">2.3. äº‹ä»¶å¤„ç†æµç¨‹</h3>

<ul>
  <li>å¾ªç¯å¤„ç†äº‹ä»¶</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// server.c</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// ae.c</span>
<span class="c1">// å¾ªç¯å¤„ç†äº‹ä»¶</span>
<span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ·»åŠ äº‹ä»¶ï¼Œå…³è” fd äº‹ä»¶ä¸å¼‚æ­¥å›è°ƒç›¸å…³ä¿¡æ¯ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">aeCreateFileEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span>
        <span class="n">aeFileProc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">errno</span> <span class="o">=</span> <span class="n">ERANGE</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">AE_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>

    <span class="c1">// è°ƒç”¨åº•å±‚ epoll_ctl æ³¨å†Œäº‹ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aeApiAddEvent</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">mask</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AE_ERR</span><span class="p">;</span>
    <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
    <span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span> <span class="o">=</span> <span class="n">clientData</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span><span class="p">)</span>
        <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">AE_OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>åˆ é™¤äº‹ä»¶ï¼Œåˆ é™¤å¯¹åº” fd çš„äº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">aeDeleteFileEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&gt;=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">fd</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">==</span> <span class="n">AE_NONE</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// å¦‚æœåˆ é™¤çš„æ˜¯å†™äº‹ä»¶ï¼Œè¦æŠŠå†™äº‹ä»¶ä¼˜å…ˆå¤„ç†çš„äº‹ä»¶ä¹Ÿå»æ‰ï¼Œæ¢å¤ä¼˜å…ˆå¤„ç†è¯»äº‹ä»¶ï¼Œå†å¤„ç†å†™äº‹ä»¶é€»è¾‘ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_BARRIER</span><span class="p">;</span>

    <span class="c1">// è°ƒç”¨åº•å±‚ epoll_ctl ä¿®æ”¹åˆ é™¤äº‹ä»¶ã€‚</span>
    <span class="n">aeApiDelEvent</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
    <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">mask</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">==</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">==</span> <span class="n">AE_NONE</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Update the max fd */</span>
        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">--</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span> <span class="o">!=</span> <span class="n">AE_NONE</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">maxfd</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="24-äº‹ä»¶å¤„ç†é€»è¾‘">2.4. äº‹ä»¶å¤„ç†é€»è¾‘</h3>

<p>æ–‡ä»¶äº‹ä»¶å¤„ç†é€»è¾‘ï¼Œä»å†…æ ¸å–å‡ºå°±ç»ªäº‹ä»¶ï¼Œæ ¹æ®äº‹ä»¶çš„è¯»å†™ç±»å‹ï¼Œåˆ†åˆ«è¿›è¡Œå›è°ƒå¤„ç†ç›¸å…³ä¸šåŠ¡é€»è¾‘ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae.c</span>
<span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// å¤šè·¯å¤ç”¨æ¥å£ï¼Œä»å†…æ ¸å–å‡ºå°±ç»ªäº‹ä»¶ã€‚</span>
    <span class="n">numevents</span> <span class="o">=</span> <span class="n">aeApiPoll</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ ¹æ®å°±ç»ªäº‹ä»¶ fdï¼Œå–å‡ºå¯¹åº”çš„å¼‚æ­¥æ–‡ä»¶äº‹ä»¶è¿›è¡Œé€»è¾‘å¤„ç†ã€‚</span>
        <span class="n">aeFileEvent</span> <span class="o">*</span><span class="n">fe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">fired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Number of events fired for current fd. */</span>

        <span class="cm">/* AE_BARRIER è¡¨ç¤ºä¼˜å…ˆå¯å†™äº‹ä»¶ã€‚æ­£å¸¸æƒ…å†µï¼Œä¸€èˆ¬å…ˆè¯»åå†™ã€‚
         * AE_BARRIER ä½¿ç”¨åœºæ™¯ï¼Œæœ‰å…´è¶£çš„æœ‹å‹ï¼Œå¯ä»¥æŸ¥æ‰¾æºç å…³é”®å­—ï¼šCONN_FLAG_WRITE_BARRIER
         * ç†è§£è¿™éƒ¨åˆ†çš„é€»è¾‘ã€‚ */</span>
        <span class="kt">int</span> <span class="n">invert</span> <span class="o">=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_BARRIER</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
            <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_WRITABLE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
                <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">invert</span> <span class="o">&amp;&amp;</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="n">AE_READABLE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fired</span> <span class="o">||</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">wfileProc</span> <span class="o">!=</span> <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">fe</span><span class="o">-&gt;</span><span class="n">rfileProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="n">fe</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">,</span><span class="n">mask</span><span class="p">);</span>
                <span class="n">fired</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="25-è·å–å¾…å¤„ç†äº‹ä»¶">2.5. è·å–å¾…å¤„ç†äº‹ä»¶</h3>

<p>é€šè¿‡ <code class="highlighter-rouge">epoll_wait</code> ä»ç³»ç»Ÿå†…æ ¸å–å‡ºå°±ç»ªæ–‡ä»¶äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae_epoll.c</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">aeApiState</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">apidata</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">numevents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// ä»å†…æ ¸å–å‡ºå°±ç»ªæ–‡ä»¶äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">,</span>
            <span class="n">tvp</span> <span class="o">?</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

        <span class="n">numevents</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_READABLE</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="n">mask</span> <span class="o">|=</span> <span class="n">AE_WRITABLE</span><span class="o">|</span><span class="n">AE_READABLE</span><span class="p">;</span>

            <span class="c1">// å°±ç»ªäº‹ä»¶å’Œfdä¿å­˜åˆ° firedã€‚</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">;</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">fired</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">numevents</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>

<ul>
  <li>redis æ²¡æœ‰ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“ï¼Œå®ç°è·¨å¹³å°çš„å¼‚æ­¥äº‹ä»¶é©±åŠ¨ã€‚å¯¹æ–‡ä»¶äº‹ä»¶é©±åŠ¨å°è£…ä¹Ÿæ¯”è¾ƒç®€æ´é«˜æ•ˆã€‚</li>
</ul>

<hr />

<h2 id="4-å‚è€ƒ">4. å‚è€ƒ</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a></li>
  <li><a href="http://www.uml.org.cn/oobject/201104212.asp">UMLç±»å›¾ä¸ç±»çš„å…³ç³»è¯¦è§£</a></li>
  <li>ã€Šredis è®¾è®¡ä¸å®ç°ã€‹</li>
  <li><a href="https://ruby-china.org/topics/38957">Redis å¤šçº¿ç¨‹çš„ Redis</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/04/09/redis-ae-file/">wenfh2020.com</a></p>
</blockquote>
