<p>ç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹å¤±å»è”ç³»ã€‚ä¸»ä»èŠ‚ç‚¹æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿå¤šä¸ªä¸»æœåŠ¡ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-è§£å†³æ–¹æ¡ˆ" id="markdown-toc-1-è§£å†³æ–¹æ¡ˆ">1. è§£å†³æ–¹æ¡ˆ</a></li>
  <li><a href="#2-å®ç°æµç¨‹" id="markdown-toc-2-å®ç°æµç¨‹">2. å®ç°æµç¨‹</a></li>
  <li><a href="#3-å‚è€ƒ" id="markdown-toc-3-å‚è€ƒ">3. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-è§£å†³æ–¹æ¡ˆ">1. è§£å†³æ–¹æ¡ˆ</h2>

<p>æ¯”è¾ƒç®€å•çš„æ–¹æ¡ˆï¼Œä¿®æ”¹ redis é…ç½® <a href="https://github.com/antirez/redis/blob/unstable/redis.conf">redis.conf</a> :</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># master è‡³å°‘æœ‰ N ä¸ªå‰¯æœ¬è¿æ¥ã€‚</span>
min-slaves-to-write 3
<span class="c"># æ•°æ®å¤åˆ¶å’ŒåŒæ­¥çš„å»¶è¿Ÿä¸èƒ½è¶…è¿‡ M ç§’ã€‚</span>
min-slaves-max-lag 10
</code></pre></div></div>

<blockquote>
  <p><strong>æ³¨æ„ï¼šé«˜ç‰ˆæœ¬ redis å·²ç»ä¿®æ”¹è¿™ä¸ªä¸¤ä¸ªé€‰é¡¹</strong></p>

  <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># min-replicas-to-write 3</span>
<span class="c"># min-replicas-max-lag 10</span>
</code></pre></div>  </div>
</blockquote>

<hr />

<p>redis.conf ç›¸å…³è§£æ</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># It is possible for a master to stop accepting writes if there are less than</span>
<span class="c"># N slaves connected, having a lag less or equal than M seconds.</span>
<span class="c">#</span>
<span class="c"># The N slaves need to be in "online" state.</span>
<span class="c">#</span>
<span class="c"># The lag in seconds, that must be &lt;= the specified value, is calculated from</span>
<span class="c"># the last ping received from the slave, that is usually sent every second.</span>
<span class="c">#</span>
<span class="c"># This option does not GUARANTEE that N replicas will accept the write, but</span>
<span class="c"># will limit the window of exposure for lost writes in case not enough slaves</span>
<span class="c"># are available, to the specified number of seconds.</span>
<span class="c">#</span>
<span class="c"># For example to require at least 3 slaves with a lag &lt;= 10 seconds use:</span>
<span class="c">#</span>
<span class="c"># min-slaves-to-write 3</span>
<span class="c"># min-slaves-max-lag 10</span>
<span class="c">#</span>
<span class="c"># Setting one or the other to 0 disables the feature.</span>
<span class="c">#</span>
<span class="c"># By default min-slaves-to-write is set to 0 (feature disabled) and</span>
<span class="c"># min-slaves-max-lag is set to 10.</span>
</code></pre></div></div>

<hr />

<h2 id="2-å®ç°æµç¨‹">2. å®ç°æµç¨‹</h2>

<ul>
  <li>æ—¶é’Ÿå®šæœŸæ£€æŸ¥å‰¯æœ¬é“¾æ¥å¥åº·æƒ…å†µã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define run_with_period(_ms_) if ((_ms_ &lt;= 1000/server.hz) || !(server.cronloops%((_ms_)/(1000/server.hz))))
</span>
<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">run_with_period</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="n">replicationCron</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* Replication cron function, called 1 time per second. */</span>
<span class="c1">// å¤åˆ¶å‘¨æœŸæ‰§è¡Œçš„å‡½æ•°ï¼Œæ¯ç§’è°ƒç”¨1æ¬¡ã€‚</span>
<span class="kt">void</span> <span class="nf">replicationCron</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ›´æ–°å»¶è¿Ÿè‡³ lag å°äº min-slaves-max-lag çš„ä»æœåŠ¡å™¨æ•°é‡</span>
    <span class="n">refreshGoodSlavesCount</span><span class="p">();</span>
<span class="p">}</span>

<span class="cm">/* This function counts the number of slaves with lag &lt;= min-slaves-max-lag.
 * If the option is active, the server will prevent writes if there are not
 * enough connected slaves with the specified lag (or less). */</span>
<span class="c1">// æ›´æ–°å»¶è¿Ÿè‡³ lag å° äºmin-slaves-max-lag çš„ä»æœåŠ¡å™¨æ•°é‡</span>
<span class="kt">void</span> <span class="nf">refreshGoodSlavesCount</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">good</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// æ²¡è®¾ç½®é™åˆ¶åˆ™è¿”å›ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_to_write</span> <span class="o">||</span>
        <span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_max_lag</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">slaves</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="c1">// éå†æ‰€æœ‰çš„ä»èŠ‚ç‚¹ clientã€‚</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
        <span class="c1">// è®¡ç®—å»¶è¿Ÿå€¼</span>
        <span class="kt">time_t</span> <span class="n">lag</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">-</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">repl_ack_time</span><span class="p">;</span>

        <span class="c1">// è®¡æ•°å°äºå»¶è¿Ÿé™åˆ¶çš„ä¸ªæ•°ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">replstate</span> <span class="o">==</span> <span class="n">SLAVE_STATE_ONLINE</span> <span class="o">&amp;&amp;</span>
            <span class="n">lag</span> <span class="o">&lt;=</span> <span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_max_lag</span><span class="p">)</span> <span class="n">good</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">repl_good_slaves_count</span> <span class="o">=</span> <span class="n">good</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è¶…å‡ºé…ç½®èŒƒå›´ï¼Œmaster ç¦æ­¢å†™å‘½ä»¤ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">processCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* Don't accept write commands if there are not enough good slaves and
     * user configured the min-slaves-to-write option. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">masterhost</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_to_write</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_max_lag</span> <span class="o">&amp;&amp;</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_WRITE</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">repl_good_slaves_count</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">repl_min_slaves_to_write</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">flagTransaction</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">shared</span><span class="p">.</span><span class="n">noreplicaserr</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-å‚è€ƒ">3. å‚è€ƒ</h2>

<ul>
  <li><a href="https://redis.io/topics/replication">Replication</a></li>
  <li><a href="https://www.cnblogs.com/yjmyzz/p/redis-split-brain-analysis.html">redis è„‘è£‚ç­‰æç«¯æƒ…å†µåˆ†æ</a></li>
  <li><a href="https://github.com/menwengit/redis_source_annotation">redis 3.2.8 çš„æºç æ³¨é‡Š</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2019/12/27/redis-split-brain/">wenfh2020.com</a></p>
</blockquote>
