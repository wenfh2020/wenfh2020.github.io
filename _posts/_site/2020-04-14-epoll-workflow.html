<p>从业务逻辑上，了解一下 <code class="highlighter-rouge">epoll</code> 多路复用 I/O 的工作流程。</p>

<blockquote>
  <p>有兴趣了解 epoll 源码实现，可以参考： <a href="https://wenfh2020.com/2020/04/23/epoll-code/">[epoll 源码走读] epoll 实现原理</a></p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-epoll" id="markdown-toc-1-epoll">1. epoll</a>    <ul>
      <li><a href="#11-事件结构" id="markdown-toc-11-事件结构">1.1. 事件结构</a></li>
      <li><a href="#12-操作接口" id="markdown-toc-12-操作接口">1.2. 操作接口</a></li>
    </ul>
  </li>
  <li><a href="#2-服务器使用流程" id="markdown-toc-2-服务器使用流程">2. 服务器使用流程</a></li>
  <li><a href="#3-参考" id="markdown-toc-3-参考">3. 参考</a></li>
</ul>

<hr />

<h2 id="1-epoll">1. epoll</h2>

<p><code class="highlighter-rouge">epoll</code> 是一个 <code class="highlighter-rouge">Linux</code> 系统的一个事件驱动。简单点来说，是一个针对系统文件的事件管理器，可以高效管理大量网络链接下的数据并发。研发人员根据业务需要，通过事件管理器，监控对应文件描述符的读写事件。</p>

<blockquote>
  <p>详细的解析可以参考 <a href="https://baike.baidu.com/item/epoll/10738144?fr=aladdin">百度百科</a></p>
</blockquote>

<hr />

<h3 id="11-事件结构">1.1. 事件结构</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// epoll.h</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">epoll_data</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">u32</span><span class="p">;</span>
  <span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
<span class="p">}</span> <span class="n">epoll_data_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">epoll_event</span> <span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">events</span><span class="p">;</span>   <span class="c1">// epoll 事件</span>
  <span class="n">epoll_data_t</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// 用户数据</span>
<span class="p">}</span> <span class="n">__EPOLL_PACKED</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<table>
  <thead>
    <tr>
      <th style="text-align: left">epoll 事件</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">EPOLLIN</td>
      <td style="text-align: left">可读。</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLOUT</td>
      <td style="text-align: left">可写。</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLERR</td>
      <td style="text-align: left">该文件描述符发生错误。</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLHUP</td>
      <td style="text-align: left">该文件描述符被挂断。</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="12-操作接口">1.2. 操作接口</h3>

<ul>
  <li>创建 epoll 文件描述符。</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>epoll 事件注册函数。</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">op 操作事件</th>
      <th style="text-align: left">描述</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">EPOLL_CTL_ADD</td>
      <td style="text-align: left">注册新的 fd 到 epfd</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLL_CTL_MOD</td>
      <td style="text-align: left">修改已经注册的 fd 的监听事件</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLL_CTL_DEL</td>
      <td style="text-align: left">从 epfd 中删除一个 fd</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>等待事件发生。</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span><span class="o">*</span> <span class="n">events</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxevents</span><span class="p">.</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div>

<hr />

<h2 id="2-服务器使用流程">2. 服务器使用流程</h2>

<ul>
  <li>服务器创建非阻塞 socket（server_fd）。</li>
  <li><code class="highlighter-rouge">epoll_create</code> 创建 epoll 事件驱动 (epoll_fd)。</li>
  <li><code class="highlighter-rouge">epoll_ctl</code> 监控 server_fd 的可读事件 <code class="highlighter-rouge">EPOLLIN</code>。</li>
  <li>服务进程通过 <code class="highlighter-rouge">epoll_wait</code> 获取内核就绪事件处理。</li>
  <li>如果就绪事件是新连接，<code class="highlighter-rouge">accept</code> 为客户端新连接分配新的文件描述符 client_fd，设置非阻塞，然后 <code class="highlighter-rouge">epoll_ctl</code> 监控 client_fd 的可读事件 <code class="highlighter-rouge">EPOLLIN</code>。</li>
  <li>如果就绪事件不是新连接，<code class="highlighter-rouge">read</code> 读取客户端发送数据进行逻辑处理。</li>
  <li>处理逻辑过程中需要 <code class="highlighter-rouge">write</code> 回复客户端，<code class="highlighter-rouge">write</code> 内容很大，超出了内核缓冲区，没能实时发送完成所有数据，需要下次继续发送；那么 <code class="highlighter-rouge">epoll_ctl</code> 监控 client_fd 的 <code class="highlighter-rouge">EPOLLOUT</code> 可写事件，下次触发事件进行发送。下次触发可写事件发送完毕后， <code class="highlighter-rouge">epoll_ctl</code> 删除 <code class="highlighter-rouge">EPOLLOUT</code> 事件。</li>
  <li>客户端关闭链接，服务端监控客户端 fd，如果 <code class="highlighter-rouge">read == 0</code>，<code class="highlighter-rouge">close</code> 关闭对应 fd 从而完成四次挥手。</li>
</ul>

<p><img src="/images/2020-05-11-16-57-43.png" alt="epoll 使用流程" data-action="zoom" /></p>

<hr />

<h2 id="3-参考">3. 参考</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/04/23/epoll-code/">[epoll 源码走读] epoll 实现原理</a></li>
  <li><a href="http://man7.org/linux/man-pages/dir_all_by_section.html">http://man7.org/linux/man-pages/dir_all_by_section.html</a></li>
  <li><a href="http://man7.org/linux/man-pages/man2/write.2.html">http://man7.org/linux/man-pages/man2/write.2.html</a></li>
  <li><a href="http://man7.org/linux/man-pages/man2/read.2.html">http://man7.org/linux/man-pages/man2/read.2.html</a></li>
</ul>

<hr />

<blockquote>
  <p>🔥文章来源：<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
