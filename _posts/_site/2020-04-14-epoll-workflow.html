<p>ä»ä¸šåŠ¡é€»è¾‘ä¸Šï¼Œäº†è§£ä¸€ä¸‹ <code class="highlighter-rouge">epoll</code> å¤šè·¯å¤ç”¨ I/O çš„å·¥ä½œæµç¨‹ã€‚</p>

<blockquote>
  <p>æœ‰å…´è¶£äº†è§£ epoll æºç å®ç°ï¼Œå¯ä»¥å‚è€ƒï¼š <a href="https://wenfh2020.com/2020/04/23/epoll-code/">[epoll æºç èµ°è¯»] epoll å®ç°åŸç†</a></p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-epoll" id="markdown-toc-1-epoll">1. epoll</a>    <ul>
      <li><a href="#11-äº‹ä»¶ç»“æ„" id="markdown-toc-11-äº‹ä»¶ç»“æ„">1.1. äº‹ä»¶ç»“æ„</a></li>
      <li><a href="#12-æ“ä½œæ¥å£" id="markdown-toc-12-æ“ä½œæ¥å£">1.2. æ“ä½œæ¥å£</a></li>
    </ul>
  </li>
  <li><a href="#2-æœåŠ¡å™¨ä½¿ç”¨æµç¨‹" id="markdown-toc-2-æœåŠ¡å™¨ä½¿ç”¨æµç¨‹">2. æœåŠ¡å™¨ä½¿ç”¨æµç¨‹</a></li>
  <li><a href="#3-å‚è€ƒ" id="markdown-toc-3-å‚è€ƒ">3. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-epoll">1. epoll</h2>

<p><code class="highlighter-rouge">epoll</code> æ˜¯ä¸€ä¸ª <code class="highlighter-rouge">Linux</code> ç³»ç»Ÿçš„ä¸€ä¸ªäº‹ä»¶é©±åŠ¨ã€‚ç®€å•ç‚¹æ¥è¯´ï¼Œæ˜¯ä¸€ä¸ªé’ˆå¯¹ç³»ç»Ÿæ–‡ä»¶çš„äº‹ä»¶ç®¡ç†å™¨ï¼Œå¯ä»¥é«˜æ•ˆç®¡ç†å¤§é‡ç½‘ç»œé“¾æ¥ä¸‹çš„æ•°æ®å¹¶å‘ã€‚ç ”å‘äººå‘˜æ ¹æ®ä¸šåŠ¡éœ€è¦ï¼Œé€šè¿‡äº‹ä»¶ç®¡ç†å™¨ï¼Œç›‘æ§å¯¹åº”æ–‡ä»¶æè¿°ç¬¦çš„è¯»å†™äº‹ä»¶ã€‚</p>

<blockquote>
  <p>è¯¦ç»†çš„è§£æå¯ä»¥å‚è€ƒ <a href="https://baike.baidu.com/item/epoll/10738144?fr=aladdin">ç™¾åº¦ç™¾ç§‘</a></p>
</blockquote>

<hr />

<h3 id="11-äº‹ä»¶ç»“æ„">1.1. äº‹ä»¶ç»“æ„</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// epoll.h</span>
<span class="k">typedef</span> <span class="k">union</span> <span class="n">epoll_data</span> <span class="p">{</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
  <span class="kt">uint32_t</span> <span class="n">u32</span><span class="p">;</span>
  <span class="kt">uint64_t</span> <span class="n">u64</span><span class="p">;</span>
<span class="p">}</span> <span class="n">epoll_data_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">epoll_event</span> <span class="p">{</span>
  <span class="kt">uint32_t</span> <span class="n">events</span><span class="p">;</span>   <span class="c1">// epoll äº‹ä»¶</span>
  <span class="n">epoll_data_t</span> <span class="n">data</span><span class="p">;</span> <span class="c1">// ç”¨æˆ·æ•°æ®</span>
<span class="p">}</span> <span class="n">__EPOLL_PACKED</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<table>
  <thead>
    <tr>
      <th style="text-align: left">epoll äº‹ä»¶</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">EPOLLIN</td>
      <td style="text-align: left">å¯è¯»ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLOUT</td>
      <td style="text-align: left">å¯å†™ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLERR</td>
      <td style="text-align: left">è¯¥æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLHUP</td>
      <td style="text-align: left">è¯¥æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="12-æ“ä½œæ¥å£">1.2. æ“ä½œæ¥å£</h3>

<ul>
  <li>åˆ›å»º epoll æ–‡ä»¶æè¿°ç¬¦ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>epoll äº‹ä»¶æ³¨å†Œå‡½æ•°ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">event</span><span class="p">);</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">op æ“ä½œäº‹ä»¶</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">EPOLL_CTL_ADD</td>
      <td style="text-align: left">æ³¨å†Œæ–°çš„ fd åˆ° epfd</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLL_CTL_MOD</td>
      <td style="text-align: left">ä¿®æ”¹å·²ç»æ³¨å†Œçš„ fd çš„ç›‘å¬äº‹ä»¶</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLL_CTL_DEL</td>
      <td style="text-align: left">ä» epfd ä¸­åˆ é™¤ä¸€ä¸ª fd</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ç­‰å¾…äº‹ä»¶å‘ç”Ÿã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span><span class="o">*</span> <span class="n">events</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxevents</span><span class="p">.</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>
</code></pre></div></div>

<hr />

<h2 id="2-æœåŠ¡å™¨ä½¿ç”¨æµç¨‹">2. æœåŠ¡å™¨ä½¿ç”¨æµç¨‹</h2>

<ul>
  <li>æœåŠ¡å™¨åˆ›å»ºéé˜»å¡ socketï¼ˆserver_fdï¼‰ã€‚</li>
  <li><code class="highlighter-rouge">epoll_create</code> åˆ›å»º epoll äº‹ä»¶é©±åŠ¨ (epoll_fd)ã€‚</li>
  <li><code class="highlighter-rouge">epoll_ctl</code> ç›‘æ§ server_fd çš„å¯è¯»äº‹ä»¶ <code class="highlighter-rouge">EPOLLIN</code>ã€‚</li>
  <li>æœåŠ¡è¿›ç¨‹é€šè¿‡ <code class="highlighter-rouge">epoll_wait</code> è·å–å†…æ ¸å°±ç»ªäº‹ä»¶å¤„ç†ã€‚</li>
  <li>å¦‚æœå°±ç»ªäº‹ä»¶æ˜¯æ–°è¿æ¥ï¼Œ<code class="highlighter-rouge">accept</code> ä¸ºå®¢æˆ·ç«¯æ–°è¿æ¥åˆ†é…æ–°çš„æ–‡ä»¶æè¿°ç¬¦ client_fdï¼Œè®¾ç½®éé˜»å¡ï¼Œç„¶å <code class="highlighter-rouge">epoll_ctl</code> ç›‘æ§ client_fd çš„å¯è¯»äº‹ä»¶ <code class="highlighter-rouge">EPOLLIN</code>ã€‚</li>
  <li>å¦‚æœå°±ç»ªäº‹ä»¶ä¸æ˜¯æ–°è¿æ¥ï¼Œ<code class="highlighter-rouge">read</code> è¯»å–å®¢æˆ·ç«¯å‘é€æ•°æ®è¿›è¡Œé€»è¾‘å¤„ç†ã€‚</li>
  <li>å¤„ç†é€»è¾‘è¿‡ç¨‹ä¸­éœ€è¦ <code class="highlighter-rouge">write</code> å›å¤å®¢æˆ·ç«¯ï¼Œ<code class="highlighter-rouge">write</code> å†…å®¹å¾ˆå¤§ï¼Œè¶…å‡ºäº†å†…æ ¸ç¼“å†²åŒºï¼Œæ²¡èƒ½å®æ—¶å‘é€å®Œæˆæ‰€æœ‰æ•°æ®ï¼Œéœ€è¦ä¸‹æ¬¡ç»§ç»­å‘é€ï¼›é‚£ä¹ˆ <code class="highlighter-rouge">epoll_ctl</code> ç›‘æ§ client_fd çš„ <code class="highlighter-rouge">EPOLLOUT</code> å¯å†™äº‹ä»¶ï¼Œä¸‹æ¬¡è§¦å‘äº‹ä»¶è¿›è¡Œå‘é€ã€‚ä¸‹æ¬¡è§¦å‘å¯å†™äº‹ä»¶å‘é€å®Œæ¯•åï¼Œ <code class="highlighter-rouge">epoll_ctl</code> åˆ é™¤ <code class="highlighter-rouge">EPOLLOUT</code> äº‹ä»¶ã€‚</li>
  <li>å®¢æˆ·ç«¯å…³é—­é“¾æ¥ï¼ŒæœåŠ¡ç«¯ç›‘æ§å®¢æˆ·ç«¯ fdï¼Œå¦‚æœ <code class="highlighter-rouge">read == 0</code>ï¼Œ<code class="highlighter-rouge">close</code> å…³é—­å¯¹åº” fd ä»è€Œå®Œæˆå››æ¬¡æŒ¥æ‰‹ã€‚</li>
</ul>

<p><img src="/images/2020-05-11-16-57-43.png" alt="epoll ä½¿ç”¨æµç¨‹" data-action="zoom" /></p>

<hr />

<h2 id="3-å‚è€ƒ">3. å‚è€ƒ</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/04/23/epoll-code/">[epoll æºç èµ°è¯»] epoll å®ç°åŸç†</a></li>
  <li><a href="http://man7.org/linux/man-pages/dir_all_by_section.html">http://man7.org/linux/man-pages/dir_all_by_section.html</a></li>
  <li><a href="http://man7.org/linux/man-pages/man2/write.2.html">http://man7.org/linux/man-pages/man2/write.2.html</a></li>
  <li><a href="http://man7.org/linux/man-pages/man2/read.2.html">http://man7.org/linux/man-pages/man2/read.2.html</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
