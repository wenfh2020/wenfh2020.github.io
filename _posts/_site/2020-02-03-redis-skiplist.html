<p><a href="http://zhangtielei.com/posts/blog-redis-skiplist.html">å¼ é“è•¾</a>çš„åšå®¢å°† <code class="highlighter-rouge">skiplist</code> åŸç†å’Œç®—æ³•å¤æ‚åº¦æè¿°å¾—å¾ˆæ¸…æ¥šï¼Œå…·ä½“å¯ä»¥å‚è€ƒã€‚æˆ‘åˆ†äº«ä¸€ä¸‹è‡ªå·±å¯¹éƒ¨åˆ†æºç çš„é˜…è¯»æƒ…å†µå’Œæ€è€ƒã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-æ•°æ®ç»“æ„" id="markdown-toc-1-æ•°æ®ç»“æ„">1. æ•°æ®ç»“æ„</a></li>
  <li><a href="#2-æ€è·¯" id="markdown-toc-2-æ€è·¯">2. æ€è·¯</a></li>
  <li><a href="#3-æ¥å£" id="markdown-toc-3-æ¥å£">3. æ¥å£</a>    <ul>
      <li><a href="#31-æ’å…¥ç»“ç‚¹" id="markdown-toc-31-æ’å…¥ç»“ç‚¹">3.1. æ’å…¥ç»“ç‚¹</a></li>
      <li><a href="#32-æµç¨‹æè¿°" id="markdown-toc-32-æµç¨‹æè¿°">3.2. æµç¨‹æè¿°</a></li>
    </ul>
  </li>
  <li><a href="#4-è°ƒè¯•" id="markdown-toc-4-è°ƒè¯•">4. è°ƒè¯•</a></li>
  <li><a href="#5-å‚è€ƒ" id="markdown-toc-5-å‚è€ƒ">5. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-æ•°æ®ç»“æ„">1. æ•°æ®ç»“æ„</h2>

<p>è·³è·ƒè¡¨æ˜¯ä¸€ä¸ªæœ‰åºçš„åŒå‘é“¾è¡¨ã€‚ç†è§£ <code class="highlighter-rouge">zskiplistNode</code> çš„ <code class="highlighter-rouge">zskiplistLevel</code> æ˜¯ç†è§£<code class="highlighter-rouge">zskiplist</code>å·¥ä½œæµç¨‹çš„å…³é”®ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* ZSETs use a specialized version of Skiplists */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">ele</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">backward</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">zskiplistLevel</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">span</span><span class="p">;</span> <span class="c1">// å½“å‰ç»“ç‚¹ä¸ forward æŒ‡å‘çš„ç»“ç‚¹è·ç¦»ï¼ˆè·¨è¶Šå¤šå°‘ä¸ªç»“ç‚¹ï¼‰ï¼Œæ’åä¸­åº”ç”¨ã€‚</span>
    <span class="p">}</span> <span class="n">level</span><span class="p">[];</span> <span class="c1">// å±‚ï¼Œå¯ä»¥ç†è§£ç»“ç‚¹çš„å‚ç›´çº¬åº¦ã€‚</span>
<span class="p">}</span> <span class="n">zskiplistNode</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zskiplist</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="o">*</span><span class="n">tail</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">length</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>
<span class="p">}</span> <span class="n">zskiplist</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="2-æ€è·¯">2. æ€è·¯</h2>

<p>è·³è·ƒè¡¨æ˜¯é“¾è¡¨ï¼Œé“¾è¡¨æŸ¥æ‰¾<code class="highlighter-rouge">æ—¶é—´å¤æ‚åº¦</code>æ˜¯ $O(n)$ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œé¡ºåºæŸ¥æ‰¾æ¯”è¾ƒæ…¢ã€‚é‚£æ¯”è¾ƒå–å·§çš„ï¼Œå› ä¸ºæ•°æ®æ˜¯é¡ºåºçš„ï¼Œæˆ‘ä»¬å¯ä»¥è·³ç€æ‰¾ã€‚ä¾‹å¦‚ä¸‹é¢ 1 - 13 çš„æ•°å­—ï¼Œæˆ‘ä»¬è¦æ‰¾ 9 è¿™ä¸ªæ•°å­—ã€‚è·³ç€æ‰¾çš„æµç¨‹æ˜¯è¿™æ ·çš„:</p>

<p><img src="/images/2020-02-20-16-41-54.png" alt="è·³è·ƒæŸ¥æ‰¾" data-action="zoom" /></p>

<p>åœ¨ç¬¬ä¸‰æ­¥å‘ç° 11 æ¯” 9 å¤§ï¼Œå°±å°è¯•è·³æ›´å°çš„é—´è·å¯»æ‰¾åˆé€‚çš„æ•°æ®ã€‚åŒæ ·çš„ä»¥æ­¤ç±»æ¨ç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬éœ€è¦çš„æ•°æ®ã€‚è¿™æ ·æ¯”æˆ‘ä»¬é¡ºåºæ‰¾è¦å¿«å¾ˆå¤šã€‚
æˆ‘ä»¬å¯ä»¥æ‹†åˆ†ä¸€ä¸‹ä¸Šå›¾çš„æŸ¥æ‰¾æµç¨‹ã€‚æ¯æ¬¡æŸ¥æ‰¾ä¸åˆ°æ—¶ï¼Œå°±é‡æ–°å®šå‘æŸ¥æ‰¾ã€‚æ¯æ¬¡é‡æ–°å®šå‘æŸ¥æ‰¾è¢«çœ‹ä½œä¸€ä¸ªå±‚ã€‚</p>

<p><img src="/images/2020-02-20-16-42-09.png" alt="æ‹†åˆ†å±‚æ¬¡" data-action="zoom" /></p>

<p>é“¾è¡¨çš„å±‚æ¬¡ï¼Œç±»ä¼¼ä¸€ä¸ªäºŒç»´ç©ºé—´ã€‚æ¯ä¸ªç»“ç‚¹æœ‰è‹¥å¹²å±‚ï¼Œæ¯ä¸€å±‚å°†ç»“ç‚¹è¿æ¥åœ¨ä¸€èµ·å»ºç«‹å…³ç³»ï¼ŒæŸ¥æ‰¾æ—¶ level ä»æœ€é«˜å±‚è‡ªä¸Šè€Œä¸‹ï¼Œç»“ç‚¹ä»å·¦åˆ°å³ã€‚</p>

<p><img src="/images/2020-02-20-16-42-25.png" alt="å±‚æ¬¡" data-action="zoom" /></p>

<p>éšæœºå±‚ levelï¼Œå±‚æ•°è¶Šé«˜ï¼Œæ¦‚ç‡è¶Šå°ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define ZSKIPLIST_MAXLEVEL 64 </span><span class="cm">/* Should be enough for 2^64 elements */</span><span class="cp">
#define ZSKIPLIST_P 0.25      </span><span class="cm">/* Skiplist P = 1/4 */</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">zslRandomLevel</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// æ¯å¢åŠ ä¸€å±‚æ¦‚ç‡æ˜¯ ZSKIPLIST_Pï¼Œæ‰€ä»¥å±‚æ•°è¶Šé«˜ï¼Œæ¦‚ç‡è¶Šå°ã€‚</span>
    <span class="k">while</span> <span class="p">((</span><span class="n">random</span><span class="p">()</span><span class="o">&amp;</span><span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ZSKIPLIST_P</span> <span class="o">*</span> <span class="mh">0xFFFF</span><span class="p">))</span>
        <span class="n">level</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="c1">// æœ€é«˜å±‚æ•° ZSKIPLIST_MAXLEVEL</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">level</span><span class="o">&lt;</span><span class="n">ZSKIPLIST_MAXLEVEL</span><span class="p">)</span> <span class="o">?</span> <span class="n">level</span> <span class="o">:</span> <span class="n">ZSKIPLIST_MAXLEVEL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-æ¥å£">3. æ¥å£</h2>

<h3 id="31-æ’å…¥ç»“ç‚¹">3.1. æ’å…¥ç»“ç‚¹</h3>

<p>sorted set åŠŸèƒ½å®ç°ï¼Œè·³è·ƒè¡¨ç»“åˆ dict ä½¿ç”¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// è·³è·ƒè¡¨å¹¶ä¸æ˜¯å•ç‹¬ä½¿ç”¨çš„ï¼Œåœ¨ sorted set ä¸­ï¼Œç»“åˆ dict ä½¿ç”¨ã€‚</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">zset</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span> <span class="c1">// ä¿å­˜ ele æ•°æ®ä½œä¸º key</span>
    <span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">;</span> <span class="c1">// è·³è·ƒè¡¨å­˜å‚¨ ele</span>
<span class="p">}</span> <span class="n">zset</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">zsetAdd</span><span class="p">(</span><span class="n">robj</span> <span class="o">*</span><span class="n">zobj</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="kt">double</span> <span class="o">*</span><span class="n">newscore</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">znode</span> <span class="o">=</span> <span class="n">zslInsert</span><span class="p">(</span><span class="n">zs</span><span class="o">-&gt;</span><span class="n">zsl</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">ele</span><span class="p">);</span>
    <span class="n">serverAssert</span><span class="p">(</span><span class="n">dictAdd</span><span class="p">(</span><span class="n">zs</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">,</span><span class="n">ele</span><span class="p">,</span><span class="o">&amp;</span><span class="n">znode</span><span class="o">-&gt;</span><span class="n">score</span><span class="p">)</span> <span class="o">==</span> <span class="n">DICT_OK</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>è·³è·ƒè¡¨æ’å…¥ç»“ç‚¹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Insert a new node in the skiplist. Assumes the element does not already
 * exist (up to the caller to enforce that). The skiplist takes ownership
 * of the passed SDS string 'ele'. */</span>
<span class="n">zskiplistNode</span> <span class="o">*</span><span class="nf">zslInsert</span><span class="p">(</span><span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">,</span> <span class="kt">double</span> <span class="n">score</span><span class="p">,</span> <span class="n">sds</span> <span class="n">ele</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// update ä¿å­˜æ¯å±‚éå†åˆ°æ»¡è¶³æ¡ä»¶çš„æœ€åä¸€ä¸ªç»“ç‚¹ã€‚</span>
    <span class="n">zskiplistNode</span> <span class="o">*</span><span class="n">update</span><span class="p">[</span><span class="n">ZSKIPLIST_MAXLEVEL</span><span class="p">],</span> <span class="o">*</span><span class="n">x</span><span class="p">;</span>

    <span class="c1">// rank æ’åä¿å­˜ span ç»“ç‚¹é—´è·ã€‚</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rank</span><span class="p">[</span><span class="n">ZSKIPLIST_MAXLEVEL</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span><span class="p">;</span>

    <span class="c1">// äºŒç»´ç©ºé—´ï¼Œlevelè‡ªä¸Šè€Œä¸‹éå†ï¼Œç»“ç‚¹ä»å¤´åˆ°å°¾éå†ï¼Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ç»“ç‚¹ä½ç½®ã€‚</span>
    <span class="n">serverAssert</span><span class="p">(</span><span class="o">!</span><span class="n">isnan</span><span class="p">(</span><span class="n">score</span><span class="p">));</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// ä¸‹å±‚ä¿å­˜ä¸Šå±‚çš„æ­¥è·ã€‚</span>
        <span class="cm">/* store rank that is crossed to reach the insert position */</span>
        <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">&lt;</span> <span class="n">score</span> <span class="o">||</span>
                    <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">score</span> <span class="o">==</span> <span class="n">score</span> <span class="o">&amp;&amp;</span>
                    <span class="n">sdscmp</span><span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">ele</span><span class="p">,</span><span class="n">ele</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="p">{</span>
            <span class="c1">// ç»“ç‚¹è·ç¦»æ•°ç›®ã€‚</span>
            <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span><span class="p">;</span>
            <span class="c1">// éå†ä¸‹ä¸€ä¸ªç»“ç‚¹ã€‚</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ä¿å­˜ i å±‚æ»¡è¶³æ¡ä»¶çš„æœ€åä¸€ä¸ªç»“ç‚¹ã€‚</span>
        <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* we assume the element is not already inside, since we allow duplicated
     * scores, reinserting the same element should never happen since the
     * caller of zslInsert() should test in the hash table if the element is
     * already inside or not. */</span>
    <span class="c1">// éšæœºå±‚æ•°</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">zslRandomLevel</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">&gt;</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åˆå§‹åŒ–æ–°å¢åŠ çš„å±‚ï¼ŒæŒ‡å‘å¤´ç»“ç‚¹ï¼Œæ­¥è·æ˜¯åˆ—è¡¨çš„é•¿åº¦ï¼ˆç»“ç‚¹ä¸ªæ•°ï¼‰ã€‚</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">;</span>
            <span class="c1">// æ–°å¢çš„ level ä¸Šæ˜¯æœ‰æŒ‡å‘ç»“ç‚¹æŒ‡é’ˆçš„ã€‚</span>
            <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span> <span class="o">=</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åˆ›å»ºæ–°çš„ç»“ç‚¹ä¿å­˜æ•°æ®ã€‚</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">zslCreateNode</span><span class="p">(</span><span class="n">level</span><span class="p">,</span><span class="n">score</span><span class="p">,</span><span class="n">ele</span><span class="p">);</span>

    <span class="c1">// æ’å…¥ç»“ç‚¹åˆ°åˆ—è¡¨</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">level</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// level è‡ªä¸‹è€Œä¸Šä¸åŒå±‚çš„æ’å…¥ä½ç½®å‰åç»“ç‚¹å»ºç«‹è”ç³»ã€‚</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span><span class="p">;</span>
        <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">forward</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>

        <span class="cm">/* update span covered by update[i] as x is inserted here */</span>
        <span class="c1">// spanï¼šåœ¨åŒä¸€ä¸ªå±‚çº§ï¼Œå½“å‰ç»“ç‚¹åˆ°ä¸‹ä¸€ä¸ªç»“ç‚¹çš„è·ç¦»ã€‚</span>
        <span class="c1">// rank[0] - rank[i] æ˜¯æ’å…¥ä½ç½®ï¼Œåˆ° i å±‚æ‰€åœ¨ç»“ç‚¹çš„ï¼Œç»“ç‚¹è·ç¦»ã€‚</span>
        <span class="c1">// update[i]-&gt;level[i].span æ˜¯æ’å…¥ä½ç½®åˆ°ä¸‹ä¸€ä¸ªç»“ç‚¹åˆ°è·ç¦»ã€‚</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span> <span class="o">=</span> <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span> <span class="o">-</span> <span class="p">(</span><span class="n">rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

        <span class="c1">// åœ¨ update[i] åé¢æ·»åŠ äº†ä¸€ä¸ªç»“ç‚¹ï¼Œspan + 1</span>
        <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span> <span class="o">=</span> <span class="p">(</span><span class="n">rank</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">rank</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* increment span for untouched levels */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">update</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">span</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// å¤„ç†åŒå‘ç»“ç‚¹çš„å‰åç»“ç‚¹è¿æ¥å…³ç³»ã€‚</span>
    <span class="n">x</span><span class="o">-&gt;</span><span class="n">backward</span> <span class="o">=</span> <span class="p">(</span><span class="n">update</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">update</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">forward</span><span class="p">)</span>
        <span class="n">x</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">backward</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">zsl</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="32-æµç¨‹æè¿°">3.2. æµç¨‹æè¿°</h3>

<p>å½“ level ä¸º 2 çš„é“¾è¡¨ï¼Œæ’å…¥ level ä¸º 3 çš„ç»“ç‚¹ 5ã€‚ï¼ˆè¿™é‡Œå¿½ç•¥äº† ele å’Œ score çš„å¤„ç†ï¼‰</p>
<blockquote>
  <p>æ’å…¥æ•°æ®çš„æµç¨‹å…¶å®æ¯”ä¸å¤æ‚ï¼Œå¯¹äºæºç çš„ç†è§£ï¼Œæœ€å¥½ç»“åˆå›¾è¡¨ï¼Œè¿™æ ·å¤§è„‘æ€è€ƒæ¯”è¾ƒä¾¿æ·ã€‚</p>
</blockquote>

<ul>
  <li>æ’å…¥å‰</li>
</ul>

<p><img src="/images/2020-02-20-16-42-47.png" alt="æ’å…¥å‰" data-action="zoom" /></p>

<ul>
  <li>æ’å…¥å</li>
</ul>

<p><img src="/images/2020-02-20-16-43-11.png" alt="æ’å…¥å" data-action="zoom" /></p>

<hr />

<h2 id="4-è°ƒè¯•">4. è°ƒè¯•</h2>

<p>å¯ä»¥ä¿®æ”¹ redis æºç ï¼Œè·Ÿè¸ªä¸€ä¸‹å·¥ä½œæµç¨‹ã€‚</p>

<blockquote>
  <p>è°ƒè¯•æ–¹æ³•å¯ä»¥å‚è€ƒæˆ‘çš„å¸–å­ï¼š <a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a></p>
</blockquote>

<p><img src="/images/2020-02-20-16-43-29.png" alt="è°ƒè¯•" data-action="zoom" /></p>

<p>server.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">tv</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

    <span class="n">zsetTest</span><span class="p">();</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>t_zset.c</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">zsetTest</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">ele</span><span class="p">;</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="n">zskiplist</span> <span class="o">*</span><span class="n">zsl</span><span class="p">;</span>
    <span class="n">zskiplistNode</span> <span class="o">*</span> <span class="n">node</span><span class="p">;</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ele</span> <span class="o">=</span> <span class="n">sdsfromlonglong</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>

    <span class="n">zsl</span> <span class="o">=</span> <span class="n">zslCreate</span><span class="p">();</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">zslInsert</span><span class="p">(</span><span class="n">zsl</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ele</span><span class="p">);</span>

    <span class="n">score</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ele</span> <span class="o">=</span> <span class="n">sdsfromlonglong</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">zslInsert</span><span class="p">(</span><span class="n">zsl</span><span class="p">,</span> <span class="n">score</span><span class="p">,</span> <span class="n">ele</span><span class="p">);</span>
    <span class="n">zslFree</span><span class="p">(</span><span class="n">zsl</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="5-å‚è€ƒ">5. å‚è€ƒ</h2>

<ul>
  <li>ã€Šredis è®¾è®¡ä¸å®ç°ã€‹</li>
  <li><a href="https://redis.io/commands/zadd">redis commands</a></li>
  <li><a href="https://mp.weixin.qq.com/s/rXIVIW7RM56xwMaQtKnmqA">Redisä¸ºä»€ä¹ˆç”¨è·³è¡¨è€Œä¸ç”¨å¹³è¡¡æ ‘ï¼Ÿ</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
