<p><code class="highlighter-rouge">linux</code> 下，需要将整数转化为二进制，很自然想到 <code class="highlighter-rouge">itoa</code>，发现这函数竟然编译不通过。标准库中貌似有这个<a href="http://www.cplusplus.com/reference/cstdlib/itoa/">实现</a>，不明白了~ 网上参考了<a href="https://stackoverflow.com/questions/190229/where-is-the-itoa-function-in-linux">帖子</a>，下面实现代码：</p>

<ul id="markdown-toc">
  <li><a href="#1-方法一" id="markdown-toc-1-方法一">1. 方法一</a></li>
  <li><a href="#2-方法二" id="markdown-toc-2-方法二">2. 方法二</a>    <ul>
      <li><a href="#21-方法三" id="markdown-toc-21-方法三">2.1. 方法三</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="1-方法一">1. 方法一</h2>

<p>感觉这方法有点费脑，不是很直观。</p>

<blockquote>
  <p>取模的方法一般都是从低位到高位，所以保存的字符串结果一般会跟需要的结果相反，需要倒转，要解决这个问题，可以从字符串数组后面开始往前保存。</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
</span>
<span class="cp">#define BUF_LEN 64
</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">i2bin</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">v</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">"0"</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">char</span><span class="o">*</span> <span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dst</span> <span class="o">-</span> <span class="n">buf</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="o">*--</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="sc">'0'</span><span class="p">;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span> <span class="o">-</span> <span class="n">dst</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
    <span class="n">scanf</span><span class="p">(</span><span class="s">"%llu"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUF_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">res</span> <span class="o">=</span> <span class="n">i2bin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUF_LEN</span><span class="p">);</span>
    <span class="n">res</span> <span class="o">?</span> <span class="n">printf</span><span class="p">(</span><span class="s">"data: %s, len: %lu</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">i2bin</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">BUF_LEN</span><span class="p">),</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
        <span class="o">:</span> <span class="n">printf</span><span class="p">(</span><span class="s">"fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="2-方法二">2. 方法二</h2>

<p>参考 redis sds.c 源码，把下面源码的 10 改为 2 即可。</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">sdsll2str</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">aux</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">v</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">l</span><span class="p">;</span>

    <span class="cm">/* Generate the string representation, this method produces
     * an reversed string. */</span>
    <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">value</span> <span class="o">:</span> <span class="n">value</span><span class="p">;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'0'</span> <span class="o">+</span> <span class="p">(</span><span class="n">v</span> <span class="o">%</span> <span class="mi">10</span><span class="p">);</span> <span class="c1">// 2 </span>
        <span class="n">v</span> <span class="o">/=</span> <span class="mi">10</span><span class="p">;</span> <span class="c1">// 2</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">v</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="sc">'-'</span><span class="p">;</span>

    <span class="cm">/* Compute length and add null term. */</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">s</span><span class="p">;</span>
    <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>

    <span class="cm">/* Reverse the string. */</span>
    <span class="n">p</span><span class="o">--</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
        <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
        <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">aux</span><span class="p">;</span>
        <span class="n">s</span><span class="o">++</span><span class="p">;</span>
        <span class="n">p</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">l</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="21-方法三">2.1. 方法三</h3>

<p>可以参考下 linux 源码，看看 printf 是怎么格式化字符串的。参考 <a href="https://github.com/torvalds/linux/blob/master/arch/x86/boot/printf.c">github 源码</a></p>

<hr />

<blockquote>
  <p>🔥文章来源：<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
