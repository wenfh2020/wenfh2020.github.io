<p>æƒŠç¾¤æ•ˆåº”ç†è§£ï¼šå¤šä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹é˜»å¡ç­‰å¾…åŒä¸€ä¸ªäº‹ä»¶ï¼Œå½“äº‹ä»¶åˆ°æ¥ï¼Œå¤šçº¿ç¨‹æˆ–è€…å¤šè¿›ç¨‹åŒæ—¶è¢«å”¤é†’ï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹è·å¾—èµ„æºã€‚é€šä¿—ç‚¹è¯´ï¼šå¾€é¸¡ç¾¤é‡Œä»ä¸€é¢—ç¨»è°·ï¼Œé¸¡ç¾¤äº‰æŠ¢ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸï¼Œå…¶å®ƒå¤±è´¥ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-ç°è±¡" id="markdown-toc-1-ç°è±¡">1. ç°è±¡</a></li>
  <li><a href="#2-ç»“æœ" id="markdown-toc-2-ç»“æœ">2. ç»“æœ</a></li>
  <li><a href="#3-è§£å†³æ–¹æ¡ˆ" id="markdown-toc-3-è§£å†³æ–¹æ¡ˆ">3. è§£å†³æ–¹æ¡ˆ</a></li>
  <li><a href="#4-åŸç†" id="markdown-toc-4-åŸç†">4. åŸç†</a></li>
  <li><a href="#5-æµ‹è¯•" id="markdown-toc-5-æµ‹è¯•">5. æµ‹è¯•</a></li>
  <li><a href="#6-å‚è€ƒ" id="markdown-toc-6-å‚è€ƒ">6. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-ç°è±¡">1. ç°è±¡</h2>

<p>ç«ç„°å›¾è§‚å¯Ÿ acceptï¼Œæˆ–è€…ç”¨ strace å‘½ä»¤è§‚å¯Ÿåº•å±‚è°ƒç”¨ã€‚å¯ä»¥ç”¨è„šæœ¬è·å–å¯¹åº”è¿›ç¨‹çš„ç«ç„°å›¾ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="k">if</span> <span class="o">[</span> <span class="nv">$# </span><span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s1">'input pid'</span>
    <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nb">rm</span> <span class="nt">-f</span> perf.<span class="k">*</span>
perf record <span class="nt">-F</span> 99 <span class="nt">-p</span> <span class="nv">$1</span> <span class="nt">-g</span> <span class="nt">--</span> <span class="nb">sleep </span>60
perf script <span class="nt">-i</span> perf.data &amp;&gt; perf.unfold
stackcollapse-perf.pl perf.unfold &amp;&gt; perf.folded
flamegraph.pl perf.folded <span class="o">&gt;</span> perf.svg
</code></pre></div></div>

<hr />

<h2 id="2-ç»“æœ">2. ç»“æœ</h2>

<p>çº¿ç¨‹æˆ–è¿›ç¨‹åˆ‡æ¢ï¼Œå†…æ ¸éœ€è¦ä¿å­˜ä¸Šä¸‹æ–‡ä»¥åŠå¯„å­˜å™¨ç­‰èµ„æºï¼Œé¢‘ç¹åˆ‡æ¢ä¼šå¯¼è‡´ç³»ç»Ÿèµ„æºæŸè€—ã€‚</p>

<hr />

<h2 id="3-è§£å†³æ–¹æ¡ˆ">3. è§£å†³æ–¹æ¡ˆ</h2>

<p>è§£å†³ epoll çš„æƒŠç¾¤é—®é¢˜ï¼š</p>

<ol>
  <li>ä»£ç åŒæ­¥åŠ é”ï¼ˆå‚è€ƒ nginx æºç ï¼‰ã€‚</li>
  <li>è®¾ç½® socket å±æ€§ SO_REUSEPORT ï¼ˆLinux ç³»ç»Ÿå†…æ ¸å±‚é¢è§£å†³ï¼Œè¿™ä¸ªæ–¹æ¡ˆç®€å•ï¼Œå‚è€ƒ nginx è¿™ä¸ªå±æ€§è®¾ç½®ï¼‰</li>
</ol>

<hr />

<h2 id="4-åŸç†">4. åŸç†</h2>

<p>å½“ç”¨ epoll äº‹ä»¶å¤„ç†é«˜å¹¶å‘äº‹ä»¶æ¨¡å‹æ—¶å€™ï¼Œå¤šä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹ epoll_wait ä¼šé˜»å¡ç­‰å¾…ç½‘ç»œäº‹ä»¶ï¼Œå½“æœ‰æ–°çš„ client connect è¿›æ¥ï¼Œepoll_wait ä¼šåŒæ—¶è¢«ä¼šå”¤é†’äº‰æŠ¢è¿™ä¸ªé“¾æ¥èµ„æºï¼Œç„¶åè°ƒç”¨ accept å¤„ç†ï¼Œäº‰æŠ¢èµ„æºå¤±è´¥çš„ accept ä¼šè¿”å› EAGAINã€‚</p>

<hr />

<h2 id="5-æµ‹è¯•">5. æµ‹è¯•</h2>

<p><a href="https://github.com/wenfh2020/c_test/blob/master/network/thundering_herd/main.cpp">æºç </a> server æ˜¯ epoll äº‹ä»¶æ¨¡å‹ï¼Œclient ç”¨ telnet å³å¯ã€‚</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;arpa/inet.h&gt;
#include &lt;assert.h&gt;
#include &lt;errno.h&gt;
#include &lt;fcntl.h&gt;
#include &lt;netdb.h&gt;
#include &lt;netinet/in.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;sys/epoll.h&gt;
#include &lt;sys/socket.h&gt;
#include &lt;sys/types.h&gt;
#include &lt;sys/wait.h&gt;
#include &lt;unistd.h&gt;
</span>
<span class="cp">#define MAXEVENTS 64
#define PROCESS_NUM 5
#define PORT 1234
</span>
<span class="kt">void</span> <span class="nf">test_accept</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"test_accept...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">PF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">connfd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">pid</span><span class="p">;</span>

    <span class="kt">char</span> <span class="n">sendbuff</span><span class="p">[</span><span class="mi">1024</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serveraddr</span><span class="p">;</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">PORT</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">iReuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iReuse</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iReuse</span><span class="p">));</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serveraddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serveraddr</span><span class="p">));</span>
    <span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROCESS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">connfd</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
                <span class="n">snprintf</span><span class="p">(</span><span class="n">sendbuff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sendbuff</span><span class="p">),</span> <span class="s">"accept pid = %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
                         <span class="n">getpid</span><span class="p">());</span>

                <span class="n">send</span><span class="p">(</span><span class="n">connfd</span><span class="p">,</span> <span class="n">sendbuff</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sendbuff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"process %d accept success</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                <span class="n">close</span><span class="p">(</span><span class="n">connfd</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sock_creat_bind</span><span class="p">(</span><span class="n">u_short</span> <span class="n">uiPort</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">sockaddr_in</span> <span class="n">serveraddr</span><span class="p">;</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">uiPort</span><span class="p">);</span>
    <span class="n">serveraddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_ANY</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">iReuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iReuse</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iReuse</span><span class="p">));</span>
    <span class="o">::</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_REUSEPORT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iReuse</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iReuse</span><span class="p">));</span>
    <span class="n">bind</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">serveraddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">serveraddr</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">sock_fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">make_nonblocking</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_GETFL</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">|=</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"fcntl set"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">create_listen_socket</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">sock_fd</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">sock_fd</span> <span class="o">=</span> <span class="n">sock_creat_bind</span><span class="p">(</span><span class="n">PORT</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"socket and bind"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">make_nonblocking</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"make non blocking"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="n">SOMAXCONN</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"listen"</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">sock_fd</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">worker</span><span class="p">(</span><span class="kt">int</span> <span class="n">iIndex</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"epoll accept....worker index: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iIndex</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">epoll_fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">create_listen_socket</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"create socket fail, worker index: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">iIndex</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">epoll_fd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="n">MAXEVENTS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"epoll_create"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">sock_fd</span><span class="p">;</span>
    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"epoll_ctl"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoll_event</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">MAXEVENTS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">MAXEVENTS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"process %d return from epoll_wait</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="o">||</span>
                <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)))</span> <span class="p">{</span>
                <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"epoll error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">close</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sock_fd</span> <span class="o">==</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">in_addr</span><span class="p">;</span>
                <span class="n">socklen_t</span> <span class="n">in_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_addr</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">accept</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"process %d accept failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"process %d accept successful!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">free</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_epoll_accept</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"test_epoll_accept...</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="kt">int</span> <span class="n">epoll_fd</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sock_fd</span> <span class="o">=</span> <span class="n">create_listen_socket</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"create socket fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">epoll_fd</span> <span class="o">=</span> <span class="n">epoll_create</span><span class="p">(</span><span class="n">MAXEVENTS</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"epoll_create"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">sock_fd</span><span class="p">;</span>
    <span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EPOLLIN</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">epoll_ctl</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"epoll_ctl"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="n">epoll_event</span> <span class="o">*</span><span class="p">)</span><span class="n">calloc</span><span class="p">(</span><span class="n">MAXEVENTS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">PROCESS_NUM</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">iPid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iPid</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"fork process pid: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
            <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">epoll_fd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">MAXEVENTS</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"process %d return from epoll_wait</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLERR</span><span class="p">)</span> <span class="o">||</span>
                        <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLHUP</span><span class="p">)</span> <span class="o">||</span>
                        <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)))</span> <span class="p">{</span>
                        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">"epoll error</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                        <span class="n">close</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">);</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sock_fd</span> <span class="o">==</span> <span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
                        <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">in_addr</span><span class="p">;</span>
                        <span class="n">socklen_t</span> <span class="n">in_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">in_addr</span><span class="p">);</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">accept</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">in_len</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">"process %d accept failed!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="n">printf</span><span class="p">(</span><span class="s">"process %d accept successful!</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock_fd</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_epoll_reuseport_accept</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"test_epoll_reuseport_accept... </span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROCESS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">iPid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iPid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">worker</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
            <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"parent, pid: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="n">wait</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">test_fork</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PROCESS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">iPid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">iPid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"child, pid: %d, index: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"parent, pid: %d, index: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span> <span class="n">i</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"end parent, pid: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">// test_fork();</span>
    <span class="c1">// test_accept();</span>
    <span class="c1">// test_epoll_accept();</span>
    <span class="n">test_epoll_reuseport_accept</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="6-å‚è€ƒ">6. å‚è€ƒ</h2>

<ul>
  <li><a href="https://www.ichenfu.com/2017/05/03/proxy-epoll-thundering-herd/">ä¸€ä¸ªepollæƒŠç¾¤å¯¼è‡´çš„æ€§èƒ½é—®é¢˜</a></li>
  <li><a href="https://blog.csdn.net/lyztyycode/article/details/78648798">LinuxæƒŠç¾¤æ•ˆåº”è¯¦è§£</a></li>
  <li><a href="https://www.cnblogs.com/Anker/p/7076537.html">Linux æœ€æ–°SO_REUSEPORTç‰¹æ€§</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
