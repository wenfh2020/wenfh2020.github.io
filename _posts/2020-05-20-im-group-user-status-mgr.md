---
layout: post
title:  "[即时通讯] 分布式系统-用户在线状态管理"
categories: 即时通讯
tags: im user status
author: wenfh2020
--- 

分布式系统，用户连接到不同的物理设备，在不同的进程里工作。独立进程在处理一些用户关系性比较强的业务时，涉及多个进程交互，逻辑要比单服复杂很多。对于相对较小的分布式系统，我们仍然希望寻求一种简单的功能实现方式。



* content
{:toc}

---

## 1. 解耦

分布式系统，每个服务节点都可以相互通信，我们希望，节点间尽量解耦，显然 B 图的逻辑更加清晰。

![通信解耦](/images/2020-05-21-20-02-12.png){:data-action="zoom"}

---

## 2. 架构

我们添加 redis 集群进行数据共享，减少节点间的通信。

![分布式架构](/images/2020-05-21-20-02-49.png){:data-action="zoom"}

架构特点：

* `gate` 接入服务集群，负责客户端接入和客户端业务协议的路由，（一致性哈希算法）路由到后端逻辑服务进行处理。
* `logic` 逻辑服务集群，负责客户端业务功能实现。
* `redis cluster` 数据缓存，方便不同类型节点服务共享数据。

---

**`gate` 写数据，`logic` 读数据。**

用户的实时在线状态被分散保存在多个 `gate` 服务上。`gate` 服务将用户在线状态实时同步到 redis 集群。

当 `logic` 服务处理群聊时，我们需要获得当前群组所有成员的在线状态，这时候我们不需要遍历 `gate` 服务进行获取，我们只需要通过 redis 获取即可。

---

## 3. Session

逻辑服务节点直接从 redis 上获取数据，可谓简单粗暴，我们仍然有很多细节问题需要处理。

这样 redis 负载可能会成为一个新的问题。特别是活跃的大群，每次发送消息，都要从 redis 取出大量的用户在线状态数据，这不是一个明智做法。所以我们可以把进程的内存利用起来 —— session。这样虽然不能保证 session 里的数据与 redis 同步，也一定程度上减轻了 redis 的负载。可以根据系统的负载设置 session 的有效时间。

那些原来离线，后面上线的用户，没有实时发送的消息，将被保存为离线消息。并通过其它策略定时对离线消息进行推送。

![缓存](/images/2020-05-21-20-44-09.png){:data-action="zoom"}

---

> 🔥 文章来源：[wenfh2020.com](https://wenfh2020.com/2020/05/20/im-group-user-status-mgr/)
>
> 👍 大家觉得文章对你有些作用！ 如果想 <font color=green>赞赏</font>，可以用微信扫描下面的二维码，感谢!
<div align=center><img src="/images/2020-08-06-15-49-47.png" width="120"/></div>
