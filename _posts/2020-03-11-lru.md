---
layout: post
title:  "ç®—æ³• lru c++ å®ç°"
categories: ç®—æ³•
tags: lru algorithm
author: wenfh2020
mathjax: true
---

LRUï¼ˆLeast recently usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ï¼‰ï¼Œæ•°æ®æ’å…¥é˜Ÿåˆ—ä¸­ï¼Œç»å¸¸è®¿é—®çš„æ•°æ®å•å…ƒé è¿‘åˆ—è¡¨å¤´éƒ¨ï¼Œä¸ç»å¸¸è®¿é—®çš„é è¿‘åˆ—è¡¨å°¾éƒ¨ã€‚åˆ—è¡¨æ•°æ®å°±åƒæŒ‰ç…§æ—¶é—´æ’åºä¸€æ ·ã€‚å¸¸ç”¨æ¥æ·˜æ±°ä¸€äº›é•¿æ—¶é—´ä¸ä½¿ç”¨çš„æ•°æ®ã€‚



* content
{:toc}

---

## 1. ç®—æ³•æµç¨‹

lru ç®—æ³•ç”¨ä¸€ä¸ªåˆ—è¡¨ä¹Ÿå¯ä»¥å®ç°ã€‚åªæ˜¯åˆ—è¡¨æ•°æ®éœ€è¦æ›´æ–°æ“ä½œï¼Œé‚£å¾—å…ˆæŸ¥æ‰¾æ•°æ®ï¼Œåˆ—è¡¨çš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n)$ï¼Œè¿™æ˜¯ä¸ªä½æ•ˆçš„æ“ä½œï¼Œæ‰€ä»¥ç”¨æ—¶é—´å¤æ‚åº¦ä¸º $ O(1) $ çš„å“ˆå¸Œè¡¨ `std::unordered_map` è¾…åŠ©å®ç°æŸ¥æ‰¾ã€‚

![lru ç®—æ³•æµç¨‹](/images/2020-03-13-12-35-17.png){: data-action="zoom"}

---

## 2. ç®—æ³•å®ç°

ç®€å•å®ç° LRU ç®—æ³•çš„æ·»åŠ ï¼Œæ›´æ–°å’Œåˆ é™¤æœ€æ—§æ•°æ®åŠŸèƒ½ã€‚å®šæ—¶æµ‹è¯•ç›¸å…³æ¥å£æ“ä½œã€‚(æµ‹è¯•æºç æ”¾åœ¨ [github](https://github.com/wenfh2020/c_test/blob/master/algorithms/lru))

```cpp
#ifndef _LRU_H_
#define _LRU_H_

#include <iostream>
#include <list>
#include <unordered_map>

class data {
   public:
    data() {}
    data(const data& d) : m_key(d.m_key), m_value(d.m_value) {}
    data(const std::string& key, const std::string& value)
        : m_key(key), m_value(value) {}

   public:
    std::string get_key() const { return m_key; }
    void set_key(const std::string& key) { m_key = key; }
    std::string get_value() const { return m_value; }
    void set_value(const std::string& value) { m_value = value; }

   private:
    std::string m_key;
    std::string m_value;
};

class lru {
   public:
    lru() {}
    virtual ~lru();
    bool insert(const std::string& key, const std::string& value);
    bool update(const std::string& key, const std::string& value);
    const data* get_random();
    bool pop();
    bool check();

   private:
    std::list<data*> m_list;
    std::unordered_map<std::string, std::list<data*>::iterator> m_map;
};

#endif  //_LRU_H_
```

```cpp
...

int main() {
    lru o;
    int i = 0;
    srand((unsigned)time(NULL));

    while (i++ <= 50) {
        if (i % 3 == 1) {
            o.insert(std::to_string(i), cur_time());
        } else if (i % 8 == 0) {
            o.pop();
        } else {
            const data* d = o.get_random();
            if (d) {
                o.update(d->get_key(), cur_time());
            }
        }

        o.check();
        sleep(2);
    }
    return 0;
}
```

---

## 3. redis è¿‘ä¼¼ lru ç®—æ³•

redis æ•°æ®åº“ `maxmemory` æ•°æ®æ·˜æ±°ç­–ç•¥ï¼Œé€šè¿‡é‡‡æ ·å®ç°äº†è¿‘ä¼¼ LRU çš„ç®—æ³•ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥å‚è€ƒæˆ‘çš„å¸–å­ [[redis æºç èµ°è¯»] maxmemory æ•°æ®æ·˜æ±°ç­–ç•¥](https://wenfh2020.com/2020/03/06/redis-max-memory/)

---

> ğŸ”¥ æ–‡ç« æ¥æºï¼š[ã€Šç®—æ³• lru c++ å®ç°ã€‹](https://wenfh2020.com/2020/03/11/lru/)
>
> ğŸ‘ å¤§å®¶è§‰å¾—æ–‡ç« å¯¹ä½ æœ‰äº›ä½œç”¨ï¼ å¦‚æœæƒ³ <font color=green>èµèµ</font>ï¼Œå¯ä»¥ç”¨å¾®ä¿¡æ‰«æä¸‹é¢çš„äºŒç»´ç ï¼Œæ„Ÿè°¢!
<div align=center><img src="/images/2020-08-06-15-49-47.png" width="120"/></div>
