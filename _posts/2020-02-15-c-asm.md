---
layout: post
title:  "åæ±‡ç¼–æŸ¥çœ‹å®å‡½æ•°/å‡½æ•°è°ƒç”¨åŸç†"
categories: c/c++
tags: c asm macro function
author: wenfh2020
---

é€šè¿‡ gdb æŸ¥çœ‹ç¨‹åºçš„æ±‡ç¼–ä»£ç ï¼Œç†è§£å®å‡½æ•°å’Œå‡½æ•°çš„å·¥ä½œåŸç†ã€‚



* content
{:toc}

---

## 1. ç¨‹åº

![æºç åæ±‡ç¼–](/images/2020-02-20-15-05-17.png){: data-action="zoom"}

ä¾‹å­ä¸­çš„æœ€å¤§å€¼å®ç°ï¼Œå®å‡½æ•°å’Œå‡½æ•°é€»è¾‘åŸºæœ¬ç›¸åŒã€‚å®åœ¨æºç é¢„ç¼–è¯‘é˜¶æ®µï¼Œè¢«æ›¿æ¢ä¸ºä»£ç ï¼Œå¢åŠ äº†ä»£ç çš„ä½“ç§¯ï¼›è€Œå‡½æ•°è°ƒç”¨å¤šäº†å‚æ•°ä¼ é€’ï¼Œå‡½æ•°è¿›æ ˆå’Œå‡ºæ ˆç­‰é€»è¾‘ï¼Œè‡ªç„¶èµ„æºæ¶ˆè€—è¦æ¯”å®å¤šã€‚

* æµ‹è¯•ä»£ç 

```c
#define _max(x, y) (x) > (y) ? (x) : (y)

int max_func(int x, int y) {
    return x > y ? x : y;
}
int main() {
    int aaa, bbb, ccc, ddd, eee, mmm;

    aaa = 1;
    bbb = 2;
    eee = 3;
    mmm = 4;
    ccc = max_func(aaa, bbb);
    ddd = _max(aaa, bbb);
    eee = ddd;
}
```

é¢„ç¼–è¯‘åï¼Œå®è¢«æ›¿æ¢ä¸ºæºç ã€‚

```shell
gcc -E test.cpp -o test.i
```

```c
int max_func(int x, int y) { return x > y ? x : y; }
int main() {
    int aaa, bbb, ccc, ddd, eee, mmm;

    aaa = 1;
    bbb = 2;
    eee = 3;
    mmm = 4;
    ccc = max_func(aaa, bbb);
    ddd = (aaa) > (bbb) ? (aaa) : (bbb);
    eee = ddd;
}

```

* ç¼–è¯‘æºç ä¸º elf æ–‡ä»¶è¿›è¡Œ gdb è°ƒè¯•

```shell
gcc -g test.cpp -o test
```

* é€šè¿‡ gdb å‘½ä»¤æŸ¥çœ‹ç¨‹åºæ±‡ç¼–ä»£ç 

```shell
layout asm
```
---

```shell
0x4004ed <max_func(int, int)>           push   %rbp
0x4004ee <max_func(int, int)+1>         mov    %rsp,%rbp
0x4004f1 <max_func(int, int)+4>         mov    %edi,-0x4(%rbp)
0x4004f4 <max_func(int, int)+7>         mov    %esi,-0x8(%rbp)
0x4004f7 <max_func(int, int)+10>        mov    -0x4(%rbp),%eax
0x4004fa <max_func(int, int)+13>        cmp    -0x8(%rbp),%eax
0x4004fd <max_func(int, int)+16>        jle    0x400504 <max_func(int, int)+23>
0x4004ff <max_func(int, int)+18>        mov    -0x4(%rbp),%eax
0x400502 <max_func(int, int)+21>        jmp    0x400507 <max_func(int, int)+26>
0x400504 <max_func(int, int)+23>        mov    -0x8(%rbp),%eax
0x400507 <max_func(int, int)+26>        pop    %rbp
0x400508 <max_func(int, int)+27>        retq
0x400509 <main()>                       push   %rbp
0x40050a <main()+1>                     mov    %rsp,%rbp
0x40050d <main()+4>                     sub    $0x20,%rsp
0x400511 <main()+8>                     movl   $0x1,-0x4(%rbp)
0x400518 <main()+15>                    movl   $0x2,-0x8(%rbp)
0x40051f <main()+22>                    movl   $0x3,-0xc(%rbp)
0x400526 <main()+29>                    movl   $0x4,-0x10(%rbp)
0x40052d <main()+36>                    mov    -0x8(%rbp),%edx
0x400530 <main()+39>                    mov    -0x4(%rbp),%eax
0x400533 <main()+42>                    mov    %edx,%esi
0x400535 <main()+44>                    mov    %eax,%edi
0x400537 <main()+46>                    callq  0x4004ed <max_func(int, int)>
0x40053c <main()+51>                    mov    %eax,-0x14(%rbp)
0x40053f <main()+54>                    mov    -0x4(%rbp),%eax
0x400542 <main()+57>                    cmp    -0x8(%rbp),%eax
0x400545 <main()+60>                    jle    0x40054c <main()+67>
0x400547 <main()+62>                    mov    -0x4(%rbp),%eax
0x40054a <main()+65>                    jmp    0x40054f <main()+70>
0x40054c <main()+67>                    mov    -0x8(%rbp),%eax
0x40054f <main()+70>                    mov    %eax,-0x18(%rbp)
0x400552 <main()+73>                    mov    -0x18(%rbp),%eax
0x400555 <main()+76>                    mov    %eax,-0xc(%rbp)
0x400558 <main()+79>                    mov    $0x0,%eax
0x40055d <main()+84>                    leaveq
0x40055e <main()+85>                    retq
```

---

## 2. æ±‡ç¼–çŸ¥è¯†

æµ‹è¯•ä¸­å‡ºç°çš„æ±‡ç¼–çŸ¥è¯†ã€‚

### 2.1. å¯„å­˜å™¨

| å¯„å­˜å™¨ | æè¿°                             |
| :----- | :------------------------------- |
| rbp    | 64 bit æ ˆåŸºå€å¯„å­˜å™¨---æŒ‡å‘æ ˆåº•é¡¶ |
| ebp    | 32 bit æ ˆåŸºå€å¯„å­˜å™¨---æŒ‡å‘æ ˆåº•   |
| bp     | 16 bit æ ˆåŸºå€å¯„å­˜å™¨---æŒ‡å‘æ ˆåº•   |
| rsp    | 64 bit æ ˆå¯„å­˜å™¨---æŒ‡å‘æ ˆé¡¶       |
| esp    | 32 bit æ ˆå¯„å­˜å™¨---æŒ‡å‘æ ˆé¡¶       |
| sp     | 16 bit æ ˆå¯„å­˜å™¨---æŒ‡å‘æ ˆé¡¶       |
| eax    | 32 bit é€šç”¨å¯„å­˜å™¨                |
| rip    | 64 bit åœ°å€åç§»å¯„å­˜å™¨            |

### 2.2. æ±‡ç¼–æŒ‡ä»¤

| å‘½ä»¤   | æè¿°                                                             |
| :----- | :--------------------------------------------------------------- |
| jmp    | æ— æ¡ä»¶æ®µå†…ç›´æ¥è½¬ç§»æŒ‡ä»¤                                           |
| sub    | å‡æ³•æŒ‡ä»¤                                                         |
| jle    | [æ¡ä»¶è½¬ç§»æŒ‡ä»¤](https://zhidao.baidu.com/question/284101534.html) |
| mov    | ä¼ é€æŒ‡ä»¤  (movl 32ä½, movw 16ä½, movb 8ä½)                       |
| cmp    | æ¯”è¾ƒæŒ‡ä»¤                                                         |
| push   | è¿›æ ˆæŒ‡ä»¤                                                         |
| pop    | å‡ºæ ˆæŒ‡ä»¤                                                         |
| ret    | æ®µå†…è¿‡ç¨‹è¿”å›æŒ‡ä»¤ï¼Œä½¿å­ç¨‹åºç»“æŸï¼Œç»§ç»­æ‰§è¡Œä¸»ç¨‹åº                   |
| callq  | ç›¸å½“äº pushq %ripï¼›   jmpq addr                                  |
| leaveq | ç›¸å½“äº movq %rbpï¼›    %rsp popq %rbp                             |
| retq   | ç›¸å½“äº popq %rip                                                 |

> callqï¼Œleaveqï¼Œretq ä¸­çš„qæ˜¯æŒ‡64ä½æ“ä½œæ•°

---

## 3. å‚è€ƒ

* [hook leaveq retq](https://blog.csdn.net/linuxheik/article/details/49277041?t=1488286725179)
* [GDB å•æ­¥è°ƒè¯•æ±‡ç¼–](https://github.com/zhangyachen/zhangyachen.github.io/issues/134)
* [æ±‡ç¼–å¸¸ç”¨æŒ‡ä»¤](https://blog.csdn.net/qq_36982160/article/details/82950848)
* [é€šç”¨32ä½CPU å¸¸ç”¨å¯„å­˜å™¨åŠå…¶ä½œç”¨](https://www.cnblogs.com/daryl-blog/p/11369588.html)

---

> ğŸ”¥ æ–‡ç« æ¥æºï¼š[wenfh2020.com](https://wenfh2020.com/)
>
> ğŸ‘ å¤§å®¶è§‰å¾—æ–‡ç« å¯¹ä½ æœ‰äº›ä½œç”¨ï¼ å¦‚æœæƒ³ <font color=green>èµèµ</font>ï¼Œå¯ä»¥ç”¨å¾®ä¿¡æ‰«æä¸‹é¢çš„äºŒç»´ç ï¼Œæ„Ÿè°¢!
<div align=center><img src="/images/2020-08-06-15-49-47.png" width="120"/></div>
