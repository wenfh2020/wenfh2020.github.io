---
layout: post
title:  "ÂèçÊ±áÁºñÊü•ÁúãÂÆèÂáΩÊï∞/ÂáΩÊï∞Ë∞ÉÁî®ÂéüÁêÜ"
categories: c/c++
tags: c asm macro function
author: wenfh2020
---

ÈÄöËøá gdb Êü•ÁúãÁ®ãÂ∫èÁöÑÊ±áÁºñ‰ª£Á†ÅÔºåÁêÜËß£ÂÆèÂáΩÊï∞ÂíåÂáΩÊï∞ÁöÑÂ∑•‰ΩúÂéüÁêÜ„ÄÇ



* content
{:toc}

---

## 1. Á®ãÂ∫è

![Ê∫êÁ†ÅÂèçÊ±áÁºñ](/images/2020-02-20-15-05-17.png){: data-action="zoom"}

‰æãÂ≠ê‰∏≠ÁöÑÊúÄÂ§ßÂÄºÂÆûÁé∞ÔºåÂÆèÂáΩÊï∞ÂíåÂáΩÊï∞ÈÄªËæëÂü∫Êú¨Áõ∏Âêå„ÄÇÂÆèÂú®Ê∫êÁ†ÅÈ¢ÑÁºñËØëÈò∂ÊÆµÔºåË¢´ÊõøÊç¢‰∏∫‰ª£Á†ÅÔºåÂ¢ûÂä†‰∫Ü‰ª£Á†ÅÁöÑ‰ΩìÁßØÔºõËÄåÂáΩÊï∞Ë∞ÉÁî®Â§ö‰∫ÜÂèÇÊï∞‰º†ÈÄíÔºåÂáΩÊï∞ËøõÊ†àÂíåÂá∫Ê†àÁ≠âÈÄªËæëÔºåËá™ÁÑ∂ËµÑÊ∫êÊ∂àËÄóË¶ÅÊØîÂÆèÂ§ö„ÄÇ

* ÊµãËØï‰ª£Á†Å

```c
#define _max(x, y) (x) > (y) ? (x) : (y)

int max_func(int x, int y) {
    return x > y ? x : y;
}
int main() {
    int aaa, bbb, ccc, ddd, eee, mmm;

    aaa = 1;
    bbb = 2;
    eee = 3;
    mmm = 4;
    ccc = max_func(aaa, bbb);
    ddd = _max(aaa, bbb);
    eee = ddd;
}
```

È¢ÑÁºñËØëÂêéÔºåÂÆèË¢´ÊõøÊç¢‰∏∫Ê∫êÁ†Å„ÄÇ

```shell
gcc -E test.cpp -o test.i
```

```c
int max_func(int x, int y) { return x > y ? x : y; }
int main() {
    int aaa, bbb, ccc, ddd, eee, mmm;

    aaa = 1;
    bbb = 2;
    eee = 3;
    mmm = 4;
    ccc = max_func(aaa, bbb);
    ddd = (aaa) > (bbb) ? (aaa) : (bbb);
    eee = ddd;
}

```

* ÁºñËØëÊ∫êÁ†Å‰∏∫ elf Êñá‰ª∂ËøõË°å gdb Ë∞ÉËØï

```shell
gcc -g test.cpp -o test
```

* ÈÄöËøá gdb ÂëΩ‰ª§Êü•ÁúãÁ®ãÂ∫èÊ±áÁºñ‰ª£Á†Å

```shell
layout asm
```
---

```shell
0x4004ed <max_func(int, int)>           push   %rbp
0x4004ee <max_func(int, int)+1>         mov    %rsp,%rbp
0x4004f1 <max_func(int, int)+4>         mov    %edi,-0x4(%rbp)
0x4004f4 <max_func(int, int)+7>         mov    %esi,-0x8(%rbp)
0x4004f7 <max_func(int, int)+10>        mov    -0x4(%rbp),%eax
0x4004fa <max_func(int, int)+13>        cmp    -0x8(%rbp),%eax
0x4004fd <max_func(int, int)+16>        jle    0x400504 <max_func(int, int)+23>
0x4004ff <max_func(int, int)+18>        mov    -0x4(%rbp),%eax
0x400502 <max_func(int, int)+21>        jmp    0x400507 <max_func(int, int)+26>
0x400504 <max_func(int, int)+23>        mov    -0x8(%rbp),%eax
0x400507 <max_func(int, int)+26>        pop    %rbp
0x400508 <max_func(int, int)+27>        retq
0x400509 <main()>                       push   %rbp
0x40050a <main()+1>                     mov    %rsp,%rbp
0x40050d <main()+4>                     sub    $0x20,%rsp
0x400511 <main()+8>                     movl   $0x1,-0x4(%rbp)
0x400518 <main()+15>                    movl   $0x2,-0x8(%rbp)
0x40051f <main()+22>                    movl   $0x3,-0xc(%rbp)
0x400526 <main()+29>                    movl   $0x4,-0x10(%rbp)
0x40052d <main()+36>                    mov    -0x8(%rbp),%edx
0x400530 <main()+39>                    mov    -0x4(%rbp),%eax
0x400533 <main()+42>                    mov    %edx,%esi
0x400535 <main()+44>                    mov    %eax,%edi
0x400537 <main()+46>                    callq  0x4004ed <max_func(int, int)>
0x40053c <main()+51>                    mov    %eax,-0x14(%rbp)
0x40053f <main()+54>                    mov    -0x4(%rbp),%eax
0x400542 <main()+57>                    cmp    -0x8(%rbp),%eax
0x400545 <main()+60>                    jle    0x40054c <main()+67>
0x400547 <main()+62>                    mov    -0x4(%rbp),%eax
0x40054a <main()+65>                    jmp    0x40054f <main()+70>
0x40054c <main()+67>                    mov    -0x8(%rbp),%eax
0x40054f <main()+70>                    mov    %eax,-0x18(%rbp)
0x400552 <main()+73>                    mov    -0x18(%rbp),%eax
0x400555 <main()+76>                    mov    %eax,-0xc(%rbp)
0x400558 <main()+79>                    mov    $0x0,%eax
0x40055d <main()+84>                    leaveq
0x40055e <main()+85>                    retq
```

---

## 2. Ê±áÁºñÁü•ËØÜ

ÊµãËØï‰∏≠Âá∫Áé∞ÁöÑÊ±áÁºñÁü•ËØÜ„ÄÇ

### 2.1. ÂØÑÂ≠òÂô®

| ÂØÑÂ≠òÂô® | ÊèèËø∞                             |
| :----- | :------------------------------- |
| rbp    | 64 bit Ê†àÂü∫ÂùÄÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÂ∫ïÈ°∂ |
| ebp    | 32 bit Ê†àÂü∫ÂùÄÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÂ∫ï   |
| bp     | 16 bit Ê†àÂü∫ÂùÄÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÂ∫ï   |
| rsp    | 64 bit Ê†àÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÈ°∂       |
| esp    | 32 bit Ê†àÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÈ°∂       |
| sp     | 16 bit Ê†àÂØÑÂ≠òÂô®---ÊåáÂêëÊ†àÈ°∂       |
| eax    | 32 bit ÈÄöÁî®ÂØÑÂ≠òÂô®                |
| rip    | 64 bit Âú∞ÂùÄÂÅèÁßªÂØÑÂ≠òÂô®            |

### 2.2. Ê±áÁºñÊåá‰ª§

| ÂëΩ‰ª§   | ÊèèËø∞                                                             |
| :----- | :--------------------------------------------------------------- |
| jmp    | Êó†Êù°‰ª∂ÊÆµÂÜÖÁõ¥Êé•ËΩ¨ÁßªÊåá‰ª§                                           |
| sub    | ÂáèÊ≥ïÊåá‰ª§                                                         |
| jle    | [Êù°‰ª∂ËΩ¨ÁßªÊåá‰ª§](https://zhidao.baidu.com/question/284101534.html) |
| mov    | ‰º†ÈÄÅÊåá‰ª§  (movl 32‰Ωç, movw 16‰Ωç, movb 8‰Ωç)                       |
| cmp    | ÊØîËæÉÊåá‰ª§                                                         |
| push   | ËøõÊ†àÊåá‰ª§                                                         |
| pop    | Âá∫Ê†àÊåá‰ª§                                                         |
| ret    | ÊÆµÂÜÖËøáÁ®ãËøîÂõûÊåá‰ª§Ôºå‰ΩøÂ≠êÁ®ãÂ∫èÁªìÊùüÔºåÁªßÁª≠ÊâßË°å‰∏ªÁ®ãÂ∫è                   |
| callq  | Áõ∏ÂΩì‰∫é pushq %ripÔºõ   jmpq addr                                  |
| leaveq | Áõ∏ÂΩì‰∫é movq %rbpÔºõ    %rsp popq %rbp                             |
| retq   | Áõ∏ÂΩì‰∫é popq %rip                                                 |

> callqÔºåleaveqÔºåretq ‰∏≠ÁöÑqÊòØÊåá64‰ΩçÊìç‰ΩúÊï∞

---

## 3. ÂèÇËÄÉ

* [hook leaveq retq](https://blog.csdn.net/linuxheik/article/details/49277041?t=1488286725179)
* [GDB ÂçïÊ≠•Ë∞ÉËØïÊ±áÁºñ](https://github.com/zhangyachen/zhangyachen.github.io/issues/134)
* [Ê±áÁºñÂ∏∏Áî®Êåá‰ª§](https://blog.csdn.net/qq_36982160/article/details/82950848)
* [ÈÄöÁî®32‰ΩçCPU Â∏∏Áî®ÂØÑÂ≠òÂô®ÂèäÂÖ∂‰ΩúÁî®](https://www.cnblogs.com/daryl-blog/p/11369588.html)

---

> üî•ÊñáÁ´†Êù•Ê∫êÔºö[wenfh2020.com](https://wenfh2020.com/)
