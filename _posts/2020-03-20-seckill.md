---
layout: post
title:  "商品秒杀问题的思考"
categories: 技术
tags: 秒杀 解决方案 问题
author: wenfh2020
---

商品秒杀场景比较常见，例如 12306 抢票等等。是高并发和分布式系统处理的经典案例。个人没做过秒杀项目，仅仅对这个问题感兴趣，研究了一下。个人认为秒杀场景主要有两个核心问题：到点抢购负载和商品超量。



* content
{:toc}

---

## 负载问题

秒杀活动开始，终端请求洪水般涌入服务器。请求包经过去重处理（uid/ip/other），放进消息队列，排队等待消费处理。

![消息队列处理负载](/images/2020-03-23-02-49-14.png)

---

## 商品超量问题

用户抢购流程：终端点击抢购按钮进入抢购页面 -> 填单 -> 提交订单。

思路：

* `logic server` 消费处理抢购请求。
* `num server` 维护商品数量。
* `logic server` 在处理抢购请求前先扣量，抢购请求处理失败或提交订单操作超时补量。
* `logic server` 扣量补量与 `num server` 交互。
* `logic server` 请求根据商品 id 为因子，通过一致性哈希，将同一个商品的量操作发送到相同的 `num server` 进行处理。
* `num server` 商品数量落地 MySQL，用悲观锁，主库上操作保证数据一致性。
* `num server` 为减少数据库的读写频率，从 MySQL 扣除一批次的量，放进进程内存。**批次数据要进行记录**，每次处理完毕，再进行下一批次数据的申请。批次处理类似于代理和厂家关系，代理卖完一批商品，再从厂家进货。
* `num server` 定时监控商品数据量变化，如果长时间不访问，内存中没分派完的量要回写 MySQL。
* `num server` 异常退出，重启或新节点启动需要检查上一批次是否完成，如果没完成需要统计该批次的量分发情况，把没有分发的量统计回收（订单状态：进行中，失败，成功）。

![商品超量处理](/images/2020-03-23-15-37-46.png)

---

## 参考

* [商品秒杀问题的解决方案](https://blog.csdn.net/koastal/article/details/78995885)

---

* 更精彩内容，可以关注我的博客：[wenfh2020.com](https://wenfh2020.com/)
