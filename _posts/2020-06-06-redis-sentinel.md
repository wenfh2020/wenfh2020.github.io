---
layout: post
title:  "[redis æºç èµ°è¯»] sentinel å“¨å…µ - åŸç†"
categories: redis
tags: redis sentinel
author: wenfh2020
mathjax: true
---

redis æœ‰ä¸»ä»æ•°æ®å¤åˆ¶åŠŸèƒ½ã€‚å¤šä¸ªå®ä¾‹é€šè¿‡è¯»å†™åˆ†ç¦»ï¼Œä½¿å¾—å•è¿›ç¨‹çš„ redis å¯ä»¥å……åˆ†åˆ©ç”¨å¤šæ ¸æ€§èƒ½ã€‚

å½“æŸäº› redis å®ä¾‹å‡ºç°æ•…éšœæ€ä¹ˆåŠï¼ŒæœåŠ¡è¿˜èƒ½æ­£å¸¸å·¥ä½œå—ï¼Ÿè¿™æ—¶å€™æ•…éšœç®¡ç†è€… `sentinel` åº”è¿è€Œç”Ÿã€‚å®ƒè´Ÿè´£ redis é›†ç¾¤ç®¡ç†å·¥ä½œï¼šæ£€æŸ¥æ•…éšœï¼Œå‘ç°æ•…éšœï¼Œè½¬ç§»æ•…éšœï¼Œä»è€Œä¿è¯é›†ç¾¤é«˜å¯ç”¨ã€‚



* content
{:toc}

---

## 1. sentinel ä½œç”¨

1. ç›‘æ§ï¼š æ£€æŸ¥ redis èŠ‚ç‚¹å¥åº·çŠ¶å†µã€‚
2. æ•…éšœè½¬ç§»ï¼šå½“ redis é›†ç¾¤èŠ‚ç‚¹å‡ºç°æ•…éšœæ—¶ï¼ŒåŠæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ç§»ã€‚
3. é€šçŸ¥ï¼šæ£€æµ‹åˆ° redis å®ä¾‹å‡ºç°æ•…éšœï¼Œé€šè¿‡ api è¿›è¡Œé€šçŸ¥ç”¨æˆ·ã€‚
4. æä¾›é…ç½®ï¼šç”¨æˆ·å¯ä»¥é€šè¿‡å‘½ä»¤æŸ¥è¯¢å½“å‰ redis é›†ç¾¤ç›¸å…³ä¿¡æ¯ã€‚

---

## 2. é›†ç¾¤

### 2.1. è§’è‰²å…³ç³»

redis é«˜å¯ç”¨é›†ç¾¤ï¼Œæœ‰ä¸‰ç§è§’è‰²ï¼š`master`ï¼Œ`slave`ï¼Œ`sentinel`ã€‚

* slave ä¸ master é€šä¿¡ï¼Œä¸ºäº†æ•°æ®å¤åˆ¶ã€‚
* sentinel ä¸ master / slave é€šä¿¡ï¼Œä¸ºäº†å¯¹ master / slave è¿›è¡Œç®¡ç†ï¼šæ£€æŸ¥æ•…éšœï¼Œå‘ç°æ•…éšœï¼Œè½¬ç§»æ•…éšœã€‚
* sentinel èŠ‚ç‚¹ä¹‹é—´é€šä¿¡ï¼Œä¸ºäº†é€‰ä¸¾ leaderï¼Œé€šè¿‡ leader è¿›è¡Œé›†ç¾¤æ•…éšœè½¬ç§»ã€‚

![é«˜å¯ç”¨èŠ‚ç‚¹é€šä¿¡å…³ç³»](/images/2020-06-09-20-24-46.png){:data-action="zoom"}

---

### 2.2. èŠ‚ç‚¹é“¾æ¥

sentinel åªè¦é…ç½® redis ä¸»æœåŠ¡ï¼ˆmasterï¼‰ä¿¡æ¯å³å¯ä¸ä¸‰ä¸ªè§’è‰²å»ºç«‹è”ç³»ã€‚

```shell
# sentinel.conf
# sentinel monitor <master-name> <ip> <redis-port> <quorum>
sentinel monitor mymaster 127.0.0.1 6379 2
```

>\<quorum\> æ˜¯`æ³•å®šäººæ•°`ã€‚ä½œç”¨ï¼šå¤šä¸ª sentinel è¿›è¡Œç›¸äº’é€‰ä¸¾ï¼Œæœ‰è¶…è¿‡ä¸€å®š`æ³•å®šäººæ•°`é€‰ä¸¾æŸäººä¸ºé¢†å¯¼ï¼Œé‚£ä¹ˆä»–å°±æˆä¸º sentinel çš„é¢†å¯¼ï¼Œé¢†å¯¼è´Ÿè´£æ•…éšœè½¬ç§»ã€‚è¿™ä¸ªæ³•å®šäººæ•°ï¼Œå¯ä»¥é…ç½®ï¼Œä¸€èˆ¬æ˜¯ sentinel ä¸ªæ•°ä¸€åŠä»¥ä¸Š $(\frac{n}{2} + 1)$ æ¯”è¾ƒåˆç†ã€‚

![èŠ‚ç‚¹å…³è”](/images/2020-06-09-21-09-04.png){:data-action="zoom"}

```shell
sentinel <--> masterï¼Œsentinel <--> slaveï¼Œsentinel A <--> sentinel B
```

* sentinel å‘ master è·å– slave ä¿¡æ¯ï¼Œä¸ slave å»ºç«‹è¿æ¥ã€‚

   master ä¸ slave æ˜¯ä¸»ä»å…³ç³»ï¼Œmaster æ‹¥æœ‰æ‰€æœ‰ slave çš„é“¾æ¥ä¿¡æ¯ã€‚sentinel åªè¦é…ç½® master çš„ ip å’Œ portï¼Œé“¾æ¥ masterï¼Œå¹¶é€šè¿‡ `info` å‘½ä»¤å°±èƒ½è·å¾— slave çš„ ip å’Œ port ä¿¡æ¯ã€‚è¿™æ · sentinel å°±å¯ä»¥ä¸ slave å»ºç«‹é“¾æ¥ã€‚

* å¤šä¸ª sentinel ç›¸äº’é“¾æ¥ã€‚

   é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œsentinel å¯ä»¥é“¾æ¥ master / slaveã€‚è€Œå¤šä¸ª sentinel é€šè¿‡å‘å¸ƒ/è®¢é˜… master / slave çš„ `__sentinel__:hello` é¢‘é“è¿›è¡Œå‘å¸ƒå’Œæ¥æ”¶ä¿¡æ¯ã€‚å¤šä¸ª sentinel ä¸éœ€è¦é…ç½®å¯¹æ–¹çš„ä¿¡æ¯ï¼Œå°±èƒ½è·å¾—é€šè¿‡è¿™ä¸ªæµç¨‹è·å¾—å…¶å®ƒ sentinel çš„ä¿¡æ¯å¹¶è¿›è¡Œç›¸äº’é“¾æ¥ã€‚

> è¯¦ç»†æµç¨‹ï¼Œå¯ä»¥å‚è€ƒ ã€Š[[redis æºç èµ°è¯»] sentinel å“¨å…µ - èŠ‚ç‚¹é“¾æ¥æµç¨‹](https://wenfh2020.com/2020/06/12/redis-sentinel-nodes-contact/)ã€‹

---

## 3. æ•…éšœ

sentinel ç›‘æ§æµç¨‹ï¼šæ£€æµ‹æ•…éšœ -> å‘ç°æ•…éšœ -> å¤„ç†æ•…éšœã€‚

redis é›†ç¾¤ä¸‰ä¸ªè§’è‰² sentinel / master / slave éƒ½å¯èƒ½å‡ºç°æ•…éšœï¼Œå½“ redis master å‡ºç°æ•…éšœï¼Œsentinel leader å¯¹é›†ç¾¤è¿›è¡Œæ•…éšœè½¬ç§»ã€‚

---

### 3.1. æ£€æµ‹æ•…éšœ

è§’è‰²èŠ‚ç‚¹ä¹‹é—´å»ºç«‹äº†è”ç³»ï¼Œé‚£ä¹ˆ sentinel ä¸å…¶å®ƒèŠ‚ç‚¹é€šè¿‡å®šæœŸå‘é€ç›¸åº”å‘½ä»¤ï¼ˆ`PING / INFO / PUBLISH`ï¼‰è¿›è¡Œç›¸äº’é€šä¿¡ã€‚

---

### 3.2. å‘ç°æ•…éšœ

1. å½“å¯¹æ–¹ï¼ˆmasterï¼‰å‘½ä»¤å›å¤å¼‚å¸¸æˆ–è€…é•¿æœŸæ”¶ä¸åˆ°å¯¹æ–¹å›å¤ï¼Œé‚£ä¹ˆ sentinel å‘ç°äº†æ•…éšœï¼Œæš‚æ—¶å°†è¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºä¸»åŠ¨ä¸‹çº¿ã€‚
2. sentinel å‘å…¶å®ƒ sentinel èŠ‚ç‚¹è¯¢é—®ï¼Œæ˜¯å¦åŒæ ·æ£€æµ‹åˆ°è¯¥ç»“ç‚¹å‡ºç°æ•…éšœã€‚
3. å…¶å®ƒèŠ‚ç‚¹å›å¤ç¡®è®¤æ•…éšœï¼Œå½“å‰ sentinel å°†è¯¥èŠ‚ç‚¹æ ‡è®°ä¸ºå®¢è§‚ä¸‹çº¿ã€‚

![å‘ç°æ•…éšœ](/images/2020-06-10-11-51-36.png){:data-action="zoom"}

---

### 3.3. æ•…éšœè½¬ç§»

* sentinel é€‰ä¸¾ leaderã€‚
* sentinel leader æ ¹æ®è§„åˆ™ç­›é€‰åˆé€‚çš„ slave ä½œä¸º masterã€‚
* é€šçŸ¥å…¶å®ƒ slave é“¾æ¥æ–°çš„ masterã€‚
* æ—§ master å¦‚æœé‡æ–°ä¸Šçº¿ï¼Œè¢« sentinel è®¾ç½®æˆä¸ºæ–° master çš„ slaveã€‚

---

## 4. æºç èµ°è¯»

é€šè¿‡ gdb è°ƒè¯•ï¼Œå»è½å® sentinel çš„æºç å·¥ä½œæµç¨‹ã€‚

åœ¨ main å‡½æ•°å…¥å£ä¸‹æ–­ç‚¹ï¼Œåœ¨ `sentinel.c` æºç æ–‡ä»¶é‡Œï¼Œå‡ ä¹æ¯ä¸ªå‡½æ•°éƒ½ä¸‹æ–­ç‚¹ï¼Œå¯åŠ¨è°ƒè¯•ï¼Œè¿™ä¸ªæ–¹æ³•å¥½åƒæœ‰ç‚¹ç¬¨ï¼Œä½†æ˜¯è¿™æ ·æ¯ä¸ªç»†èŠ‚æµç¨‹éƒ½ä¸ä¼šé”™è¿‡ï¼ˆ^_^!ï¼‰ã€‚

> è°ƒè¯•è¯·å‚è€ƒ ã€Š[ç”¨ gdb è°ƒè¯• redis](https://wenfh2020.com/2020/01/05/redis-gdb/)ã€‹ã€‚

![å¯åŠ¨è°ƒè¯•](/images/2020-06-12-14-31-49.png){:data-action="zoom"}

---

## 5. å‚è€ƒ

* [Redis Sentinel Documentation](https://redis.io/topics/sentinel)
* [[redis æºç èµ°è¯»] ä¸»ä»æ•°æ®å¤åˆ¶ï¼ˆä¸Šï¼‰](https://wenfh2020.com/2020/05/17/redis-replication/)
* [[redis æºç èµ°è¯»] ä¸»ä»æ•°æ®å¤åˆ¶ï¼ˆä¸‹ï¼‰](https://wenfh2020.com/2020/05/31/redis-replication-next/)
* ã€Šredis å®ç°ä¸è®¾è®¡ã€‹
* [åˆ†å¸ƒå¼ç®—æ³•ä¹‹é€‰ä¸¾ç®—æ³•Raft](https://blog.csdn.net/cainaioaaa/article/details/79881296)
* [10åˆ†é’Ÿå¼„æ‡‚Raftç®—æ³•](http://blog.itpub.net/31556438/viewspace-2637112/)
* [Rediså¼€å‘ä¸è¿ç»´ä¹‹ç¬¬ä¹ç« å“¨å…µ(å››)--é…ç½®ä¼˜åŒ–](https://blog.csdn.net/cuiwjava/article/details/99405508)
* [ç”¨ gdb è°ƒè¯• redis](https://wenfh2020.com/2020/01/05/redis-gdb/)

---

> ğŸ”¥æ–‡ç« æ¥æºï¼š[wenfh2020.com](https://wenfh2020.com/2020/06/06/redis-sentinel/)
