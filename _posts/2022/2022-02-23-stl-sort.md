---
layout: post
title:  "[stl æºç åˆ†æ] std::sort"
categories: c/c++
tags: stl sort
author: wenfh2020
---

std::sort æ˜¯æ ‡å‡†åº“é‡Œæ¯”è¾ƒç»å…¸çš„ç®—æ³•ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¤åˆæ’åºï¼Œç»“åˆäº†å‡ ç§ç®—æ³•çš„ä¼˜ç‚¹ã€‚





* content
{:toc}

---

## 1. æ¦‚è¿°

[std::sort](http://www.cplusplus.com/reference/algorithm/sort/?kw=sort) ä¸»è¦æ˜¯ä¸‰ç§ç®—æ³•çš„ç»“åˆä½“ï¼šæ’å…¥æ’åºï¼Œå¿«é€Ÿæ’åºï¼Œå †æ’åºã€‚

---

### 1.1. ç®—æ³•ä¼˜ç¼ºç‚¹

<style> table th:first-of-type { width: 70px; } </style>

|ç®—æ³•|æ—¶é—´å¤æ‚åº¦|ä¼˜ç‚¹|ç¼ºç‚¹|
|:--:|:--:|:--|:--|
|æ’å…¥æ’åº|O(N\*N)|å½“æ•°æ®é‡å¾ˆå°‘æ—¶ï¼Œæ•ˆç‡æ¯”è¾ƒé«˜ã€‚|å½“æ•°æ®é‡æ¯”è¾ƒå¤§æ—¶ï¼Œæ—¶é—´å¤æ‚åº¦æ¯”è¾ƒé«˜ã€‚|
|å¿«é€Ÿæ’åº|å¹³å‡ O(N\*logN)ï¼Œæœ€å O(N\*N)|å¤§éƒ¨åˆ†æ—¶å€™æ€§èƒ½æ¯”è¾ƒå¥½ã€‚|ç®—æ³•æ—¶é—´å¤æ‚åº¦ä¸ç¨³å®šï¼Œæ•°æ®é‡å¤§æ—¶é€’å½’æ·±åº¦å¾ˆå¤§ï¼Œå½±å“ç¨‹åºå·¥ä½œæ•ˆç‡ã€‚|
|å †æ’åº|O(N\*logN)|ç®—æ³•æ—¶é—´å¤æ‚åº¦ç¨³å®šï¼Œæ¯”è¾ƒå°ï¼Œé€‚åˆæ•°æ®é‡æ¯”è¾ƒå¤§çš„æ’åºã€‚|å †æ’åºåœ¨å»ºå †å’Œè°ƒæ•´å †çš„è¿‡ç¨‹ä¸­ä¼šäº§ç”Ÿæ¯”è¾ƒå¤§çš„å¼€é”€ï¼Œæ•°æ®é‡å°‘çš„æ—¶å€™ä¸é€‚ç”¨ã€‚|

---

### 1.2. ç®—æ³•ç»“åˆ

std::sort æ ¹æ®ä¸Šæ–‡æåˆ°çš„å‡ ç§ç®—æ³•çš„ä¼˜ç¼ºç‚¹ï¼Œå¯¹æ’åºç®—æ³•è¿›è¡Œæ•´åˆã€‚

1. å¿«é€Ÿæ’åºï¼Œé€’å½’æ’åºåˆ°ä¸€å®šæ·±åº¦åï¼Œæ•°æ®å·²ç»è¢«åˆ†ä¸ºå¤šä¸ªå­åŒºåŸŸï¼Œå­åŒºåŸŸé‡Œé¢çš„æ•°æ®å¯èƒ½æ˜¯æ— åºçš„ï¼Œä½†æ˜¯å­åŒºåŸŸä¹‹é—´å·²ç»æ˜¯æœ‰åºäº†ã€‚
2. åœ¨è¿™å¤šä¸ªå­åŒºåŸŸé‡Œï¼Œå¦‚æœæŸä¸ªå­åŒºåŸŸæ•°æ®ä¸ªæ•°å¤§äºé˜ˆå€¼ï¼ˆ16ï¼‰ï¼Œé‡‡ç”¨å †æ’åºï¼Œä½¿å¾—æŸä¸ªå­åŒºåŸŸå†…éƒ¨æœ‰åºã€‚
3. å‰©ä¸‹çš„æ²¡æœ‰è¢«å †æ’åºçš„å°åŒºåŸŸï¼Œæ•°æ®é‡éƒ½æ˜¯å°äºé˜ˆå€¼çš„ï¼Œæœ€åæ•´ä¸ªæ•°æ®åŒºåŸŸé‡‡ç”¨æ’å…¥æ’åºã€‚

> è¿™ç§è¢«ä¼˜åŒ–çš„å¿«é€Ÿæ’åº+å †æ’åºï¼Œè¢«ç§°ä¸º `å†…çœæ’åº`ï¼ˆintrospective sortï¼‰ã€‚

<div align=center><img src="/images/2022/2022-02-23-17-12-00.png" data-action="zoom"/></div>

---

## 2. æºç 

### 2.1. æµ‹è¯•

```cpp
/* g++ -g -O0 -W -std=c++11 main.cpp -o test && ./test */
#include <time.h>

#include <algorithm>
#include <iostream>
#include <vector>

#define MAX_LEN 1000000
#define LIMT_CNT 100

int main() {
    int limit = 0;
    std::vector<int> nums;
    nums.reserve(MAX_LEN);

    srand((unsigned)time(NULL));

    for (int i = 0; i < MAX_LEN; i++) {
        nums.push_back(rand());
    }

    std::sort(nums.begin(), nums.end(), std::less<int>());

    for (auto v : nums) {
        std::cout << v << " " << std::endl;
        if (++limit > LIMT_CNT) {
            break;
        }
    }
    return 0;
}
```

---

### 2.2. è°ƒè¯•

åŠ¨æ‰‹è°ƒè¯•æºç ï¼Œé€»è¾‘ä¼šæ›´æ¸…æ™° ğŸ˜ã€‚ï¼ˆ[ubuntu è°ƒè¯•ç¯å¢ƒæ­å»º](https://wenfh2020.com/2022/02/19/vscode-gdb-cpp/)ï¼‰

<div align=center><img src="/images/2022/2022-02-24-17-29-07.png" data-action="zoom"/></div>

---

### 2.3. stl æºç åˆ†æ

#### 2.3.1. å‡½æ•°è°ƒç”¨å…³ç³»

```shell
std::sort
|-- std::__sort
    |-- __introsort_loop
        |-- __unguarded_partition_pivot # å°†æŸä¸ªåŒºåŸŸçš„æ•°æ®æ ¹æ®å“¨å…µåˆ†ç¦»å‡ºä¸¤ä¸ªå­åŒºåŸŸï¼Œå¹¶è¿”å›è¿™ä¸¤ä¸ªå­åŒºåŸŸçš„åˆ†ç•Œä½ç½® __cutã€‚
        |-- __introsort_loop # é€’å½’ã€‚
        |-- __partial_sort -- if (__depth_limit == 0) # å¿«æ’åˆ°è¾¾æŒ‡å®šæ·±åº¦ï¼Œæ•°æ®é‡å¤§äºé˜ˆå€¼ï¼Œé‡‡ç”¨å †æ’åºã€‚
    |-- __final_insertion_sort # æ’å…¥æ’åºæ•´ä¸ªæ’åºåŒºåŸŸã€‚
```

---

#### 2.3.2. æ’åºæºç 

æ’åºæºç ï¼šå†…çœæ’åº + æ’å…¥æ’åºã€‚

```cpp
/* /usr/include/c++/9/bits/stl_algo.h */

template<typename _RandomAccessIterator, typename _Compare>
inline void
sort(_RandomAccessIterator __first, _RandomAccessIterator __last,
    _Compare __comp) {
    ...
    std::__sort(__first, __last, __gnu_cxx::__ops::__iter_comp_iter(__comp));
}

template<typename _RandomAccessIterator, typename _Compare>
inline void
__sort(_RandomAccessIterator __first, _RandomAccessIterator __last,
    _Compare __comp) {
    if (__first != __last) {
        /* å†…çœæ’åºï¼š
         * å¿«é€Ÿæ’åºé€’å½’ä¸€å®šæ·±åº¦ï¼Œå¦‚æœå¯¹åº”åŒºåŸŸå†…æ•°æ®é‡å¤§äºé˜ˆå€¼ï¼Œå¯¹åº”åŒºåŸŸå†…æ•°æ®é‡‡ç”¨å †æ’åºã€‚ 
         * std::__lg() è®¡ç®—é€’å½’æ·±åº¦é™åˆ¶ã€‚*/
        std::__introsort_loop(__first, __last,
            std::__lg(__last - __first) * 2,  __comp);
        /* æ’å…¥æ’åºã€‚ */
        std::__final_insertion_sort(__first, __last, __comp);
    }
}
```

---

##### 2.3.2.1. å†…çœæ’åº

```cpp
/* /usr/include/c++/9/bits/stl_algo.h */

template<typename _RandomAccessIterator, typename _Size, typename _Compare>
void
__introsort_loop(_RandomAccessIterator __first,
            _RandomAccessIterator __last,
            _Size __depth_limit, _Compare __comp) {
    while (__last - __first > int(_S_threshold)) {
        if (__depth_limit == 0) {
            /* å­åŒºåŸŸé‡‡ç”¨å †æ’åºã€‚ */
            std::__partial_sort(__first, __last, __last, __comp);
            return;
        }
        --__depth_limit;
        /* é€’å½’æ’åºï¼Œå¹¶è¿”å›æ’åºåŒºåŸŸè¢«åˆ†æˆä¸¤ä¸ªåŒºåŸŸåï¼ŒåŒºåŸŸçš„åˆ†ç•Œä½ç½® __cutã€‚ */
        _RandomAccessIterator __cut =
        std::__unguarded_partition_pivot(__first, __last, __comp);
        /* å¿«é€Ÿæ’åºï¼ˆé€’å½’ï¼‰ã€‚*/
        std::__introsort_loop(__cut, __last, __depth_limit, __comp);
        __last = __cut;
    }
}

/// This is a helper function...
template<typename _RandomAccessIterator, typename _Compare>
inline _RandomAccessIterator
__unguarded_partition_pivot(_RandomAccessIterator __first,
            _RandomAccessIterator __last, _Compare __comp) {
    /* æ•°æ®åŒºåŸŸä¸­é—´ä½ç½®ã€‚ */
    _RandomAccessIterator __mid = __first + (__last - __first) / 2;
    /* æ¯”è¾ƒä¸‰ä¸ªå€¼ï¼šç¬¬ä¸€ä¸ªä½ç½® ï¼Œæœ€åä¸€ä¸ªä½ç½®ï¼Œä¸­é—´ä½ç½®è¿™ä¸‰ä¸ªå€¼ã€‚
     * å“ªä¸ªä½ç½®ä¸Šçš„æ•°æ®å¤„äºä¸­é—´çš„ï¼ˆa < b < c å– bï¼‰ä½œä¸ºå¿«é€Ÿæ’åºçš„å“¨å…µã€‚
     * é‚£ä¹ˆå°†å“¨å…µæ•°æ®ä¸ç¬¬ä¸€ä¸ªä½ç½®æ•°æ®ç½®æ¢ã€‚ */
    std::__move_median_to_first(__first, __first + 1, __mid, __last - 1, __comp);
    /* ç¬¬ä¸€ä¸ªä½ç½®ä¸Šçš„æ•°æ®æ˜¯å“¨å…µï¼Œé‚£ä¹ˆä» [__first + 1, __last) è¿™ä¸ªåŒºé—´çš„æ•°æ®ï¼Œ
     * æ ¹æ®å“¨å…µçš„å€¼ï¼Œå°†è¿™ä¸ªåŒºåŸŸçš„æ•°æ®åˆ†æˆå·¦å³ä¸¤éƒ¨åˆ†ï¼Œ
     * ä¾‹å¦‚ï¼šå°äºå“¨å…µçš„æ•°æ®æ”¾åœ¨åŒºåŸŸå·¦è¾¹ï¼Œå¤§äºå“¨å…µçš„æ•°æ®æ”¾åœ¨åŒºåŸŸå³è¾¹ã€‚*/
    return std::__unguarded_partition(__first + 1, __last, __first, __comp);
}

/* ä¸‰ä¸ªæ•°å–ä¸­å€¼ï¼Œæ”¾åœ¨ __result ä½ç½®ã€‚*/
template<typename _Iterator, typename _Compare>
void __move_median_to_first(_Iterator __result,_Iterator __a, _Iterator __b,
            _Iterator __c, _Compare __comp) {
    if (__comp(__a, __b)) {
        if (__comp(__b, __c))
            std::iter_swap(__result, __b);
        else if (__comp(__a, __c))
            std::iter_swap(__result, __c);
        else
            std::iter_swap(__result, __a);
    }
    else if (__comp(__a, __c))
        std::iter_swap(__result, __a);
    else if (__comp(__b, __c))
        std::iter_swap(__result, __c);
    else
        std::iter_swap(__result, __b);
}

/* æ ¹æ®å“¨å…µï¼Œå°†æ•°æ®åŒºåŸŸåˆ†æˆä¸¤éƒ¨åˆ†ï¼Œå¹¶è¿”å›åŒºåŸŸåˆ†ç•Œä½ç½®ã€‚ */
template<typename _RandomAccessIterator, typename _Compare>
_RandomAccessIterator
__unguarded_partition(_RandomAccessIterator __first,
            _RandomAccessIterator __last,
            _RandomAccessIterator __pivot, _Compare __comp) {
    while (true) {
        while (__comp(__first, __pivot))
        ++__first;
        --__last;
        while (__comp(__pivot, __last))
        --__last;
        if (!(__first < __last))
        return __first;
        std::iter_swap(__first, __last);
        ++__first;
    }
}
```

---

##### 2.3.2.2. æ’å…¥æ’åº

* æºç åˆ†æã€‚

```cpp
/* /usr/include/c++/9/bits/stl_algo.h */

template <typename _RandomAccessIterator, typename _Compare>
void
__final_insertion_sort(_RandomAccessIterator __first,
                        _RandomAccessIterator __last, _Compare __comp) {
    if (__last - __first > int(_S_threshold)) {
        std::__insertion_sort(__first, __first + int(_S_threshold), __comp);
        std::__unguarded_insertion_sort(__first + int(_S_threshold), __last,  __comp);
    } else
        std::__insertion_sort(__first, __last, __comp);
}

/// This is a helper function for the sort routine.
template <typename _RandomAccessIterator, typename _Compare>
void
__insertion_sort(_RandomAccessIterator __first,
                    _RandomAccessIterator __last, _Compare __comp) {
    if (__first == __last) return;

    for (_RandomAccessIterator __i = __first + 1; __i != __last; ++__i) {
        /* å¦‚æœå½“å‰æ•°æ®æ¯”ç¬¬ä¸€ä¸ªæ•°æ®è¿˜è¦å°ï¼ˆå¦‚æœæ˜¯ä»å°åˆ°å¤§æ’åºï¼‰ï¼Œ
         * [__first, __i) åŒºåŸŸæ•°æ®å‘å³ç§»åŠ¨ä¸€ä¸ªä½ç½®ï¼Œ__i æ•°æ®æ”¾åœ¨é¦–ä½ã€‚ */
        if (__comp(__i, __first)) {
            typename iterator_traits<_RandomAccessIterator>::value_type
                __val = _GLIBCXX_MOVE(*__i);
            _GLIBCXX_MOVE_BACKWARD3(__first, __i, __i + 1);
            *__first = _GLIBCXX_MOVE(__val);
        } else
            /* __i ä½ç½®ä¸Šçš„æ•°æ®ä½œä¸ºè¦æ’å…¥çš„æ•°æ®ï¼Œ
             * ä»å³åˆ°å·¦ï¼ˆ__i ä½ç½®å¼€å§‹ï¼‰é€ä¸ªæ•°æ®è¿›è¡Œæ¯”è¾ƒæ’åºï¼Œç›´åˆ°ä¸æ»¡è¶³æ¡ä»¶å†åœä¸‹æ¥ã€‚ */
            std::__unguarded_linear_insert(__i,
                __gnu_cxx::__ops::__val_comp_iter(__comp));
    }
}

template <typename _RandomAccessIterator, typename _Compare>
void
__unguarded_linear_insert(_RandomAccessIterator __last, _Compare __comp) {
    typename iterator_traits<_RandomAccessIterator>::value_type
        __val = _GLIBCXX_MOVE(*__last);
    _RandomAccessIterator __next = __last;
    --__next;
    while (__comp(__val, __next)) {
        *__last = _GLIBCXX_MOVE(*__next);
        __last = __next;
        --__next;
    }
    *__last = _GLIBCXX_MOVE(__val);
}
```

* `æ³¨æ„`ï¼Œå› ä¸º `__unguarded_linear_insert` å†…éƒ¨ while å¾ªç¯æ²¡æœ‰ä½œè¾¹ç•Œæ£€æŸ¥ï¼Œæ‰€ä»¥ __comp å‡½æ•°ä¸¤ä¸ªå‚æ•°çš„æ¯”è¾ƒå¿…é¡»æ˜¯ v1 > v2 æˆ–è€… v1 < v2ï¼Œä¸èƒ½ v1 >= v2 æˆ–è€… v1 <= v2 è¿™æ ·çš„ï¼Œå¦åˆ™ç¨‹åºå¯èƒ½ä¼šå› ä¸ºå†…å­˜è¶Šç•Œå´©æºƒï¼ˆ å‚è€ƒä¸‹é¢é”™è¯¯ç¤ºä¾‹ï¼‰ã€‚

<div align=center><img src="/images/2022/2022-02-24-18-14-07.png" data-action="zoom"/></div>

```cpp
/* g++ main.cpp -o test && ./test */
#include <algorithm>
#include <iostream>
#include <vector>

int main() {
    std::vector<int> nums;
    for (int i = 0; i < 100; i++) {
        nums.push_back(1);
    }
    std::sort(nums.begin(), nums.end(), [](int v1, int v2) {
        return v1 <= v2;
    });
    return 0;
}
```

---

## 3. å°ç»“

1. std::sort é‡‡ç”¨çš„æ˜¯åˆ†æ²»æ€ç»´ï¼Œå…ˆé‡‡ç”¨å¿«é€Ÿæ’åºï¼Œå°†æ•´ä¸ªåŒºåŸŸåˆ†æˆå¤šä¸ªå­åŒºåŸŸï¼Œæ¯ä¸ªå­åŒºåŸŸå†…éƒ¨æ ¹æ®æ•°æ®é‡é‡‡ç”¨ä¸åŒç®—æ³•ã€‚
2. åˆ†æ²»åï¼Œå„ä¸ªå­åŒºåŸŸå±€éƒ¨æœ‰åºåå†é€šè¿‡æ•´ä¸ªåŒºåŸŸè¿›è¡Œæ’åºã€‚

---

## 4. å‚è€ƒ

* [åå¤§æ’åºç®—æ³•](https://zhuanlan.zhihu.com/p/42586566)
* [å¿«æ’çš„æ”¹è‰¯ç‰ˆâ€”â€”å†…çœå¼æ’åº](https://blog.csdn.net/sky453589103/article/details/51116264)
* [C++ä¸­ä½¿ç”¨std::sortè‡ªå®šä¹‰æ’åºè§„åˆ™æ—¶è¦æ³¨æ„çš„å´©æºƒé—®é¢˜](https://blog.csdn.net/albertsh/article/details/119523587)
* ã€ŠSTL æºç å‰–æã€‹- (389 - 400)
