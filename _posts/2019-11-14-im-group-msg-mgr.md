---
layout: post
title:  "[å³æ—¶é€šè®¯]åƒäººç¾¤ç»„-æ¶ˆæ¯ç®¡ç†"
categories: å³æ—¶é€šè®¯
tags: im group
author: wenfh2020
--- 

å³æ—¶é€šè®¯ï¼Œæ¶ˆæ¯æœ‰å¾ˆå¤šç§ç±»å‹ï¼Œå•èŠï¼Œç¾¤èŠç­‰ç­‰ã€‚ç¾¤ç»„èŠå¤©æ¶ˆæ¯ç®¡ç†ç›¸å¯¹æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºæ¶‰åŠåˆ°å¤šä¸ªç”¨æˆ·ï¼Œå°¤å…¶æ˜¯åƒäººç¾¤ç»„ï¼Œ1 ä¸ªäººå‘é€æ¶ˆæ¯ï¼Œ999 ä¸ªäººæ¥æ”¶ï¼Œæ•°æ®åº“é’ˆå¯¹æ¯ä¸ªç”¨æˆ·å­˜å‚¨ä¸€æ¡è®°å½•å—ï¼Ÿè¿™ä¸ªé‡çº§çš„æ•°æ®å­˜å‚¨æ˜¯ååˆ†ææ€–çš„ï¼Œæ‰€ä»¥æ¶ˆæ¯çš„å­˜å‚¨ç­–ç•¥æ˜¾å¾—ååˆ†é‡è¦ã€‚



* content
{:toc}

---

## 1. æ¶ˆæ¯æ—¶åº

ç†æƒ³çŠ¶æ€ä¸‹ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚å®é™…æƒ…å†µï¼Œæ¶‰åŠåˆ°ç”¨æˆ·ä¸Šçº¿æˆ–ä¸‹çº¿ã€‚ï¼ˆè¯¦è§ä¸‹å›¾ï¼‰

1. ç”¨æˆ·åœ¨çº¿ï¼šæœåŠ¡å®æ—¶å‘é€æ¶ˆæ¯ã€‚
2. ç”¨æˆ·ç¦»çº¿ï¼šæœåŠ¡ä¿å­˜æ¶ˆæ¯ï¼›ç”¨æˆ·é‡æ–°ä¸Šçº¿åï¼Œå‘æœåŠ¡è·å–ç¦»çº¿æ¶ˆæ¯ã€‚

---

![æ¶ˆæ¯æ—¶åº](/images/2020-02-25-08-14-15.png){: data-action="zoom"}

---

* ç¾¤ç»„ç¦»çº¿æ¶ˆæ¯æ•°æ®åˆ†é¡µé“¾å¼ç®¡ç†ã€‚

   å¦‚ä¸Šå›¾ï¼Œæ¯æ¡æ¶ˆæ¯éƒ½æ˜¯æœ‰æ—¶åºçš„ï¼Œåƒé“¾è¡¨ä¸€æ ·ï¼Œä¸²è”èµ·æ¥ï¼Œæ¯ä¸ª node éƒ½å¯ä»¥é€šè¿‡ next æŒ‡å‘ä¸Šä¸€æ¡æ¶ˆæ¯ï¼š
   1. å¦‚æœä¸Šä¸€æ¡æ¶ˆæ¯ msg_id æ˜¯  0ï¼Œè¯´æ˜å½“å‰ç»“ç‚¹æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¦‚ä¸Šå›¾ msg_id == 1 çš„æ¶ˆæ¯ï¼‰ã€‚
   2. å¦‚æœä¸Šä¸€æ¡æ¶ˆæ¯ msg_id ä¸æ˜¯ 0ï¼Œä¸”æ¶ˆæ¯å­˜åœ¨äºæœ¬åœ°ï¼Œé‚£ä¹ˆæ¶ˆæ¯æ˜¯è¿ç»­çš„ï¼Œä¸éœ€è¦å‘æœåŠ¡åŒæ­¥ï¼ˆå¦‚ä¸Šå›¾ msg_id == 2 çš„æ¶ˆæ¯ï¼‰ã€‚
   3. å¦‚æœä¸Šä¸€æ¡æ¶ˆæ¯ msg_id ä¸æ˜¯ 0ï¼Œä½†æœ¬åœ°æ¶ˆæ¯ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆéœ€è¦å‘æœåŠ¡å™¨è·å–ã€‚ï¼ˆå¦‚ä¸Šå›¾ msg_id == 9 çš„æ¶ˆæ¯ï¼‰ã€‚
   > ç»ˆç«¯é€šè¿‡æ¶ˆæ¯é“¾è¡¨æ–¹å¼çš„æ£€æŸ¥ï¼Œå¾ˆå®¹æ˜“ç¡®è®¤æ˜¯å¦éœ€è¦å‘æœåŠ¡åŒæ­¥æ•°æ®ã€‚

* ç¾¤ç»„æœªè¯»æ¶ˆæ¯æ€»æ¡æ•°ã€‚

   ä» client çš„ç¼“å­˜ä¸­æå–æœ€æ–°ï¼ˆlastestï¼‰çš„ msg_idï¼Œå¯¹åº”æ¶ˆæ¯ä½“æœ‰ recv_timeã€‚
   æœåŠ¡ç«¯æ¶ˆæ¯çš„æ—¶åºé€šè¿‡ redis çš„ sortset å­˜å‚¨çš„ï¼Œredis çš„ sortset ç»“æ„ï¼Œå¾ˆå®¹æ˜“é€šè¿‡ä¸€ä¸ª score è·å–ä¸€ä¸ªåŒºé—´çš„æ•°æ®æ€»æ•°ã€‚

```shell
key: group_id, score: recv_time, value: msg_id
```

---

## 2. redis è®¾è®¡

* sortset å­˜å‚¨å­˜å‚¨æ¶ˆæ¯æ—¶åºã€‚

```shell
key: group_id, score: recv_time, value: msg_id
```

* string å­˜å‚¨æ¶ˆæ¯ä½“ã€‚

  å› ä¸ºæ¶ˆæ¯ä½“æ•°é‡è¾ƒå¤šï¼Œè€Œä¸”æ´»è·ƒæ—¶é—´æ¯”è¾ƒçŸ­ï¼ˆå› ä¸ºå¤§éƒ¨åˆ†ç”¨æˆ·åªå…³å¿ƒæœ€è¿‘æ¥æ”¶çš„æ¶ˆæ¯ï¼‰ï¼Œæ‰€ä»¥æŠŠå®ƒç‹¬ç«‹å‡ºæ¥ã€‚ä¾¿äº timeout å redis èƒ½åˆ é™¤èŠ‚çœå†…å­˜ã€‚

```shell
key: msg_id, value: msg_body
```

* set å­˜å‚¨æœªè¯»æ¶ˆæ¯å¯¹è±¡ã€‚

  æ¯ä¸ªç”¨æˆ·éƒ½å¯èƒ½æœ‰ N ä¸ªç¾¤ç»„ï¼ŒN ä¸ªå¥½å‹ã€‚ç”¨æˆ·é‡æ–°ä¸Šçº¿åï¼Œä¸å¯èƒ½éå†æ‰€æœ‰å¥½å‹æˆ–ç¾¤ç»„å¯¹è±¡ã€‚æ‰€ä»¥æœåŠ¡åœ¨å¤„ç†ç¦»çº¿æ¶ˆæ¯æ—¶ï¼Œéœ€è¦è®°å½•æœªè¯»æ¶ˆæ¯å¯¹è±¡ã€‚

```shell
key: uid, member:group_id/send_uid
```

---

## 3. database è®¾è®¡

* ç¾¤ç»„å’Œç¾¤ç»„æˆå‘˜å…³ç³»

```shell
group_id, uid
```

* æ¶ˆæ¯ç»“æ„

```shell
msg_id, group_id, send_uid, recv_uid,  recv_time, msg_body
```

---

## 4. æœåŠ¡å­˜å‚¨æ¶æ„

å³æ—¶é€šè®¯æœåŠ¡æ˜¯è¯»å¤šå†™å°‘ç±»å‹ã€‚æœåŠ¡ç«¯æœ‰ä¸‰å±‚å­˜å‚¨ï¼ˆå¦‚ä¸‹å›¾ï¼‰ï¼Œé€šè¿‡çƒ­ç‚¹æ•°æ®çš„ç¼“å­˜ï¼Œè®©æœåŠ¡é«˜æ•ˆè¯»å–ã€‚

* `msg server` æœåŠ¡è¿›ç¨‹å†…å­˜ `session` ç¼“å­˜çƒ­ç‚¹æ•°æ®ã€‚
   ç¼“å­˜å½“å‰æ´»è·ƒçš„æ•°æ®ï¼šå¤´åƒä¿¡æ¯ï¼Œç”¨æˆ·åç§°ï¼Œæ¶ˆæ¯å®ä½“ç­‰æ•°æ®ï¼Œç¼“å­˜ä¸€èˆ¬ 5 - 30 åˆ†é’Ÿï¼Œæ ¹æ®å…·ä½“çš„ä¸šåŠ¡éœ€è¦

* redis ç¬¬äºŒå±‚ç¼“å­˜çƒ­ç‚¹æ•°æ®ã€‚
   ç¼“å­˜å¤§é‡çš„çƒ­ç‚¹æ•°æ®ï¼Œå‡å°‘å¯¹ db çš„è®¿é—®é¢‘ç‡ï¼Œç¼“å­˜æ—¶é—´ç›¸å¯¹è¾ƒé•¿ï¼Œå‡ ä¸ªæœˆä¸ç­‰ã€‚

* database æ•°æ®è½åœ°ã€‚

![å­˜å‚¨æ¶æ„](/images/2020-02-25-08-16-18.png){: data-action="zoom"}

---

## 5. æ•°æ®è¯»å†™æ—¶åº

### 5.1. å†™æ•°æ®

![å†™é€»è¾‘](/images/2020-02-25-08-16-44.png){: data-action="zoom"}

---

### 5.2. è¯»æ•°æ®

![è¯»é€»è¾‘](/images/2020-02-25-08-17-14.png){: data-action="zoom"}

---

## 6. æ€»ç»“

åŸºäºä»¥ä¸Šåˆ†æï¼Œç¾¤ç»„æ¶ˆæ¯ï¼Œæ¯ä¸ªç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œä¸éœ€è¦é’ˆå¯¹æ¯ä¸ªç¾¤ç»„æˆå‘˜å­˜ä¸€æ¡è®°å½•åˆ°æ•°æ®åº“ï¼Œæ•°æ®åº“åªéœ€è¦å­˜ä¸€æ¡è®°å½•å³å¯ã€‚é€šè¿‡å¤šçº§ç¼“å­˜çš„æ¶æ„ï¼ŒæœåŠ¡çš„æ€§èƒ½ä¸€èˆ¬ä½“é‡çš„æ¶ˆæ¯å®æ—¶é€šè®¯æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å½“ç„¶è¿™é‡Œé¢è¿˜æœ‰å¾ˆå¤šç»†èŠ‚é—®é¢˜éœ€è¦åœ¨å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­è°ƒä¼˜ã€‚

---

> ğŸ”¥æ–‡ç« æ¥æºï¼š[wenfh2020.com](https://wenfh2020.com/2019/11/14/im-group-msg-mgr/)