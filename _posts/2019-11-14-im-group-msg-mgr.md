---
layout: post
title:  "[即时通讯] 千人群组-消息管理"
categories: 即时通讯
tags: im group message
author: wenfh2020
--- 

即时通讯，消息有很多种类型，单聊，群聊等等。群组聊天消息管理相对比较麻烦，因为涉及到多个用户，尤其是千人群组，1 个人发送消息，999 个人接收，数据库针对每个用户存储一条记录吗？这个量级的数据存储是十分恐怖的，所以消息的存储策略显得十分重要。



* content
{:toc}

---

## 1. 消息时序

理想状态下，客户端和服务端数据是一致的。实际情况，涉及到用户上线或下线。（详见下图）

1. 用户在线：服务实时发送消息。
2. 用户离线：服务保存消息；用户重新上线后，向服务获取离线消息。

---

![消息时序](/images/2020-02-25-08-14-15.png){: data-action="zoom"}

> 设计图来源：[《即时通讯（IM）- 千人群组消息管理》](https://www.processon.com/apps/5dbb0ac4e4b0ea86c41ca550)

---

* 群组离线消息数据分页链式管理。

   如上图，每条消息都是有时序的，像链表一样，串联起来，每个 node 都可以通过 next 指向上一条消息：
   1. 如果上一条消息 msg_id 是  0，说明当前结点是第一条消息（如上图 msg_id == 1 的消息）。
   2. 如果上一条消息 msg_id 不是 0，且消息存在于本地，那么消息是连续的，不需要向服务同步（如上图 msg_id == 2 的消息）。
   3. 如果上一条消息 msg_id 不是 0，但本地消息不存在，那么需要向服务器获取。（如上图 msg_id == 9 的消息）。
   > 终端通过消息链表方式的检查，很容易确认是否需要向服务同步数据。

* 群组未读消息总条数。

   从 client 的缓存中提取最新（lastest）的 msg_id，对应消息体有 recv_time。
   服务端消息的时序通过 redis 的 sortset 存储的，redis 的 sortset 结构，很容易通过一个 score 获取一个区间的数据总数。

```shell
key: group_id, score: recv_time, value: msg_id
```

---

## 2. redis 设计

* sortset 存储存储消息时序。

```shell
key: group_id, score: recv_time, value: msg_id
```

* string 存储消息体。

  因为消息体数量较多，而且活跃时间比较短（因为大部分用户只关心最近接收的消息），所以把它独立出来。便于 timeout 后 redis 能删除节省内存。

```shell
key: msg_id, value: msg_body
```

* set 存储未读消息对象。

  每个用户都可能有 N 个群组，N 个好友。用户重新上线后，不可能遍历所有好友或群组对象。所以服务在处理离线消息时，需要记录未读消息对象。

```shell
key: uid, member:group_id/send_uid
```

---

## 3. database 设计

* 群组和群组成员关系

```shell
group_id, uid
```

* 消息结构

```shell
msg_id, group_id, send_uid, recv_uid,  recv_time, msg_body
```

---

## 4. 服务存储架构

即时通讯服务是读多写少类型。服务端有三层存储（如下图），通过热点数据的缓存，让服务高效读取。

* `msg server` 服务进程内存 `session` 缓存热点数据。
   缓存当前活跃的数据：头像信息，用户名称，消息实体等数据，缓存一般 5 - 30 分钟，根据具体的业务需要

* redis 第二层缓存热点数据。
   缓存大量的热点数据，减少对 db 的访问频率，缓存时间相对较长，几个月不等。

* database 数据落地。

![存储架构](/images/2020-02-25-08-16-18.png){: data-action="zoom"}

---

## 5. 数据读写时序

### 5.1. 写数据

![写逻辑](/images/2020-02-25-08-16-44.png){: data-action="zoom"}

---

### 5.2. 读数据

![读逻辑](/images/2020-02-25-08-17-14.png){: data-action="zoom"}

---

## 6. 总结

基于以上分析，群组消息，每个用户发送的消息，不需要针对每个群组成员存一条记录到数据库，数据库只需要存一条记录即可。通过多级缓存的架构，服务的性能一般体量的消息实时通讯是没有问题的。当然这里面还有很多细节问题需要在实际的业务场景中调优。

---

## 7. 问题

### 7.1. redis 故障

redis 故障会<font color=red>丢数据</font>：

* 主从数据异步复制，所以主从数据并非强一致。
* redis 高性能的数据持久化策略并不能使数据实时落地（数据实时落地的配置没有性能可言）。

综上所述，redis 重启或故障转移，会出现少量数据丢失的现象。

---

### 7.2. 故障分析

1. redis 丢失了哪些数据。
2. 哪些用户会丢失数据。

---

* redis aof 持久化策略，默认每秒存盘一次，主库重启，主库最多丢一秒数据。
* redis 主从复制，一般情况丢失积压缓冲区数据，从库丢失的数据可能就几秒钟数据。
* redis 主从复制，极端情况下主从失去联系，主库一直在写，从库得不到数据更新，这个可以配置，主库如果与从库失去连接，到达一定的时间就禁止写。

```shell
# redis.conf
min-replicas-to-write xxx
min-replicas-max-lag xxx
```

综上所述，我们会发现，丢失的数据，大概率是几秒钟。

---

哪些用户会丢失数据？那些离线没有取消息的用户。推拉结合，当我们发现用户离线，应该进行离线推送，推送数据生产到消息队列，等待消费。离线推送并非实时（1 分钟以内可以接受），后台推送数据，会根据当前推送数据，重新检查 redis，redis 没有，会重新回写，这样 redis 丢失的数据，就能通过推送，重新填充。

> 推送失败消息（例如 redis 故障了，在推送执行的时候，redis 仍然没起来），记录下来，等待下次推。

---

如果当 redis 和消息队列同时故障呢？😅。。。告警？从数据库日志流水里，捞一些数据出来恢复？或者大家可以考虑一下另外一个解决方案：mongodb，它保证数据最终一致性。

---

> 🔥 文章来源：[《即时通讯（IM）- 千人群组消息管理》](https://wenfh2020.com/2019/11/14/im-group-msg-mgr/)
>
> 👍 大家觉得文章对你有些作用！ 如果想 <font color=green>赞赏</font>，可以用微信扫描下面的二维码，感谢!
<div align=center><img src="/images/2020-08-06-15-49-47.png" width="120"/></div>

