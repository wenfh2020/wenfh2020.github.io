I">Ô<p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œçµæ´»å¤„ç†ä¸åŒé•¿åº¦èŒƒå›´çš„å­—ç¬¦ä¸²ï¼Œredis å®šä¹‰äº†å‡ ç§ <code class="highlighter-rouge">sdshdr(X)</code> æ•°æ®ç»“æ„ï¼Œå¯¹ä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²æ•°æ®è¿›è¡Œå­˜å‚¨ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-æ•°æ®ç»“æ„" id="markdown-toc-1-æ•°æ®ç»“æ„">1. æ•°æ®ç»“æ„</a>    <ul>
      <li><a href="#11-sds-æ•°æ®ç»“æ„è§†å›¾" id="markdown-toc-11-sds-æ•°æ®ç»“æ„è§†å›¾">1.1. sds æ•°æ®ç»“æ„è§†å›¾</a></li>
      <li><a href="#12-ç»“æ„å¤§å°" id="markdown-toc-12-ç»“æ„å¤§å°">1.2. ç»“æ„å¤§å°</a></li>
    </ul>
  </li>
  <li><a href="#2-æ ¸å¿ƒæ¥å£" id="markdown-toc-2-æ ¸å¿ƒæ¥å£">2. æ ¸å¿ƒæ¥å£</a></li>
  <li><a href="#3-å·¥ä½œæµç¨‹" id="markdown-toc-3-å·¥ä½œæµç¨‹">3. å·¥ä½œæµç¨‹</a></li>
  <li><a href="#4-åè®°" id="markdown-toc-4-åè®°">4. åè®°</a></li>
</ul>

<h2 id="1-æ•°æ®ç»“æ„">1. æ•°æ®ç»“æ„</h2>

<p><img src="/images/2020-02-20-16-48-09.png" alt="æ•°æ®ç»“æ„å†…å­˜" data-action="zoom" /></p>

<p>ä¸ºäº†èŠ‚çœå†…å­˜ç©ºé—´ï¼Œçµæ´»å¤„ç†ä¸åŒé•¿åº¦èŒƒå›´çš„å­—ç¬¦ä¸²</p>

<ul>
  <li>redis å®šä¹‰äº†<code class="highlighter-rouge">sdshdr(X)</code>å‡ ç§æ•°æ®ç»“æ„ï¼Œå¯ä»¥æŸ¥çœ‹<code class="highlighter-rouge">æ•°æ®ç»“æ„å¤§å°</code>ã€‚</li>
  <li>åŒæ—¶ struct æ•°æ®ç»“æ„æ²¡æœ‰è¿›è¡Œå†…å­˜å¯¹é½ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sds</span><span class="p">;</span>
<span class="cp">#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))
#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));
</span>
<span class="cm">/* Note: sdshdr5 is never used, we just access the flags byte directly.
 * However is here to document the layout of type 5 SDS strings. */</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr5</span> <span class="p">{</span>
    <span class="c1">// å½“å­—ç¬¦ä¸²å¾ˆå°æ—¶ï¼Œ `flags` æ˜¯ä¸€ä¸ª8 ä¸ªå­—èŠ‚çš„ç»„åˆå­—ç¬¦ï¼Œå‰ 3 bit æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œåé¢5bitæ˜¯å­—ç¬¦ä¸²é•¿åº¦ã€‚</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, and 5 msb of string length */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr8</span> <span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* used */</span>
    <span class="kt">uint8_t</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* excluding the header and null terminator */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, 5 unused bits */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr16</span> <span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* used */</span>
    <span class="kt">uint16_t</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* excluding the header and null terminator */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, 5 unused bits */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr32</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* used */</span>
    <span class="kt">uint32_t</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* excluding the header and null terminator */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, 5 unused bits */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr64</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* used */</span>
    <span class="kt">uint64_t</span> <span class="n">alloc</span><span class="p">;</span> <span class="cm">/* excluding the header and null terminator */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, 5 unused bits */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">len</td>
      <td style="text-align: left">å½“å‰å·²ä½¿ç”¨çš„å†…å­˜ç©ºé—´é•¿åº¦</td>
    </tr>
    <tr>
      <td style="text-align: left">alloc</td>
      <td style="text-align: left">åˆ†é…çš„å†…å­˜ç©ºé—´é•¿åº¦</td>
    </tr>
    <tr>
      <td style="text-align: left">flags</td>
      <td style="text-align: left">æ•°æ®ç»“æ„ç±»å‹ æˆ–è€… ï¼ˆæ•°æ®ç»“æ„ç±»å‹ + å­—ç¬¦ä¸²é•¿åº¦ ä¾‹å¦‚ï¼šsdshdr5ï¼‰</td>
    </tr>
    <tr>
      <td style="text-align: left">buf</td>
      <td style="text-align: left">uf å¦‚æœæœ‰æ•°æ®ï¼Œæ˜¯ä»¥ â€˜\0â€™ ç»“æŸçš„å­—ç¬¦ä¸²ã€‚</td>
    </tr>
  </tbody>
</table>

<h3 id="11-sds-æ•°æ®ç»“æ„è§†å›¾">1.1. sds æ•°æ®ç»“æ„è§†å›¾</h3>

<p><img src="/images/2020-02-20-16-48-09.png" alt="æ•°æ®ç»“æ„å†…å­˜" data-action="zoom" /></p>

<blockquote>
  <p>åˆ¶ä½œå›¾è¡¨æ–¹æ³•å¯ä»¥ç”¨ processonï¼Œå‚è€ƒè§†é¢‘</p>

  <ul>
    <li>bilibili: <a href="https://www.bilibili.com/video/av83487454/">ç»˜åˆ¶ redis sds æ•°æ®ç»“æ„å†…å­˜ç©ºé—´è§†å›¾</a></li>
    <li>youtube: <a href="https://youtu.be/eT_qW3-q8no">Draw Redis SDS Struct Memmory Chart</a></li>
  </ul>
</blockquote>

<h3 id="12-ç»“æ„å¤§å°">1.2. ç»“æ„å¤§å°</h3>

<p>å¯ä»¥é€šè¿‡å‡½æ•° <code class="highlighter-rouge">sdsReqType</code> çŸ¥é“ï¼Œsds æ•°æ®ç»“æ„ï¼Œæ˜¯æ ¹æ®æ•°æ®é•¿åº¦èŒƒå›´å»ç¡®å®šæ•°æ®ç»“æ„ç±»å‹çš„ã€‚ä¸‹é¢åˆ—å‡ºçš„æ•°æ®ç»“æ„çš„æ¯”è¾ƒã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">ç»“æ„ç±»å‹</th>
      <th style="text-align: left">å¤§å°</th>
      <th style="text-align: left">å­—ç¬¦ä¸²é•¿åº¦</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">sdshdr5</td>
      <td style="text-align: left">1</td>
      <td style="text-align: left">1 Â«Â 5 - 1</td>
    </tr>
    <tr>
      <td style="text-align: left">sdshdr8</td>
      <td style="text-align: left">3</td>
      <td style="text-align: left">1 Â«Â 8 - 1</td>
    </tr>
    <tr>
      <td style="text-align: left">sdshdr16</td>
      <td style="text-align: left">5</td>
      <td style="text-align: left">1 Â«Â 16 - 1</td>
    </tr>
    <tr>
      <td style="text-align: left">sdshdr32</td>
      <td style="text-align: left">9</td>
      <td style="text-align: left">1 Â«Â 32 - 1</td>
    </tr>
    <tr>
      <td style="text-align: left">sdshdr64</td>
      <td style="text-align: left">17</td>
      <td style="text-align: left">å¤§äº 1 Â«Â 32</td>
    </tr>
  </tbody>
</table>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="nf">sdsReqType</span><span class="p">(</span><span class="kt">size_t</span> <span class="n">string_size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">string_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span>
        <span class="c1">// 1 &lt;&lt; 5 == 32ï¼Œæ‰€ä»¥é•¿åº¦æœ€å¤§ 31ï¼ŒäºŒè¿›åˆ¶ 11111ï¼Œå  5 ä½ã€‚ç»“åˆæ•°æ®ç»“æ„å¯ä»¥æŸ¥çœ‹ flags çš„ç»„åˆï¼Œå·¦ç§» 5 ä½ï¼Œå­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ï¼Œå³è¾¹3ä½å­˜å‚¨å­—ç¬¦ä¸²é•¿åº¦ã€‚</span>
        <span class="k">return</span> <span class="n">SDS_TYPE_5</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">string_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SDS_TYPE_8</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">string_size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">16</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SDS_TYPE_16</span><span class="p">;</span>
<span class="cp">#if (LONG_MAX == LLONG_MAX)
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">string_size</span> <span class="o">&lt;</span> <span class="mi">1ll</span><span class="o">&lt;&lt;</span><span class="mi">32</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">SDS_TYPE_32</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">SDS_TYPE_64</span><span class="p">;</span>
<span class="cp">#else
</span>    <span class="k">return</span> <span class="n">SDS_TYPE_32</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ä¾‹å¦‚ sdshdr32 æ•°æ®ç»“æ„ï¼Œ sizeof(sdshdr32) == 9 ï¼Œå¦‚æœæ˜¯å­—èŠ‚å¯¹é½ï¼Œåº”è¯¥ 12 æ‰å¯¹ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">__attribute__</span><span class="p">((</span><span class="n">__packed__</span><span class="p">))</span> <span class="n">sdshdr32</span> <span class="p">{</span>
    <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">;</span>        <span class="cm">/* used */</span>
    <span class="kt">uint32_t</span> <span class="n">alloc</span><span class="p">;</span>      <span class="cm">/* excluding the header and null terminator */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span><span class="p">;</span> <span class="cm">/* 3 lsb of type, 5 unused bits */</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[];</span>
<span class="p">};</span>
</code></pre></div></div>

<hr />

<h2 id="2-æ ¸å¿ƒæ¥å£">2. æ ¸å¿ƒæ¥å£</h2>

<p>sds ä¸»è¦çš„é€»è¾‘æ˜¯å¯¹å­—ç¬¦ä¸²å†…å­˜ç®¡ç†ã€‚å¯ä»¥å‚è€ƒä¸‹é¢æ¥å£è¿›è¡Œç†è§£ã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æ¥å£</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">sdsnew</td>
      <td style="text-align: left">åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡</td>
    </tr>
    <tr>
      <td style="text-align: left">sdsfree</td>
      <td style="text-align: left">é‡Šæ”¾å­—ç¬¦ä¸²ç»“æ„å¯¹è±¡</td>
    </tr>
    <tr>
      <td style="text-align: left">sdsavail</td>
      <td style="text-align: left">æŸ¥è¯¢å­—ç¬¦ä¸²å¯¹è±¡ç©ºé—²å†…å­˜å¤§å°</td>
    </tr>
    <tr>
      <td style="text-align: left">sdsnewlen</td>
      <td style="text-align: left">æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ†é…åˆé€‚çš„å†…å­˜ç©ºé—´ï¼Œè®¾ç½®æ•°æ®ç»“æ„çš„ç›¸å…³çš„æˆå‘˜æ•°æ®</td>
    </tr>
    <tr>
      <td style="text-align: left">sdsMakeRoomFor</td>
      <td style="text-align: left">ä¸ºå¯¹è±¡åˆ†é…å¢é•¿çš„ç©ºé—´ï¼Œå¢é•¿å°äº 1Mï¼Œ newlen *= 2ï¼Œå¦åˆ™  newlen += SDS_MAX_PREALLOC</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-å·¥ä½œæµç¨‹">3. å·¥ä½œæµç¨‹</h2>

<p>æˆ‘ä»¬ä¾æ—§å¯ä»¥ç”¨ gdb å¯¹ sds è¿›è¡Œè°ƒè¯•ï¼Œç†Ÿæ‚‰å®ƒå¯¹å·¥ä½œæµç¨‹ã€‚ä½œè€…åœ¨ sds.c æ–‡ä»¶å°±è®¾ç½®äº†æµ‹è¯•å®<code class="highlighter-rouge">SDS_TEST_MAIN</code>ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–è¯‘ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè°ƒè¯•ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-g</span>  <span class="nt">-DSDS_TEST_MAIN</span> sds.c zmalloc.c <span class="nt">-o</span> sds
</code></pre></div></div>

<blockquote>
  <p>è°ƒè¯•æ–¹æ³•ï¼Œå¯ä»¥å‚è€ƒè§†é¢‘</p>

  <ul>
    <li>bilibili: <a href="https://www.bilibili.com/video/av83332533/">Debug Redis sds with Gdb</a></li>
    <li>youtube: <a href="https://youtu.be/_buPUWclhU0">Debug Redis sds with Gdb</a></li>
  </ul>
</blockquote>

<ul>
  <li>å †æ ˆä¿¡æ¯</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#0  sdsnewlen (init=0x100006a71, initlen=3) at sds.c:99</span>
<span class="c">#1  0x00000001000018a6 in sdsnew (init=0x100006a71 "foo") at sds.c:156</span>
<span class="c">#2  0x0000000100004cb7 in sdsTest () at sds.c:1130</span>
<span class="c">#3  0x0000000100006124 in main () at sds.c:1294</span>
</code></pre></div></div>

<ul>
  <li>sdsnewlen æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œç”¨ä¸åŒæ•°æ®ç»“æ„è¿›è¡Œå­˜å‚¨ï¼Œæ¯ä¸ªæ•°æ®ç»“æ„æœ‰ä¸åŒç±»å‹ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Create a new sds string starting from a null terminated C string. */</span>
<span class="n">sds</span> <span class="nf">sdsnew</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">initlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">init</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">strlen</span><span class="p">(</span><span class="n">init</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sdsnewlen</span><span class="p">(</span><span class="n">init</span><span class="p">,</span> <span class="n">initlen</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ ¹æ®å­—ç¬¦ä¸²é•¿åº¦ï¼Œåˆ†é…åˆé€‚çš„å†…å­˜ç©ºé—´ï¼Œè®¾ç½®æ•°æ®ç»“æ„çš„ç›¸å…³çš„æˆå‘˜æ•°æ®</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Create a new sds string with the content specified by the 'init' pointer
 * and 'initlen'.
 * If NULL is used for 'init' the string is initialized with zero bytes.
 * If SDS_NOINIT is used, the buffer is left uninitialized;
 *
 * The string is always null-termined (all the sds strings are, always) so
 * even if you create an sds string with:
 *
 * mystring = sdsnewlen("abc",3);
 *
 * You can print the string with printf() as there is an implicit \0 at the
 * end of the string. However the string is binary safe and can contain
 * \0 characters in the middle, as the length is stored in the sds header. */</span>
<span class="n">sds</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">init</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">initlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">sh</span><span class="p">;</span>
    <span class="n">sds</span> <span class="n">s</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">type</span> <span class="o">=</span> <span class="n">sdsReqType</span><span class="p">(</span><span class="n">initlen</span><span class="p">);</span>
    <span class="cm">/* Empty strings are usually created in order to append. Use type 8
     * since type 5 is not good at this. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDS_TYPE_5</span> <span class="o">&amp;&amp;</span> <span class="n">initlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">type</span> <span class="o">=</span> <span class="n">SDS_TYPE_8</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">sdsHdrSize</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span> <span class="cm">/* flags pointer. */</span>

    <span class="c1">// ç”³è¯·æ•°æ®ç»“æ„å†…å­˜ã€‚+ 1 æ˜¯ä¸ºäº†å­—ç¬¦ä¸²çš„ç»“æŸç¬¦ '\0'ã€‚</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="n">s_malloc</span><span class="p">(</span><span class="n">hdrlen</span><span class="o">+</span><span class="n">initlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="o">==</span><span class="n">SDS_NOINIT</span><span class="p">)</span>
        <span class="n">init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdrlen</span><span class="o">+</span><span class="n">initlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">sh</span><span class="o">+</span><span class="n">hdrlen</span><span class="p">;</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_5</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">// SDS_TYPE_BITS </span>
            <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">type</span> <span class="o">|</span> <span class="p">(</span><span class="n">initlen</span> <span class="o">&lt;&lt;</span> <span class="n">SDS_TYPE_BITS</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_8</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_16</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_32</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_64</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">initlen</span><span class="p">;</span>
            <span class="o">*</span><span class="n">fp</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">initlen</span> <span class="o">&amp;&amp;</span> <span class="n">init</span><span class="p">)</span>
        <span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="n">initlen</span><span class="p">);</span>
    <span class="n">s</span><span class="p">[</span><span class="n">initlen</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è·å–å­—ç¬¦ä¸²é•¿åº¦</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define SDS_TYPE_5_LEN(f) ((f)&gt;&gt;SDS_TYPE_BITS)
</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">sdslen</span><span class="p">(</span><span class="k">const</span> <span class="n">sds</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">SDS_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_5</span><span class="p">:</span>
            <span class="c1">// ä¸€ä¸ªå­—èŠ‚é«˜ 5 ä½æ˜¯é•¿åº¦ï¼Œé€šè¿‡å‘å³ç§»åŠ¨ 3 ä½è·å¾—å¤§å°ã€‚</span>
            <span class="k">return</span> <span class="n">SDS_TYPE_5_LEN</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_8</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SDS_HDR</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_16</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SDS_HDR</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SDS_HDR</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">SDS_HDR</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">s</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>é‡Šæ”¾å†…å­˜ï¼Œå› ä¸º sds struct æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜æ•°æ®ç»“æ„ï¼Œæ ¹æ® sds æŒ‡å‘çš„ bufï¼Œå¾€å›æ‰¾ struct çš„èµ·å§‹åœ°å€ï¼Œè¿›è¡Œé‡Šæ”¾ã€‚</li>
</ul>

<blockquote>
  <p>çœ‹çœ‹ <code class="highlighter-rouge">sdsnewlen</code> æ˜¯å¦‚ä½•ç”³è¯·å†…å­˜çš„ã€‚</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Free an sds string. No operation is performed if 's' is NULL. */</span>
<span class="kt">void</span> <span class="nf">sdsfree</span><span class="p">(</span><span class="n">sds</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
    <span class="n">s_free</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-</span><span class="n">sdsHdrSize</span><span class="p">(</span><span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]));</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sdsHdrSize</span><span class="p">(</span><span class="kt">char</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">type</span><span class="o">&amp;</span><span class="n">SDS_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_5</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdshdr5</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_8</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdshdr8</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_16</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdshdr16</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_32</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdshdr32</span><span class="p">);</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_64</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdshdr64</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æŸ¥è¯¢æ•°æ®ç»“æ„å¤šå°‘ç©ºé—²å†…å­˜ç©ºé—´</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kr">inline</span> <span class="kt">size_t</span> <span class="nf">sdsavail</span><span class="p">(</span><span class="k">const</span> <span class="n">sds</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
    <span class="k">switch</span><span class="p">(</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">SDS_TYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_5</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1">// å°äº 32 é•¿åº¦çš„å†…å­˜ï¼Œéƒ½æ˜¯ç›´æ¥ç”³è¯·çš„ï¼Œæ²¡æœ‰ç©ºä½™å†…å­˜ã€‚</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_8</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">-</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_16</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">-</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_32</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">-</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">case</span> <span class="n">SDS_TYPE_64</span><span class="p">:</span> <span class="p">{</span>
            <span class="n">SDS_HDR_VAR</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span><span class="n">s</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">alloc</span> <span class="o">-</span> <span class="n">sh</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è¿½åŠ å†…å­˜</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Append the specified null termianted C string to the sds string 's'.
 *
 * After the call, the passed sds string is no longer valid and all the
 * references must be substituted with the new pointer returned by the call. */</span>
<span class="n">sds</span> <span class="nf">sdscat</span><span class="p">(</span><span class="n">sds</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">t</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>redis sds ä¹ æƒ¯å…ˆæ ¹æ®é•¿åº¦ï¼Œåˆ†é…åˆé€‚çš„å†…å­˜ï¼Œå†è¿›è¡Œæ•°æ®æ‹·è´ç­‰æ“ä½œã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Append the specified binary-safe string pointed by 't' of 'len' bytes to the
 * end of the specified sds string 's'.
 *
 * After the call, the passed sds string is no longer valid and all the
 * references must be substituted with the new pointer returned by the call. */</span>
<span class="n">sds</span> <span class="nf">sdscatlen</span><span class="p">(</span><span class="n">sds</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">curlen</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

    <span class="c1">// æ ¹æ®å½“å‰æ•°æ®å’Œè¿½åŠ çš„æ•°æ®ï¼Œåˆ†é…åˆé€‚é•¿åº¦çš„å†…å­˜èµ„æºã€‚</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">sdsMakeRoomFor</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">+</span><span class="n">curlen</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">sdssetlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">curlen</span><span class="o">+</span><span class="n">len</span><span class="p">);</span>
    <span class="n">s</span><span class="p">[</span><span class="n">curlen</span><span class="o">+</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ ¹æ®å¢é•¿çš„é•¿åº¦ï¼Œä¸º sds ç”³è¯·åˆé€‚é•¿åº¦çš„ç©ºé—´ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Enlarge the free space at the end of the sds string so that the caller
 * is sure that after calling this function can overwrite up to addlen
 * bytes after the end of the string, plus one more byte for nul term.
 *
 * Note: this does not change the *length* of the sds string as returned
 * by sdslen(), but only the free buffer space we have. */</span>
<span class="n">sds</span> <span class="nf">sdsMakeRoomFor</span><span class="p">(</span><span class="n">sds</span> <span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">addlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">sh</span><span class="p">,</span> <span class="o">*</span><span class="n">newsh</span><span class="p">;</span>
    <span class="c1">// è·å–å‰©ä½™çš„å†…å­˜</span>
    <span class="kt">size_t</span> <span class="n">avail</span> <span class="o">=</span> <span class="n">sdsavail</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span> <span class="n">newlen</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">type</span><span class="p">,</span> <span class="n">oldtype</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SDS_TYPE_MASK</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>

    <span class="cm">/* Return ASAP if there is enough space left. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">avail</span> <span class="o">&gt;=</span> <span class="n">addlen</span><span class="p">)</span> <span class="k">return</span> <span class="n">s</span><span class="p">;</span>

    <span class="n">len</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="n">sh</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-</span><span class="n">sdsHdrSize</span><span class="p">(</span><span class="n">oldtype</span><span class="p">);</span>
    <span class="n">newlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span><span class="o">+</span><span class="n">addlen</span><span class="p">);</span>
    <span class="c1">// å°äº 1 M å†…å­˜çš„ç¿»å€å¢åŠ ï¼Œå¦åˆ™æ¯æ¬¡å¢åŠ  1M</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">newlen</span> <span class="o">&lt;</span> <span class="n">SDS_MAX_PREALLOC</span><span class="p">)</span>
        <span class="n">newlen</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">else</span>
        <span class="n">newlen</span> <span class="o">+=</span> <span class="n">SDS_MAX_PREALLOC</span><span class="p">;</span>

    <span class="n">type</span> <span class="o">=</span> <span class="n">sdsReqType</span><span class="p">(</span><span class="n">newlen</span><span class="p">);</span>

    <span class="c1">// å¦‚æœå°æ•°æ®ï¼Œé‡åˆ° cat æ“ä½œï¼Œç±»å‹å‡çº§åˆ° SDS_TYPE_8ï¼Œæ–¹ä¾¿ cat çš„åç»­æ“ä½œã€‚è¿™é‡Œä½œè€…ä¼°è®¡æ˜¯æ ¹æ®å¾ˆå¤šåœºæ™¯ç»“åˆçš„ç»éªŒå¾—å‡ºçš„ç»“è®ºã€‚</span>
    <span class="cm">/* Don't use type 5: the user is appending to the string and type 5 is
     * not able to remember empty space, so sdsMakeRoomFor() must be called
     * at every appending operation. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDS_TYPE_5</span><span class="p">)</span> <span class="n">type</span> <span class="o">=</span> <span class="n">SDS_TYPE_8</span><span class="p">;</span>

    <span class="c1">// æ ¹æ®å¯¹åº”ç±»å‹çš„å¯¹è±¡ç”³è¯·ç›¸åº”çš„ç©ºé—´ã€‚</span>
    <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">sdsHdrSize</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">oldtype</span><span class="o">==</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">newsh</span> <span class="o">=</span> <span class="n">s_realloc</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">hdrlen</span><span class="o">+</span><span class="n">newlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newsh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">newsh</span><span class="o">+</span><span class="n">hdrlen</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Since the header size changes, need to move the string forward,
         * and can't use realloc */</span>
        <span class="n">newsh</span> <span class="o">=</span> <span class="n">s_malloc</span><span class="p">(</span><span class="n">hdrlen</span><span class="o">+</span><span class="n">newlen</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">newsh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">newsh</span><span class="o">+</span><span class="n">hdrlen</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
        <span class="n">s_free</span><span class="p">(</span><span class="n">sh</span><span class="p">);</span>
        <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">newsh</span><span class="o">+</span><span class="n">hdrlen</span><span class="p">;</span>
        <span class="n">s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
        <span class="n">sdssetlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">sdssetalloc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">newlen</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ç©ºæ•°æ®ç»“æ„ <code class="highlighter-rouge">sdsempty()</code>ï¼Œä¸€äº›ä¸å®šé•¿çš„å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ <code class="highlighter-rouge">sdscatprintf</code>ï¼Œæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼Œç»å¸¸æ€§æœ‰å¾ˆé•¿çš„å­—ç¬¦ä¸²ã€‚æ‰€ä»¥åœ¨ <code class="highlighter-rouge">sdsnewlen</code> ä¸­ç»™ç”³è¯· <code class="highlighter-rouge">SDS_TYPE_8</code> ç±»å‹è¿›è¡Œå¤„ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sds</span> <span class="nf">sdsnewlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">init</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">initlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDS_TYPE_5</span> <span class="o">&amp;&amp;</span> <span class="n">initlen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">type</span> <span class="o">=</span> <span class="n">SDS_TYPE_8</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å»æ‰å­—ç¬¦ä¸²å¤´å°¾å‡ºç°åœ¨å­—ä¸²çš„æ‰€æœ‰å­—ç¬¦</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Remove the part of the string from left and from right composed just of
 * contiguous characters found in 'cset', that is a null terminted C string.
 *
 * After the call, the modified sds string is no longer valid and all the
 * references must be substituted with the new pointer returned by the call.
 *
 * Example:
 *
 * s = sdsnew("AA...AA.a.aa.aHelloWorld     :::");
 * s = sdstrim(s,"Aa. :");
 * printf("%s\n", s);
 *
 * Output will be just "HelloWorld".
 */</span>
<span class="n">sds</span> <span class="nf">sdstrim</span><span class="p">(</span><span class="n">sds</span> <span class="n">s</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cset</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="p">,</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

    <span class="c1">// é€šè¿‡ä¸¤æ¬¡éå†ï¼Œä»å¤´å‘å°¾ï¼Œ</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">start</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">end</span> <span class="o">=</span> <span class="n">s</span><span class="o">+</span><span class="n">sdslen</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">sp</span> <span class="o">&lt;=</span> <span class="n">end</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cset</span><span class="p">,</span> <span class="o">*</span><span class="n">sp</span><span class="p">))</span> <span class="n">sp</span><span class="o">++</span><span class="p">;</span>
    <span class="k">while</span><span class="p">(</span><span class="n">ep</span> <span class="o">&gt;</span> <span class="n">sp</span> <span class="o">&amp;&amp;</span> <span class="n">strchr</span><span class="p">(</span><span class="n">cset</span><span class="p">,</span> <span class="o">*</span><span class="n">ep</span><span class="p">))</span> <span class="n">ep</span><span class="o">--</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">sp</span> <span class="o">&gt;</span> <span class="n">ep</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">ep</span><span class="o">-</span><span class="n">sp</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="n">sp</span><span class="p">)</span> <span class="n">memmove</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
    <span class="n">s</span><span class="p">[</span><span class="n">len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\0'</span><span class="p">;</span>
    <span class="n">sdssetlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>ä¸¤ä¸ª sds å­—ç¬¦ä¸²æ¯”è¾ƒ</li>
</ul>

<blockquote>
  <p>å–æœ€çŸ­å­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œè¯¥é•¿åº¦çš„ä¸¤ä¸ªå­—ç¬¦ä¸²ç›¸æ¯”è¾ƒï¼Œåœ¨è¿™ä¸ªæ¡ä»¶åŸºç¡€ä¸Šï¼Œå¯¹ä½™ä¸‹å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒã€‚è¿”å›ç›¸åº”ç»“æœã€‚</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Compare two sds strings s1 and s2 with memcmp().
 *
 * Return value:
 *
 *     positive if s1 &gt; s2.
 *     negative if s1 &lt; s2.
 *     0 if s1 and s2 are exactly the same binary string.
 *
 * If two strings share exactly the same prefix, but one of the two has
 * additional characters, the longer string is considered to be greater than
 * the smaller one. */</span>
<span class="kt">int</span> <span class="nf">sdscmp</span><span class="p">(</span><span class="k">const</span> <span class="n">sds</span> <span class="n">s1</span><span class="p">,</span> <span class="k">const</span> <span class="n">sds</span> <span class="n">s2</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span> <span class="n">minlen</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">cmp</span><span class="p">;</span>

    <span class="n">l1</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">s1</span><span class="p">);</span>
    <span class="n">l2</span> <span class="o">=</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">s2</span><span class="p">);</span>
    <span class="n">minlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">l2</span><span class="p">)</span> <span class="o">?</span> <span class="n">l1</span> <span class="o">:</span> <span class="n">l2</span><span class="p">;</span>
    <span class="n">cmp</span> <span class="o">=</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="n">minlen</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">l1</span> <span class="o">&gt;</span> <span class="n">l2</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="p">(</span><span class="n">l1</span> <span class="o">&lt;</span> <span class="n">l2</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">cmp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-åè®°">4. åè®°</h2>

<p>æºç èµ°è¯»ç³»åˆ—ï¼Œé€šè¿‡è°ƒè¯•æ‰‹æ®µï¼Œèµ°è¯»æºç ï¼Œæ˜¯è‡ªå·±æµæ°´è´¦å¼çš„è®°å½•ï¼Œä»è€Œç†è§£äº†æ›´å¤šçš„å®ç°ç»†èŠ‚ã€‚</p>
:ET