I"ë7<p>é˜…è¯»æºç å‰ï¼Œå…ˆäº†è§£ redis ä¸»ä»å¤åˆ¶çš„åŸºæœ¬çŸ¥è¯†ã€‚</p>

<blockquote>
  <p>è¯¦ç»†æºç åˆ†æï¼Œè¯·å‚è€ƒä¸‹ä¸€ç« ï¼š<a href="https://wenfh2020.com/2020/05/31/redis-replication-next/">[redis æºç èµ°è¯»] ä¸»ä»æ•°æ®å¤åˆ¶ï¼ˆä¸‹ï¼‰
</a></p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-å¤åˆ¶æ¨¡å¼" id="markdown-toc-1-å¤åˆ¶æ¨¡å¼">1. å¤åˆ¶æ¨¡å¼</a></li>
  <li><a href="#2-é…ç½®" id="markdown-toc-2-é…ç½®">2. é…ç½®</a></li>
  <li><a href="#3-å®¢æˆ·ç«¯å‘½ä»¤" id="markdown-toc-3-å®¢æˆ·ç«¯å‘½ä»¤">3. å®¢æˆ·ç«¯å‘½ä»¤</a>    <ul>
      <li><a href="#31-replicaof" id="markdown-toc-31-replicaof">3.1. replicaof</a></li>
      <li><a href="#32-info" id="markdown-toc-32-info">3.2. info</a></li>
    </ul>
  </li>
  <li><a href="#4-å¤åˆ¶" id="markdown-toc-4-å¤åˆ¶">4. å¤åˆ¶</a>    <ul>
      <li><a href="#41-å¤åˆ¶æ–¹å¼" id="markdown-toc-41-å¤åˆ¶æ–¹å¼">4.1. å¤åˆ¶æ–¹å¼</a></li>
      <li><a href="#42-è¯·æ±‚å¤åˆ¶å‚æ•°" id="markdown-toc-42-è¯·æ±‚å¤åˆ¶å‚æ•°">4.2. è¯·æ±‚å¤åˆ¶å‚æ•°</a></li>
    </ul>
  </li>
  <li><a href="#5-ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹" id="markdown-toc-5-ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹">5. ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹</a>    <ul>
      <li><a href="#51-slave-1270016379" id="markdown-toc-51-slave-1270016379">5.1. slave (127.0.0.1:6379)</a></li>
      <li><a href="#52-master-12700116379" id="markdown-toc-52-master-12700116379">5.2. master (127.0.0.1:16379)</a></li>
    </ul>
  </li>
</ul>

<hr />

<h2 id="1-å¤åˆ¶æ¨¡å¼">1. å¤åˆ¶æ¨¡å¼</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># Master-Replica replication. Use replicaof to make a Redis instance a copy of</span>
<span class="c"># another Redis server. A few things to understand ASAP about Redis replication.</span>
<span class="c">#</span>
<span class="c">#   +------------------+      +---------------+</span>
<span class="c">#   |      Master      | ---&gt; |    Replica    |</span>
<span class="c">#   | (receive writes) |      |  (exact copy) |</span>
<span class="c">#   +------------------+      +---------------+</span>
</code></pre></div></div>

<p>ä¸»ä»å¤åˆ¶ï¼Œæ•°æ®æ˜¯ç”± master å‘é€åˆ° slaveã€‚ä¸€èˆ¬æœ‰ä¸¤ç§æ¨¡å¼ï¼šä¸€ä¸»å¤šä»ï¼Œé“¾å¼ä¸»ä»ã€‚è¿™ä¸¤ç§å¤åˆ¶æ¨¡å¼å„æœ‰ä¼˜ç¼ºç‚¹ï¼š</p>

<ul>
  <li>A å›¾ï¼Œæ•°æ®å¤åˆ¶å®æ—¶æ€§æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯å¦‚æœ slave èŠ‚ç‚¹æ•°é‡å¤šäº†ï¼Œmaster å¤åˆ¶æ•°æ®é‡å°±ä¼šå¢å¤§ï¼Œç‰¹åˆ«æ˜¯å…¨é‡å¤åˆ¶åœºæ™¯ã€‚</li>
  <li>B å›¾ï¼ŒDï¼ŒE sub-slave èŠ‚ç‚¹æ•°æ®å¤åˆ¶å®æ—¶æ€§ç›¸å¯¹å·®ä¸€ç‚¹ï¼Œä½†æ˜¯èƒ½è§£å†³å¤šä¸ªä»èŠ‚ç‚¹ä¸‹ï¼Œmaster æ•°æ®å¤åˆ¶å‹åŠ›ï¼Œèƒ½æ”¯æ’‘ç³»ç»Ÿæ›´å¤§çš„è´Ÿè½½ã€‚</li>
</ul>

<p><img src="/images/2020-05-31-12-04-10.png" alt="ä¸»ä»å¤åˆ¶æ¨¡å¼" data-action="zoom" /></p>

<hr />

<h2 id="2-é…ç½®">2. é…ç½®</h2>

<p>redis.conf å¯¹åº” <code class="highlighter-rouge">REPLICATION</code> éƒ¨åˆ†ä¸»è¦é…ç½®é¡¹å†…å®¹ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æœåŠ¡å»ºç«‹ä¸»ä»å…³ç³»å‘½ä»¤ï¼Œè®¾ç½®è¯¥æœåŠ¡ä¸ºå…¶å®ƒæœåŠ¡çš„ slaveã€‚</span>
replicaof &lt;masterip&gt; &lt;masterport&gt;

<span class="c"># slaveæ˜¯å¦æ”¯æŒå†™å‘½ä»¤æ“ä½œã€‚</span>
replica-read-only <span class="nb">yes</span>

<span class="c"># ç§¯å‹ç¼“å†²åŒºå¤§å°ã€‚ç¼“å†²åŒºåœ¨ masterï¼Œslave æ–­çº¿é‡è¿åï¼Œå¦‚æœæ˜¯å¢é‡å¤åˆ¶ï¼Œmaster å°±ä»ç¼“å†²åŒºé‡Œå–å‡ºæ•°æ®å¤åˆ¶ç»™ slaveã€‚</span>
repl-backlog-size 1mb

<span class="c"># é˜²æ­¢è„‘è£‚è®¾ç½®ï¼Œå¯¹ slave çš„é“¾æ¥æ•°é‡å’Œ slave å¤åˆ¶ï¼ˆä¿æ´»ï¼‰æ—¶é—´é™åˆ¶ã€‚</span>
min-replicas-to-write 3
min-replicas-max-lag 10
</code></pre></div></div>

<hr />

<h2 id="3-å®¢æˆ·ç«¯å‘½ä»¤">3. å®¢æˆ·ç«¯å‘½ä»¤</h2>

<h3 id="31-replicaof">3.1. replicaof</h3>

<p>å®¢æˆ·ç«¯å‘½ä»¤ï¼š<code class="highlighter-rouge">replicaof</code> / <code class="highlighter-rouge">slaveof</code>ï¼Œå¯ä»¥ä½¿ä¸¤ä¸ª redis å®ä¾‹å®ç°ä¸»ä»å¤åˆ¶å…³ç³»ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å»ºç«‹ä¸»ä»å…³ç³»ã€‚</span>
replicaof &lt;masterip&gt; &lt;masterport&gt;

<span class="c"># å–æ¶ˆä¸»ä»å…³ç³»ã€‚</span>
replicaof no one
</code></pre></div></div>

<hr />

<p><a href="https://redis.io/commands/replicaof">replicaof</a> å’Œ <a href="https://redis.io/commands/slaveof">slaveof</a> å‘½ä»¤å®ç°æ–¹æ³•ç›¸åŒï¼Œä½†æ˜¯ä¸æ”¯æŒ redis <code class="highlighter-rouge">cluster</code> é›†ç¾¤æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// replicaof å’Œ slaveof å‘½ä»¤åŠŸèƒ½å®ç°ç›¸åŒã€‚</span>
<span class="k">struct</span> <span class="n">redisCommand</span> <span class="n">redisCommandTable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">{</span><span class="s">"slaveof"</span><span class="p">,</span><span class="n">replicaofCommand</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
     <span class="s">"admin no-script ok-stale"</span><span class="p">,</span>
     <span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>

    <span class="p">{</span><span class="s">"replicaof"</span><span class="p">,</span><span class="n">replicaofCommand</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
     <span class="s">"admin no-script ok-stale"</span><span class="p">,</span>
     <span class="mi">0</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// ä¸æ”¯æŒ cluster é›†ç¾¤æ¨¡å¼ã€‚</span>
<span class="kt">void</span> <span class="nf">replicaofCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"REPLICAOF not allowed in cluster mode."</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="32-info">3.2. info</h3>

<p><a href="https://redis.io/commands/info">info</a> å‘½ä»¤å¯ä»¥æŸ¥è¯¢ä¸»ä»å‰¯æœ¬çš„ç›¸å…³å±æ€§ä¿¡æ¯ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>into replication
</code></pre></div></div>

<hr />

<h2 id="4-å¤åˆ¶">4. å¤åˆ¶</h2>

<h3 id="41-å¤åˆ¶æ–¹å¼">4.1. å¤åˆ¶æ–¹å¼</h3>

<p>ä¸»ä»æ•°æ®å¤åˆ¶ï¼Œæœ‰ä¸‰ç§æ–¹å¼ï¼š</p>

<ol>
  <li>å…¨é‡æ•°æ®å¤åˆ¶ï¼Œå½“ slave ç¬¬ä¸€æ¬¡ä¸ master é“¾æ¥æˆ– slave ä¸ master æ–­å¼€é“¾æ¥å¾ˆä¹…ï¼Œé‡æ–°é“¾æ¥åï¼Œä¸»ä»æ•°æ®ä¸¥é‡ä¸ä¸€è‡´äº†ï¼Œéœ€è¦å…¨éƒ¨æ•°æ®è¿›è¡Œå¤åˆ¶ã€‚</li>
  <li>å¢é‡æ•°æ®å¤åˆ¶ï¼Œslave å› ä¸ºç½‘ç»œæŠ–åŠ¨æˆ–å…¶å®ƒåŸå› ï¼Œä¸ master æ–­å¼€ä¸€æ®µæ—¶é—´ï¼Œé‡æ–°é“¾æ¥ï¼Œå‘ç°ä¸»ä»æ•°æ®å·®å¼‚ä¸å¤§ï¼Œmaster åªéœ€è¦å¤åˆ¶å¢åŠ éƒ¨åˆ†æ•°æ®å³å¯ã€‚</li>
  <li>æ­£å¸¸é“¾æ¥æ•°æ®å¤åˆ¶ï¼Œä¸»ä»æˆåŠŸé“¾æ¥ï¼Œåœ¨å·¥ä½œè¿‡ç¨‹ä¸­ï¼Œmaster æ•°æ®æœ‰å˜åŒ–ï¼Œå¼‚æ­¥å¤åˆ¶åˆ° slaveã€‚</li>
</ol>

<hr />

<h3 id="42-è¯·æ±‚å¤åˆ¶å‚æ•°">4.2. è¯·æ±‚å¤åˆ¶å‚æ•°</h3>

<p>é‡ç‚¹çœ‹çœ‹ <code class="highlighter-rouge">PSYNC</code> ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹ï¼Œslave æ•°æ®å¤åˆ¶è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š</p>

<ul>
  <li>å‘è°è¦æ•°æ®ï¼Œ&lt;repild&gt; å‰¯æœ¬ idï¼Œmaster é€šè¿‡å‰¯æœ¬ id æ ‡è¯†è‡ªå·±ã€‚</li>
  <li>è¦å¤šå°‘æ•°æ®ï¼Œ&lt;offset&gt; æ•°æ®åç§»é‡ï¼Œslave ä¿å­˜çš„åç§»é‡å’Œ master ä¿å­˜çš„åç§»é‡ä¹‹é—´çš„æ•°æ®å·®ï¼Œå°±æ˜¯éœ€è¦å¤åˆ¶çš„å¢é‡æ•°æ®ã€‚</li>
</ul>

<p>æ‰€ä»¥ slave ä¿å­˜äº†ä¸€ä»½ master æ•°æ®ï¼šmaster çš„ &lt;master_repild&gt; å’Œ æ•°æ®åç§»é‡ &lt;master_offset&gt;ã€‚ä¸»ä»æ•°æ®å¤åˆ¶æ˜¯å¼‚æ­¥æ“ä½œï¼Œä¸»ä»æ•°æ®å¹¶éä¸¥æ ¼ä¸€è‡´ï¼Œæœ‰ä¸€å®šå»¶æ—¶ã€‚å½“ä¸»ä»æ–­å¼€é“¾æ¥ï¼Œslave é‡æ–°é“¾æ¥ masterï¼Œéœ€è¦é€šè¿‡åè®®ï¼Œä¼ é€’ &lt;replid&gt;  å’Œ &lt;offset&gt; ç»™ masterã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PSYNC &lt;master_replid&gt; &lt;master_offset&gt;
</code></pre></div></div>

<p>ç¬¬ä¸€æ¬¡é“¾æ¥ï¼Œslave è¿˜æ²¡æœ‰ master çš„æ•°æ®ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PSYNC ? <span class="nt">-1</span>
</code></pre></div></div>

<hr />

<h2 id="5-ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹">5. ä¸»ä»æ•°æ®å¤åˆ¶æµç¨‹</h2>

<p>Linux å¹³å°å¯ä»¥é€šè¿‡ <code class="highlighter-rouge">strace</code> æŠ“åŒ…ï¼Œè§‚å¯Ÿä¸»ä»æ•°æ®å¤åˆ¶å·¥ä½œæµç¨‹ã€‚</p>

<p>å®¢æˆ·ç«¯ client å°† redis-server1 è®¾ç½®æˆ redis-server2 çš„å‰¯æœ¬ã€‚</p>

<ul>
  <li>(<strong>slave</strong>) redis-server1: ç«¯å£ 6379</li>
  <li>(<strong>master</strong>) redis-server2: ç«¯å£ 16379</li>
  <li>client</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># é“¾æ¥ 6379 ç«¯å£æœåŠ¡ã€‚</span>
./src/redis-cli <span class="nt">-h</span> 127.0.0.1 <span class="nt">-p</span> 6379

<span class="c"># è®¾ç½®ä¸»ä»å…³ç³»ã€‚</span>
replicaof 127.0.0.1 16379
</code></pre></div></div>

<p><img src="/images/2020-05-31-10-16-02.png" alt="redis å…¨é‡å¤åˆ¶æµç¨‹" data-action="zoom" /></p>

<hr />

<h3 id="51-slave-1270016379">5.1. slave (127.0.0.1:6379)</h3>

<ul>
  <li>strace æŸ¥çœ‹åº•å±‚é€šä¿¡æµç¨‹ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># strace æŠ“å–åº•å±‚é€šä¿¡æ¥å£çš„è°ƒç”¨ã€‚</span>
strace <span class="nt">-p</span> 19836 <span class="nt">-s</span> 512 <span class="nt">-o</span> /tmp/connect.slave

<span class="c"># å¤ªå¤šæ—¶é—´æ¥å£è°ƒç”¨äº†ã€‚å¯ä»¥é€šè¿‡ sed è¿‡æ»¤è¿™äº›æ•°æ®ã€‚</span>
<span class="nb">sed</span> <span class="s1">'/gettimeofday/d'</span> /tmp/connect.slave <span class="o">&gt;</span>  /tmp/connect.slave.bak
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="c"># slave æ¥æ”¶åˆ° client å‘é€çš„ replicaof å‘½ä»¤ã€‚</span>
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$9</span><span class="se">\r\n</span><span class="s2">replicaof</span><span class="se">\r\n</span><span class="nv">$9</span><span class="se">\r\n</span><span class="s2">127.0.0.1</span><span class="se">\r\n</span><span class="nv">$5</span><span class="se">\r\n</span><span class="s2">16379</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 45
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:07.745 * Before turning into a replica, using my own master parameters to synthesize a cached master: I may be able to synchronize with the new master with just a partial transfer.</span><span class="se">\n</span><span class="s2">"</span>, 207<span class="o">)</span> <span class="o">=</span> 207
getpeername<span class="o">(</span>7, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>13832<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, <span class="o">[</span>16]<span class="o">)</span> <span class="o">=</span> 0
<span class="c"># ç»™å®¢æˆ·ç«¯è¿”å› ackï¼ŒæœåŠ¡å¼€å§‹ä¸ master è¿›è¡Œé€šä¿¡è¿æ¥ã€‚</span>
write<span class="o">(</span>7, <span class="s2">"+OK</span><span class="se">\r\n</span><span class="s2">"</span>, 5<span class="o">)</span>                  <span class="o">=</span> 5
<span class="c"># -------------------------------------------</span>
epoll_wait<span class="o">(</span>5, <span class="o">[]</span>, 10128, 757<span class="o">)</span>           <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.507 * Connecting to MASTER 127.0.0.1:16379</span><span class="se">\n</span><span class="s2">"</span>, 72<span class="o">)</span> <span class="o">=</span> 72
<span class="c"># åˆ›å»ºéé˜»å¡ socketã€‚</span>
socket<span class="o">(</span>AF_INET, SOCK_STREAM, IPPROTO_TCP<span class="o">)</span> <span class="o">=</span> 8
setsockopt<span class="o">(</span>8, SOL_SOCKET, SO_REUSEADDR, <span class="o">[</span>1], 4<span class="o">)</span> <span class="o">=</span> 0
fcntl<span class="o">(</span>8, F_GETFL<span class="o">)</span>                       <span class="o">=</span> 0x2 <span class="o">(</span>flags O_RDWR<span class="o">)</span>
fcntl<span class="o">(</span>8, F_SETFL, O_RDWR|O_NONBLOCK<span class="o">)</span>    <span class="o">=</span> 0
<span class="nb">bind</span><span class="o">(</span>8, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>0<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> 0
<span class="c"># è¿æ¥ masterã€‚</span>
connect<span class="o">(</span>8, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>16379<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, 16<span class="o">)</span> <span class="o">=</span> <span class="nt">-1</span> EINPROGRESS <span class="o">(</span>Operation now <span class="k">in </span>progress<span class="o">)</span>
<span class="c"># è¿æ¥æˆåŠŸåå‘é€æ•°æ®ã€‚</span>
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_ADD, 8, <span class="o">{</span>EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}})</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.508 * MASTER &lt;-&gt; REPLICA sync started</span><span class="se">\n</span><span class="s2">"</span>, 67<span class="o">)</span> <span class="o">=</span> 67
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># ï¼Ÿ</span>
getsockopt<span class="o">(</span>8, SOL_SOCKET, SO_ERROR, <span class="o">[</span>0], <span class="o">[</span>4]<span class="o">)</span> <span class="o">=</span> 0
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_DEL, 8, 0x7fff69ce0c24<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.508 * Non blocking connect for SYNC fired the event.</span><span class="se">\n</span><span class="s2">"</span>, 82<span class="o">)</span> <span class="o">=</span> 82
<span class="c"># ç›‘å¬è¿æ¥æ˜¯å¦æœ‰å¯è¯»æ•°æ®ã€‚master å›å¤çš„æ•°æ®ã€‚</span>
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_ADD, 8, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}})</span> <span class="o">=</span> 0
<span class="c"># è¿æ¥æˆåŠŸåï¼Œèµ°æ¡æ‰‹æµç¨‹ã€‚å‘é€ 'PING'ã€‚</span>
write<span class="o">(</span>8, <span class="s2">"*1</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">PING</span><span class="se">\r\n</span><span class="s2">"</span>, 14<span class="o">)</span>    <span class="o">=</span> 14
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># master å›å¤ '+PONG'ã€‚</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"+"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"P"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"O"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"N"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"G"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.511 * Master replied to PING, replication can continue...</span><span class="se">\n</span><span class="s2">"</span>, 87<span class="o">)</span> <span class="o">=</span> 87
<span class="c"># å›å¤ master æœ¬æœåŠ¡ç›‘å¬çš„ç«¯å£ã€‚</span>
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$14</span><span class="se">\r\n</span><span class="s2">listening-port</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">6379</span><span class="se">\r\n</span><span class="s2">"</span>, 49<span class="o">)</span> <span class="o">=</span> 49
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 996<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># master å›å¤ç¡®è®¤ã€‚</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"+"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"O"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"K"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="c"># REPLCONF CAPA is used in order to notify masters that a slave is able to understand the new +CONTINUE reply.</span>
write<span class="o">(</span>8, <span class="s2">"*5</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">capa</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">eof</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">capa</span><span class="se">\r\n</span><span class="nv">$6</span><span class="se">\r\n</span><span class="s2">psync2</span><span class="se">\r\n</span><span class="s2">"</span>, 59<span class="o">)</span> <span class="o">=</span> 59
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 995<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"+"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"O"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"K"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.514 * Trying a partial resynchronization (request 48f9e4f8d75856f90b65299ce0c6ae57a8a69814:1).</span><span class="se">\n</span><span class="s2">"</span>, 124<span class="o">)</span> <span class="o">=</span> 124
<span class="c"># æˆåŠŸæ¡æ‰‹åï¼Œå‘é€å‘½ä»¤ psyncï¼Œï¼ˆæœåŠ¡ id + å½“å‰æ•°æ®åç§»é‡ï¼‰è¦æ±‚ master è¿›è¡Œæ•°æ®å¤åˆ¶å·¥ä½œã€‚</span>
<span class="c"># slaveTryPartialResynchronization(conn,0)</span>
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$5</span><span class="se">\r\n</span><span class="s2">PSYNC</span><span class="se">\r\n</span><span class="nv">$40</span><span class="se">\r\n</span><span class="s2">48f9e4f8d75856f90b65299ce0c6ae57a8a69814</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">1</span><span class="se">\r\n</span><span class="s2">"</span>, 69<span class="o">)</span> <span class="o">=</span> 69
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 993<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># master å›å¤ç¡®è®¤ '+FULLRESYNC'ï¼Œè¿›è¡Œå…¨é‡æ•°æ®å¤åˆ¶ã€‚(+FULLRESYNC &lt;replid&gt; &lt;offset&gt;)</span>
<span class="c"># reply = sendSynchronousCommand(SYNC_CMD_READ,conn,NULL);</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"+"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"F"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"U"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"L"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"L"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"R"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"E"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"S"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"Y"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"N"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"C"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">" "</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"d"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"2"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"b"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"d"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"c"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"2"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"2"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"b"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"5"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"6"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"7"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"3"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"d"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"b"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"a"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"7"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"4"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"3"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"f"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"7"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"6"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"6"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"9"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"8"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"4"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"e"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">" "</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"0"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="c"># connSetReadHandler(conn, NULL);</span>
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_DEL, 8, 0x7fff69ce0a74<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.531 * Full resync from master: d28bd808c0922b5679039db98a7493f76689084e:0</span><span class="se">\n</span><span class="s2">"</span>, 103<span class="o">)</span> <span class="o">=</span> 103
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.532 * Discarding previously cached master state.</span><span class="se">\n</span><span class="s2">"</span>, 78<span class="o">)</span> <span class="o">=</span> 78
<span class="c"># åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥æ”¶æ•°æ®ã€‚</span>
open<span class="o">(</span><span class="s2">"temp-1589928788.19836.rdb"</span>, O_WRONLY|O_CREAT|O_EXCL, 0644<span class="o">)</span> <span class="o">=</span> 9
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_ADD, 8, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}})</span> <span class="o">=</span> 0
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 976<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># æ¥æ”¶æ•°æ®é•¿åº¦ã€‚</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"$"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"2"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"7"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"6"</span>, 1<span class="o">)</span>                         <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\r</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span>, 1<span class="o">)</span>                        <span class="o">=</span> 1
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.799 * MASTER &lt;-&gt; REPLICA sync: receiving 276 bytes from master to disk</span><span class="se">\n</span><span class="s2">"</span>, 100<span class="o">)</span> <span class="o">=</span> 100
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 709<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># slave æ¥æ”¶ master å‘é€çš„æ•°æ®ã€‚</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"REDIS0009</span><span class="se">\3</span><span class="s2">72</span><span class="se">\t</span><span class="s2">redis-ver</span><span class="se">\0</span><span class="s2">075.9.104</span><span class="se">\3</span><span class="s2">72</span><span class="se">\n</span><span class="s2">redis-bits</span><span class="se">\3</span><span class="s2">00@</span><span class="se">\3</span><span class="s2">72</span><span class="se">\5</span><span class="s2">ctime</span><span class="se">\3</span><span class="s2">02Tc</span><span class="se">\3</span><span class="s2">04^</span><span class="se">\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">0used-mem</span><span class="se">\3</span><span class="s2">02</span><span class="se">\2</span><span class="s2">704</span><span class="se">\3</span><span class="s2">5</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">6repl-stream-db</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\7</span><span class="s2">repl-id(d28bd808c0922b5679039db98a7493f76689084e</span><span class="se">\3</span><span class="s2">72</span><span class="se">\v</span><span class="s2">repl-offset</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\f</span><span class="s2">aof-preamble</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">76</span><span class="se">\0\3</span><span class="s2">73</span><span class="se">\6\0\0\7</span><span class="s2">fsddf3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\0\3</span><span class="s2">fsf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\4</span><span class="s2">fsdf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\5</span><span class="s2">fsdf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\6</span><span class="s2">fsddf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\t</span><span class="s2">fsd44df3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\3</span><span class="s2">77Q</span><span class="se">\2</span><span class="s2">11</span><span class="se">\2</span><span class="s2">40</span><span class="se">\2</span><span class="s2">11</span><span class="se">\3</span><span class="s2">06</span><span class="se">\2</span><span class="s2">70</span><span class="se">\r</span><span class="s2">$"</span>, 276<span class="o">)</span> <span class="o">=</span> 276
<span class="c"># ä¿å­˜åœ¨æœ¬åœ°ä¸´æ—¶ rdb æ–‡ä»¶ã€‚</span>
write<span class="o">(</span>9, <span class="s2">"REDIS0009</span><span class="se">\3</span><span class="s2">72</span><span class="se">\t</span><span class="s2">redis-ver</span><span class="se">\0</span><span class="s2">075.9.104</span><span class="se">\3</span><span class="s2">72</span><span class="se">\n</span><span class="s2">redis-bits</span><span class="se">\3</span><span class="s2">00@</span><span class="se">\3</span><span class="s2">72</span><span class="se">\5</span><span class="s2">ctime</span><span class="se">\3</span><span class="s2">02Tc</span><span class="se">\3</span><span class="s2">04^</span><span class="se">\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">0used-mem</span><span class="se">\3</span><span class="s2">02</span><span class="se">\2</span><span class="s2">704</span><span class="se">\3</span><span class="s2">5</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">6repl-stream-db</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\7</span><span class="s2">repl-id(d28bd808c0922b5679039db98a7493f76689084e</span><span class="se">\3</span><span class="s2">72</span><span class="se">\v</span><span class="s2">repl-offset</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\f</span><span class="s2">aof-preamble</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">76</span><span class="se">\0\3</span><span class="s2">73</span><span class="se">\6\0\0\7</span><span class="s2">fsddf3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\0\3</span><span class="s2">fsf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\4</span><span class="s2">fsdf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\5</span><span class="s2">fsdf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\6</span><span class="s2">fsddf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\t</span><span class="s2">fsd44df3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\3</span><span class="s2">77Q</span><span class="se">\2</span><span class="s2">11</span><span class="se">\2</span><span class="s2">40</span><span class="se">\2</span><span class="s2">11</span><span class="se">\3</span><span class="s2">06</span><span class="se">\2</span><span class="s2">70</span><span class="se">\r</span><span class="s2">$"</span>, 276<span class="o">)</span> <span class="o">=</span> 276
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.800 * MASTER &lt;-&gt; REPLICA sync: Flushing old data</span><span class="se">\n</span><span class="s2">"</span>, 78<span class="o">)</span> <span class="o">=</span> 78
<span class="c"># åœ¨å¯¼å…¥æ•°æ®å‰ï¼Œå…ˆåˆ é™¤ fd è¯»äº‹ä»¶ï¼Œé¿å…äº‹ä»¶è§¦å‘å¼‚æ­¥å›è°ƒï¼Œå¯¼è‡´é€’å½’é‡å¤å¤„ç†é€»è¾‘ã€‚</span>
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_DEL, 8, 0x7fff69cdcb24<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.800 * MASTER &lt;-&gt; REPLICA sync: Loading DB in memory</span><span class="se">\n</span><span class="s2">"</span>, 81<span class="o">)</span> <span class="o">=</span> 81
open<span class="o">(</span><span class="s2">"dump.rdb"</span>, O_RDONLY|O_NONBLOCK<span class="o">)</span>   <span class="o">=</span> 10
<span class="c"># æ–°æ–‡ä»¶è¦†ç›–æ—§æ–‡ä»¶ã€‚</span>
rename<span class="o">(</span><span class="s2">"temp-1589928788.19836.rdb"</span>, <span class="s2">"dump.rdb"</span><span class="o">)</span> <span class="o">=</span> 0
futex<span class="o">(</span>0x7ac164, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x7ac160, <span class="o">{</span>FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1<span class="o">})</span> <span class="o">=</span> 1
futex<span class="o">(</span>0x7ac200, FUTEX_WAKE_PRIVATE, 1<span class="o">)</span>  <span class="o">=</span> 1
open<span class="o">(</span><span class="s2">"dump.rdb"</span>, O_RDONLY<span class="o">)</span>              <span class="o">=</span> 10
fstat<span class="o">(</span>10, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0644, <span class="nv">st_size</span><span class="o">=</span>276, ...<span class="o">})</span> <span class="o">=</span> 0
fstat<span class="o">(</span>10, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0644, <span class="nv">st_size</span><span class="o">=</span>276, ...<span class="o">})</span> <span class="o">=</span> 0
mmap<span class="o">(</span>NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, <span class="nt">-1</span>, 0<span class="o">)</span> <span class="o">=</span> 0x7f80929da000
<span class="c"># è¯»æ•°æ®åŠ è½½è¿›å…¥å†…å­˜ã€‚</span>
<span class="nb">read</span><span class="o">(</span>10, <span class="s2">"REDIS0009</span><span class="se">\3</span><span class="s2">72</span><span class="se">\t</span><span class="s2">redis-ver</span><span class="se">\0</span><span class="s2">075.9.104</span><span class="se">\3</span><span class="s2">72</span><span class="se">\n</span><span class="s2">redis-bits</span><span class="se">\3</span><span class="s2">00@</span><span class="se">\3</span><span class="s2">72</span><span class="se">\5</span><span class="s2">ctime</span><span class="se">\3</span><span class="s2">02Tc</span><span class="se">\3</span><span class="s2">04^</span><span class="se">\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">0used-mem</span><span class="se">\3</span><span class="s2">02</span><span class="se">\2</span><span class="s2">704</span><span class="se">\3</span><span class="s2">5</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">6repl-stream-db</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\7</span><span class="s2">repl-id(d28bd808c0922b5679039db98a7493f76689084e</span><span class="se">\3</span><span class="s2">72</span><span class="se">\v</span><span class="s2">repl-offset</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\f</span><span class="s2">aof-preamble</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">76</span><span class="se">\0\3</span><span class="s2">73</span><span class="se">\6\0\0\7</span><span class="s2">fsddf3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\0\3</span><span class="s2">fsf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\4</span><span class="s2">fsdf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\5</span><span class="s2">fsdf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\6</span><span class="s2">fsddf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\t</span><span class="s2">fsd44df3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\3</span><span class="s2">77Q</span><span class="se">\2</span><span class="s2">11</span><span class="se">\2</span><span class="s2">40</span><span class="se">\2</span><span class="s2">11</span><span class="se">\3</span><span class="s2">06</span><span class="se">\2</span><span class="s2">70</span><span class="se">\r</span><span class="s2">$"</span>, 4096<span class="o">)</span> <span class="o">=</span> 276
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.801 * Loading RDB produced by version 5.9.104</span><span class="se">\n</span><span class="s2">"</span>, 75<span class="o">)</span> <span class="o">=</span> 75
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.802 * RDB age 0 seconds</span><span class="se">\n</span><span class="s2">"</span>, 53<span class="o">)</span> <span class="o">=</span> 53
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.802 * RDB memory usage when created 1.83 Mb</span><span class="se">\n</span><span class="s2">"</span>, 73<span class="o">)</span> <span class="o">=</span> 73
close<span class="o">(</span>10<span class="o">)</span>                               <span class="o">=</span> 0
munmap<span class="o">(</span>0x7f80929da000, 4096<span class="o">)</span>            <span class="o">=</span> 0
close<span class="o">(</span>9<span class="o">)</span>                                <span class="o">=</span> 0
<span class="c"># rdb æ–‡ä»¶åŠ è½½è¿›å†…å­˜å®Œæˆï¼Œslave åˆ›å»º master çš„é“¾æ¥å¯¹è±¡ã€‚ replicationCreateMasterClient</span>
fcntl<span class="o">(</span>8, F_GETFL<span class="o">)</span>                       <span class="o">=</span> 0x802 <span class="o">(</span>flags O_RDWR|O_NONBLOCK<span class="o">)</span>
fcntl<span class="o">(</span>8, F_SETFL, O_RDWR|O_NONBLOCK<span class="o">)</span>    <span class="o">=</span> 0
setsockopt<span class="o">(</span>8, SOL_TCP, TCP_NODELAY, <span class="o">[</span>1], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>8, SOL_SOCKET, SO_KEEPALIVE, <span class="o">[</span>1], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>8, SOL_TCP, TCP_KEEPIDLE, <span class="o">[</span>300], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>8, SOL_TCP, TCP_KEEPINTVL, <span class="o">[</span>100], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>8, SOL_TCP, TCP_KEEPCNT, <span class="o">[</span>3], 4<span class="o">)</span> <span class="o">=</span> 0
<span class="c"># connSetReadHandler(server.master-&gt;conn, readQueryFromClient);</span>
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_ADD, 8, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}})</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19836:S 20 May 2020 06:53:08.804 * MASTER &lt;-&gt; REPLICA sync: Finished with success</span><span class="se">\n</span><span class="s2">"</span>, 82<span class="o">)</span> <span class="o">=</span> 82
epoll_wait<span class="o">(</span>5, <span class="o">[]</span>, 10128, 703<span class="o">)</span>           <span class="o">=</span> 0
<span class="c"># é€šçŸ¥ master æ•°æ®æ›´æ–°å®Œæ¯•ã€‚</span>
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 34<span class="o">)</span> <span class="o">=</span> 34
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 34<span class="o">)</span> <span class="o">=</span> 34
epoll_wait<span class="o">(</span>5, <span class="o">[]</span>, 10128, 999<span class="o">)</span>           <span class="o">=</span> 0
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 34<span class="o">)</span> <span class="o">=</span> 34
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>8, <span class="nv">u64</span><span class="o">=</span>8<span class="o">}}]</span>, 10128, 999<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># åŒæ–¹é“¾æ¥é€šè¿‡å¿ƒè·³ä¿æ´»ã€‚</span>
<span class="c"># master å‘é€ â€˜PINGâ€™</span>
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"*1</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">PING</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span>  <span class="o">=</span> 14
<span class="c"># å›å¤ 'ACK'ã€‚</span>
write<span class="o">(</span>8, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$2</span><span class="se">\r\n</span><span class="s2">14</span><span class="se">\r\n</span><span class="s2">"</span>, 35<span class="o">)</span> <span class="o">=</span> 35
</code></pre></div></div>

<hr />

<h3 id="52-master-12700116379">5.2. master (127.0.0.1:16379)</h3>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>strace <span class="nt">-p</span> 19831 <span class="nt">-s</span> 512 <span class="nt">-o</span> /tmp/connect.master
<span class="nb">sed</span> <span class="s1">'/gettimeofday/d'</span> /tmp/connect.master <span class="o">&gt;</span>  /tmp/connect.master.bak
</code></pre></div></div>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
<span class="c"># ç›‘å¬ socket æ¥æ”¶åˆ° slave çš„ connectã€‚</span>
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>6, <span class="nv">u64</span><span class="o">=</span>6<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
accept<span class="o">(</span>6, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>32795<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, <span class="o">[</span>16]<span class="o">)</span> <span class="o">=</span> 7
fcntl<span class="o">(</span>7, F_GETFL<span class="o">)</span>                       <span class="o">=</span> 0x2 <span class="o">(</span>flags O_RDWR<span class="o">)</span>
fcntl<span class="o">(</span>7, F_SETFL, O_RDWR|O_NONBLOCK<span class="o">)</span>    <span class="o">=</span> 0
<span class="c"># è®¾ç½®å¼‚æ­¥é€šä¿¡å’Œä¿æ´»ã€‚</span>
setsockopt<span class="o">(</span>7, SOL_TCP, TCP_NODELAY, <span class="o">[</span>1], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>7, SOL_SOCKET, SO_KEEPALIVE, <span class="o">[</span>1], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>7, SOL_TCP, TCP_KEEPIDLE, <span class="o">[</span>300], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>7, SOL_TCP, TCP_KEEPINTVL, <span class="o">[</span>100], 4<span class="o">)</span> <span class="o">=</span> 0
setsockopt<span class="o">(</span>7, SOL_TCP, TCP_KEEPCNT, <span class="o">[</span>3], 4<span class="o">)</span> <span class="o">=</span> 0
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_ADD, 7, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}})</span> <span class="o">=</span> 0
accept<span class="o">(</span>6, 0x7ffeac017080, 0x7ffeac01707c<span class="o">)</span> <span class="o">=</span> <span class="nt">-1</span> EAGAIN <span class="o">(</span>Resource temporarily unavailable<span class="o">)</span>
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 284<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># æ¥æ”¶åˆ° slave çš„ 'PING'</span>
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*1</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">PING</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span>  <span class="o">=</span> 14
<span class="c"># å›å¤ 'PONG'</span>
write<span class="o">(</span>7, <span class="s2">"+PONG</span><span class="se">\r\n</span><span class="s2">"</span>, 7<span class="o">)</span>                <span class="o">=</span> 7
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 283<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># replconfCommandã€‚</span>
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$14</span><span class="se">\r\n</span><span class="s2">listening-port</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">6379</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 49
<span class="c"># å›å¤ã€‚</span>
write<span class="o">(</span>7, <span class="s2">"+OK</span><span class="se">\r\n</span><span class="s2">"</span>, 5<span class="o">)</span>                  <span class="o">=</span> 5
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 281<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># slave å›å¤ï¼Œæ”¯æŒæ–°åè®®ã€‚(REPLCONF CAPA is used in order to notify masters that a slave is able to understand the new +CONTINUE reply.)</span>
<span class="c"># replconfCommand</span>
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*5</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">capa</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">eof</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">capa</span><span class="se">\r\n</span><span class="nv">$6</span><span class="se">\r\n</span><span class="s2">psync2</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 59
write<span class="o">(</span>7, <span class="s2">"+OK</span><span class="se">\r\n</span><span class="s2">"</span>, 5<span class="o">)</span>                  <span class="o">=</span> 5
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 280<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># æ¥æ”¶ slave çš„ 'PSYNC' å‘½ä»¤ã€‚</span>
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$5</span><span class="se">\r\n</span><span class="s2">PSYNC</span><span class="se">\r\n</span><span class="nv">$40</span><span class="se">\r\n</span><span class="s2">48f9e4f8d75856f90b65299ce0c6ae57a8a69814</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">1</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 69
getpeername<span class="o">(</span>7, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>32795<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, <span class="o">[</span>16]<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.515 * Replica 127.0.0.1:6379 asks for synchronization</span><span class="se">\n</span><span class="s2">"</span>, 83<span class="o">)</span> <span class="o">=</span> 83
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.516 * Partial resynchronization not accepted: Replication ID mismatch (Replica asked for '48f9e4f8d75856f90b65299ce0c6ae57a8a69814', my replication IDs are '667662257ed2a295ae15f5a3b92c93fb535ece50' and '0000000000000000000000000000000000000000')</span><span class="se">\n</span><span class="s2">"</span>, 276<span class="o">)</span> <span class="o">=</span> 276
mmap<span class="o">(</span>NULL, 2621440, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS|MAP_NORESERVE, <span class="nt">-1</span>, 0<span class="o">)</span> <span class="o">=</span> 0x7fe7db452000
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.516 * Starting BGSAVE for SYNC with target: disk</span><span class="se">\n</span><span class="s2">"</span>, 78<span class="o">)</span> <span class="o">=</span> 78
pipe<span class="o">([</span>8, 9]<span class="o">)</span>                            <span class="o">=</span> 0
fcntl<span class="o">(</span>8, F_GETFL<span class="o">)</span>                       <span class="o">=</span> 0 <span class="o">(</span>flags O_RDONLY<span class="o">)</span>
fcntl<span class="o">(</span>8, F_SETFL, O_RDONLY|O_NONBLOCK<span class="o">)</span>  <span class="o">=</span> 0
<span class="c"># fork å­è¿›ç¨‹è¿›è¡Œå¼‚æ­¥å­˜å‚¨ rdb å¿«ç…§ã€‚</span>
clone<span class="o">(</span><span class="nv">child_stack</span><span class="o">=</span>0, <span class="nv">flags</span><span class="o">=</span>CLONE_CHILD_CLEARTID|CLONE_CHILD_SETTID|SIGCHLD, <span class="nv">child_tidptr</span><span class="o">=</span>0x7fe7e5346250<span class="o">)</span> <span class="o">=</span> 19934
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.518 * Background saving started by pid 19934</span><span class="se">\n</span><span class="s2">"</span>, 74<span class="o">)</span> <span class="o">=</span> 74
<span class="c"># å›å¤å…¨é‡å‘é€ã€‚</span>
write<span class="o">(</span>7, <span class="s2">"+FULLRESYNC d28bd808c0922b5679039db98a7493f76689084e 0</span><span class="se">\r\n</span><span class="s2">"</span>, 56<span class="o">)</span> <span class="o">=</span> 56
epoll_wait<span class="o">(</span>5, 0x7fe7e4127d80, 10128, 274<span class="o">)</span> <span class="o">=</span> <span class="nt">-1</span> EINTR <span class="o">(</span>Interrupted system call<span class="o">)</span>
<span class="nt">---</span> SIGCHLD <span class="o">{</span><span class="nv">si_signo</span><span class="o">=</span>SIGCHLD, <span class="nv">si_code</span><span class="o">=</span>CLD_EXITED, <span class="nv">si_pid</span><span class="o">=</span>19934, <span class="nv">si_uid</span><span class="o">=</span>0, <span class="nv">si_status</span><span class="o">=</span>0, <span class="nv">si_utime</span><span class="o">=</span>0, <span class="nv">si_stime</span><span class="o">=</span>0<span class="o">}</span> <span class="nt">---</span>
futex<span class="o">(</span>0x7fe7e420738c, FUTEX_WAKE_OP_PRIVATE, 1, 1, 0x7fe7e4207388, <span class="o">{</span>FUTEX_OP_SET, 0, FUTEX_OP_CMP_GT, 1<span class="o">})</span> <span class="o">=</span> 1
futex<span class="o">(</span>0x7fe7e42073f8, FUTEX_WAKE_PRIVATE, 1<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># fork è¿›ç¨‹å­˜å‚¨ rdb å¿«ç…§å®Œæˆã€‚å…³é—­å­è¿›ç¨‹ã€‚</span>
wait4<span class="o">(</span><span class="nt">-1</span>, <span class="o">[{</span>WIFEXITED<span class="o">(</span>s<span class="o">)</span> <span class="o">&amp;&amp;</span> WEXITSTATUS<span class="o">(</span>s<span class="o">)</span> <span class="o">==</span> 0<span class="o">}]</span>, WNOHANG, NULL<span class="o">)</span> <span class="o">=</span> 19934
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.795 * Background saving terminated with success</span><span class="se">\n</span><span class="s2">"</span>, 77<span class="o">)</span> <span class="o">=</span> 77
<span class="c"># æ‰“å¼€ rdb æ–‡ä»¶ï¼Œè¯»å–æ•°æ®ã€‚</span>
open<span class="o">(</span><span class="s2">"dump.rdb"</span>, O_RDONLY<span class="o">)</span>              <span class="o">=</span> 10
<span class="c"># è¯»å–æ–‡ä»¶å¤§å°ä¸º 276 byteã€‚</span>
fstat<span class="o">(</span>10, <span class="o">{</span><span class="nv">st_mode</span><span class="o">=</span>S_IFREG|0644, <span class="nv">st_size</span><span class="o">=</span>276, ...<span class="o">})</span> <span class="o">=</span> 0
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_MOD, 7, <span class="o">{</span>EPOLLIN|EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}})</span> <span class="o">=</span> 0
<span class="nb">read</span><span class="o">(</span>8, <span class="s2">"</span><span class="se">\0\0\0\0\0\0\0\0\0</span><span class="s2">@</span><span class="se">\4\0\0\0\0\0</span><span class="s2">xV4</span><span class="se">\2</span><span class="s2">2z</span><span class="se">\3</span><span class="s2">32}</span><span class="se">\3</span><span class="s2">01"</span>, 24<span class="o">)</span> <span class="o">=</span> 24
close<span class="o">(</span>8<span class="o">)</span>                                <span class="o">=</span> 0
close<span class="o">(</span>9<span class="o">)</span>                                <span class="o">=</span> 0
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 999<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># å…ˆå‘é€æ–‡ä»¶é•¿åº¦ï¼Œåœ¨å‘é€æ•°æ®ã€‚</span>
write<span class="o">(</span>7, <span class="s2">"</span><span class="nv">$276</span><span class="se">\r\n</span><span class="s2">"</span>, 6<span class="o">)</span>                 <span class="o">=</span> 6
lseek<span class="o">(</span>10, 0, SEEK_SET<span class="o">)</span>                  <span class="o">=</span> 0
<span class="c"># ä» rdb æ–‡ä»¶ä¸­è¯»æ•°æ®è¿›è¡Œå‘é€ã€‚</span>
<span class="nb">read</span><span class="o">(</span>10, <span class="s2">"REDIS0009</span><span class="se">\3</span><span class="s2">72</span><span class="se">\t</span><span class="s2">redis-ver</span><span class="se">\0</span><span class="s2">075.9.104</span><span class="se">\3</span><span class="s2">72</span><span class="se">\n</span><span class="s2">redis-bits</span><span class="se">\3</span><span class="s2">00@</span><span class="se">\3</span><span class="s2">72</span><span class="se">\5</span><span class="s2">ctime</span><span class="se">\3</span><span class="s2">02Tc</span><span class="se">\3</span><span class="s2">04^</span><span class="se">\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">0used-mem</span><span class="se">\3</span><span class="s2">02</span><span class="se">\2</span><span class="s2">704</span><span class="se">\3</span><span class="s2">5</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">6repl-stream-db</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\7</span><span class="s2">repl-id(d28bd808c0922b5679039db98a7493f76689084e</span><span class="se">\3</span><span class="s2">72</span><span class="se">\v</span><span class="s2">repl-offset</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\f</span><span class="s2">aof-preamble</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">76</span><span class="se">\0\3</span><span class="s2">73</span><span class="se">\6\0\0\7</span><span class="s2">fsddf3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\0\3</span><span class="s2">fsf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\4</span><span class="s2">fsdf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\5</span><span class="s2">fsdf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\6</span><span class="s2">fsddf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\t</span><span class="s2">fsd44df3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\3</span><span class="s2">77Q</span><span class="se">\2</span><span class="s2">11</span><span class="se">\2</span><span class="s2">40</span><span class="se">\2</span><span class="s2">11</span><span class="se">\3</span><span class="s2">06</span><span class="se">\2</span><span class="s2">70</span><span class="se">\r</span><span class="s2">$"</span>, 16384<span class="o">)</span> <span class="o">=</span> 276
<span class="c"># å‘é€æ•°æ®ç»™ slaveã€‚</span>
write<span class="o">(</span>7, <span class="s2">"REDIS0009</span><span class="se">\3</span><span class="s2">72</span><span class="se">\t</span><span class="s2">redis-ver</span><span class="se">\0</span><span class="s2">075.9.104</span><span class="se">\3</span><span class="s2">72</span><span class="se">\n</span><span class="s2">redis-bits</span><span class="se">\3</span><span class="s2">00@</span><span class="se">\3</span><span class="s2">72</span><span class="se">\5</span><span class="s2">ctime</span><span class="se">\3</span><span class="s2">02Tc</span><span class="se">\3</span><span class="s2">04^</span><span class="se">\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">0used-mem</span><span class="se">\3</span><span class="s2">02</span><span class="se">\2</span><span class="s2">704</span><span class="se">\3</span><span class="s2">5</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\1</span><span class="s2">6repl-stream-db</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\7</span><span class="s2">repl-id(d28bd808c0922b5679039db98a7493f76689084e</span><span class="se">\3</span><span class="s2">72</span><span class="se">\v</span><span class="s2">repl-offset</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">72</span><span class="se">\f</span><span class="s2">aof-preamble</span><span class="se">\3</span><span class="s2">00</span><span class="se">\0\3</span><span class="s2">76</span><span class="se">\0\3</span><span class="s2">73</span><span class="se">\6\0\0\7</span><span class="s2">fsddf3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\0\3</span><span class="s2">fsf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\4</span><span class="s2">fsdf</span><span class="se">\4</span><span class="s2">fdsf</span><span class="se">\0\5</span><span class="s2">fsdf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\6</span><span class="s2">fsddf3</span><span class="se">\1</span><span class="s2">0fdsffdsf</span><span class="se">\0\t</span><span class="s2">fsd44df3a</span><span class="se">\t</span><span class="s2">fddsffdsf</span><span class="se">\3</span><span class="s2">77Q</span><span class="se">\2</span><span class="s2">11</span><span class="se">\2</span><span class="s2">40</span><span class="se">\2</span><span class="s2">11</span><span class="se">\3</span><span class="s2">06</span><span class="se">\2</span><span class="s2">70</span><span class="se">\r</span><span class="s2">$"</span>, 276<span class="o">)</span> <span class="o">=</span> 276
close<span class="o">(</span>10<span class="o">)</span>                               <span class="o">=</span> 0
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_MOD, 7, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}})</span> <span class="o">=</span> 0
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_MOD, 7, <span class="o">{</span>EPOLLIN|EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}})</span> <span class="o">=</span> 0
getpeername<span class="o">(</span>7, <span class="o">{</span><span class="nv">sa_family</span><span class="o">=</span>AF_INET, <span class="nv">sin_port</span><span class="o">=</span>htons<span class="o">(</span>32795<span class="o">)</span>, <span class="nv">sin_addr</span><span class="o">=</span>inet_addr<span class="o">(</span><span class="s2">"127.0.0.1"</span><span class="o">)}</span>, <span class="o">[</span>16]<span class="o">)</span> <span class="o">=</span> 0
write<span class="o">(</span>1, <span class="s2">"19831:M 20 May 2020 06:53:08.798 * Synchronization with replica 127.0.0.1:6379 succeeded</span><span class="se">\n</span><span class="s2">"</span>, 89<span class="o">)</span> <span class="o">=</span> 89
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLOUT, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 998<span class="o">)</span> <span class="o">=</span> 1
epoll_ctl<span class="o">(</span>5, EPOLL_CTL_MOD, 7, <span class="o">{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}})</span> <span class="o">=</span> 0
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 998<span class="o">)</span> <span class="o">=</span> 1
<span class="c"># master æ¥æ”¶ slave çš„å¿ƒè·³ã€‚</span>
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 34
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 34
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$1</span><span class="se">\r\n</span><span class="s2">0</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 34
write<span class="o">(</span>7, <span class="s2">"*1</span><span class="se">\r\n</span><span class="nv">$4</span><span class="se">\r\n</span><span class="s2">PING</span><span class="se">\r\n</span><span class="s2">"</span>, 14<span class="o">)</span>    <span class="o">=</span> 14
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 1000<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$2</span><span class="se">\r\n</span><span class="s2">14</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 35
epoll_wait<span class="o">(</span>5, <span class="o">[{</span>EPOLLIN, <span class="o">{</span><span class="nv">u32</span><span class="o">=</span>7, <span class="nv">u64</span><span class="o">=</span>7<span class="o">}}]</span>, 10128, 999<span class="o">)</span> <span class="o">=</span> 1
<span class="nb">read</span><span class="o">(</span>7, <span class="s2">"*3</span><span class="se">\r\n</span><span class="nv">$8</span><span class="se">\r\n</span><span class="s2">REPLCONF</span><span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="s2">ACK</span><span class="se">\r\n</span><span class="nv">$2</span><span class="se">\r\n</span><span class="s2">14</span><span class="se">\r\n</span><span class="s2">"</span>, 16384<span class="o">)</span> <span class="o">=</span> 35
...
</code></pre></div></div>

<p>ä¸Šé¢ä¸»è¦é€šè¿‡ <code class="highlighter-rouge">strace</code> æŠ“åŒ…ï¼Œæè¿°äº†å…¨é‡å¤åˆ¶çš„æµç¨‹ã€‚å…¶å®ƒåœºæ™¯ä¹Ÿä¸€æ ·å¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•ï¼Œç†Ÿæ‚‰å®ƒä»¬çš„å·¥ä½œæµç¨‹ã€‚</p>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/05/17/redis-replication/">wenfh2020.com</a></p>
</blockquote>
:ET