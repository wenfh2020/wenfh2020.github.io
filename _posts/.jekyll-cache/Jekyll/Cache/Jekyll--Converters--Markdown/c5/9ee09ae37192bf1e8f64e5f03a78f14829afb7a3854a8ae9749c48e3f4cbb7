I"¼Ç<p>aof (Append Only File) æ˜¯ redis æŒä¹…åŒ–çš„å…¶ä¸­ä¸€ç§æ–¹å¼ã€‚</p>

<p>æœåŠ¡å™¨æ¥æ”¶çš„æ¯ä¸ªå†™å…¥æ“ä½œå‘½ä»¤ï¼Œéƒ½ä¼šè¿½åŠ è®°å½•åˆ° aof æ–‡ä»¶æœ«å°¾ï¼Œå½“æœåŠ¡å™¨é‡æ–°å¯åŠ¨æ—¶ï¼Œè®°å½•çš„å‘½ä»¤ä¼šé‡æ–°è½½å…¥åˆ°æœåŠ¡å™¨å†…å­˜è¿˜åŸæ•°æ®ã€‚è¿™ä¸€ç« æˆ‘ä»¬èµ°è¯»ä¸€ä¸‹æºç ï¼Œçœ‹çœ‹ aof æŒä¹…åŒ–çš„æ•°æ®ç»“æ„å’Œåº”ç”¨åœºæ™¯æ˜¯æ€æ ·çš„ã€‚</p>

<blockquote>
  <p>ä¸»è¦æºç é€»è¾‘åœ¨ <code class="highlighter-rouge">aof.c</code> æ–‡ä»¶ä¸­ã€‚</p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-å¼€å¯-aof-æŒä¹…åŒ–æ¨¡å¼" id="markdown-toc-1-å¼€å¯-aof-æŒä¹…åŒ–æ¨¡å¼">1. å¼€å¯ aof æŒä¹…åŒ–æ¨¡å¼</a></li>
  <li><a href="#2-ç»“æ„" id="markdown-toc-2-ç»“æ„">2. ç»“æ„</a>    <ul>
      <li><a href="#21-aof-æ–‡ä»¶ç»“æ„" id="markdown-toc-21-aof-æ–‡ä»¶ç»“æ„">2.1. aof æ–‡ä»¶ç»“æ„</a></li>
      <li><a href="#22-aof-å’Œ-rdb-æ··åˆç»“æ„" id="markdown-toc-22-aof-å’Œ-rdb-æ··åˆç»“æ„">2.2. aof å’Œ rdb æ··åˆç»“æ„</a></li>
    </ul>
  </li>
  <li><a href="#3-æŒä¹…åŒ–ç­–ç•¥" id="markdown-toc-3-æŒä¹…åŒ–ç­–ç•¥">3. æŒä¹…åŒ–ç­–ç•¥</a>    <ul>
      <li><a href="#31-ç­–ç•¥" id="markdown-toc-31-ç­–ç•¥">3.1. ç­–ç•¥</a></li>
      <li><a href="#32-æµç¨‹åŸç†" id="markdown-toc-32-æµç¨‹åŸç†">3.2. æµç¨‹åŸç†</a></li>
      <li><a href="#33-ç­–ç•¥å®ç°" id="markdown-toc-33-ç­–ç•¥å®ç°">3.3. ç­–ç•¥å®ç°</a></li>
    </ul>
  </li>
  <li><a href="#4-å¼‚æ­¥æŒä¹…åŒ–" id="markdown-toc-4-å¼‚æ­¥æŒä¹…åŒ–">4. å¼‚æ­¥æŒä¹…åŒ–</a></li>
</ul>

<hr />

<p>åœ¨äº†è§£ redis æŒä¹…åŒ–åŠŸèƒ½å‰ï¼Œå¯ä»¥å…ˆçœ‹çœ‹ redis ä½œè€…è¿™ä¸¤ç¯‡æ–‡ç« ï¼š</p>

<ul>
  <li><a href="https://redis.io/topics/persistence#how-durable-is-the-append-only-file">Redis Persistence</a></li>
  <li><a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">Redis persistence demystified</a></li>
</ul>

<blockquote>
  <p>é“¾æ¥å¯èƒ½è¢«å¢™ï¼Œå¯ä»¥ç”¨å›½å†…æœç´¢å¼•æ“æœç´¢ä¸‹å¯¹åº”çš„æ–‡ç« é¢˜ç›®ã€‚</p>
</blockquote>

<hr />

<h2 id="1-å¼€å¯-aof-æŒä¹…åŒ–æ¨¡å¼">1. å¼€å¯ aof æŒä¹…åŒ–æ¨¡å¼</h2>

<p>å¯ä»¥çœ‹ä¸€ä¸‹ <a href="https://github.com/antirez/redis/blob/unstable/redis.conf">redis.conf</a> æœ‰å…³ aof æŒä¹…åŒ–é…ç½®ï¼Œæœ‰redis ä½œè€…ä¸°å¯Œçš„æ³¨é‡Šå†…å®¹ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># æŒä¹…åŒ–æ–¹å¼ (yes - aof) / (no - rdb)</span>
appendonly <span class="nb">yes</span>

<span class="c"># aof æ–‡ä»¶åï¼Œé»˜è®¤ "appendonly.aof"</span>
appendfilename <span class="s2">"appendonly.aof"</span>
</code></pre></div></div>

<hr />

<h2 id="2-ç»“æ„">2. ç»“æ„</h2>

<h3 id="21-aof-æ–‡ä»¶ç»“æ„">2.1. aof æ–‡ä»¶ç»“æ„</h3>

<p><img src="/images/2020-03-28-15-38-27.png" alt="aof æ–‡ä»¶ç»“æ„" data-action="zoom" /></p>

<p><strong>aof æ–‡ä»¶å¯ä»¥ç”± redis åè®®å‘½ä»¤ç»„æˆæ–‡æœ¬æ–‡ä»¶</strong>ã€‚ ç¬¬ä¸€æ¬¡å¯åŠ¨ redisï¼Œæ‰§è¡Œç¬¬ä¸€ä¸ªå†™å‘½ä»¤ï¼š <code class="highlighter-rouge">set key1111 1111</code>ã€‚æˆ‘ä»¬è§‚å¯Ÿä¸€ä¸‹ aof æ–‡ä»¶ï¼š</p>

<ul>
  <li>redis è®°å½•äº† <code class="highlighter-rouge">select</code> æ•°æ®åº“å‘½ä»¤ï¼Œ<code class="highlighter-rouge">^M</code> æ˜¯ <code class="highlighter-rouge">cat</code> å‘½ä»¤æ‰“å°çš„ <code class="highlighter-rouge">\r\n</code>ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cat -v appendonly.aof</span>
<span class="k">*</span>2^M
<span class="nv">$6</span>^M
SELECT^M
<span class="nv">$1</span>^M
0^M
<span class="k">*</span>3^M
<span class="nv">$3</span>^M
<span class="nb">set</span>^M
<span class="nv">$7</span>^M
key1111^M
<span class="nv">$4</span>^M
1111^M
</code></pre></div></div>

<ul>
  <li>å‘½ä»¤å­˜å‚¨æ–‡æœ¬ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># set key1111 1111</span>
<span class="k">*</span>3<span class="se">\r\n</span><span class="nv">$3</span><span class="se">\r\n</span><span class="nb">set</span><span class="se">\r\n</span><span class="nv">$7</span><span class="se">\r\n</span>key1111<span class="nv">$4</span><span class="se">\r\n</span><span class="nv">$1111</span><span class="se">\r\n</span>
</code></pre></div></div>

<ul>
  <li><a href="https://redis.io/topics/protocol">RESP åè®®æ ¼å¼</a>ï¼Œä»¥ <code class="highlighter-rouge">\r\n</code> ä½œä¸ºåˆ†éš”ç¬¦ï¼Œæœ‰ä¸€ä¸ªä½œç”¨ï¼šå¯ä»¥ç”¨ <code class="highlighter-rouge">fgets</code>ï¼Œå°†æ–‡ä»¶æ•°æ®ä¸€è¡Œä¸€è¡Œè¯»å‡ºæ¥ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>&lt;å‘½ä»¤å‚æ•°ä¸ªæ•°&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬1ä¸ªå‚æ•°å­—ç¬¦ä¸²é•¿åº¦&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬1ä¸ªå‚æ•°å­—ç¬¦ä¸²&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬2ä¸ªå‚æ•°å­—ç¬¦ä¸²é•¿åº¦&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬2ä¸ªå‚æ•°å­—ç¬¦ä¸²&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬nä¸ªå‚æ•°å­—ç¬¦ä¸²é•¿åº¦&gt;<span class="se">\r\n</span><span class="nv">$&lt;</span>ç¬¬nä¸ªå‚æ•°å­—ç¬¦ä¸²&gt;
</code></pre></div></div>

<ul>
  <li>aof è¿½åŠ å‘½ä»¤è®°å½•æºç ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sds</span> <span class="nf">catAppendOnlyGenericCommand</span><span class="p">(</span><span class="n">sds</span> <span class="n">dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
    <span class="n">robj</span> <span class="o">*</span><span class="n">o</span><span class="p">;</span>

    <span class="c1">// å‘½ä»¤å‚æ•°ä¸ªæ•°</span>
    <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'*'</span><span class="p">;</span>
    <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">ll2string</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">argc</span><span class="p">);</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
    <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">getDecodedObject</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="c1">// å‚æ•°å­—ç¬¦ä¸²é•¿åº¦</span>
        <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'$'</span><span class="p">;</span>
        <span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="o">+</span><span class="n">ll2string</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">));</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\r'</span><span class="p">;</span>
        <span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">;</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
        <span class="c1">// å‚æ•°</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">o</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">));</span>
        <span class="n">dst</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span><span class="s">"</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span>
        <span class="n">decrRefCount</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">dst</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="22-aof-å’Œ-rdb-æ··åˆç»“æ„">2.2. aof å’Œ rdb æ··åˆç»“æ„</h3>

<p><img src="/images/2020-03-28-16-19-34.png" alt="rdb aof æ··åˆç»“æ„" data-action="zoom" /></p>

<p><strong>redis æ”¯æŒ aof å’Œ rdb æŒä¹…åŒ–åŒæ—¶ä½¿ç”¨</strong>ï¼Œrdb å’Œ aof å­˜å‚¨æ ¼å¼åŒæ—¶å­˜å‚¨åœ¨ä¸€ä¸ª aof æ–‡ä»¶ä¸­ã€‚</p>

<p>rdb æŒä¹…åŒ–é€Ÿåº¦å¿«ï¼Œè€Œä¸”è½åœ°æ–‡ä»¶å°ï¼Œè¿™ä¸ªä¼˜åŠ¿ç†åº”åŠ å¼ºä½¿ç”¨ã€‚redis æŒä¹…åŒ–ç›®å‰æœ‰ä¸¤ç§æ–¹å¼ï¼Œæœ€ç»ˆç»“åˆä¸ºä¸€ç§æ–¹å¼ï¼Œä½¿å…¶æ›´åŠ é«˜æ•ˆï¼Œè¿™æ˜¯ redis ä½œè€…ä¸€ç›´åŠªåŠ›çš„ç›®æ ‡ã€‚</p>

<blockquote>
  <p>æœ‰å…³ rdb æŒä¹…åŒ–ï¼Œå¯ä»¥å‚è€ƒå¸–å­ï¼š</p>

  <p><a href="https://wenfh2020.com/2020/03/19/redis-rdb-struct/">[redis æºç èµ°è¯»] rdb æŒä¹…åŒ– - æ–‡ä»¶ç»“æ„</a></p>

  <p><a href="https://wenfh2020.com/2020/03/19/redis-rdb-application/">[redis æºç èµ°è¯»] rdb æŒä¹…åŒ– - åº”ç”¨åœºæ™¯</a></p>
</blockquote>

<ul>
  <li>å¯ä»¥é€šè¿‡é…ç½®ï¼Œaof æŒä¹…åŒ–æ¨¡å¼ä¸‹ï¼Œå†…å­˜æ•°æ®å¯ä»¥é‡å†™å­˜å‚¨ä¸º rdb æ ¼å¼çš„ aof æ–‡ä»¶ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

<span class="c"># å¼€å¯ aof æŒä¹…åŒ–æ¨¡å¼</span>
appendonly <span class="nb">yes</span>

<span class="c"># [RDB file][AOF tail] æ”¯æŒ aof å’Œ rdb æ··åˆæŒä¹…åŒ–ã€‚</span>
aof-use-rdb-preamble <span class="nb">yes</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// rdb æŒä¹…åŒ–æ—¶ï¼Œæ·»åŠ  aof æ ‡è¯†ã€‚</span>
<span class="kt">int</span> <span class="nf">rdbSaveInfoAuxFields</span><span class="p">(</span><span class="n">rio</span> <span class="o">*</span><span class="n">rdb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rdbflags</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveAuxFieldStrInt</span><span class="p">(</span><span class="n">rdb</span><span class="p">,</span><span class="s">"aof-preamble"</span><span class="p">,</span><span class="n">aof_preamble</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>redis ç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œæ‰§è¡Œç¬¬äºŒä¸ªå‘½ä»¤ <code class="highlighter-rouge">bgrewriteaof</code> é‡å†™ aof æ–‡ä»¶ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cat -v appendonly.aof</span>
REDIS0009ï¿½      redis-ver^K999.999.999ï¿½
redis-bitsï¿½@ï¿½^Ectimeï¿½M-^Jï¿½<span class="o">}</span>^ï¿½^Hused-memï¿½^Pl^Q^@ï¿½^Laof-preamble
ï¿½^Aï¿½^@ï¿½^A^@^@^Gkey1111ï¿½W^Dï¿½ï¿½^Lï¿½6Afiï¿½
</code></pre></div></div>

<ul>
  <li>redis ç¬¬ä¸€æ¬¡å¯åŠ¨åï¼Œæ‰§è¡Œç¬¬ä¸‰ä¸ªå‘½ä»¤ <code class="highlighter-rouge">set key2222 2222</code>ï¼Œaof æ–‡ä»¶ç»“æ„å±•ç¤ºäº† rdb å’Œ aof ç»“åˆå­˜å‚¨æ–¹å¼ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># cat -v appendonly.aof</span>
REDIS0009ï¿½      redis-ver^K999.999.999ï¿½
redis-bitsï¿½@ï¿½^Ectimeï¿½M-^Jï¿½<span class="o">}</span>^ï¿½^Hused-memï¿½^Pl^Q^@ï¿½^Laof-preamble
ï¿½^Aï¿½^@ï¿½^A^@^@^Gkey1111ï¿½W^Dï¿½ï¿½^Lï¿½6Afiï¿½<span class="k">*</span>2^M
<span class="nv">$6</span>^M
SELECT^M
<span class="nv">$1</span>^M
0^M
<span class="k">*</span>3^M
<span class="nv">$3</span>^M
<span class="nb">set</span>^M
<span class="nv">$7</span>^M
key2222^M
<span class="nv">$4</span>^M
2222^M
</code></pre></div></div>

<hr />

<h2 id="3-æŒä¹…åŒ–ç­–ç•¥">3. æŒä¹…åŒ–ç­–ç•¥</h2>

<h3 id="31-ç­–ç•¥">3.1. ç­–ç•¥</h3>

<p>ç£ç›˜ I/O é€Ÿåº¦æ…¢ï¼Œredis ä½œä¸ºé«˜æ€§èƒ½çš„ç¼“å­˜æ•°æ®åº“ï¼Œåœ¨å¹³è¡¡æ€§èƒ½å’ŒæŒä¹…åŒ–ä¸Šï¼Œæä¾›äº†å‡ ä¸ªå­˜å‚¨ç­–ç•¥ï¼š</p>

<blockquote>
  <p>aof æŒä¹…åŒ–ï¼Œæ¯ç§’åˆ·æ–°ä¸€æ¬¡ç¼“å­˜åˆ°ç£ç›˜ï¼Œè¿™æ˜¯ redis aof æŒä¹…åŒ–é»˜è®¤çš„æ“ä½œï¼Œå…¼é¡¾æ€§èƒ½å’ŒæŒä¹…åŒ–ã€‚å¦‚æœä½¿ç”¨åœºæ™¯æ•°æ®å¾ˆé‡è¦ï¼Œå¯ä»¥è®¾ç½®æ¯æ¡å‘½ä»¤åˆ·æ–°ç£ç›˜ä¸€æ¬¡ï¼Œä½†æ˜¯é€Ÿåº¦ä¼šéå¸¸æ…¢ã€‚å¦‚æœ redis åªä½œä¸ºç¼“å­˜ï¼ŒæŒä¹…åŒ–ä¸é‚£ä¹ˆé‡è¦ï¼Œé‚£ä¹ˆåˆ·ç›˜è¡Œä¸ºäº¤ç»™ Linux ç³»ç»Ÿç®¡ç†ã€‚</p>
</blockquote>

<ul>
  <li>æ¯ç§’å°†æ–°å‘½ä»¤ç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜ã€‚é€Ÿåº¦è¶³å¤Ÿå¿«ï¼Œå¦‚æœ redis å‘ç”Ÿå¼‚å¸¸ï¼Œæ‚¨å¯èƒ½ä¼šä¸¢å¤±1ç§’çš„æ•°æ®ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
appendfsync everysec
</code></pre></div></div>

<ul>
  <li>æ¯æ¬¡å°†æ–°å‘½ä»¤åˆ·æ–°åˆ°ç£ç›˜ï¼Œéå¸¸éå¸¸æ…¢ï¼Œä½†æ˜¯éå¸¸å®‰å…¨ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
appendfsync always
</code></pre></div></div>

<ul>
  <li>redis ä¸ä¸»åŠ¨åˆ·æ–°æ–‡ä»¶ç¼“å­˜åˆ°ç£ç›˜ï¼Œåªéœ€å°†æ•°æ®äº¤ç»™æ“ä½œç³»ç»Ÿå³å¯ã€‚é€Ÿåº¦æ›´å¿«ï¼Œä½†æ˜¯æ›´ä¸å®‰å…¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒLinux ä½¿ç”¨æ­¤é…ç½®æ¯30ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
appendfsync no
</code></pre></div></div>

<h3 id="32-æµç¨‹åŸç†">3.2. æµç¨‹åŸç†</h3>

<ul>
  <li>
    <p>æ–‡ä»¶æ•°æ®åˆ·æ–°åˆ°ç£ç›˜åŸç†ï¼š</p>

    <p>ä¼ ç»Ÿçš„ UNIX å®ç°åœ¨å†…æ ¸ä¸­è®¾æœ‰ç¼“å†²å­˜å‚¨å™¨ï¼Œâ¼¤å¤šæ•°ç£ç›˜ I/O éƒ½é€šè¿‡ç¼“å­˜è¿›â¾ã€‚</p>

    <p>å½“å°†æ•°æ®å†™åˆ°æ–‡ä»¶ä¸Šæ—¶ï¼Œé€šå¸¸è¯¥æ•°æ®å…ˆç”±å†…æ ¸å¤åˆ¶åˆ°ç¼“å­˜ä¸­ï¼Œå¦‚æœè¯¥ç¼“å­˜å°šæœªå†™æ»¡ï¼Œåˆ™å¹¶ä¸å°†å…¶æ’å…¥è¾“å‡ºé˜Ÿåˆ—ï¼Œâ½½æ˜¯ç­‰å¾…å…¶å†™æ»¡æˆ–è€…å½“å†…æ ¸éœ€è¦é‡â½¤è¯¥ç¼“å­˜ä»¥ä¾¿å­˜æ”¾å…¶ä»–ç£ç›˜å—æ•°æ®æ—¶ï¼Œå†å°†è¯¥ç¼“å­˜æ’å…¥è¾“å‡ºé˜Ÿåˆ—ï¼Œç„¶åå¾…å…¶åˆ°è¾¾é˜Ÿé¦–æ—¶ï¼Œæ‰è¿›â¾å®é™…çš„ I/O æ“ä½œã€‚è¿™ç§è¾“å‡ºâ½…å¼è¢«ç§°ä¹‹ä¸ºå»¶è¿Ÿå†™(delayed write)ã€‚</p>

    <p>å»¶è¿Ÿå†™å‡å°‘äº†ç£ç›˜è¯»å†™æ¬¡æ•°ï¼Œä½†æ˜¯å´é™ä½äº†æ–‡ä»¶å†…å®¹çš„æ›´æ–°é€Ÿåº¦ï¼Œä½¿å¾—æ¬²å†™åˆ°â½‚ä»¶ä¸­çš„æ•°æ®åœ¨â¼€æ®µæ—¶é—´å†…å¹¶æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šã€‚å½“ç³»ç»Ÿå‘â½£ç”Ÿæ•…éšœæ—¶ï¼Œè¿™ç§å»¶è¿Ÿå¯èƒ½é€ æˆâ½‚ä»¶æ›´æ–°å†…å®¹çš„ä¸¢å¤±ã€‚ä¸ºäº†ä¿è¯ç£ç›˜ä¸Šå®é™…æ–‡ä»¶ç³»ç»Ÿä¸ç¼“å­˜ä¸­å†…å®¹çš„ä¸€è‡´æ€§ï¼ŒUNIXç³»ç»Ÿæä¾›äº† sync å’Œ fsync ä¸¤ä¸ªç³»ç»Ÿè°ƒâ½¤å‡½æ•°ã€‚</p>

    <p>sync åªæ˜¯å°†æ‰€æœ‰ä¿®æ”¹è¿‡çš„å—çš„ç¼“å­˜æ’å…¥å†™é˜Ÿåˆ—ï¼Œç„¶åå°±è¿”å›ï¼Œå®ƒå¹¶ä¸ç­‰å¾…å®é™… I/Oæ“ä½œç»“æŸã€‚ç³»ç»Ÿç²¾çµè¿›ç¨‹ (é€šå¸¸ç§°ä¸º update)ä¸€èˆ¬æ¯éš” 30ç§’è°ƒâ½¤ä¸€æ¬¡ sync å‡½æ•°ã€‚è¿™å°±ä¿è¯äº†å®šæœŸåˆ·æ–°å†…æ ¸çš„å—ç¼“å­˜ã€‚</p>

    <p>å‡½æ•°fsync åªå¼•â½¤å•ä¸ªæ–‡ä»¶ï¼Œå®ƒç­‰å¾…I/Oç»“æŸï¼Œç„¶åè¿”å›ã€‚fsync å¯ç”¨äºæ•°æ®åº“è¿™æ ·çš„åº”ç”¨ç¨‹åºï¼Œå®ƒç¡®ä¿ä¿®æ”¹è¿‡çš„å—â½´å³å†™åˆ°ç£ç›˜ä¸Šã€‚</p>

    <blockquote>
      <p>ä¸Šæ–‡å¼•ç”¨è‡ª ã€ŠUNINX ç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹ 4.24</p>
    </blockquote>
  </li>
</ul>

<p><img src="/images/2020-03-29-19-12-04.png" alt="æ•°æ®æŒä¹…åŒ–æµç¨‹" data-action="zoom" /></p>

<ul>
  <li>æ–‡ä»¶æ•°æ®åˆ·æ–°åˆ°ç£ç›˜æµç¨‹ã€‚</li>
</ul>

<ol>
  <li>client å‘ redis æœåŠ¡å‘é€å†™å‘½ä»¤ã€‚</li>
  <li>redis æœåŠ¡æ¥æ”¶åˆ° client å‘é€çš„å†™å‘½ä»¤ï¼Œå­˜å‚¨äº redis è¿›ç¨‹å†…å­˜ä¸­ï¼ˆredis æœåŠ¡ç¼“å­˜ï¼‰ã€‚</li>
  <li>
    <p>redis æœåŠ¡è°ƒç”¨æ¥å£ write å°†è¿›ç¨‹å†…å­˜æ•°æ®å†™å…¥æ–‡ä»¶ã€‚</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="kt">void</span> <span class="nf">flushAppendOnlyFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
     <span class="p">...</span>
     <span class="n">nwritten</span> <span class="o">=</span> <span class="n">aofWrite</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">));</span>
     <span class="p">...</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>redis æœåŠ¡è°ƒç”¨æ¥å£(<code class="highlighter-rouge">redis_fsync</code>)ï¼Œå°†æ–‡ä»¶åœ¨å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ç¼“å†²åŒºä¸­ã€‚</p>

    <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cm">/* Define redis_fsync to fdatasync() in Linux and fsync() for all the rest */</span>
 <span class="cp">#ifdef __linux__
</span> <span class="cp">#define redis_fsync fdatasync
</span> <span class="cp">#else
</span> <span class="cp">#define redis_fsync fsync
</span> <span class="cp">#endif
</span></code></pre></div>    </div>
  </li>
  <li>ç£ç›˜æ§åˆ¶å™¨å°†ç£ç›˜ç¼“å†²åŒºæ•°æ®å†™å…¥åˆ°ç£ç›˜ç‰©ç†ä»‹è´¨ä¸­ã€‚</li>
</ol>

<hr />

<p>æµç¨‹èµ°åˆ°ç¬¬ 5 æ­¥ï¼Œæ•°æ®æ‰ç®—çœŸæ­£æŒä¹…åŒ–æˆåŠŸã€‚å…¶ä¸­ 2-4 æ­¥éª¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šæä¾›å¯¹å¤–æ¥å£ç»™æœåŠ¡æ§åˆ¶ï¼Œä½†æ˜¯ç¬¬ 5 æ­¥æ²¡æœ‰æ¥å£ï¼Œredis æœåŠ¡æ§åˆ¶ä¸äº†ç£ç›˜ç¼“å­˜å†™å…¥ç‰©ç†ä»‹è´¨ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿›ç¨‹æ­£å¸¸é€€å‡ºæˆ–è€…å´©æºƒé€€å‡ºï¼Œç¬¬ 5 æ­¥æœºå™¨ç³»ç»Ÿä¼šæ‰§è¡Œçš„ã€‚ä½†æ˜¯å¦‚æœæ–­ç”µæƒ…å†µæˆ–å…¶ä»–ç‰©ç†å¼‚å¸¸ï¼Œè¿™æ ·ç£ç›˜æ•°æ®è¿˜æ˜¯ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†ã€‚</p>

<p>å¦‚æœç”¨ <code class="highlighter-rouge">appendfsync everysec</code> é…ç½®ï¼Œæ­£å¸¸æƒ…å†µç¨‹åºé€€å‡ºå¯èƒ½ä¼šä¸¢å¤± 1 - 2 ç§’æ•°æ®ï¼Œä½†æ˜¯æ–­ç”µç­‰ç‰©ç†æƒ…å†µå¯¼è‡´ç³»ç»Ÿç»ˆæ­¢ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¸å¯é¢„æ–™äº†ã€‚</p>

<blockquote>
  <p>å‚è€ƒ <a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">Redis persistence demystified</a></p>
</blockquote>

<hr />

<h3 id="33-ç­–ç•¥å®ç°">3.3. ç­–ç•¥å®ç°</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define AOF_WRITE_LOG_ERROR_RATE 30 </span><span class="cm">/* Seconds between errors logging. */</span><span class="cp">
</span>
<span class="c1">// åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜ã€‚</span>
<span class="kt">void</span> <span class="nf">flushAppendOnlyFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">ssize_t</span> <span class="n">nwritten</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">sync_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">mstime_t</span> <span class="n">latency</span><span class="p">;</span>

    <span class="c1">// æ–°çš„å‘½ä»¤æ•°æ®æ˜¯å…ˆå†™å…¥ aof ç¼“å†²åŒºçš„ï¼Œæ‰€ä»¥å…ˆåˆ¤æ–­ç¼“å†²åŒºæ˜¯å¦æœ‰æ•°æ®éœ€è¦åˆ·æ–°åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* æ¯ç§’åˆ·æ–°ç­–ç•¥ï¼Œæœ‰å¯èƒ½å­˜åœ¨ç¼“å†²åŒºæ˜¯ç©ºçš„ï¼Œä½†æ˜¯è¿˜æœ‰æ•°æ®æ²¡åˆ·æ–°ç£ç›˜çš„æƒ…å†µï¼Œéœ€è¦æ‰§è¡Œåˆ·æ–°æ“ä½œã€‚
         * å½“å¼‚æ­¥çº¿ç¨‹è¿˜æœ‰åˆ·ç›˜ä»»åŠ¡æ²¡æœ‰å®Œæˆï¼Œæ–°çš„åˆ·ç›˜ä»»åŠ¡æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œä½†æ˜¯ aof_buf å·²ç»å†™è¿›äº†
         * æ–‡ä»¶ç¼“å­˜ï¼Œaof_buf ç¼“å­˜ä»»åŠ¡å·²ç»å®Œæˆéœ€è¦æ¸…ç©ºã€‚åªæ˜¯æ–‡ä»¶ç¼“å­˜è¿˜æ²¡åˆ·æ–°åˆ°ç£ç›˜ï¼Œæ•°æ®åªåœ¨æ–‡ä»¶ç¼“å­˜
         * é‡Œï¼Œè¿˜ç®—ä¸ä¸Šæœ€ç»ˆè½åœ°ï¼Œéœ€è¦è°ƒç”¨ redis_fsync æ‰ä¼šå°†æ–‡ä»¶ç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜ã€‚* aof_fsync_offset æ‰ä¼šæœ€åæ›´æ–°åˆ°åˆ·ç›˜çš„ä½ç½®*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_EVERYSEC</span> <span class="o">&amp;&amp;</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_fsync_offset</span> <span class="o">!=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">&amp;&amp;</span>
            <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="n">sync_in_progress</span> <span class="o">=</span> <span class="n">aofFsyncInProgress</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">goto</span> <span class="n">try_fsync</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// æ¯ç§’åˆ·æ–°ç­–ç•¥ï¼Œé‡‡ç”¨çš„æ˜¯åå°çº¿ç¨‹åˆ·æ–°æ–¹å¼ï¼Œæ£€æŸ¥åå°çº¿ç¨‹æ˜¯å¦è¿˜æœ‰åˆ·æ–°ä»»åŠ¡æ²¡å®Œæˆã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_EVERYSEC</span><span class="p">)</span>
        <span class="n">sync_in_progress</span> <span class="o">=</span> <span class="n">aofFsyncInProgress</span><span class="p">();</span>

    <span class="c1">// éƒ¨åˆ†æ“ä½œéœ€è¦ force å¼ºåˆ¶å†™å…¥ï¼Œä¸æ¥å—å»¶æ—¶ã€‚ä¾‹å¦‚é€€å‡º redis æœåŠ¡ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_EVERYSEC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sync_in_progress</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_flush_postponed_start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// å¦‚æœåå°çº¿ç¨‹è¿˜æœ‰åˆ·æ–°ä»»åŠ¡ï¼Œå½“å‰åˆ·æ–°éœ€è¦å»¶åæ“ä½œã€‚</span>
                <span class="n">server</span><span class="p">.</span><span class="n">aof_flush_postponed_start</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">-</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_flush_postponed_start</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// å»¶æ—¶æ“ä½œä¸èƒ½è¶…è¿‡ 2 ç§’ï¼Œå¦åˆ™å¼ºåˆ¶æ‰§è¡Œã€‚</span>
                <span class="k">return</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// å»¶æ—¶è¶…æ—¶ï¼Œå¼ºåˆ¶æ‰§è¡Œã€‚</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_delayed_fsync</span><span class="o">++</span><span class="p">;</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"Asynchronous AOF fsync is taking too long (disk is busy?). Writing the AOF buffer without waiting for fsync to complete, this may slow down Redis."</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">...</span>

    <span class="c1">// å†™ç¼“å†²åŒºæ•°æ®åˆ°æ–‡ä»¶ã€‚</span>
    <span class="n">nwritten</span> <span class="o">=</span> <span class="n">aofWrite</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">));</span>
    <span class="p">...</span>
    <span class="cm">/* We performed the write so reset the postponed flush sentinel to zero. */</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_flush_postponed_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// å¤„ç†å†™æ–‡ä»¶å¼‚å¸¸</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">ssize_t</span><span class="p">)</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">static</span> <span class="kt">time_t</span> <span class="n">last_write_error_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">can_log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="c1">// è®¾ç½®å¼‚å¸¸æ—¥å¿—æ‰“å°é¢‘ç‡</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">-</span> <span class="n">last_write_error_log</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">AOF_WRITE_LOG_ERROR_RATE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">can_log</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">last_write_error_log</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Log the AOF write error and record the error code. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">can_log</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Error writing to the AOF file: %s"</span><span class="p">,</span>
                    <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
                <span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_errno</span> <span class="o">=</span> <span class="n">errno</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">can_log</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Short write while writing to "</span>
                                       <span class="s">"the AOF file: (nwritten=%lld, "</span>
                                       <span class="s">"expected=%lld)"</span><span class="p">,</span>
                                       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">nwritten</span><span class="p">,</span>
                                       <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">));</span>
            <span class="p">}</span>

            <span class="cm">/* å†™å…¥äº†éƒ¨åˆ†æ•°æ®ï¼Œæ–°å†™å…¥çš„æ•°æ®æœ‰å¯èƒ½æ˜¯ä¸å®Œæ•´çš„å‘½ä»¤ã€‚è¿™æ ·ä¼šå¯¼è‡´ redis å¯åŠ¨æ—¶ï¼Œ
             * è§£æ aof æ–‡ä»¶å¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦å°†æ–‡ä»¶æˆªæ–­åˆ°ä¸Šä¸€æ¬¡æœ‰æ•ˆå†™å…¥çš„ä½ç½®ã€‚*/</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">can_log</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span> <span class="s">"Could not remove short write "</span>
                             <span class="s">"from the append-only file.  Redis may refuse "</span>
                             <span class="s">"to load the AOF the next time it starts.  "</span>
                             <span class="s">"ftruncate: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
                <span class="p">}</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="cm">/* If the ftruncate() succeeded we can set nwritten to
                 * -1 since there is no longer partial data into the AOF. */</span>
                <span class="n">nwritten</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_errno</span> <span class="o">=</span> <span class="n">ENOSPC</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// å¤„ç†é”™è¯¯</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_ALWAYS</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// å‘½ä»¤å®æ—¶æ›´æ–°ç­–ç•¥ä¸‹ï¼Œå¦‚æœå‡ºç°å†™æ–‡ä»¶é”™è¯¯ï¼Œéœ€è¦å…³é—­æœåŠ¡ã€‚</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Can't recover from AOF write error when the AOF fsync policy is 'always'. Exiting..."</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="cm">/* å…¶å®ƒç­–ç•¥ï¼Œå‡ºç°å†™å…¥é”™è¯¯ï¼Œæ›´æ–°å†™å…¥æˆåŠŸéƒ¨åˆ†ï¼Œæ²¡å†™æˆåŠŸéƒ¨åˆ†åˆ™åœ¨æ—¶é’Ÿé‡Œå®šæ—¶æ£€æŸ¥ï¼Œé‡æ–°å†™å…¥ã€‚*/</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_status</span> <span class="o">=</span> <span class="n">C_ERR</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">nwritten</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">+=</span> <span class="n">nwritten</span><span class="p">;</span>
                <span class="n">sdsrange</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">,</span><span class="n">nwritten</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span><span class="p">;</span> <span class="cm">/* We'll try again on the next call... */</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// ä¹‹å‰æŒä¹…åŒ–å¼‚å¸¸ï¼Œç°åœ¨å·²ç»æ­£å¸¸æ¢å¤ï¼Œè§£é™¤å¼‚å¸¸æ ‡è¯†ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_status</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span>
                <span class="s">"AOF write error looks solved, Redis can write again."</span><span class="p">);</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_status</span> <span class="o">=</span> <span class="n">C_OK</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">+=</span> <span class="n">nwritten</span><span class="p">;</span>

    <span class="c1">// æŒä¹…åŒ–æˆåŠŸï¼Œæ¸…ç©º aof ç¼“å†²åŒºã€‚</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">)</span><span class="o">+</span><span class="n">sdsavail</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">4000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sdsclear</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">sdsfree</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
    <span class="p">}</span>

<span class="nl">try_fsync:</span>
    <span class="c1">// æ£€æŸ¥å½“æœ‰å­è¿›ç¨‹åœ¨æ“ä½œæ—¶æ˜¯å¦å…è®¸åˆ·æ–°æ–‡ä»¶ç¼“å­˜åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_no_fsync_on_rewrite</span> <span class="o">&amp;&amp;</span> <span class="n">hasActiveChildProcess</span><span class="p">())</span>
        <span class="k">return</span><span class="p">;</span>

    <span class="c1">// åˆ·æ–°æ–‡ä»¶ç¼“å­˜åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_ALWAYS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">latencyStartMonitor</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
        <span class="n">redis_fsync</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">);</span> <span class="cm">/* Let's try to get this data on the disk */</span>
        <span class="n">latencyEndMonitor</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
        <span class="n">latencyAddSampleIfNeeded</span><span class="p">(</span><span class="s">"aof-fsync-always"</span><span class="p">,</span><span class="n">latency</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_fsync_offset</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_EVERYSEC</span> <span class="o">&amp;&amp;</span>
                <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sync_in_progress</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// å°†åˆ·æ–°æ–‡ä»¶ç¼“å­˜åˆ°ç£ç›˜æ“ä½œæ·»åŠ åˆ°å¼‚æ­¥çº¿ç¨‹å¤„ç†ã€‚</span>
            <span class="n">aof_background_fsync</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">);</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_fsync_offset</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-å¼‚æ­¥æŒä¹…åŒ–">4. å¼‚æ­¥æŒä¹…åŒ–</h2>

<p>redis ä½œä¸ºé«˜æ€§èƒ½ç¼“å­˜ç³»ç»Ÿï¼Œå®ƒçš„ä¸»é€»è¾‘éƒ½åœ¨ä¸»è¿›ç¨‹ä¸»çº¿ç¨‹ä¸­å®ç°è¿è¡Œçš„ã€‚è€ŒæŒä¹…åŒ–å†™ç£ç›˜æ˜¯ä¸€ä¸ªä½æ•ˆç¼“æ…¢æ“ä½œï¼Œå› æ­¤redis ä¸€èˆ¬æƒ…å†µä¸‹ä¸å…è®¸è¿™ä¸ªæ“ä½œåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œã€‚è¿™æ · redis å¼€å¯äº†åå°çº¿ç¨‹ï¼Œç”¨æ¥å¼‚æ­¥å¤„ç†ä»»åŠ¡ï¼Œä¿éšœä¸»çº¿ç¨‹å¯ä»¥é«˜é€Ÿè¿è¡Œã€‚</p>

<ul>
  <li>æ·»åŠ å¼‚æ­¥ä»»åŠ¡</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Define redis_fsync to fdatasync() in Linux and fsync() for all the rest */</span>
<span class="cp">#ifdef __linux__
#define redis_fsync fdatasync
#else
#define redis_fsync fsync
#endif
</span>
<span class="kt">void</span> <span class="nf">flushAppendOnlyFile</span><span class="p">(</span><span class="kt">int</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fsync</span> <span class="o">==</span> <span class="n">AOF_FSYNC_EVERYSEC</span> <span class="o">&amp;&amp;</span>
                <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// æ¯ç§’åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜ä¸€æ¬¡ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sync_in_progress</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// æ·»åŠ ä»»åŠ¡åˆ°åå°çº¿ç¨‹ã€‚</span>
            <span class="n">aof_background_fsync</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_fd</span><span class="p">);</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_fsync_offset</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_last_fsync</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// æ·»åŠ å¼‚æ­¥ä»»åŠ¡</span>
<span class="kt">void</span> <span class="nf">aof_background_fsync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">bioCreateBackgroundJob</span><span class="p">(</span><span class="n">BIO_AOF_FSYNC</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">fd</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å¼‚æ­¥çº¿ç¨‹åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// åå°å¼‚æ­¥çº¿ç¨‹åˆ›å»º</span>
<span class="kt">void</span> <span class="nf">bioInit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">BIO_NUM_OPS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">j</span><span class="p">;</span>
        <span class="c1">// åˆ›å»ºçº¿ç¨‹</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="p">,</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="n">bioProcessBackgroundJobs</span><span class="p">,</span><span class="n">arg</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Fatal: Can't initialize Background Jobs."</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">bio_threads</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kr">thread</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// æ·»åŠ å¼‚æ­¥ä»»åŠ¡</span>
<span class="kt">void</span> <span class="nf">bioCreateBackgroundJob</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg2</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg3</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">bio_job</span> <span class="o">*</span><span class="n">job</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">job</span><span class="p">));</span>

    <span class="n">job</span><span class="o">-&gt;</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">job</span><span class="o">-&gt;</span><span class="n">arg1</span> <span class="o">=</span> <span class="n">arg1</span><span class="p">;</span>
    <span class="n">job</span><span class="o">-&gt;</span><span class="n">arg2</span> <span class="o">=</span> <span class="n">arg2</span><span class="p">;</span>
    <span class="n">job</span><span class="o">-&gt;</span><span class="n">arg3</span> <span class="o">=</span> <span class="n">arg3</span><span class="p">;</span>
    <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bio_mutex</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
    <span class="n">listAddNodeTail</span><span class="p">(</span><span class="n">bio_jobs</span><span class="p">[</span><span class="n">type</span><span class="p">],</span><span class="n">job</span><span class="p">);</span>
    <span class="n">bio_pending</span><span class="p">[</span><span class="n">type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
    <span class="n">pthread_cond_signal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bio_newjob_cond</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
    <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bio_mutex</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>
<span class="p">}</span>

<span class="c1">// çº¿ç¨‹å¤„ç†</span>
<span class="kt">void</span> <span class="o">*</span><span class="nf">bioProcessBackgroundJobs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">BIO_AOF_FSYNC</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// åˆ·æ–°å†…æ ¸ç¼“å­˜åˆ°ç£ç›˜ã€‚</span>
        <span class="n">redis_fsync</span><span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">job</span><span class="o">-&gt;</span><span class="n">arg1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/03/29/redis-aof-prev/">wenfh2020.com</a></p>
</blockquote>
:ET