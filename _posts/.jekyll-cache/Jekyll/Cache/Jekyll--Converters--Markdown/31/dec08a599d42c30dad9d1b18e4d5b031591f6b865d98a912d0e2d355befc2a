I"_Ä<p>æ–‡ç« ä¸»è¦å¯¹ tcp é€šä¿¡è¿›è¡Œ epoll æºç èµ°è¯»ã€‚</p>

<p>Linux æºç ï¼š<a href="https://github.com/torvalds/linux/releases/tag/v5.7-rc4">Linux 5.7 ç‰ˆæœ¬</a>ã€‚epoll æ ¸å¿ƒæºç ï¼š<a href="https://github.com/torvalds/linux/blob/master/include/linux/eventpoll.h">eventpoll.h</a> / <a href="https://github.com/torvalds/linux/blob/master/fs/eventpoll.c">eventpoll.c</a>ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-åº”ç”¨åœºæ™¯" id="markdown-toc-1-åº”ç”¨åœºæ™¯">1. åº”ç”¨åœºæ™¯</a></li>
  <li><a href="#2-é¢„å¤‡çŸ¥è¯†" id="markdown-toc-2-é¢„å¤‡çŸ¥è¯†">2. é¢„å¤‡çŸ¥è¯†</a></li>
  <li><a href="#3-ä½¿ç”¨" id="markdown-toc-3-ä½¿ç”¨">3. ä½¿ç”¨</a></li>
  <li><a href="#4-äº‹ä»¶" id="markdown-toc-4-äº‹ä»¶">4. äº‹ä»¶</a></li>
  <li><a href="#5-æºç å·¥ä½œæµç¨‹" id="markdown-toc-5-æºç å·¥ä½œæµç¨‹">5. æºç å·¥ä½œæµç¨‹</a></li>
  <li><a href="#6-æ•°æ®ç»“æ„" id="markdown-toc-6-æ•°æ®ç»“æ„">6. æ•°æ®ç»“æ„</a>    <ul>
      <li><a href="#61-eventpoll" id="markdown-toc-61-eventpoll">6.1. eventpoll</a></li>
      <li><a href="#62-epitem" id="markdown-toc-62-epitem">6.2. epitem</a></li>
      <li><a href="#63-epoll_filefd" id="markdown-toc-63-epoll_filefd">6.3. epoll_filefd</a></li>
      <li><a href="#64-epoll_event" id="markdown-toc-64-epoll_event">6.4. epoll_event</a></li>
      <li><a href="#65-poll_table_struct" id="markdown-toc-65-poll_table_struct">6.5. poll_table_struct</a></li>
      <li><a href="#66-ep_pqueue" id="markdown-toc-66-ep_pqueue">6.6. ep_pqueue</a></li>
    </ul>
  </li>
  <li><a href="#7-å…³é”®å‡½æ•°" id="markdown-toc-7-å…³é”®å‡½æ•°">7. å…³é”®å‡½æ•°</a></li>
  <li><a href="#8-æ ¸å¿ƒæºç " id="markdown-toc-8-æ ¸å¿ƒæºç ">8. æ ¸å¿ƒæºç </a>    <ul>
      <li><a href="#81-åˆå§‹åŒ–" id="markdown-toc-81-åˆå§‹åŒ–">8.1. åˆå§‹åŒ–</a></li>
      <li><a href="#82-epoll_create" id="markdown-toc-82-epoll_create">8.2. epoll_create</a></li>
      <li><a href="#83-epoll_ctl" id="markdown-toc-83-epoll_ctl">8.3. epoll_ctl</a></li>
      <li><a href="#84-ep_item_poll" id="markdown-toc-84-ep_item_poll">8.4. ep_item_poll</a></li>
      <li><a href="#85-ep_ptable_queue_proc" id="markdown-toc-85-ep_ptable_queue_proc">8.5. ep_ptable_queue_proc</a></li>
      <li><a href="#86-epoll_wait" id="markdown-toc-86-epoll_wait">8.6. epoll_wait</a></li>
      <li><a href="#87-ep_scan_ready_list" id="markdown-toc-87-ep_scan_ready_list">8.7. ep_scan_ready_list</a></li>
      <li><a href="#88-ep_send_events_proc" id="markdown-toc-88-ep_send_events_proc">8.8. ep_send_events_proc</a></li>
      <li><a href="#89-ep_poll_callback" id="markdown-toc-89-ep_poll_callback">8.9. ep_poll_callback</a></li>
    </ul>
  </li>
  <li><a href="#9-å‚è€ƒ" id="markdown-toc-9-å‚è€ƒ">9. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-åº”ç”¨åœºæ™¯">1. åº”ç”¨åœºæ™¯</h2>

<p>epoll åº”ç”¨ï¼Œé€‚åˆæµ·é‡ç”¨æˆ·ï¼Œä¸€ä¸ªæ—¶é—´æ®µå†…éƒ¨åˆ†æ´»è·ƒçš„ç”¨æˆ·ç¾¤ä½“ã€‚</p>

<p>ä¾‹å¦‚ appï¼Œæ­£å¸¸ç”¨æˆ·å¹¶ä¸æ˜¯ 24 å°æ—¶éƒ½æ‹¿èµ·æ‰‹æœºç©ä¸ªä¸åœï¼Œå¯èƒ½ç©ä¸€ä¸‹ï¼Œåˆå»å¹²åˆ«çš„äº‹ï¼Œå›å¤´åˆç©ä¸€ä¸‹ï¼Œæ–­æ–­ç»­ç»­åœ°æ“ä½œã€‚å³ä¾¿æ­£åœ¨ä½¿ç”¨ app ä¹Ÿä¸æ˜¯è¿ç»­äº§ç”Ÿè¯»å†™é€šä¿¡äº‹ä»¶ï¼Œå¯èƒ½æ‰‹æŒ‡ç‚¹å‡»å‡ ä¸‹é¡µé¢ï¼Œé¡µé¢äº§ç”Ÿéœ€è¦çš„å†…å®¹ï¼Œç”¨æˆ·å°±å»æµè§ˆå†…å®¹ï¼Œä¸å†æ“ä½œäº†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨æµ·é‡ç”¨æˆ·é‡Œï¼ŒåŒä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œå¾ˆå¯èƒ½åªæœ‰ä¸€å°éƒ¨åˆ†ç”¨æˆ·æ­£åœ¨æ´»è·ƒï¼Œè€Œåœ¨è¿™ä¸€å°éƒ¨åˆ†æ´»è·ƒç”¨æˆ·é‡Œï¼Œåˆåªæœ‰ä¸€å°æ’®äººåŒæ—¶ç‚¹å‡»é¡µé¢ä¸Šçš„æ“ä½œã€‚é‚£ epoll ç®¡ç†æµ·é‡ç”¨æˆ·ï¼Œåªéœ€è¦å°†è¿™ä¸€å°æ’®äººäº§ç”Ÿçš„äº‹ä»¶ï¼ŒåŠæ—¶é€šçŸ¥ appserver å¤„ç†é€»è¾‘å³å¯ã€‚</p>

<blockquote>
  <p>é—®é¢˜ï¼šåŒæ ·åœºæ™¯ï¼Œå¦‚æœç”¨æˆ·æ˜¯æœºå™¨äººï¼Œ24 å°æ—¶æŒç»­å·¥ä½œï¼Œè¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨ epoll è¿˜åˆé€‚å—ï¼Ÿ</p>
</blockquote>

<hr />

<h2 id="2-é¢„å¤‡çŸ¥è¯†">2. é¢„å¤‡çŸ¥è¯†</h2>

<ul>
  <li>èµ°è¯» epoll æºç å‰ï¼Œå…ˆç†Ÿæ‚‰å†…æ ¸ç›¸å…³å·¥ä½œæµç¨‹ï¼š<a href="https://wenfh2020.com/2020/04/22/epoll_code-prepare/">[epoll æºç èµ°è¯»] epoll æºç å®ç°-é¢„å¤‡çŸ¥è¯†</a>ã€‚</li>
  <li>èµ°è¯»æºç è¿‡ç¨‹ä¸­ï¼Œå¯ä»¥é€šè¿‡ <a href="https://linux.die.net/man/">Linux æ–‡æ¡£</a> æœç´¢ epoll ç›¸å…³çŸ¥è¯†ã€‚</li>
</ul>

<hr />

<h2 id="3-ä½¿ç”¨">3. ä½¿ç”¨</h2>

<ul>
  <li>æ¥å£ã€‚</li>
</ul>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æ¥å£</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><a href="http://man7.org/linux/man-pages/man2/epoll_create.2.html">epoll_create</a></td>
      <td style="text-align: left">åˆ›å»º epollã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="http://man7.org/linux/man-pages/man2/epoll_ctl.2.html">epoll_ctl</a></td>
      <td style="text-align: left">fd äº‹ä»¶æ³¨å†Œå‡½æ•°ï¼Œç”¨æˆ·é€šè¿‡è¿™ä¸ªå‡½æ•°å…³æ³¨ fd è¯»å†™äº‹ä»¶ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="http://man7.org/linux/man-pages/man2/epoll_wait.2.html">epoll_wait</a></td>
      <td style="text-align: left">é˜»å¡ç­‰å¾… fd äº‹ä»¶å‘ç”Ÿã€‚</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ä½¿ç”¨æµç¨‹ã€‚</li>
</ul>

<p><img src="/images/2020-05-11-16-57-43.png" alt="epoll ä½¿ç”¨æµç¨‹" data-action="zoom" /></p>

<hr />

<h2 id="4-äº‹ä»¶">4. äº‹ä»¶</h2>

<p>å¸¸ç”¨äº‹ä»¶æ³¨é‡Šå¯ä»¥è¯·å‚è€ƒ <a href="http://man7.org/linux/man-pages/man2/epoll_ctl.2.html">epoll_ctl æ–‡æ¡£</a>ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// eventpoll.h</span>
<span class="cp">#define EPOLLIN     (__force __poll_t)0x00000001
#define EPOLLOUT    (__force __poll_t)0x00000004
#define EPOLLERR    (__force __poll_t)0x00000008
#define EPOLLHUP    (__force __poll_t)0x00000010
#define EPOLLRDHUP  (__force __poll_t)0x00002000
#define EPOLLEXCLUSIVE  ((__force __poll_t)(1U &lt;&lt; 28))
#define EPOLLET     ((__force __poll_t)(1U &lt;&lt; 31))
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">äº‹ä»¶</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">EPOLLIN</td>
      <td style="text-align: left">æœ‰å¯è¯»æ•°æ®åˆ°æ¥ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLOUT</td>
      <td style="text-align: left">æœ‰æ•°æ®è¦å†™ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLERR</td>
      <td style="text-align: left">è¯¥æ–‡ä»¶æè¿°ç¬¦å‘ç”Ÿé”™è¯¯ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLHUP</td>
      <td style="text-align: left">è¯¥æ–‡ä»¶æè¿°ç¬¦è¢«æŒ‚æ–­ã€‚å¸¸è§ socket è¢«å…³é—­ï¼ˆread == 0ï¼‰ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLRDHUP</td>
      <td style="text-align: left">å¯¹ç«¯å·²å…³é—­é“¾æ¥ï¼Œæˆ–è€…ç”¨ shutdown å…³é—­äº†å†™é“¾æ¥ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLEXCLUSIVE</td>
      <td style="text-align: left">å”¯ä¸€å”¤é†’äº‹ä»¶ï¼Œä¸»è¦ä¸ºäº†è§£å†³ epoll_wait æƒŠç¾¤é—®é¢˜ã€‚å¤šçº¿ç¨‹ä¸‹å¤šä¸ª epoll_wait åŒæ—¶ç­‰å¾…ï¼Œåªå”¤é†’ä¸€ä¸ª epoll_wait æ‰§è¡Œã€‚ è¯¥äº‹ä»¶åªæ”¯æŒ epoll_ctl æ·»åŠ æ“ä½œ EPOLL_CTL_ADDã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">EPOLLET</td>
      <td style="text-align: left">è¾¹ç¼˜è§¦å‘æ¨¡å¼ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<p>é€šè¿‡ tcp_poll å‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ° socket äº‹ä»¶å¯¹åº”çš„ç›¸å…³äº‹ä»¶é€»è¾‘ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// tcp.c</span>
<span class="cm">/*
 *    Wait for a TCP event.
 *
 *    Note that we don't need to lock the socket, as the upper poll layers
 *    take care of normal races (between the test and the event) and we don't
 *    go look at any of the socket buffers directly.
 */</span>
<span class="n">__poll_t</span> <span class="nf">tcp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__poll_t</span> <span class="n">mask</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

    <span class="c1">// fd æ·»åŠ ç­‰å¾…äº‹ä»¶ï¼Œå…³è”äº‹ä»¶å›è°ƒã€‚</span>
    <span class="n">sock_poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

    <span class="c1">// socket å¯¹åº”äº‹ä»¶é€»è¾‘ã€‚</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">inet_sk_state_load</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inet_csk_listen_poll</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>

    <span class="cm">/* Socket is not locked. We are protected from async events
     * by poll logic and correct handling of state changes
     * made by other threads is impossible in any case.
     */</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="cm">/*
     * EPOLLHUP is certainly not done right. But poll() doesn't
     * have a notion of HUP in just one direction, and for a
     * socket the read side is more interesting.
     *
     * Some poll() documentation says that EPOLLHUP is incompatible
     * with the EPOLLOUT/POLLWR flags, so somebody should check this
     * all. But careful, it tends to be safer to return too many
     * bits than too few, and you can easily break real applications
     * if you don't tell them that something has hung up!
     *
     * Check-me.
     *
     * Check number 1. EPOLLHUP is _UNMASKABLE_ event (see UNIX98 and
     * our fs/select.c). It means that after we received EOF,
     * poll always returns immediately, making impossible poll() on write()
     * in state CLOSE_WAIT. One solution is evident --- to set EPOLLHUP
     * if and only if shutdown has been made in both directions.
     * Actually, it is interesting to look how Solaris and DUX
     * solve this dilemma. I would prefer, if EPOLLHUP were maskable,
     * then we could set it on SND_SHUTDOWN. BTW examples given
     * in Stevens' books assume exactly this behaviour, it explains
     * why EPOLLHUP is incompatible with EPOLLOUT.    --ANK
     *
     * NOTE. Check for TCP_CLOSE is added. The goal is to prevent
     * blocking on fresh not-connected or disconnected socket. --ANK
     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">==</span> <span class="n">SHUTDOWN_MASK</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">TCP_CLOSE</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLHUP</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">RCV_SHUTDOWN</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">EPOLLRDNORM</span> <span class="o">|</span> <span class="n">EPOLLRDHUP</span><span class="p">;</span>

    <span class="cm">/* Connected or passive Fast Open socket? */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TCP_SYN_SENT</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">TCP_SYN_RECV</span> <span class="o">||</span> <span class="n">rcu_access_pointer</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">fastopen_rsk</span><span class="p">)))</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">target</span> <span class="o">=</span> <span class="n">sock_rcvlowat</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">urg_seq</span><span class="p">)</span> <span class="o">==</span> <span class="n">READ_ONCE</span><span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">copied_seq</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="n">sock_flag</span><span class="p">(</span><span class="n">sk</span><span class="p">,</span> <span class="n">SOCK_URGINLINE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">tp</span><span class="o">-&gt;</span><span class="n">urg_data</span><span class="p">)</span>
            <span class="n">target</span><span class="o">++</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tcp_stream_is_readable</span><span class="p">(</span><span class="n">tp</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">sk</span><span class="p">))</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLIN</span> <span class="o">|</span> <span class="n">EPOLLRDNORM</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_shutdown</span> <span class="o">&amp;</span> <span class="n">SEND_SHUTDOWN</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_is_writeable</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span> <span class="o">|</span> <span class="n">EPOLLWRNORM</span><span class="p">;</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>  <span class="cm">/* send SIGIO later */</span>
                <span class="n">sk_set_bit</span><span class="p">(</span><span class="n">SOCKWQ_ASYNC_NOSPACE</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
                <span class="n">set_bit</span><span class="p">(</span><span class="n">SOCK_NOSPACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_socket</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

                <span class="cm">/* Race breaker. If space is freed after
                 * wspace test but before the flags are set,
                 * IO signal will be lost. Memory barrier
                 * pairs with the input side.
                 */</span>
                <span class="n">smp_mb__after_atomic</span><span class="p">();</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sk_stream_is_writeable</span><span class="p">(</span><span class="n">sk</span><span class="p">))</span>
                    <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span> <span class="o">|</span> <span class="n">EPOLLWRNORM</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span> <span class="o">|</span> <span class="n">EPOLLWRNORM</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="o">-&gt;</span><span class="n">urg_data</span> <span class="o">&amp;</span> <span class="n">TCP_URG_VALID</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLPRI</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_SYN_SENT</span> <span class="o">&amp;&amp;</span> <span class="n">inet_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">defer_connect</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Active TCP fastopen socket with defer_connect
         * Return EPOLLOUT so application can call write()
         * in order for kernel to generate SYN+data
         */</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLOUT</span> <span class="o">|</span> <span class="n">EPOLLWRNORM</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* This barrier is coupled with smp_wmb() in tcp_reset() */</span>
    <span class="n">smp_rmb</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_err</span> <span class="o">||</span> <span class="o">!</span><span class="n">skb_queue_empty_lockless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_error_queue</span><span class="p">))</span>
        <span class="n">mask</span> <span class="o">|=</span> <span class="n">EPOLLERR</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">tcp_poll</span><span class="p">);</span>
</code></pre></div></div>

<hr />

<h2 id="5-æºç å·¥ä½œæµç¨‹">5. æºç å·¥ä½œæµç¨‹</h2>

<p><img src="/images/2020-05-16-21-14-46.png" alt="epoll æºç å·¥ä½œæµç¨‹" data-action="zoom" /></p>

<h2 id="6-æ•°æ®ç»“æ„">6. æ•°æ®ç»“æ„</h2>

<h3 id="61-eventpoll">6.1. eventpoll</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * This structure is stored inside the "private_data" member of the file
 * structure and represents the main data structure for the eventpoll
 * interface.
 */</span>
<span class="k">struct</span> <span class="n">eventpoll</span> <span class="p">{</span>
    <span class="cm">/*
     * This mutex is used to ensure that files are not removed
     * while epoll is using them. This is held during the event
     * collection loop, the file cleanup path, the epoll file exit
     * code and the ctl operations.
     */</span>
    <span class="k">struct</span> <span class="n">mutex</span> <span class="n">mtx</span><span class="p">;</span>

    <span class="cm">/* Wait queue used by sys_epoll_wait() */</span>
    <span class="n">wait_queue_head_t</span> <span class="n">wq</span><span class="p">;</span>

    <span class="cm">/* Wait queue used by file-&gt;poll() */</span>
    <span class="n">wait_queue_head_t</span> <span class="n">poll_wait</span><span class="p">;</span>

    <span class="cm">/* List of ready file descriptors */</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">rdllist</span><span class="p">;</span>

    <span class="cm">/* Lock which protects rdllist and ovflist */</span>
    <span class="n">rwlock_t</span> <span class="n">lock</span><span class="p">;</span>

    <span class="cm">/* RB tree root used to store monitored fd structs */</span>
    <span class="k">struct</span> <span class="n">rb_root_cached</span> <span class="n">rbr</span><span class="p">;</span>

    <span class="cm">/*
     * This is a single linked list that chains all the "struct epitem" that
     * happened while transferring ready events to userspace w/out
     * holding -&gt;lock.
     */</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">ovflist</span><span class="p">;</span>

    <span class="cm">/* wakeup_source used when ep_scan_ready_list is running */</span>
    <span class="k">struct</span> <span class="n">wakeup_source</span> <span class="o">*</span><span class="n">ws</span><span class="p">;</span>

    <span class="cm">/* The user that created the eventpoll descriptor */</span>
    <span class="k">struct</span> <span class="n">user_struct</span> <span class="o">*</span><span class="n">user</span><span class="p">;</span>

    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

    <span class="cm">/* used to optimize loop detection check */</span>
    <span class="kt">int</span> <span class="n">visited</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">visited_list_link</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_NET_RX_BUSY_POLL
</span>    <span class="cm">/* used to track busy poll napi_id */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">napi_id</span><span class="p">;</span>
<span class="cp">#endif
</span><span class="p">};</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">mtx</td>
      <td style="text-align: left">äº’æ–¥å˜é‡ï¼Œé¿å…åœ¨éå† epi èŠ‚ç‚¹æ—¶ï¼ˆä¾‹å¦‚ ep_send_eventsï¼‰ï¼Œepi è¢«åˆ é™¤ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">wq</td>
      <td style="text-align: left">ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“ epoll_wait æ²¡å‘ç°å°±ç»ªäº‹ä»¶éœ€è¦å¤„ç†ï¼Œæ·»åŠ ç­‰å¾…äº‹ä»¶ï¼Œéœ€è¦ç¡çœ é˜»å¡ç­‰å¾…å”¤é†’è¿›ç¨‹ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">poll_wait</td>
      <td style="text-align: left">ç­‰å¾…é˜Ÿåˆ—ï¼Œå½“epoll_ctl ç›‘å¬çš„æ˜¯å¦å¤–ä¸€ä¸ª epoll fd æ—¶ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">rdllist</td>
      <td style="text-align: left">å°±ç»ªåˆ—è¡¨ï¼Œäº§ç”Ÿäº†ç”¨æˆ·æ³¨å†Œçš„ fdè¯»å†™äº‹ä»¶çš„ epi é“¾è¡¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ovflist</td>
      <td style="text-align: left">å•é“¾è¡¨ï¼Œå½“ rdllist è¢«é”å®šéå†ï¼Œå‘ç”¨æˆ·ç©ºé—´å‘é€æ•°æ®æ—¶ï¼Œrdllist ä¸å…è®¸è¢«ä¿®æ”¹ï¼Œæ–°è§¦å‘çš„å°±ç»ª epitem è¢« ovflist ä¸²è”èµ·æ¥ï¼Œç­‰å¾… rdllist è¢«å¤„ç†å®Œäº†ï¼Œé‡æ–°å°† ovflist æ•°æ®å†™å…¥ rdllistã€‚ è¯¦çœ‹ ep_scan_ready_list é€»è¾‘ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">user</td>
      <td style="text-align: left">åˆ›å»º eventpoll çš„ç”¨æˆ·ç»“æ„ä¿¡æ¯ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">lock</td>
      <td style="text-align: left">é”ï¼Œä¿æŠ¤ rdllist å’Œ ovflist ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">rbr</td>
      <td style="text-align: left">çº¢é»‘æ ‘æ ¹ç»“ç‚¹ï¼Œç®¡ç† fd ç»“ç‚¹ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">file</td>
      <td style="text-align: left">eventpoll å¯¹åº”çš„æ–‡ä»¶ç»“æ„ï¼ŒLinux ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œç”¨ vfs ç®¡ç†æ•°æ®ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">napi_id</td>
      <td style="text-align: left">åº”ç”¨äºä¸­æ–­ç¼“è§£æŠ€æœ¯ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="62-epitem">6.2. epitem</h3>

<p>fd äº‹ä»¶ç®¡ç†èŠ‚ç‚¹ã€‚å¯ä»¥æ·»åŠ åˆ°çº¢é»‘æ ‘ï¼Œä¹Ÿå¯ä»¥ä¸²è”æˆå°±ç»ªåˆ—è¡¨æˆ–å…¶å®ƒåˆ—è¡¨ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/*
 * Each file descriptor added to the eventpoll interface will
 * have an entry of this type linked to the "rbr" RB tree.
 * Avoid increasing the size of this struct, there can be many thousands
 * of these on a server and we do not want this to take another cache line.
 */</span>
<span class="k">struct</span> <span class="n">epitem</span> <span class="p">{</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="cm">/* RB tree node links this structure to the eventpoll RB tree */</span>
        <span class="k">struct</span> <span class="n">rb_node</span> <span class="n">rbn</span><span class="p">;</span>
        <span class="cm">/* Used to free the struct epitem */</span>
        <span class="k">struct</span> <span class="n">rcu_head</span> <span class="n">rcu</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="cm">/* List header used to link this structure to the eventpoll ready list */</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">rdllink</span><span class="p">;</span>

    <span class="cm">/*
     * Works together "struct eventpoll"-&gt;ovflist in keeping the
     * single linked chain of items.
     */</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

    <span class="cm">/* The file descriptor information this item refers to */</span>
    <span class="k">struct</span> <span class="n">epoll_filefd</span> <span class="n">ffd</span><span class="p">;</span>

    <span class="cm">/* Number of active wait queue attached to poll operations */</span>
    <span class="kt">int</span> <span class="n">nwait</span><span class="p">;</span>

    <span class="cm">/* List containing poll wait queues */</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">pwqlist</span><span class="p">;</span>

    <span class="cm">/* The "container" of this item */</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>

    <span class="cm">/* List header used to link this item to the "struct file" items list */</span>
    <span class="k">struct</span> <span class="n">list_head</span> <span class="n">fllink</span><span class="p">;</span>

    <span class="cm">/* wakeup_source used when EPOLLWAKEUP is set */</span>
    <span class="k">struct</span> <span class="n">wakeup_source</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">ws</span><span class="p">;</span>

    <span class="cm">/* The structure that describe the interested events and the source fd */</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">event</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">rbn</td>
      <td style="text-align: left">è¿æ¥çº¢é»‘æ ‘ç»“æ„èŠ‚ç‚¹ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">rdllink</td>
      <td style="text-align: left">å°±ç»ªé˜Ÿåˆ—èŠ‚ç‚¹ï¼Œç”¨äºå°† epitem ä¸²è”æˆå°±ç»ªé˜Ÿåˆ—åˆ—è¡¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">next</td>
      <td style="text-align: left">æŒ‡å‘ä¸‹ä¸€ä¸ªå•é“¾è¡¨èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚é…åˆ eventpoll çš„ ovflist ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ffd</td>
      <td style="text-align: left">è®°å½•èŠ‚ç‚¹å¯¹åº”çš„ fd å’Œ file æ–‡ä»¶ä¿¡æ¯ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">nwait</td>
      <td style="text-align: left">ç­‰å¾…é˜Ÿåˆ—ä¸ªæ•°ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">pwqlist</td>
      <td style="text-align: left">ç­‰å¾…äº‹ä»¶å›è°ƒé˜Ÿåˆ—ã€‚å½“æ•°æ®è¿›å…¥ç½‘å¡ï¼Œåº•å±‚ä¸­æ–­æ‰§è¡Œ ep_poll_callbackã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep</td>
      <td style="text-align: left">eventpoll æŒ‡é’ˆï¼Œepitem å…³è” eventpollã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">fllink</td>
      <td style="text-align: left">epoll æ–‡ä»¶é“¾è¡¨ç»“ç‚¹ï¼Œä¸ epoll æ–‡ä»¶é“¾è¡¨è¿›è¡Œå…³è” file.f_ep_linksã€‚å‚è€ƒ fs.h, struct file ç»“æ„ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ws</td>
      <td style="text-align: left">EPOLLWAKEUP æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">event</td>
      <td style="text-align: left">ç”¨æˆ·å…³æ³¨çš„äº‹ä»¶ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="63-epoll_filefd">6.3. epoll_filefd</h3>

<p>fd å¯¹åº” file æ–‡ä»¶ç»“æ„ï¼ŒLinux ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œé‡‡ç”¨äº† vfs ï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ç®¡ç†æ–‡ä»¶æˆ–è®¾å¤‡ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">epoll_filefd</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h3 id="64-epoll_event">6.4. epoll_event</h3>

<p>ç”¨æˆ·å…³æ³¨çš„ epoll äº‹ä»¶ç»“æ„ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">epoll_event</span> <span class="p">{</span>
    <span class="n">__poll_t</span> <span class="n">events</span><span class="p">;</span>
    <span class="n">__u64</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span> <span class="n">EPOLL_PACKED</span><span class="p">;</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">events</td>
      <td style="text-align: left">äº‹ä»¶é›†åˆ</td>
    </tr>
    <tr>
      <td style="text-align: left">data</td>
      <td style="text-align: left">fd</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="65-poll_table_struct">6.5. poll_table_struct</h3>

<p>å°±ç»ªäº‹ä»¶å¤„ç†ç»“æ„ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* poll.h
 * Do not touch the structure directly, use the access functions
 * poll_does_not_wait() and poll_requested_events() instead.
 */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="p">{</span>
    <span class="n">poll_queue_proc</span> <span class="n">_qproc</span><span class="p">;</span>
    <span class="n">__poll_t</span> <span class="n">_key</span><span class="p">;</span>
<span class="p">}</span> <span class="n">poll_table</span><span class="p">;</span>

<span class="cm">/*
 * structures and helpers for f_op-&gt;poll implementations
 */</span>
<span class="k">typedef</span> <span class="nf">void</span> <span class="p">(</span><span class="o">*</span><span class="n">poll_queue_proc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="p">);</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">_qproc</td>
      <td style="text-align: left">å¤„ç†å‡½æ•°ï¼Œå¯ä»¥æŒ‡å‘ ep_ptable_queue_proc å‡½æ•°ï¼Œæˆ–è€…ç©ºã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">_key</td>
      <td style="text-align: left">äº‹ä»¶ç»„åˆã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="66-ep_pqueue">6.6. ep_pqueue</h3>

<p>åŒ…è£…å°±ç»ªäº‹ä»¶å¤„ç†ç»“æ„ï¼Œå…³è” epitemã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Wrapper struct used by poll queueing */</span>
<span class="k">struct</span> <span class="n">ep_pqueue</span> <span class="p">{</span>
    <span class="n">poll_table</span> <span class="n">pt</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">æˆå‘˜</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">_qproc</td>
      <td style="text-align: left">å¤„ç†å‡½æ•°ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">_key</td>
      <td style="text-align: left">äº‹ä»¶ç»„åˆã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="7-å…³é”®å‡½æ•°">7. å…³é”®å‡½æ•°</h2>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å‡½æ•°</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">eventpoll_init</td>
      <td style="text-align: left">åˆå§‹åŒ– epoll æ¨¡å—ã€‚eventpoll ä½œä¸º Linux å†…æ ¸çš„ä¸€éƒ¨åˆ†ï¼Œæ¨¡å—åŒ–ç®¡ç†ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">do_epoll_create</td>
      <td style="text-align: left">ä¸º eventpoll ç»“æ„åˆ†é…èµ„æºã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">do_epoll_ctl</td>
      <td style="text-align: left">epoll ç®¡ç† fd äº‹ä»¶æ¥å£ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">do_epoll_wait</td>
      <td style="text-align: left">æœ‰æ¡ä»¶é˜»å¡ç­‰å¾… fd äº‹ä»¶å‘ç”Ÿï¼Œè¿”å›å¯¹fd å’Œå¯¹åº”äº‹ä»¶æ•°æ®ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_item_poll</td>
      <td style="text-align: left">è·å– fd å°±ç»ªäº‹ä»¶ï¼Œå¹¶å…³è” fd å’Œäº‹ä»¶è§¦å‘å›è°ƒå‡½æ•° ep_poll_callbackã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_poll_callback</td>
      <td style="text-align: left">fd äº‹ä»¶å›è°ƒå‡½æ•°ã€‚å½“åº•å±‚æ”¶åˆ°æ•°æ®ï¼Œä¸­æ–­è°ƒç”¨ fd å…³è”çš„ ep_poll_callback å›è°ƒå‡½æ•°ï¼Œå¦‚æœäº‹ä»¶æ˜¯ç”¨æˆ·å…³æ³¨çš„äº‹ä»¶ï¼Œä¼šå°† fd å¯¹åº”çš„ epi ç»“ç‚¹æ·»åŠ è¿›å°±ç»ªé˜Ÿåˆ—ï¼Œç„¶åå”¤é†’é˜»å¡ç­‰å¾…çš„ epoll_wait å¤„ç†ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_send_events</td>
      <td style="text-align: left">éå†å°±ç»ªåˆ—è¡¨ï¼Œæ‹·è´å†…æ ¸ç©ºé—´å°±ç»ªæ•°æ®åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç»“åˆ ep_scan_ready_list å’Œ ep_send_events_proc ä½¿ç”¨ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_scan_ready_list</td>
      <td style="text-align: left">éå†å°±ç»ªåˆ—è¡¨ã€‚å½“ fd æ”¶åˆ°æ•°æ®ï¼Œå›è°ƒ ep_poll_callbackï¼Œå¦‚æœäº‹ä»¶æ˜¯ç”¨æˆ·å…³æ³¨çš„ï¼Œé‚£ä¹ˆå°† fd å¯¹åº”çš„ epi ç»“ç‚¹æ·»åŠ åˆ°å°±ç»ªé˜Ÿåˆ—ï¼Œep_scan_ready_list ä¼šéå†è¿™ä¸ªå°±ç»ªåˆ—è¡¨ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œæˆ–è€…å…¶å®ƒæ“ä½œã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_send_events_proc</td>
      <td style="text-align: left">å†…æ ¸å°†å°±ç»ªåˆ—è¡¨æ•°æ®ï¼Œå‘é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚ç»“åˆ ep_scan_ready_list ä½¿ç”¨ã€‚LT/ET æ¨¡å¼åœ¨è¿™ä¸ªå‡½æ•°é‡Œå®ç°ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">ep_ptable_queue_proc</td>
      <td style="text-align: left">æ·»åŠ  fd çš„ç­‰å¾…äº‹ä»¶åˆ°ç­‰å¾…é˜Ÿåˆ—ï¼Œå…³è” fd ä¸å›è°ƒå‡½æ•° ep_poll_callbackã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="8-æ ¸å¿ƒæºç ">8. æ ¸å¿ƒæºç </h2>

<h3 id="81-åˆå§‹åŒ–">8.1. åˆå§‹åŒ–</h3>

<p>æ·»åŠ  epoll æ¨¡å—åˆ°å†…æ ¸ï¼Œslab ç®—æ³•ä¸º epoll åˆ†é…èµ„æºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">eventpoll_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">sysinfo</span> <span class="n">si</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="cm">/* Allocates slab cache used to allocate "struct epitem" items */</span>
    <span class="n">epi_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">"eventpoll_epi"</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epitem</span><span class="p">),</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_HWCACHE_ALIGN</span><span class="o">|</span><span class="n">SLAB_PANIC</span><span class="o">|</span><span class="n">SLAB_ACCOUNT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="cm">/* Allocates slab cache used to allocate "struct eppoll_entry" */</span>
    <span class="n">pwq_cache</span> <span class="o">=</span> <span class="n">kmem_cache_create</span><span class="p">(</span><span class="s">"eventpoll_pwq"</span><span class="p">,</span>
        <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">eppoll_entry</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SLAB_PANIC</span><span class="o">|</span><span class="n">SLAB_ACCOUNT</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">eventpoll_init</span><span class="p">);</span>
</code></pre></div></div>

<hr />

<h3 id="82-epoll_create">8.2. epoll_create</h3>

<p>åˆ›å»º eventpoll å¯¹è±¡ï¼Œå…³è”æ–‡ä»¶èµ„æºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">do_epoll_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span><span class="p">,</span> <span class="n">fd</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="c1">// slab ç®—æ³•ä¸º eventpoll ç»“æ„åˆ†é…å†…å­˜ï¼Œå¹¶åˆå§‹åŒ– eventpoll æˆå‘˜æ•°æ®ã€‚</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">ep_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">;</span>

    <span class="c1">// åˆ†é…ä¸€ä¸ªç©ºé—²çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">get_unused_fd_flags</span><span class="p">(</span><span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CLOEXEC</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
        <span class="k">goto</span> <span class="n">out_free_ep</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// slab åˆ†é…ä¸€ä¸ªæ–°çš„æ–‡ä»¶ç»“æ„å¯¹è±¡ï¼ˆstruct file *ï¼‰</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">anon_inode_getfile</span><span class="p">(</span><span class="s">"[eventpoll]"</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">eventpoll_fops</span><span class="p">,</span> <span class="n">ep</span><span class="p">,</span>
                 <span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_CLOEXEC</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out_free_fd</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

    <span class="c1">// fd ä¸ file* ç»“æ„è¿›è¡Œç»‘å®šã€‚</span>
    <span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="83-epoll_ctl">8.3. epoll_ctl</h3>

<p>fd å¯¹åº”çš„äº‹ä»¶ç®¡ç†ï¼ˆå¢åˆ æ”¹ï¼‰ã€‚</p>

<ul>
  <li>æ·»åŠ  fd äº‹ä»¶ç®¡ç†æµç¨‹ï¼šfd å…³è”å›è°ƒ ep_poll_callbackã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fd -&gt; socket -&gt; poll -&gt; ep_ptable_queue_proc -&gt; wait_queue -&gt; ep_poll_callback
</code></pre></div></div>

<ul>
  <li>è§¦å‘äº† fd å…³æ³¨çš„äº‹ä»¶å›è°ƒå¤„ç†ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>driver -&gt; ep_poll_callback -&gt; waitup -&gt; epoll_wait<span class="o">(</span>wake up<span class="o">)</span>
</code></pre></div></div>

<hr />

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">epoll_ctl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span>
        <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">epds</span><span class="p">;</span>

    <span class="c1">// ä¸ºäº† event æ•°æ®çš„å®‰å…¨æ€§ï¼Œå°†æ•°æ®è¿›è¡Œæ‹·è´ï¼Œå†è¿›è¡Œé€»è¾‘å¤„ç†ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ep_op_has_event</span><span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epds</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">epoll_event</span><span class="p">)))</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">do_epoll_ctl</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">op</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epds</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">do_epoll_ctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">op</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">epds</span><span class="p">,</span> <span class="n">bool</span> <span class="n">nonblock</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">full_check</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">fd</span> <span class="n">f</span><span class="p">,</span> <span class="n">tf</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">tep</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="c1">// æ£€æŸ¥å‚æ•°åˆæ³•æ€§ã€‚</span>
    <span class="p">...</span>
    <span class="c1">// åœ¨ do_epoll_create å®ç°é‡Œ anon_inode_getfile å°† private_data ä¸ eventpoll å…³è”ã€‚</span>
    <span class="n">ep</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="c1">// çº¢é»‘æ ‘æ£€æŸ¥ fd æ˜¯å¦å·²ç»è¢«æ·»åŠ ã€‚</span>
    <span class="n">epi</span> <span class="o">=</span> <span class="n">ep_find</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">fd</span><span class="p">);</span>

    <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">op</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">EPOLL_CTL_ADD</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">epi</span><span class="p">)</span> <span class="p">{</span>
            <span class="cm">/* epoll å¦‚æœæ²¡æœ‰æ·»åŠ è¿‡è¯¥ fdï¼Œå°±æ·»åŠ åˆ°çº¢é»‘æ ‘è¿›è¡Œç®¡ç†ã€‚
             * äº‹ä»¶é»˜è®¤å…³æ³¨å¼‚å¸¸å¤„ç†(EPOLLERR | EPOLLHUP)ã€‚*/</span>
            <span class="n">epds</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLERR</span> <span class="o">|</span> <span class="n">EPOLLHUP</span><span class="p">;</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ep_insert</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">epds</span><span class="p">,</span> <span class="n">tf</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">full_check</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">full_check</span><span class="p">)</span>
            <span class="n">clear_tfile_check_list</span><span class="p">();</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EPOLL_CTL_DEL</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">ep_remove</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">epi</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="n">EPOLL_CTL_MOD</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLEXCLUSIVE</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">epds</span><span class="o">-&gt;</span><span class="n">events</span> <span class="o">|=</span> <span class="n">EPOLLERR</span> <span class="o">|</span> <span class="n">EPOLLHUP</span><span class="p">;</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">ep_modify</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">epi</span><span class="p">,</span> <span class="n">epds</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span>
            <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_insert</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
             <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">tfile</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">full_check</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// epoll ç®¡ç† fd å’Œå¯¹åº”äº‹ä»¶èŠ‚ç‚¹ epitem æ•°æ®ç»“æ„ã€‚</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">ep_pqueue</span> <span class="n">epq</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">epq</span><span class="p">.</span><span class="n">epi</span> <span class="o">=</span> <span class="n">epi</span><span class="p">;</span>

    <span class="c1">// åˆå§‹åŒ–å°±ç»ªäº‹ä»¶å¤„ç†å‡½æ•°è°ƒç”¨ã€‚poll() æ¥å£è°ƒç”¨ ep_ptable_queue_procã€‚</span>
    <span class="n">init_poll_funcptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epq</span><span class="p">.</span><span class="n">pt</span><span class="p">,</span> <span class="n">ep_ptable_queue_proc</span><span class="p">);</span>

    <span class="c1">// æ·»åŠ ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœ fd æœ‰ç”¨æˆ·å…³æ³¨çš„äº‹ä»¶å‘ç”Ÿï¼Œè¿”å›å¯¹åº” fd å…³æ³¨çš„äº‹ä»¶ reventsã€‚</span>
    <span class="n">revents</span> <span class="o">=</span> <span class="n">ep_item_poll</span><span class="p">(</span><span class="n">epi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epq</span><span class="p">.</span><span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">// å°†å½“å‰èŠ‚ç‚¹ï¼Œæ·»åŠ åˆ° epoll æ–‡ä»¶é’©å­ï¼Œå°† epoll æ–‡ä»¶ä¸ fd å¯¹åº”æ–‡ä»¶ä¸²è”èµ·æ¥ã€‚</span>
    <span class="n">list_add_tail_rcu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">fllink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tfile</span><span class="o">-&gt;</span><span class="n">f_ep_links</span><span class="p">);</span>

    <span class="c1">// å°†èŠ‚ç‚¹æ·»åŠ è¿›äºŒå‰æ ‘</span>
    <span class="n">ep_rbtree_insert</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">epi</span><span class="p">);</span>

    <span class="c1">// å¦‚æœæœ‰å…³æ³¨çš„äº‹ä»¶å‘ç”Ÿï¼Œå°†èŠ‚ç‚¹å…³è”åˆ°å°±ç»ªäº‹ä»¶åˆ—è¡¨ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">revents</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ep_is_linked</span><span class="p">(</span><span class="n">epi</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">);</span>
        <span class="n">ep_pm_stay_awake</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>

        <span class="cm">/* å¦‚æœè¿›ç¨‹æ­£åœ¨ç¡çœ ç­‰å¾…ï¼Œå”¤é†’å®ƒå»å¤„ç†å°±ç»ªäº‹ä»¶ã€‚ç¡çœ äº‹ä»¶ ep-&gt;wq åœ¨ epoll_wait ä¸­æ·»åŠ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span>
            <span class="c1">// å”¤é†’è¿›ç¨‹</span>
            <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>

        <span class="c1">// å¦‚æœç›‘æ§çš„æ˜¯å¦å¤–ä¸€ä¸ª epoll_create çš„ fdï¼Œæœ‰å°±ç»ªäº‹ä»¶ï¼Œä¹Ÿå”¤é†’è¿›ç¨‹ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">))</span>
            <span class="n">pwake</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pwake</span><span class="p">)</span>
        <span class="n">ep_poll_safewake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="84-ep_item_poll">8.4. ep_item_poll</h3>

<p>fd èŠ‚ç‚¹å°±ç»ªäº‹ä»¶å¤„ç†ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">__poll_t</span> <span class="nf">ep_item_poll</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">locked</span><span class="p">;</span>

    <span class="n">pt</span><span class="o">-&gt;</span><span class="n">_key</span> <span class="o">=</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_file_epoll</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">ffd</span><span class="p">.</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// é epoll fdï¼Œtcp_poll æ£€æŸ¥ socket å°±ç»ªäº‹ä»¶ï¼Œfd å…³è”å›è°ƒå‡½æ•° ep_poll_callbackã€‚</span>
        <span class="k">return</span> <span class="n">vfs_poll</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">ffd</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// epoll åµŒå¥—ã€‚epoll_ctl æ·»åŠ å…³æ³¨äº†å¦å¤–ä¸€ä¸ª epoll çš„ fd(epfd)ã€‚</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">ffd</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
        <span class="n">poll_wait</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">ffd</span><span class="p">.</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
        <span class="n">locked</span> <span class="o">=</span> <span class="n">pt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">_qproc</span> <span class="o">==</span> <span class="n">ep_ptable_queue_proc</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">ep_scan_ready_list</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">ffd</span><span class="p">.</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
                    <span class="n">ep_read_events_proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">depth</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">locked</span><span class="p">)</span> <span class="o">&amp;</span>
            <span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// vfs - Virtual Filesystem Switchï¼ˆLinux è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰</span>
<span class="c1">// poll.h å°±ç»ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__poll_t</span> <span class="nf">vfs_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">DEFAULT_POLLMASK</span><span class="p">;</span>
    <span class="c1">// è¿™é‡Œçš„ poll å‡½æ•°æŒ‡é’ˆæŒ‡å‘ tcp_poll å‡½æ•°ã€‚</span>
    <span class="k">return</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// tcp.c</span>
<span class="c1">// tcp å°±ç»ªäº‹ä»¶è·å–å‡½æ•°ã€‚</span>
<span class="n">__poll_t</span> <span class="nf">tcp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__poll_t</span> <span class="n">mask</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

    <span class="cm">/* æ·»åŠ ç­‰å¾…é˜Ÿåˆ—å’Œå…³è”äº‹ä»¶å›è°ƒå‡½æ•° ep_poll_callback
     *ï¼ˆåªæœ‰ epoll_ctl EPOLL_CTL_ADD çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ·»åŠ ç­‰å¾…äº‹ä»¶ï¼Œå¦åˆ™ wait == NULLï¼‰*/</span>
    <span class="n">sock_poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

    <span class="c1">// æ£€æŸ¥ fd æ˜¯å¦æœ‰äº‹ä»¶å‘ç”Ÿã€‚</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">inet_sk_state_load</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inet_csk_listen_poll</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// socket.h</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sock_poll_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ep_insert è°ƒç”¨ ep_item_poll æ‰ä¼šæ’å…¥ç­‰å¾…äº‹ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">poll_does_not_wait</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// poll.h</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">poll_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="n">wait_queue_head_t</span> <span class="o">*</span> <span class="n">wait_address</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_qproc</span> <span class="o">&amp;&amp;</span> <span class="n">wait_address</span><span class="p">)</span>
        <span class="c1">// _qproc ---&gt; ep_ptable_queue_proc</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_qproc</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">wait_address</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="85-ep_ptable_queue_proc">8.5. ep_ptable_queue_proc</h3>

<p>socket çš„ç­‰å¾…é˜Ÿåˆ—å…³è”å›è°ƒå‡½æ•° ep_poll_callback</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">ep_ptable_queue_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">whead</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span> <span class="o">=</span> <span class="n">ep_item_from_epqueue</span><span class="p">(</span><span class="n">pt</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">eppoll_entry</span> <span class="o">*</span><span class="n">pwq</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">nwait</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pwq</span> <span class="o">=</span> <span class="n">kmem_cache_alloc</span><span class="p">(</span><span class="n">pwq_cache</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
        <span class="c1">// å…³è”ç­‰å¾…é˜Ÿåˆ—å’Œep_poll_callbackã€‚</span>
        <span class="n">init_waitqueue_func_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">ep_poll_callback</span><span class="p">);</span>

        <span class="c1">// whead ---&gt; socket-&gt;wq.wait</span>
        <span class="n">pwq</span><span class="o">-&gt;</span><span class="n">whead</span> <span class="o">=</span> <span class="n">whead</span><span class="p">;</span>
        <span class="n">pwq</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">epi</span><span class="p">;</span>

        <span class="cm">/* ç­‰å¾…äº‹ä»¶ï¼Œæ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ã€‚EPOLLEXCLUSIVE ä¸ºäº†è§£å†³ epoll_wait æƒŠç¾¤é—®é¢˜ã€‚
         * å¦‚æœå¤šçº¿ç¨‹åŒæ—¶è°ƒç”¨ epoll_waitï¼Œé‚£ä¹ˆ fd åº”è¯¥è®¾ç½® EPOLLEXCLUSIVE äº‹ä»¶ã€‚ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLEXCLUSIVE</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">add_wait_queue_exclusive</span><span class="p">(</span><span class="n">whead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">add_wait_queue</span><span class="p">(</span><span class="n">whead</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="cm">/* ç­‰å¾…äº‹ä»¶ï¼Œå…³è” epitemã€‚epitem ä¸ºä»€ä¹ˆè¦æœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—å‘¢ï¼Œ
         * å› ä¸ºæœ‰å¯èƒ½ä¸€ä¸ªè¿›ç¨‹é‡Œå­˜åœ¨å¤šä¸ª epoll å®ä¾‹åŒæ—¶ epoll_ctl å…³æ³¨ä¸€ä¸ª fdã€‚*/</span>
        <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pwq</span><span class="o">-&gt;</span><span class="n">llink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">pwqlist</span><span class="p">);</span>
        <span class="n">epi</span><span class="o">-&gt;</span><span class="n">nwait</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* We have to signal that an error occurred */</span>
        <span class="n">epi</span><span class="o">-&gt;</span><span class="n">nwait</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="86-epoll_wait">8.6. epoll_wait</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SYSCALL_DEFINE4</span><span class="p">(</span><span class="n">epoll_wait</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span>
        <span class="kt">int</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">do_epoll_wait</span><span class="p">(</span><span class="n">epfd</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_epoll_wait</span><span class="p">(</span><span class="kt">int</span> <span class="n">epfd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span>
             <span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// timeout é˜»å¡ç­‰å¾…å¤„ç†å¹¶è¿”å›å°±ç»ªäº‹ä»¶ã€‚</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">ep_poll</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span>
           <span class="kt">int</span> <span class="n">maxevents</span><span class="p">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eavail</span><span class="p">,</span> <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">u64</span> <span class="n">slack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">bool</span> <span class="n">waiter</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">wait_queue_entry_t</span> <span class="n">wait</span><span class="p">;</span>
    <span class="n">ktime_t</span> <span class="n">expires</span><span class="p">,</span> <span class="o">*</span><span class="n">to</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// è®¡ç®— timeout ç¡çœ æ—¶é—´ã€‚å¦‚æœæœ‰å°±ç»ªäº‹ä»¶ï¼Œå¤„ç†å¹¶å‘é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚</span>
    <span class="p">...</span>

<span class="nl">fetch_events:</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">))</span>
        <span class="c1">// napi ä¸­æ–­ç¼“è§£æŠ€æœ¯ï¼Œé¿å…ç½‘å¡é¢‘ç¹ä¸­æ–­ cpuï¼Œæé«˜æ•°æ®è·å–çš„æ•ˆç‡ã€‚è¿™é‡Œä¸ºäº†ç§¯æ”’ç½‘ç»œæ•°æ®è¿›è¡Œè¿”å›ã€‚</span>
        <span class="n">ep_busy_loop</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">timed_out</span><span class="p">);</span>

    <span class="c1">// æ£€æŸ¥å°±ç»ªé˜Ÿåˆ—æ˜¯å¦æœ‰æ•°æ®ã€‚</span>
    <span class="n">eavail</span> <span class="o">=</span> <span class="n">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span>
        <span class="c1">// å¦‚æœæœ‰å°±ç»ªäº‹ä»¶äº†ï¼Œå°±ç›´æ¥ä¸ç”¨ç¡çœ ç­‰å¾…äº†ï¼Œè¿›å…¥å‘é€ç¯èŠ‚ã€‚</span>
        <span class="k">goto</span> <span class="n">send_events</span><span class="p">;</span>

    <span class="p">...</span>

    <span class="c1">// æ²¡æœ‰å°±ç»ªäº‹ä»¶å‘ç”Ÿï¼Œéœ€è¦ç¡çœ ç­‰å¾…ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waiter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">waiter</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="c1">// ç­‰å¾…äº‹ä»¶ï¼Œå…³è”å½“å‰è¿›ç¨‹ã€‚</span>
        <span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

        <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="c1">// æ·»åŠ ç­‰å¾…äº‹ä»¶ã€‚ï¼ˆä¸ºäº†è§£å†³æƒŠç¾¤æ•ˆåº”ï¼Œæ‰€ä»¥ç­‰å¾…äº‹ä»¶æ·»åŠ äº† WQ_FLAG_EXCLUSIVE æ ‡è¯†ã€‚æŸ¥çœ‹ __wake_up_common å®ç°ã€‚ï¼‰</span>
        <span class="n">__add_wait_queue_exclusive</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
        <span class="cm">/*
         * We don't want to sleep if the ep_poll_callback() sends us
         * a wakeup in between. That's why we set the task state
         * to TASK_INTERRUPTIBLE before doing the checks.
         */</span>

        <span class="c1">// è®¾ç½®å½“å‰è¿›ç¨‹çŠ¶æ€ä¸ºç­‰å¾…çŠ¶æ€ï¼Œå¯ä»¥è¢«ä¿¡å·è§£é™¤ç­‰å¾…ã€‚</span>
        <span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
        <span class="cm">/*
         * Always short-circuit for fatal signals to allow
         * threads to make a timely exit without the chance of
         * finding more events available and fetching
         * repeatedly.
         */</span>

        <span class="c1">// ä¿¡å·ä¸­æ–­ï¼Œä¸è¦æ‰§è¡Œç¡çœ äº†ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fatal_signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// æ£€æŸ¥å°±ç»ªé˜Ÿåˆ—ã€‚</span>
        <span class="n">eavail</span> <span class="o">=</span> <span class="n">ep_events_available</span><span class="p">(</span><span class="n">ep</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eavail</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="c1">// ä¿¡å·ä¸­æ–­ï¼Œä¸è¦æ‰§è¡Œç¡çœ äº†ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// è¿›ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_hrtimeout_range</span><span class="p">(</span><span class="n">to</span><span class="p">,</span> <span class="n">slack</span><span class="p">,</span> <span class="n">HRTIMER_MODE_ABS</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// è¿›ç¨‹ç­‰å¾…è¶…æ—¶ï¼Œæˆ–è€…è¢«å”¤é†’ï¼Œè®¾ç½®è¿›ç¨‹è¿›å…¥è¿è¡ŒçŠ¶æ€ï¼Œç­‰å¾…å†…æ ¸è°ƒåº¦è¿è¡Œã€‚</span>
    <span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>

<span class="nl">send_events:</span>
    <span class="cm">/*
     * Try to transfer events to user space. In case we get 0 events and
     * there's still timeout left over, we go trying again in search of
     * more luck.
     */</span>

    <span class="c1">// æœ‰å°±ç»ªäº‹ä»¶å°±å‘é€åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå¦åˆ™ç»§ç»­è·å–æ•°æ®ç›´åˆ°è¶…æ—¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">eavail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">res</span> <span class="o">=</span> <span class="n">ep_send_events</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">maxevents</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">timed_out</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">fetch_events</span><span class="p">;</span>

    <span class="c1">// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œåˆ é™¤ç­‰å¾…äº‹ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">waiter</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
        <span class="n">__remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
        <span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Used by the ep_send_events() function as callback private data */</span>
<span class="k">struct</span> <span class="n">ep_send_events_data</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">maxevents</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_send_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
              <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span> <span class="kt">int</span> <span class="n">maxevents</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ep_send_events_data</span> <span class="n">esed</span><span class="p">;</span>

    <span class="n">esed</span><span class="p">.</span><span class="n">maxevents</span> <span class="o">=</span> <span class="n">maxevents</span><span class="p">;</span>
    <span class="n">esed</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">events</span><span class="p">;</span>

    <span class="c1">// éå†äº‹ä»¶å°±ç»ªåˆ—è¡¨ï¼Œå‘é€å°±ç»ªäº‹ä»¶åˆ°ç”¨æˆ·ç©ºé—´ã€‚</span>
    <span class="n">ep_scan_ready_list</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">ep_send_events_proc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">esed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">esed</span><span class="p">.</span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="87-ep_scan_ready_list">8.7. ep_scan_ready_list</h3>

<p>éå†å°±ç»ªåˆ—è¡¨ï¼Œå¤„ç† sproc å‡½æ•°ã€‚è¿™é‡Œ sproc å‡½æ•°æŒ‡é’ˆçš„ä½¿ç”¨ï¼Œæ˜¯ä¸ºäº†å‡å°‘ä»£ç å†—ä½™ï¼Œå°† ep_scan_ready_list åšæˆä¸€ä¸ªé€šç”¨çš„å‡½æ•°ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// </span>
<span class="k">static</span> <span class="n">__poll_t</span> <span class="nf">ep_scan_ready_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span>
                  <span class="n">__poll_t</span> <span class="p">(</span><span class="o">*</span><span class="n">sproc</span><span class="p">)(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="p">,</span>
                       <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
                  <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ep_locked</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__poll_t</span> <span class="n">res</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">,</span> <span class="o">*</span><span class="n">nepi</span><span class="p">;</span>
    <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">txlist</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">// å°†å°±ç»ªé˜Ÿåˆ—åˆ†ç‰‡é“¾æ¥åˆ° txlist é“¾è¡¨ä¸­ã€‚</span>
    <span class="n">list_splice_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txlist</span><span class="p">);</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">sproc</span><span class="p">)(</span><span class="n">ep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txlist</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">// åœ¨å¤„ç† sproc å›è°ƒå¤„ç†è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½äº§ç”Ÿæ–°çš„å°±ç»ªäº‹ä»¶è¢«å†™å…¥ ovflistï¼Œå°† ovflist å›å†™ rdllistã€‚</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">nepi</span> <span class="o">=</span> <span class="n">READ_ONCE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ovflist</span><span class="p">);</span> <span class="p">(</span><span class="n">epi</span> <span class="o">=</span> <span class="n">nepi</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
         <span class="n">nepi</span> <span class="o">=</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">EP_UNACTIVE_PTR</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_is_linked</span><span class="p">(</span><span class="n">epi</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">);</span>
            <span class="n">ep_pm_stay_awake</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// txlist åœ¨ epitem å›è°ƒä¸­ï¼Œå¯èƒ½æ²¡æœ‰å®Œå…¨å¤„ç†å®Œï¼Œé‚£ä¹ˆé‡æ–°æ”¾å›åˆ° rdllistï¼Œä¸‹æ¬¡å¤„ç†ã€‚</span>
    <span class="n">list_splice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="88-ep_send_events_proc">8.8. ep_send_events_proc</h3>

<p>å¤„ç†å°±ç»ªåˆ—è¡¨ï¼Œå°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="n">__poll_t</span> <span class="nf">ep_send_events_proc</span><span class="p">(</span><span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span><span class="p">,</span> <span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">ep_send_events_data</span> <span class="o">*</span><span class="n">esed</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
    <span class="n">__poll_t</span> <span class="n">revents</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epoll_event</span> <span class="n">__user</span> <span class="o">*</span><span class="n">uevent</span> <span class="o">=</span> <span class="n">esed</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">wakeup_source</span> <span class="o">*</span><span class="n">ws</span><span class="p">;</span>
    <span class="n">poll_table</span> <span class="n">pt</span><span class="p">;</span>
    <span class="n">init_poll_funcptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">...</span>

    <span class="c1">// éå†å¤„ç† txlistï¼ˆåŸ ep-&gt;rdllist æ•°æ®ï¼‰å°±ç»ªé˜Ÿåˆ—ç»“ç‚¹ï¼Œè·å–äº‹ä»¶æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ã€‚</span>
    <span class="n">list_for_each_entry_safe</span> <span class="p">(</span><span class="n">epi</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">rdllink</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">esed</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="n">esed</span><span class="o">-&gt;</span><span class="n">maxevents</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">...</span>
        <span class="c1">// å…ˆä»å°±ç»ªé˜Ÿåˆ—ä¸­åˆ é™¤ epiï¼Œå¦‚æœæ˜¯ LT æ¨¡å¼ï¼Œå°±ç»ªäº‹ä»¶è¿˜æ²¡å¤„ç†å®Œï¼Œå†æŠŠå®ƒæ·»åŠ å›å»ã€‚</span>
        <span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">);</span>

        <span class="c1">// è·å– epi å¯¹åº” fd çš„å°±ç»ªäº‹ä»¶ã€‚</span>
        <span class="n">revents</span> <span class="o">=</span> <span class="n">ep_item_poll</span><span class="p">(</span><span class="n">epi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">revents</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// å†…æ ¸ç©ºé—´å‘ç”¨æˆ·ç©ºé—´ä¼ é€’æ•°æ®ã€‚__put_user æˆåŠŸæ‹·è´è¿”å› 0ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">__put_user</span><span class="p">(</span><span class="n">revents</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uevent</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">)</span> <span class="o">||</span>
            <span class="n">__put_user</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uevent</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// å¦‚æœæ‹·è´å¤±è´¥ï¼Œç»§ç»­ä¿å­˜åœ¨å°±ç»ªåˆ—è¡¨é‡Œã€‚</span>
            <span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">,</span> <span class="n">head</span><span class="p">);</span>
            <span class="n">ep_pm_stay_awake</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">esed</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)</span>
                <span class="n">esed</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// æˆåŠŸå¤„ç†å°±ç»ªäº‹ä»¶çš„ fd ä¸ªæ•°ã€‚</span>
        <span class="n">esed</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">++</span><span class="p">;</span>
        <span class="n">uevent</span><span class="o">++</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLONESHOT</span><span class="p">)</span>
            <span class="c1">// #define EP_PRIVATE_BITS (EPOLLWAKEUP | EPOLLONESHOT | EPOLLET | EPOLLEXCLUSIVE)</span>
            <span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;=</span> <span class="n">EP_PRIVATE_BITS</span><span class="p">;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLET</span><span class="p">))</span> <span class="p">{</span>
            <span class="cm">/*
             * If this file has been added with Level
             * Trigger mode, we need to insert back inside
             * the ready list, so that the next call to
             * epoll_wait() will check again the events
             * availability. At this point, no one can insert
             * into ep-&gt;rdllist besides us. The epoll_ctl()
             * callers are locked out by
             * ep_scan_ready_list() holding "mtx" and the
             * poll callback will queue them in ep-&gt;ovflist.
             */</span>
            <span class="cm">/* lt æ¨¡å¼ä¸‹ï¼Œå½“å‰äº‹ä»¶è¢«å¤„ç†å®Œåï¼Œä¸ä¼šä»å°±ç»ªåˆ—è¡¨ä¸­åˆ é™¤ï¼Œç•™å¾…ä¸‹ä¸€æ¬¡ epoll_wait
             * è°ƒç”¨ï¼Œå†æŸ¥çœ‹æ˜¯å¦è¿˜æœ‰äº‹ä»¶æ²¡å¤„ç†ï¼Œå¦‚æœæ²¡æœ‰äº‹ä»¶äº†å°±ä»å°±ç»ªåˆ—è¡¨ä¸­åˆ é™¤ã€‚
             * åœ¨éå†äº‹ä»¶çš„è¿‡ç¨‹ä¸­ï¼Œä¸èƒ½å†™ ep-&gt;rdllistï¼Œå› ä¸ºå·²ç»ä¸Šé”ï¼Œåªèƒ½æŠŠæ–°çš„å°±ç»ªä¿¡æ¯
             * æ·»åŠ åˆ° ep-&gt;ovflist */</span>
            <span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">);</span>
            <span class="n">ep_pm_stay_awake</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="89-ep_poll_callback">8.9. ep_poll_callback</h3>

<p>fd äº‹ä»¶å›è°ƒã€‚å½“ fd æœ‰ç½‘ç»œäº‹ä»¶å‘ç”Ÿï¼Œå°±ä¼šé€šè¿‡ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›è¡Œå›è°ƒã€‚å‚è€ƒ __wake_up_commonï¼Œå¦‚æœäº‹ä»¶æ˜¯ç”¨æˆ·å…³æ³¨çš„äº‹ä»¶ï¼Œå›è°ƒä¼šå”¤é†’è¿›ç¨‹è¿›è¡Œå¤„ç†ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">ep_poll_callback</span><span class="p">(</span><span class="n">wait_queue_entry_t</span> <span class="o">*</span><span class="n">wait</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">pwake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">epitem</span> <span class="o">*</span><span class="n">epi</span> <span class="o">=</span> <span class="n">ep_item_from_wait</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
    <span class="k">struct</span> <span class="n">eventpoll</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">ep</span><span class="p">;</span>
    <span class="n">__poll_t</span> <span class="n">pollflags</span> <span class="o">=</span> <span class="n">key_to_poll</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ewake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// ç¦æ­¢æœ¬åœ°ä¸­æ–­å¹¶è·å¾—æŒ‡å®šè¯»é”ã€‚</span>
    <span class="n">read_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="n">ep_set_busy_poll_napi_id</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>

    <span class="c1">// #define EP_PRIVATE_BITS (EPOLLWAKEUP | EPOLLONESHOT | EPOLLET | EPOLLEXCLUSIVE)</span>
    <span class="c1">// å¦‚æœ fd æ²¡æœ‰å…³æ³¨é™¤äº† EP_PRIVATE_BITS ä¹‹å¤–çš„äº‹ä»¶ï¼Œé‚£ä¹ˆèµ°è§£é”æµç¨‹ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EP_PRIVATE_BITS</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

    <span class="c1">// å¦‚æœå›è°ƒçš„äº‹ä»¶ï¼Œä¸æ˜¯ç”¨æˆ·å…³æ³¨çš„ fd äº‹ä»¶ï¼Œé‚£ä¹ˆèµ°è§£é”æµç¨‹ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pollflags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">pollflags</span> <span class="o">&amp;</span> <span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span><span class="p">))</span>
        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

    <span class="cm">/*
     * If we are transferring events to userspace, we can hold no locks
     * (because we're accessing user memory, and because of linux f_op-&gt;poll()
     * semantics). All the events that happen during that period of time are
     * chained in ep-&gt;ovflist and requeued later on.
     */</span>
    <span class="c1">// å½“å†…æ ¸ç©ºé—´å‘ç”¨æˆ·ç©ºé—´æ‹·è´æ•°æ®æ—¶ï¼Œä¸æ·»åŠ  epi åˆ° rdllistï¼Œå°†å®ƒæ·»åŠ åˆ° ovflistã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">READ_ONCE</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">ovflist</span><span class="p">)</span> <span class="o">!=</span> <span class="n">EP_UNACTIVE_PTR</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">EP_UNACTIVE_PTR</span> <span class="o">&amp;&amp;</span> <span class="n">chain_epi_lockless</span><span class="p">(</span><span class="n">epi</span><span class="p">))</span>
            <span class="n">ep_pm_stay_awake_rcu</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// epi å·²ç»åŠ å…¥å°±ç»ªé“¾è¡¨å°±ä¸éœ€è¦æ·»åŠ äº†ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_is_linked</span><span class="p">(</span><span class="n">epi</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">list_add_tail_lockless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">rdllink</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">rdllist</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">ep_pm_stay_awake_rcu</span><span class="p">(</span><span class="n">epi</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// å½“å›è°ƒäº‹ä»¶æ˜¯ç”¨æˆ·å…³æ³¨çš„äº‹ä»¶ï¼Œé‚£ä¹ˆéœ€è¦å”¤é†’è¿›ç¨‹å¤„ç†ã€‚</span>

    <span class="c1">// ep-&gt;wq åœ¨ epoll_wait æ—¶æ·»åŠ ï¼Œå½“æ²¡æœ‰å°±ç»ªäº‹ä»¶ï¼Œepoll_wait è¿›è¡Œç¡çœ ç­‰å¾…å”¤é†’ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLEXCLUSIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">!</span><span class="p">(</span><span class="n">pollflags</span> <span class="o">&amp;</span> <span class="n">POLLFREE</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// #define EPOLLINOUT_BITS (EPOLLIN | EPOLLOUT)</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">pollflags</span> <span class="o">&amp;</span> <span class="n">EPOLLINOUT_BITS</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">EPOLLIN</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLIN</span><span class="p">)</span>
                    <span class="n">ewake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">EPOLLOUT</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLOUT</span><span class="p">)</span>
                    <span class="n">ewake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ewake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// ep-&gt;poll_wait æ˜¯ epoll ç›‘æ§å¦å¤–ä¸€ä¸ª epoll fd çš„ç­‰å¾…é˜Ÿåˆ—ã€‚å¦‚æœè§¦å‘äº‹ä»¶ï¼Œä¹Ÿéœ€è¦å”¤é†’è¿›ç¨‹å¤„ç†ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">))</span>
        <span class="n">pwake</span><span class="o">++</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
    <span class="n">read_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="cm">/* We have to call this outside the lock */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pwake</span><span class="p">)</span>
        <span class="n">ep_poll_safewake</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">poll_wait</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">epi</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">.</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">EPOLLEXCLUSIVE</span><span class="p">))</span>
        <span class="n">ewake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pollflags</span> <span class="o">&amp;</span> <span class="n">POLLFREE</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/*
         * If we race with ep_remove_wait_queue() it can miss
         * -&gt;whead = NULL and do another remove_wait_queue() after
         * us, so we can't use __remove_wait_queue().
         */</span>
        <span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">);</span>
        <span class="cm">/*
         * -&gt;whead != NULL protects us from the race with ep_free()
         * or ep_remove(), ep_remove_wait_queue() takes whead-&gt;lock
         * held by the caller. Once we nullify it, nothing protects
         * ep/epi or even wait.
         */</span>
        <span class="n">smp_store_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ep_pwq_from_wait</span><span class="p">(</span><span class="n">wait</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">whead</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ewake</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="9-å‚è€ƒ">9. å‚è€ƒ</h2>

<ul>
  <li><a href="https://www.cnblogs.com/lojunren/p/3856290.html">Linuxä¸‹çš„I/Oå¤ç”¨ä¸epollè¯¦è§£</a></li>
  <li><a href="https://www.cnblogs.com/lojunren/p/3856290.html">inuxä¸‹çš„I/Oå¤ç”¨ä¸epollè¯¦è§£</a></li>
  <li><a href="https://blog.codingnow.com/2011/12/buddy_memory_allocation.html">Buddy memory allocation (ä¼™ä¼´å†…å­˜åˆ†é…å™¨)</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/74947007">Linuxå†…å­˜ç®¡ç†ï¼Œå†…å­˜å¯»å€</a></li>
  <li><a href="https://blog.csdn.net/linkedin_38454662/article/details/73337208">EPOLLå†…æ ¸åŸç†æç®€å›¾æ–‡è§£è¯»</a></li>
  <li><a href="https://blog.csdn.net/qq_31967569/article/details/102953756">å½»åº•ç†è§£epoll</a></li>
  <li>ã€ŠUNIX ç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹3.2 æ–‡ä»¶æè¿°ç¬¦</li>
  <li><a href="https://blog.csdn.net/lu_embedded/article/details/51588902">Linuxå†…æ ¸ç©ºé—´å†…å­˜ç”³è¯·å‡½æ•°kmallocã€kzallocã€vmallocçš„åŒºåˆ«</a></li>
  <li><a href="https://www.cnblogs.com/JaSonS-toy/p/5110199.html">Linuxå†…æ ¸ç¬”è®°â€“æ·±å…¥ç†è§£æ–‡ä»¶æè¿°ç¬¦</a></li>
  <li><a href="http://man7.org/Linux/man-pages/man2/epoll_ctl.2.html">epoll_ctl æ–‡æ¡£</a></li>
  <li><a href="https://www.bilibili.com/video/BV1T4411h7nH?from=search&amp;seid=4446246779743557520">epollçš„åŸç†è¿‡ç¨‹è®²è§£</a></li>
  <li><a href="https://blog.csdn.net/hhhhhyyyyy8/article/details/102755866">socketâ€”proto_opsâ€”inetsw_arrayç­‰åŸºæœ¬ç»“æ„</a></li>
  <li><a href="https://zhuanlan.zhihu.com/p/72532475">epollé«˜æ•ˆIOå¤ç”¨</a></li>
  <li><a href="https://blog.csdn.net/wind_602/article/details/104863808">EpollæŠ€æœ¯æ‰©å±•</a></li>
  <li><a href="https://www.cnblogs.com/zhjh256/p/12227883.html">Linuxç½‘ç»œåŒ…æ”¶å‘æ€»ä½“è¿‡ç¨‹</a></li>
  <li><a href="https://www.cnblogs.com/diegodu/p/9377535.html">epollæºç åˆ†æ</a></li>
  <li><a href="https://blog.csdn.net/robertsong2004/article/details/37693783">TASK_INTERRUPTIBLE å’Œ TASK_UNINTERRUPTIBLE</a></li>
  <li><a href="https://www.jianshu.com/p/6292b3f4c5c0">NAPI(New API)çš„ä¸€äº›æµ…è§</a></li>
  <li><a href="https://www.ibm.com/developerworks/cn/linux/l-napi/index.html">NAPI æŠ€æœ¯åœ¨ Linux ç½‘ç»œé©±åŠ¨ä¸Šçš„åº”ç”¨å’Œå®Œå–„</a></li>
  <li><a href="http://www.pigpig.vip/?p=8">EPOLL æºç åˆ†æ</a></li>
  <li><a href="https://www.cnblogs.com/wanghetao/archive/2012/06/02/2532225.html">ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¼ é€’æ•°æ®</a></li>
  <li><a href="https://www.cnblogs.com/wang_yb/archive/2013/05/01/3052865.html">ã€ŠLinuxå†…æ ¸è®¾è®¡ä¸å®ç°ã€‹è¯»ä¹¦ç¬”è®°ï¼ˆåï¼‰- å†…æ ¸åŒæ­¥æ–¹æ³•</a></li>
  <li><a href="https://www.cnblogs.com/nufangrensheng/p/3579145.html">è™šæ‹Ÿæ–‡ä»¶ç³»ç»ŸVFS</a></li>
  <li><a href="https://www.cnblogs.com/apprentice89/archive/2013/05/06/3063039.html">epollç”¨æ³•ã€æ•´ç†ã€‘</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/04/23/epoll-code/">wenfh2020.com</a></p>
</blockquote>
:ET