I"¸Ğ<p>æ–‡ç« é‡ç‚¹è®²è¿° aof æŒä¹…åŒ–çš„åº”ç”¨åœºæ™¯ã€‚aof æŒä¹…åŒ–ï¼Œæ‹†åˆ†ä¸Šä¸‹ä¸ºä¸¤ç« ï¼Œå¯ä»¥å…ˆè¯»ä¸Šä¸€ç« ï¼š <a href="https://wenfh2020.com/2020/03/29/redis-aof-prev/">[redis æºç èµ°è¯»] aof æŒä¹…åŒ– (ä¸Š)</a>ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-åº”ç”¨åœºæ™¯" id="markdown-toc-1-åº”ç”¨åœºæ™¯">1. åº”ç”¨åœºæ™¯</a>    <ul>
      <li><a href="#11-å¯åŠ¨åŠ è½½" id="markdown-toc-11-å¯åŠ¨åŠ è½½">1.1. å¯åŠ¨åŠ è½½</a></li>
      <li><a href="#12-å†™å‘½ä»¤æ‰§è¡Œæµç¨‹" id="markdown-toc-12-å†™å‘½ä»¤æ‰§è¡Œæµç¨‹">1.2. å†™å‘½ä»¤æ‰§è¡Œæµç¨‹</a></li>
      <li><a href="#13-å®šæ—¶ä¿å­˜" id="markdown-toc-13-å®šæ—¶ä¿å­˜">1.3. å®šæ—¶ä¿å­˜</a></li>
      <li><a href="#14-é‡å†™" id="markdown-toc-14-é‡å†™">1.4. é‡å†™</a>        <ul>
          <li><a href="#141-é‡å†™æ–¹å¼" id="markdown-toc-141-é‡å†™æ–¹å¼">1.4.1. é‡å†™æ–¹å¼</a></li>
          <li><a href="#142-é‡å†™å®ç°" id="markdown-toc-142-é‡å†™å®ç°">1.4.2. é‡å†™å®ç°</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#2-è°ƒè¯•" id="markdown-toc-2-è°ƒè¯•">2. è°ƒè¯•</a></li>
  <li><a href="#3-æ€»ç»“" id="markdown-toc-3-æ€»ç»“">3. æ€»ç»“</a></li>
  <li><a href="#4-å‚è€ƒ" id="markdown-toc-4-å‚è€ƒ">4. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-åº”ç”¨åœºæ™¯">1. åº”ç”¨åœºæ™¯</h2>

<p><img src="/images/2020-03-29-19-03-42.png" alt="åº”ç”¨åœºæ™¯" data-action="zoom" /></p>

<h3 id="11-å¯åŠ¨åŠ è½½">1.1. å¯åŠ¨åŠ è½½</h3>

<p>redis å¯åŠ¨ï¼Œç¨‹åºä¼šæ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯åŠ è½½ä» aof æ–‡ä»¶è¯»å‡ºçš„å‘½ä»¤ã€‚</p>

<blockquote>
  <p>aof æŒä¹…åŒ–æ”¯æŒ aof å’Œ rdb æ··åˆæ¨¡å¼ï¼Œå‚è€ƒä¸Šé¢çš„ <code class="highlighter-rouge">aof å’Œ rdb æ··åˆç»“æ„</code></p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">loadDataFromDisk</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loadDataFromDisk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">==</span> <span class="n">AOF_ON</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loadAppendOnlyFile</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"DB loaded from append only file: %.3f seconds"</span><span class="p">,(</span><span class="kt">float</span><span class="p">)(</span><span class="n">ustime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span><span class="o">/</span><span class="mi">1000000</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">loadAppendOnlyFile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// ç¨‹åºæ¨¡æ‹Ÿä¸€ä¸ªå®¢æˆ·ç«¯æ‰§è¡Œä» aof æ–‡ä»¶è¯»å‡ºçš„å‘½ä»¤ã€‚</span>
    <span class="n">fakeClient</span> <span class="o">=</span> <span class="n">createAOFClient</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="c1">// æ£€æŸ¥ aof æ–‡ä»¶è¯»å–æ•°æ®æ–¹å¼ã€‚</span>
    <span class="kt">char</span> <span class="n">sig</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="s">"REDIS"</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// é€šè¿‡ aof æ–¹å¼åŠ è½½æ•°æ®ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">readerr</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="c1">// é€šè¿‡ rdb æ–¹å¼åŠ è½½æ•°æ®ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbLoadRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Error reading the RDB preamble of the AOF file, AOF loading aborted"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">readerr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="cm">/* Read the actual AOF file, in REPL format, command by command. */</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ ¹æ® aof æ–‡ä»¶æ•°æ®ç»“æ„ï¼Œå–å‡ºæ•°æ®å›å†™å†…å­˜ã€‚</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="12-å†™å‘½ä»¤æ‰§è¡Œæµç¨‹">1.2. å†™å‘½ä»¤æ‰§è¡Œæµç¨‹</h3>

<ol>
  <li>client å‘ redis æœåŠ¡å‘é€å†™å‘½ä»¤ã€‚</li>
  <li>redis æœåŠ¡æ¥æ”¶å‘½ä»¤ï¼Œè¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</li>
  <li>redis æœåŠ¡å°†æ–°çš„å†™å‘½ä»¤è¿½åŠ åˆ° aof æ•°æ®ç¼“å†²åŒºã€‚</li>
  <li>redis æœåŠ¡ä¼šé€šè¿‡æ—¶é’Ÿï¼Œï¼ˆ<code class="highlighter-rouge">eventloop</code>ï¼‰äº‹ä»¶å¤„ç†å‰(<code class="highlighter-rouge">beforeSleep</code>)ç­‰æ–¹æ³•å°† aof æ•°æ®ç¼“å†²åŒºè½åœ°ï¼Œç„¶åæ¸…ç©º aof ç¼“å†²åŒºã€‚</li>
</ol>

<ul>
  <li>æµç¨‹</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">call</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span> <span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wenfh2020</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">other</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">3266</span><span class="p">)</span>
<span class="n">processCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span> <span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wenfh2020</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">other</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">3552</span><span class="p">)</span>
<span class="p">...</span>
<span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span> <span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wenfh2020</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">other</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ae</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">457</span><span class="p">)</span>
<span class="n">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span> <span class="n">eventLoop</span><span class="p">)</span> <span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wenfh2020</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">other</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">ae</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">515</span><span class="p">)</span>
<span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">(</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">wenfh2020</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">other</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">c</span><span class="o">:</span><span class="mi">5054</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>æ‰§è¡Œå‘½ä»¤ï¼Œå¡«å…… aof æ•°æ®ç¼“å†²åŒº</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Command propagation flags, see propagate() function
   + PROPAGATE_NONE (no propagation of command at all)
   + PROPAGATE_AOF (propagate into the AOF file if is enabled)
   + PROPAGATE_REPL (propagate into the replication link)
*/</span>

<span class="cp">#define PROPAGATE_NONE 0
#define PROPAGATE_AOF 1
#define PROPAGATE_REPL 2
</span>
<span class="kt">void</span> <span class="nf">call</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">propagate_flags</span> <span class="o">!=</span> <span class="n">PROPAGATE_NONE</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CMD_MODULE</span><span class="p">))</span>
        <span class="n">propagate</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argv</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">argc</span><span class="p">,</span><span class="n">propagate_flags</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">propagate</span><span class="p">(</span><span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dbid</span><span class="p">,</span> <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">!=</span> <span class="n">AOF_OFF</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">PROPAGATE_AOF</span><span class="p">)</span>
        <span class="n">feedAppendOnlyFile</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span><span class="n">dbid</span><span class="p">,</span><span class="n">argv</span><span class="p">,</span><span class="n">argc</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// aof ç¼“å†²åŒº</span>
<span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">sds</span> <span class="n">aof_buf</span><span class="p">;</span>      <span class="cm">/* AOF buffer, written before entering the event loop */</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// è¿½åŠ å†…å®¹åˆ° aof æ–‡ä»¶</span>
<span class="kt">void</span> <span class="nf">feedAppendOnlyFile</span><span class="p">(</span><span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dictid</span><span class="p">,</span> <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">sds</span> <span class="n">buf</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
    <span class="n">robj</span> <span class="o">*</span><span class="n">tmpargv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

    <span class="c1">// å‘½ä»¤æ‰§è¡Œï¼Œéœ€è¦æŒ‡å®šåˆ°å¯¹åº”æ•°æ®åº“ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dictid</span> <span class="o">!=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_selected_db</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">seldb</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

        <span class="n">snprintf</span><span class="p">(</span><span class="n">seldb</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">seldb</span><span class="p">),</span><span class="s">"%d"</span><span class="p">,</span><span class="n">dictid</span><span class="p">);</span>
        <span class="n">buf</span> <span class="o">=</span> <span class="n">sdscatprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="s">"*2</span><span class="se">\r\n</span><span class="s">$6</span><span class="se">\r\n</span><span class="s">SELECT</span><span class="se">\r\n</span><span class="s">$%lu</span><span class="se">\r\n</span><span class="s">%s</span><span class="se">\r\n</span><span class="s">"</span><span class="p">,</span>
            <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">seldb</span><span class="p">),</span><span class="n">seldb</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_selected_db</span> <span class="o">=</span> <span class="n">dictid</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// å°†å‘½ä»¤æ ¼å¼åŒ–ä¸º redis å‘½ä»¤æ ¼å¼ï¼Œç„¶åè¿½åŠ åˆ° aof æ•°æ®ç¼“å†²åŒºã€‚</span>
    <span class="n">buf</span> <span class="o">=</span> <span class="n">catAppendOnlyGenericCommand</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">argc</span><span class="p">,</span><span class="n">argv</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">==</span> <span class="n">AOF_ON</span><span class="p">)</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span> <span class="o">=</span> <span class="n">sdscatlen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_buf</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

    <span class="c1">// å¦‚æœæœ‰å­è¿›ç¨‹æ­£åœ¨é‡å†™ï¼Œçˆ¶è¿›ç¨‹å°†æ–°çš„æ•°æ®å‘é€ç»™æ­£åœ¨é‡å†™çš„å­è¿›ç¨‹ï¼Œä½¿å¾—é‡å†™æ–‡ä»¶æ•°æ®æ›´å®Œå¤‡ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aofRewriteBufferAppend</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>é‡å†™è¿‡ç¨‹ä¸­ï¼Œçˆ¶è¿›ç¨‹æ¥æ”¶åˆ°æ–°çš„å‘½ä»¤ï¼Œçˆ¶è¿›ç¨‹å‘é€ç»™å­è¿›ç¨‹ï¼Œå¯¹é‡å†™æ•°æ®è¿›è¡Œè¿½åŠ ã€‚</p>

    <blockquote>
      <p>çˆ¶å­è¿›ç¨‹é€šè¿‡ç®¡é“è¿›è¡Œé€šä¿¡äº¤äº’ã€‚</p>
    </blockquote>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">feedAppendOnlyFile</span><span class="p">(</span><span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dictid</span><span class="p">,</span> <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// å¦‚æœæœ‰å­è¿›ç¨‹æ­£åœ¨é‡å†™ï¼Œçˆ¶è¿›ç¨‹å°†æ–°çš„æ•°æ®å‘é€ç»™æ­£åœ¨é‡å†™çš„å­è¿›ç¨‹ï¼Œä½¿å¾—é‡å†™æ–‡ä»¶æ•°æ®æ›´å®Œå¤‡ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">aofRewriteBufferAppend</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// å°†æ•°æ®ä¿å­˜åˆ°é‡å†™ç¼“å†²åŒºé“¾è¡¨ã€‚ç„¶åé€šè¿‡çˆ¶å­è¿›ç¨‹ç®¡é“è¿›è¡Œæ•°æ®ä¼ è¾“</span>
<span class="kt">void</span> <span class="nf">aofRewriteBufferAppend</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">// çˆ¶è¿›ç¨‹é€šè¿‡ç®¡é“æŠŠé‡å†™ç¼“å†²åŒºæ•°æ®ï¼Œå‘é€åˆ°å­è¿›ç¨‹</span>
<span class="kt">void</span> <span class="nf">aofChildWriteDiffData</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{}</span>

<span class="c1">// å­è¿›ç¨‹è¯»å–çˆ¶è¿›ç¨‹å‘é€çš„æ•°æ®ã€‚</span>
<span class="kt">ssize_t</span> <span class="nf">aofReadDiffFromParent</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{...}</span>

<span class="c1">// åˆ›å»ºçˆ¶å­è¿›ç¨‹é€šä¿¡ç®¡é“</span>
<span class="kt">int</span> <span class="nf">aofCreatePipes</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{...}</span>

<span class="c1">// çˆ¶å­ç»“æŸé€šä¿¡</span>
<span class="kt">void</span> <span class="nf">aofChildPipeReadable</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">privdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{}</span>
</code></pre></div></div>

<hr />

<h3 id="13-å®šæ—¶ä¿å­˜">1.3. å®šæ—¶ä¿å­˜</h3>

<p>ä¸»è¦å¯¹å»¶æ—¶åˆ·æ–°å’Œå†™ç£ç›˜å‡ºç°é”™è¯¯å›å†™çš„æ£€æŸ¥åˆ·æ–°ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Using the following macro you can run code inside serverCron() with the
 * specified period, specified in milliseconds.
 * The actual resolution depends on server.hz. */</span>
<span class="cp">#define run_with_period(_ms_)         \
    if ((_ms_ &lt;= 1000 / server.hz) || \
        !(cronloops % ((_ms_) / (1000 / server.hz))))
</span>
<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// å¦‚æœæœ‰å»¶æ—¶ä»»åŠ¡ï¼Œå®šæ—¶æ£€æŸ¥åˆ·æ–°ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_flush_postponed_start</span><span class="p">)</span> <span class="n">flushAppendOnlyFile</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="c1">// åˆ·æ–°ç¼“å­˜åˆ°ç£ç›˜å‡ºç°é”™è¯¯ï¼ˆä¾‹å¦‚ï¼šç£ç›˜æ»¡äº†ï¼‰ï¼Œå®šæ—¶æ£€æŸ¥å›å†™ã€‚</span>
    <span class="c1">// hz é¢‘ç‡ä¸º 10 ï¼Œè¿™é‡Œä¸€èˆ¬æ¯åæ¬¡æ—¶é’Ÿæ£€æŸ¥ä¸€æ¬¡ã€‚</span>
    <span class="n">run_with_period</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_last_write_status</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span>
            <span class="n">flushAppendOnlyFile</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">cronloops</span><span class="o">++</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">1000</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">hz</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="14-é‡å†™">1.4. é‡å†™</h3>

<p>æœåŠ¡å™¨æ¥æ”¶åˆ°å†™å…¥æ“ä½œå‘½ä»¤ä¼šè¿½åŠ åˆ° aof æ–‡ä»¶ï¼Œé‚£ä¹ˆ aof æ–‡ä»¶ç›¸å½“äºä¸€ä¸ªæµæ°´æ–‡ä»¶ã€‚éšç€æ—¶é—´æ¨ç§»ï¼Œæ–‡ä»¶å°†ä¼šè¶Šæ¥è¶Šå¤§ã€‚ç„¶è€Œ aof æ–‡ä»¶ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†æŒä¹…åŒ–ï¼Œå¹¶ä¸æ˜¯ä¸ºäº†è®°å½•æœåŠ¡å™¨æµæ°´ã€‚è¿™äº›æµæ°´å‘½ä»¤æœ‰å¯èƒ½å¾ˆå¤šæ˜¯å†—ä½™çš„ï¼Œéœ€è¦é‡æ–°æ•´ç†â€”â€”é€šè¿‡<strong>é‡å†™</strong>æ¥å‡å° aof æ–‡ä»¶ä½“ç§¯ã€‚</p>

<p>ä¾‹å¦‚ä¸‹é¢ 4 æ¡å‘½ä»¤ï¼Œä¼šè¿½åŠ è®°å½•åˆ° aof æ–‡ä»¶ï¼Œå› ä¸ºå¯¹åŒä¸€ä¸ª key æ“ä½œï¼Œå†…å­˜é‡Œæœ€ç»ˆæ•°æ® key1 å¯¹åº”çš„æ•°æ®æ˜¯ 4ï¼Œè¿™æ ·å‰é¢ 3 æ¡å†å²å‘½ä»¤æ˜¯å†—ä½™çš„ï¼Œé€šè¿‡é‡å†™åŠŸèƒ½ï¼Œaof æ–‡ä»¶åªç•™ä¸‹ key å¯¹åº”çš„æœ€æ–°çš„ valueã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set </span>key1 1
<span class="nb">set </span>key1 2
<span class="nb">set </span>key1 3
<span class="nb">set </span>key1 4
</code></pre></div></div>

<hr />

<h4 id="141-é‡å†™æ–¹å¼">1.4.1. é‡å†™æ–¹å¼</h4>

<ul>
  <li>é€šè¿‡å‘½ä»¤ <a href="https://redis.io/commands/bgrewriteaof"><code class="highlighter-rouge">BGREWRITEAOF</code></a> é‡å†™ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">bgrewriteaofCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å½“é‡å†™æ­£åœ¨è¿›è¡Œæ—¶ï¼Œè¿”å›é”™è¯¯ã€‚</span>
        <span class="n">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background append only file rewriting already in progress"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hasActiveChildProcess</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// å½“æœ‰å…¶å®ƒå­è¿›ç¨‹æ­£åœ¨è¿›è¡Œå·¥ä½œæ—¶ï¼Œå»¶åæ‰§è¡Œã€‚</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_scheduled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">addReplyStatus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background append only file rewriting scheduled"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rewriteAppendOnlyFileBackground</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¼‚æ­¥æ‰§è¡Œé‡å†™</span>
        <span class="n">addReplyStatus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background append only file rewriting started"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// é‡å†™æ“ä½œå¤±è´¥ï¼Œæ£€æŸ¥åŸå› ã€‚</span>
        <span class="n">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Can't execute an AOF background rewriting. "</span>
                        <span class="s">"Please check the server logs for more information."</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ—¶é’Ÿå®šæœŸæ£€æŸ¥ redis ä½¿ç”¨å†…å­˜å¤§å°ï¼Œå½“è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼Œè§¦å‘è‡ªåŠ¨é‡å†™ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

<span class="c"># å½“å‰å¢åŠ çš„å†…å­˜è¶…è¿‡ä¸Šä¸€æ¬¡é‡å†™åçš„å†…å­˜ç™¾åˆ†æ¯”ï¼Œæ‰ä¼šè§¦å‘è‡ªåŠ¨é‡å†™ã€‚</span>
auto-aof-rewrite-percentage 100

<span class="c"># å†…å­˜é‡å†™ä¸‹é™</span>
auto-aof-rewrite-min-size 64mb
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* Trigger an AOF rewrite if needed. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">==</span> <span class="n">AOF_ON</span> <span class="o">&amp;&amp;</span>
        <span class="o">!</span><span class="n">hasActiveChildProcess</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_perc</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_min_size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">base</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_base_size</span> <span class="o">?</span>
            <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_base_size</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">growth</span> <span class="o">=</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_current_size</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">base</span><span class="p">)</span> <span class="o">-</span> <span class="mi">100</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">growth</span> <span class="o">&gt;=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_perc</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"Starting automatic rewriting of AOF on %lld%% growth"</span><span class="p">,</span><span class="n">growth</span><span class="p">);</span>
            <span class="n">rewriteAppendOnlyFileBackground</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="142-é‡å†™å®ç°">1.4.2. é‡å†™å®ç°</h4>

<ol>
  <li>çˆ¶è¿›ç¨‹ fork å­è¿›ç¨‹å®ç°é‡å†™é€»è¾‘ã€‚</li>
  <li>å­è¿›ç¨‹åˆ›å»º aof ä¸´æ—¶æ–‡ä»¶å­˜å‚¨é‡å†™å­è¿›ç¨‹<code class="highlighter-rouge">fork-on-write</code> å†…å­˜åˆ° aof æ–‡ä»¶ã€‚</li>
  <li>å­è¿›ç¨‹é‡å†™å®Œæˆ fork å†…å­˜æ•°æ®å†…å®¹åï¼Œè¿½åŠ åœ¨é‡å†™è¿‡ç¨‹ä¸­çˆ¶è¿›ç¨‹å‘é€çš„æ–°çš„å†…å®¹ã€‚</li>
  <li>å­è¿›ç¨‹ç»“æŸçˆ¶å­è¿›ç¨‹ç®¡é“é€šä¿¡ã€‚</li>
  <li>æ›´æ–°ä¸´æ—¶æ–‡ä»¶è¦†ç›–æ—§çš„æ–‡ä»¶ã€‚</li>
</ol>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// çˆ¶è¿›ç¨‹ fork å­è¿›ç¨‹è¿›è¡Œ aof é‡å†™</span>
<span class="kt">int</span> <span class="nf">rewriteAppendOnlyFileBackground</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">redisFork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rewriteAppendOnlyFile</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sendChildCOWInfo</span><span class="p">(</span><span class="n">CHILD_INFO_TYPE_AOF</span><span class="p">,</span> <span class="s">"AOF rewrite"</span><span class="p">);</span>
            <span class="n">exitFromChild</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">exitFromChild</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="cm">/* Parent */</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span> <span class="cm">/* unreached */</span>
<span class="p">}</span>

<span class="c1">// é‡å†™ aof å®ç°é€»è¾‘</span>
<span class="kt">int</span> <span class="nf">rewriteAppendOnlyFile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">rio</span> <span class="n">aof</span><span class="p">;</span>
    <span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tmpfile</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>

    <span class="c1">// åˆ›å»º aof ä¸´æ—¶æ–‡ä»¶ã€‚</span>
    <span class="n">snprintf</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="mi">256</span><span class="p">,</span><span class="s">"temp-rewriteaof-%d.aof"</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="n">fp</span> <span class="o">=</span> <span class="n">fopen</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="s">"w"</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span> <span class="s">"Opening the temp file for AOF rewrite in rewriteAppendOnlyFile(): %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">server</span><span class="p">.</span><span class="n">aof_child_diff</span> <span class="o">=</span> <span class="n">sdsempty</span><span class="p">();</span>
    <span class="n">rioInitWithFile</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">,</span><span class="n">fp</span><span class="p">);</span>

    <span class="c1">// é€æ­¥å°†æ–‡ä»¶ç¼“å­˜åˆ·æ–°åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_rewrite_incremental_fsync</span><span class="p">)</span>
        <span class="n">rioSetAutoSync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">,</span><span class="n">REDIS_AUTOSYNC_BYTES</span><span class="p">);</span>

    <span class="n">startSaving</span><span class="p">(</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">);</span>

    <span class="c1">// æ ¹æ®é…ç½®ï¼Œé‡å†™æ–‡ä»¶å†…å®¹æ–¹å¼ï¼Œrdb æˆ–è€… aofï¼Œaof å­˜å‚¨æ–¹å¼æ”¯æŒ rdb å’Œ aof å†…å®¹å…¼å®¹åœ¨åŒä¸€ä¸ª aof æ–‡ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_use_rdb_preamble</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">,</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">errno</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rewriteAppendOnlyFileRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// è¿›ç¨‹å†…å­˜æ›´æ–°å®Œæ¯•ï¼Œåˆ·æ–°æ–‡ä»¶åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fflush</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fsync</span><span class="p">(</span><span class="n">fileno</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// å­è¿›ç¨‹æ¥æ”¶çˆ¶è¿›ç¨‹å‘é€çš„æ–°æ•°æ®ã€‚</span>
    <span class="kt">int</span> <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">mstime_t</span> <span class="n">start</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>
    <span class="k">while</span><span class="p">(</span><span class="n">mstime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">nodata</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">aeWait</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_read_data_from_parent</span><span class="p">,</span> <span class="n">AE_READABLE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">nodata</span><span class="o">++</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">nodata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Start counting from zero, we stop on N *contiguous*
                       timeouts. */</span>
        <span class="n">aofReadDiffFromParent</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="c1">// å­è¿›ç¨‹é€šçŸ¥çˆ¶è¿›ç¨‹ä¸è¦å‘æ–°çš„æ•°æ®äº†ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_write_ack_to_parent</span><span class="p">,</span><span class="s">"!"</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">anetNonBlock</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_read_ack_from_parent</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ANET_OK</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// çˆ¶è¿›ç¨‹æ”¶åˆ°å­è¿›ç¨‹çš„ç»“æŸé€šçŸ¥ï¼Œå‘é€ç¡®è®¤ç»™å­è¿›ç¨‹ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">syncRead</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_pipe_read_ack_from_parent</span><span class="p">,</span><span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5000</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">||</span>
        <span class="n">byte</span> <span class="o">!=</span> <span class="sc">'!'</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"Parent agreed to stop sending diffs. Finalizing AOF..."</span><span class="p">);</span>

    <span class="cm">/* Read the final diff if any. */</span>
    <span class="n">aofReadDiffFromParent</span><span class="p">();</span>

    <span class="c1">// å­è¿›ç¨‹æ¥æ”¶çˆ¶è¿›ç¨‹å‘é€çš„å†…å®¹ç¼“å­˜åœ¨ç¼“å†²åŒºï¼Œå°†ç¼“å†²åŒºå†…å®¹è¿½åŠ åˆ°é‡å†™ aof æ–‡ä»¶åã€‚</span>
    <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span>
        <span class="s">"Concatenating %.2f MB of AOF diff received from parent."</span><span class="p">,</span>
        <span class="p">(</span><span class="kt">double</span><span class="p">)</span> <span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_diff</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">1024</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rioWrite</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_diff</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_child_diff</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// å†…å®¹å†™å…¥æ–‡ä»¶å®Œæ¯•ï¼Œåˆ·æ–°æ–‡ä»¶ç¼“å­˜åˆ°ç£ç›˜ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fflush</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fsync</span><span class="p">(</span><span class="n">fileno</span><span class="p">(</span><span class="n">fp</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span> <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>

    <span class="c1">// æ–°çš„é‡å†™ aof æ–‡ä»¶ï¼Œè¦†ç›–æ—§çš„æ–‡ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rename</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Error moving temp append only file on the final destination: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
        <span class="n">unlink</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span>
        <span class="n">stopSaving</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"SYNC append only file rewrite performed"</span><span class="p">);</span>
    <span class="n">stopSaving</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>

<span class="nl">werr:</span>
    <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Write error writing append only file on disk: %s"</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
    <span class="n">fclose</span><span class="p">(</span><span class="n">fp</span><span class="p">);</span>
    <span class="n">unlink</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">);</span>
    <span class="n">stopSaving</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">C_ERR</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="2-è°ƒè¯•">2. è°ƒè¯•</h2>

<p>æˆ‘ä¸€ç›´è®¤ä¸ºï¼šçœ‹æ–‡æ¡£å’Œç»“åˆæºç è°ƒè¯•æ˜¯ç†è§£ä¸€ä¸ªé¡¹ç›®çš„æœ€å¥½æ–¹æ³•ã€‚</p>

<ul>
  <li>
    <p>gdb è°ƒè¯•ï¼Œåœ¨è‡ªå·±æ„Ÿå…´è¶£çš„åœ°æ–¹è®¾ä¸‹æ–­ç‚¹ï¼Œé€šè¿‡è°ƒè¯•ç†Ÿæ‚‰ redis aof æŒä¹…åŒ–å·¥ä½œæµç¨‹ã€‚</p>

    <blockquote>
      <p>è°ƒè¯•æ–¹æ³•å¯ä»¥å‚è€ƒæˆ‘çš„å¸–å­ï¼š <a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a></p>
    </blockquote>
  </li>
</ul>

<p><img src="/images/2020-03-25-16-40-24.png" alt="è°ƒè¯•èµ°æµç¨‹" data-action="zoom" /></p>

<ul>
  <li>å¼€å¯æ—¥å¿—</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

<span class="c"># Specify the server verbosity level.</span>
<span class="c"># This can be one of:</span>
<span class="c"># debug (a lot of information, useful for development/testing)</span>
<span class="c"># verbose (many rarely useful info, but not a mess like the debug level)</span>
<span class="c"># notice (moderately verbose, what you want in production probably)</span>
<span class="c"># warning (only very important / critical messages are logged)</span>
loglevel notice

<span class="c"># Specify the log file name. Also the empty string can be used to force</span>
<span class="c"># Redis to log on the standard output. Note that if you use standard</span>
<span class="c"># output for logging but daemonize, logs will be sent to /dev/null</span>
logfile <span class="s2">"redis.log"</span>
</code></pre></div></div>

<hr />

<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>

<ul>
  <li>aof æ–‡ä»¶å­˜å‚¨ RESP å‘½ä»¤ï¼Œæ–°æ•°æ®è¿½åŠ åˆ°æ–‡ä»¶æœ«ã€‚</li>
  <li>aof å­˜å‚¨ä¸ºäº†é¿å…å†—ä½™ï¼Œéœ€è¦è®¾ç½®é‡å†™å¤„ç†ã€‚</li>
  <li>aof æœ‰ä¸‰ç§å­˜å‚¨ç­–ç•¥ï¼Œé»˜è®¤æ¯ç§’å­˜ç›˜ä¸€æ¬¡ã€‚æ ¹æ®è‡ªå·±çš„ä½¿ç”¨åœºæ™¯ï¼Œé€‰æ‹©å­˜å‚¨ç­–ç•¥ã€‚</li>
  <li>æ¯ç§’å­˜ç›˜ç­–ç•¥å’Œé‡å†™åŠŸèƒ½é€šè¿‡å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†ï¼Œä¿è¯ä¸»çº¿ç¨‹é«˜æ€§èƒ½ã€‚</li>
  <li>å…³æ³¨ redis çš„åšå®¢ï¼Œå¤šçœ‹ redis.conf é…ç½®é¡¹ï¼Œé‡Œé¢æœ‰å¾ˆå¤šä¿¡æ¯é‡ã€‚</li>
  <li>aof æŒä¹…åŒ–æ–‡ä»¶æ”¯æŒ aof å’Œ rdb æ–¹å¼æ··åˆå­˜å‚¨ï¼Œå¯ä»¥å¿«é€Ÿé‡å†™ï¼Œå¹¶ä¸”å‡å°‘ aof ä½“ç§¯ã€‚</li>
  <li>aof ä¸ rdb ç›¸æ¯”æ–‡ä»¶ä½“ç§¯å¤§ï¼Œä½†æ˜¯å®¹ç¾èƒ½åŠ›å¼ºï¼Œå‡ºç°é—®é¢˜ä¸¢å¤±æ•°æ®å°‘ã€‚</li>
</ul>

<h2 id="4-å‚è€ƒ">4. å‚è€ƒ</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/03/19/redis-rdb-struct/">[redis æºç èµ°è¯»] rdb æŒä¹…åŒ– - æ–‡ä»¶ç»“æ„</a></li>
  <li><a href="https://wenfh2020.com/2020/03/19/redis-rdb-application/">[redis æºç èµ°è¯»] rdb æŒä¹…åŒ– - åº”ç”¨åœºæ™¯</a></li>
  <li><a href="http://oldblog.antirez.com/post/redis-persistence-demystified.html">Redis persistence demystified</a></li>
  <li><a href="https://redis.io/topics/persistence#how-durable-is-the-append-only-file">Redis Persistence</a></li>
  <li><a href="https://blog.csdn.net/ybxuwei/article/details/22727565">read/write/fsyncä¸fread/fwrite/fflushçš„å…³ç³»å’ŒåŒºåˆ«</a></li>
  <li>ã€Šredis è®¾è®¡ä¸å®ç°ã€‹</li>
  <li>ã€ŠUNINX ç¯å¢ƒé«˜çº§ç¼–ç¨‹ã€‹</li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/03/29/redis-aof-next/">wenfh2020.com</a></p>
</blockquote>
:ET