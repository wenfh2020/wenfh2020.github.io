I"w¡<p>å®šæ—¶å™¨æ˜¯ redis å¼‚æ­¥å¤„ç†äº‹ä»¶çš„ä¸€ä¸ªååˆ†é‡è¦çš„åŠŸèƒ½ã€‚redis å®šæ—¶å™¨åŠŸèƒ½ç”±å¤šä¸ªæ—¶é—´äº‹ä»¶ç»„æˆï¼Œäº‹ä»¶ç”±ä¸€ä¸ªåŒå‘é“¾è¡¨ç»´æŠ¤ã€‚æ—¶é—´äº‹ä»¶å¯ä»¥å¤„ç†å¤šä¸ªå®šæ—¶ä»»åŠ¡ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-ä½œç”¨" id="markdown-toc-1-ä½œç”¨">1. ä½œç”¨</a></li>
  <li><a href="#2-å®šæ—¶å™¨å®ç°åŸç†" id="markdown-toc-2-å®šæ—¶å™¨å®ç°åŸç†">2. å®šæ—¶å™¨å®ç°åŸç†</a>    <ul>
      <li><a href="#21-äº‹ä»¶ç»“æ„" id="markdown-toc-21-äº‹ä»¶ç»“æ„">2.1. äº‹ä»¶ç»“æ„</a></li>
      <li><a href="#22-å®šæ—¶å™¨æ‰§è¡Œæµç¨‹" id="markdown-toc-22-å®šæ—¶å™¨æ‰§è¡Œæµç¨‹">2.2. å®šæ—¶å™¨æ‰§è¡Œæµç¨‹</a></li>
    </ul>
  </li>
  <li><a href="#3-å•è¿›ç¨‹å¼‚æ­¥å¤„ç†äº‹ä»¶é€»è¾‘" id="markdown-toc-3-å•è¿›ç¨‹å¼‚æ­¥å¤„ç†äº‹ä»¶é€»è¾‘">3. å•è¿›ç¨‹å¼‚æ­¥å¤„ç†äº‹ä»¶é€»è¾‘</a></li>
  <li><a href="#4-å¤šå®šæ—¶ä»»åŠ¡" id="markdown-toc-4-å¤šå®šæ—¶ä»»åŠ¡">4. å¤šå®šæ—¶ä»»åŠ¡</a></li>
  <li><a href="#5-æ€»ç»“" id="markdown-toc-5-æ€»ç»“">5. æ€»ç»“</a></li>
  <li><a href="#7-åè®°" id="markdown-toc-7-åè®°">7. åè®°</a></li>
</ul>

<hr />

<p>ç†è§£ redis å®šæ—¶å™¨ï¼Œæˆ‘ä»¬å¸¦ç€é—®é¢˜ï¼Œçœ‹çœ‹ redis æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼š</p>

<ul>
  <li>å®šæ—¶å™¨ä½œç”¨æ˜¯ä»€ä¹ˆã€‚</li>
  <li>å®šæ—¶å™¨å®ç°åŸç†ã€‚</li>
  <li>å•è¿›ç¨‹é‡Œå¦‚ä½•åŒæ—¶å¤„ç†æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶ã€‚</li>
  <li>å¦‚ä½•å®ç°å¤šå®šæ—¶ä»»åŠ¡ã€‚</li>
</ul>

<hr />

<h2 id="1-ä½œç”¨">1. ä½œç”¨</h2>

<p>å®šæ—¶å™¨æ˜¯ redis å¼‚æ­¥å¤„ç†ä»»åŠ¡çš„ä¸€ä¸ªååˆ†é‡è¦çš„åŠŸèƒ½ã€‚æ ¸å¿ƒé€»è¾‘åœ¨ <code class="highlighter-rouge">serverCron</code> å‡½æ•°é‡Œã€‚</p>

<ul>
  <li>å¯¹è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®è¿›è¡Œæ£€æŸ¥å›æ”¶ã€‚</li>
  <li>å¼‚æ­¥å›æ”¶éœ€è¦å…³é—­çš„é“¾æ¥(socket)ã€‚</li>
  <li>æ£€æŸ¥ fork çš„å­è¿›ç¨‹æ˜¯å¦å·²ç»å…³é—­ï¼Œå¤„ç†å›æ”¶çš„ç›¸å…³å·¥ä½œã€‚</li>
  <li>æ£€æŸ¥å†…å­˜æ•°æ®æ˜¯å¦ç¬¦åˆ rdb æŒä¹…åŒ–å¿«ç…§è½åœ°æ¡ä»¶ï¼Œfork å­è¿›ç¨‹è¿›è¡Œå¿«ç…§ä¿å­˜ã€‚</li>
  <li><code class="highlighter-rouge">bgsave</code> rdb ç”Ÿæˆå¿«ç…§æˆ– <code class="highlighter-rouge">bgrewriteaof</code> aof é‡å†™å»¶åæ“ä½œã€‚</li>
  <li>å¯¹éœ€è¦æ‰©å®¹å’Œç¼©å®¹çš„å“ˆå¸Œè¡¨ï¼ˆdictï¼‰è¿›è¡Œæ•°æ®è¿ç§»ã€‚</li>
  <li>é›†ç¾¤é‡ŒèŠ‚ç‚¹é—´çš„æ–­çº¿é‡è¿ã€‚</li>
  <li>redis æœåŠ¡çš„ä¸€äº›ä¿¡æ¯ç»Ÿè®¡ã€‚</li>
  <li>â€¦ç­‰ç­‰ã€‚</li>
</ul>

<hr />

<h2 id="2-å®šæ—¶å™¨å®ç°åŸç†">2. å®šæ—¶å™¨å®ç°åŸç†</h2>

<p>redis å®šæ—¶å™¨åŠŸèƒ½ç”±å¤šä¸ªæ—¶é—´äº‹ä»¶ç»„æˆï¼Œäº‹ä»¶ç”±ä¸€ä¸ªåŒå‘é“¾è¡¨ç»´æŠ¤ã€‚æœ‰äº›å®ç°é€»è¾‘ï¼Œä¸Šæ–‡å·²ç»æåˆ°ï¼Œä¸‹é¢å°±ç®€å•è¯´ä¸€ä¸‹éƒ¨åˆ†å®ç°åŸç†ã€‚</p>

<h3 id="21-äº‹ä»¶ç»“æ„">2.1. äº‹ä»¶ç»“æ„</h3>

<ul>
  <li>äº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æ—¶é—´äº‹ä»¶</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeTimeEvent</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span> <span class="cm">/* time event identifier. */</span>
    <span class="kt">long</span> <span class="n">when_sec</span><span class="p">;</span> <span class="cm">/* seconds */</span>
    <span class="kt">long</span> <span class="n">when_ms</span><span class="p">;</span> <span class="cm">/* milliseconds */</span>
    <span class="n">aeTimeProc</span> <span class="o">*</span><span class="n">timeProc</span><span class="p">;</span> <span class="cm">/* æ—¶é’Ÿåˆ°æœŸäº‹ä»¶è§¦å‘å›è°ƒå¤„ç†å‡½æ•°ã€‚*/</span>
    <span class="n">aeEventFinalizerProc</span> <span class="o">*</span><span class="n">finalizerProc</span><span class="p">;</span> <span class="cm">/* æ—¶é—´äº‹ä»¶åˆ é™¤æ—¶ï¼Œè§¦å‘å›è°ƒã€‚*/</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">;</span> <span class="cm">/* æ‰©å±•å‚æ•°ï¼Œå¼‚æ­¥æ“ä½œæ–¹ä¾¿æ•°æ®å›è°ƒï¼Œåœ¨ timeProc é€šè¿‡å‚æ•°å›ä¼ ã€‚*/</span>
    <span class="k">struct</span> <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span> <span class="cm">/* æ—¶é—´äº‹ä»¶æ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ã€‚*/</span>
    <span class="k">struct</span> <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">}</span> <span class="n">aeTimeEvent</span><span class="p">;</span>

<span class="c1">// äº‹ä»¶ç®¡ç†</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">timeEventNextId</span><span class="p">;</span>  <span class="c1">// æ—¶é—´äº‹ä»¶ä¸‹ä¸€ä¸ª id (é€šè¿‡ â€˜++â€™ é€’å¢)</span>
    <span class="p">...</span>
    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">timeEventHead</span><span class="p">;</span> <span class="c1">// æ—¶é—´äº‹ä»¶é“¾è¡¨ã€‚</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">aeEventLoop</span><span class="p">;</span>
</code></pre></div></div>

<ul>
  <li>äº‹ä»¶å¾ªç¯ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¾ªç¯å¤„ç†äº‹ä»¶ã€‚</span>
<span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>äº‹ä»¶å›è°ƒå‡½æ•°ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1">// æ—¶é—´äº‹ä»¶è§¦å‘å¤„ç†å‡½æ•°ã€‚</span>
<span class="k">typedef</span> <span class="kt">int</span> <span class="nf">aeTimeProc</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">);</span>

<span class="c1">// æ—¶é—´äº‹ä»¶å¤„ç†å®Œæ¯•ï¼Œè¢«åˆ é™¤æ—¶ï¼Œè§¦å‘çš„å›è°ƒå¤„ç†ã€‚</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="nf">aeEventFinalizerProc</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">);</span>
</code></pre></div></div>

<ul>
  <li>åˆ›å»ºæ—¶é—´äº‹ä»¶ï¼Œæ—¶é—´äº‹ä»¶é€šè¿‡åŒå‘é“¾è¡¨ç®¡ç†ï¼Œæ–°çš„äº‹ä»¶æ’å…¥åˆ°é“¾è¡¨å¤´ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">long</span> <span class="kt">long</span> <span class="nf">aeCreateTimeEvent</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">milliseconds</span><span class="p">,</span>
        <span class="n">aeTimeProc</span> <span class="o">*</span><span class="n">proc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">,</span>
        <span class="n">aeEventFinalizerProc</span> <span class="o">*</span><span class="n">finalizerProc</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// äº‹ä»¶ id é€’å¢ã€‚</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventNextId</span><span class="o">++</span><span class="p">;</span>
    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">te</span><span class="p">;</span>

    <span class="n">te</span> <span class="o">=</span> <span class="n">zmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">te</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">te</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="n">AE_ERR</span><span class="p">;</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
    <span class="c1">// è®¾ç½®åˆ°æœŸæ—¶é—´ã€‚</span>
    <span class="n">aeAddMillisecondsToNow</span><span class="p">(</span><span class="n">milliseconds</span><span class="p">,</span><span class="o">&amp;</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">when_sec</span><span class="p">,</span><span class="o">&amp;</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">when_ms</span><span class="p">);</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">timeProc</span> <span class="o">=</span> <span class="n">proc</span><span class="p">;</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">finalizerProc</span> <span class="o">=</span> <span class="n">finalizerProc</span><span class="p">;</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">clientData</span> <span class="o">=</span> <span class="n">clientData</span><span class="p">;</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
        <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">te</span><span class="p">;</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span> <span class="o">=</span> <span class="n">te</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">id</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è®¾ç½®äº‹ä»¶åˆ°æœŸæ—¶é—´ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">aeAddMillisecondsToNow</span><span class="p">(</span><span class="kt">long</span> <span class="kt">long</span> <span class="n">milliseconds</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">sec</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="n">cur_sec</span><span class="p">,</span> <span class="n">cur_ms</span><span class="p">,</span> <span class="n">when_sec</span><span class="p">,</span> <span class="n">when_ms</span><span class="p">;</span>

    <span class="c1">// å½“å‰æ—¶é—´å¢åŠ åˆ°æœŸæ—¶é—´é—´éš”ã€‚</span>
    <span class="n">aeGetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_ms</span><span class="p">);</span>
    <span class="n">when_sec</span> <span class="o">=</span> <span class="n">cur_sec</span> <span class="o">+</span> <span class="n">milliseconds</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
    <span class="n">when_ms</span> <span class="o">=</span> <span class="n">cur_ms</span> <span class="o">+</span> <span class="n">milliseconds</span><span class="o">%</span><span class="mi">1000</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">when_ms</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">when_sec</span> <span class="o">++</span><span class="p">;</span>
        <span class="n">when_ms</span> <span class="o">-=</span> <span class="mi">1000</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">sec</span> <span class="o">=</span> <span class="n">when_sec</span><span class="p">;</span>
    <span class="o">*</span><span class="n">ms</span> <span class="o">=</span> <span class="n">when_ms</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="22-å®šæ—¶å™¨æ‰§è¡Œæµç¨‹">2.2. å®šæ—¶å™¨æ‰§è¡Œæµç¨‹</h3>

<ul>
  <li>redis å¯åŠ¨æ·»åŠ æ—¶é’Ÿå¤„ç†äº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae.c</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">initServer</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="n">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆ›å»ºå®šæ—¶äº‹ä»¶ï¼Œç»‘å®šå›è°ƒå‡½æ•°ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aeCreateTimeEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">serverCron</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverPanic</span><span class="p">(</span><span class="s">"Can't create event loop timers."</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// æ—¶é’Ÿå›è°ƒå¤„ç†å‡½æ•°</span>
<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>äº‹ä»¶å¾ªç¯å¤„ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å¾ªç¯å¤„ç†äº‹ä»¶ã€‚</span>
<span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¤„ç†æ—¶é—´äº‹ä»¶</span>
<span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
     <span class="cm">/* Check time events */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span>
        <span class="c1">// å¤„ç†æ—¶é—´äº‹ä»¶</span>
        <span class="n">processed</span> <span class="o">+=</span> <span class="n">processTimeEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-å•è¿›ç¨‹å¼‚æ­¥å¤„ç†äº‹ä»¶é€»è¾‘">3. å•è¿›ç¨‹å¼‚æ­¥å¤„ç†äº‹ä»¶é€»è¾‘</h2>

<p>è¿›ç¨‹é€šè¿‡å¾ªç¯ï¼Œä¸åœåœ°å¤„ç†æ—¶é—´äº‹ä»¶å’Œæ–‡ä»¶äº‹ä»¶ã€‚</p>

<p><img src="/images/2020-04-07-14-42-08.png" alt="redis å•è¿›ç¨‹å¤„ç†æ–‡ä»¶äº‹ä»¶å’Œæ—¶é—´äº‹ä»¶" data-action="zoom" /></p>

<ul>
  <li>åœ¨è¿›ç¨‹çš„å¾ªç¯ä¸­ä¸åœåœ°æå‡ºæ–‡ä»¶å’Œæ—¶é—´äº‹ä»¶è¿›è¡Œå¤„ç† <code class="highlighter-rouge">aeProcessEvents</code>ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ae.c</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// å¾ªç¯å¤„ç†äº‹ä»¶ã€‚</span>
<span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// å¤„ç†äº‹ä»¶</span>
<span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// å…ˆæœç´¢å‡ºæœ€å¿«åˆ°æœŸçš„å®šæ—¶å™¨ï¼ŒæŸ¥çœ‹æ—¶é—´æˆ³ï¼Œæ–‡ä»¶äº‹ä»¶è¦åœ¨å®šæ—¶å™¨åˆ°æœŸå‰ä»ç³»ç»Ÿå†…æ ¸æå‡ºæ¥å¤„ç†ã€‚</span>
    <span class="n">shortest</span> <span class="o">=</span> <span class="n">aeSearchNearestTimer</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="c1">// å¤„ç†æ–‡ä»¶äº‹ä»¶ï¼Œç­‰å¾…è·å–äº‹ä»¶æ—¶é—´é—´éš”ä¸èƒ½å¤ªé•¿ï¼Œå¦åˆ™å®šæ—¶å™¨äº‹ä»¶å¤„ç†è¦è¶…æ—¶äº†ã€‚</span>
    <span class="n">numevents</span> <span class="o">=</span> <span class="n">aeApiPoll</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// å¤„ç†æ—¶é—´äº‹ä»¶</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span>
        <span class="n">processed</span> <span class="o">+=</span> <span class="n">processTimeEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å¯¹äºæ–‡ä»¶äº‹ä»¶ï¼Œåœ¨ linux ç³»ç»Ÿä¸­ï¼Œredis é‡‡ç”¨äº† <code class="highlighter-rouge">epoll</code> å¤šè·¯å¤ç”¨ I/O äº‹ä»¶é©±åŠ¨å¤„ç†æ–‡ä»¶äº‹ä»¶ã€‚é€šè¿‡ <code class="highlighter-rouge">epoll_wait</code> æå‡ºå°±ç»ªäº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">aeApiPoll</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tvp</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">epoll_wait</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">epfd</span><span class="p">,</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">,</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">setsize</span><span class="p">,</span>
            <span class="n">tvp</span> <span class="o">?</span> <span class="p">(</span><span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_sec</span><span class="o">*</span><span class="mi">1000</span> <span class="o">+</span> <span class="n">tvp</span><span class="o">-&gt;</span><span class="n">tv_usec</span><span class="o">/</span><span class="mi">1000</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å…ˆå¤„ç†å®Œæ–‡ä»¶äº‹ä»¶ï¼Œå†å¤„ç†æ—¶é—´äº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">processTimeEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-å¤šå®šæ—¶ä»»åŠ¡">4. å¤šå®šæ—¶ä»»åŠ¡</h2>

<p>æˆ‘ä»¬çœ‹çœ‹ <code class="highlighter-rouge">processTimeEvents</code> æ˜¯å¦‚ä½•å¤„ç†å¤šä¸ªå®šæ—¶ä»»åŠ¡çš„ï¼š</p>

<p><img src="/images/2020-04-07-14-40-30.png" alt="redis å¤šå®šæ—¶ä»»åŠ¡" data-action="zoom" /></p>

<ul>
  <li>éå†æ—¶é—´äº‹ä»¶é“¾è¡¨ï¼Œå…ˆåˆ é™¤å·²å¤„ç†ï¼Œè¢«æ ‡è¯†éœ€è¦åˆ é™¤çš„äº‹ä»¶ï¼Œå†æ‰§è¡Œåˆ°æœŸäº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">processTimeEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">te</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">maxId</span><span class="p">;</span>
    <span class="kt">time_t</span> <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">lastTime</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

    <span class="n">te</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span><span class="p">;</span>
    <span class="n">maxId</span> <span class="o">=</span> <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventNextId</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="c1">// éå†æ—¶é—´é“¾è¡¨ï¼Œå¤„ç†åˆ°æœŸæ‰§è¡Œçš„æ—¶é—´äº‹ä»¶ã€‚</span>
    <span class="k">while</span><span class="p">(</span><span class="n">te</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">long</span> <span class="n">now_sec</span><span class="p">,</span> <span class="n">now_ms</span><span class="p">;</span>
        <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>

        <span class="c1">// ä»æ—¶é—´äº‹ä»¶é“¾è¡¨ä¸­ï¼Œåˆ é™¤æ—¶è¢«æ ‡è¯†ä¸ºåˆ é™¤çŠ¶æ€çš„äº‹ä»¶ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">AE_DELETED_EVENT_ID</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">aeTimeEvent</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">)</span>
                <span class="n">te</span><span class="o">-&gt;</span><span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="k">else</span>
                <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">timeEventHead</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span>
                <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="o">-&gt;</span><span class="n">prev</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">finalizerProc</span><span class="p">)</span>
                <span class="n">te</span><span class="o">-&gt;</span><span class="n">finalizerProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">);</span>
            <span class="n">zfree</span><span class="p">(</span><span class="n">te</span><span class="p">);</span>
            <span class="n">te</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
        <span class="c1">// æ—¶é—´äº‹ä»¶åˆ°æœŸï¼Œæ‰§è¡Œäº‹ä»¶ã€‚</span>
        <span class="n">aeGetTime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now_sec</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">now_ms</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">now_sec</span> <span class="o">&gt;</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">when_sec</span> <span class="o">||</span>
            <span class="p">(</span><span class="n">now_sec</span> <span class="o">==</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">when_sec</span> <span class="o">&amp;&amp;</span> <span class="n">now_ms</span> <span class="o">&gt;=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">when_ms</span><span class="p">))</span> <span class="p">{</span>
            <span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

            <span class="n">id</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
            <span class="c1">// æ‰§è¡Œæ—¶é’Ÿå›è°ƒå‡½æ•°</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">timeProc</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">clientData</span><span class="p">);</span>
            <span class="n">processed</span><span class="o">++</span><span class="p">;</span>
            <span class="c1">// å¦‚æœå›è°ƒå‡½æ•°ä¸è¿”å› AE_NOMOREï¼Œé‡æ–°æ›´æ–°è¯¥äº‹ä»¶çš„åˆ°æœŸæ—¶é—´ï¼Œç­‰å¾…ä¸‹æ¬¡è§¦å‘ï¼Œå¦åˆ™æ ‡è¯†äº‹ä»¶ä¸ºåˆ é™¤çŠ¶æ€ã€‚</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="n">AE_NOMORE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">aeAddMillisecondsToNow</span><span class="p">(</span><span class="n">retval</span><span class="p">,</span><span class="o">&amp;</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">when_sec</span><span class="p">,</span><span class="o">&amp;</span><span class="n">te</span><span class="o">-&gt;</span><span class="n">when_ms</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">te</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">AE_DELETED_EVENT_ID</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">te</span> <span class="o">=</span> <span class="n">te</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>æ—¶é—´äº‹ä»¶å®šæ—¶æ‰§è¡ŒåŸç†ã€‚</p>

    <p>åˆ°æœŸäº‹ä»¶å›è°ƒå¤„ç†å‡½æ•° <code class="highlighter-rouge">timeProc</code>ï¼Œä¾‹å¦‚ redis å¯¹åº”çš„å¤„ç†å‡½æ•° <code class="highlighter-rouge">serverCron</code>ã€‚ <code class="highlighter-rouge">serverCron</code> è¿”å›ä¸‹ä¸€æ¬¡åˆ°æœŸçš„æ—¶é—´é—´éš”ï¼Œäº‹ä»¶åˆ°æœŸæ—¶é—´è¢«(<code class="highlighter-rouge">aeAddMillisecondsToNow</code>)ä¿®æ”¹å»¶åä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œä¸‹ä¸€æ¬¡åˆ°æœŸå†é‡æ–°æ‰§è¡Œï¼Œä»è€Œè¾¾åˆ°æ—¶é’Ÿå®šæœŸæ‰§è¡Œçš„æ•ˆæœã€‚</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// è¿”å›æ—¶é—´é—´éš”ï¼Œå•ä½æ¯«ç§’ã€‚</span>
    <span class="k">return</span> <span class="mi">1000</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">hz</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>
    <p>å®šæ—¶å™¨å®šæ—¶æ‰§è¡Œé¢‘ç‡ã€‚</p>

    <p>å¾ˆå¤šåå°ä»»åŠ¡éƒ½åœ¨å®šæ—¶å™¨é‡Œæ‰§è¡Œï¼Œå®šæ—¶æ‰§è¡Œé¢‘ç‡å¯ä»¥ç”±é…ç½®æ–‡ä»¶çš„ <code class="highlighter-rouge">hz</code> é¢‘ç‡æ§åˆ¶ï¼Œæ—¶é—´äº‹ä»¶ (1000/hz) æ¯«ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œé¢‘ç‡è¶Šé«˜ï¼Œåˆ°æœŸæ—¶é—´é—´éš”è¶Šå°ï¼Œåˆ·å¾—è¶Šå¿«ï¼Œå®šæ—¶åå°ä»»åŠ¡å¤„ç†å¾—è¶Šå¿«ï¼Œä½†æ˜¯è¿™æ ·ä¹Ÿä¼šç›¸åº”åœ°æŸè€—æ›´å¤šçš„ç³»ç»Ÿèµ„æºï¼Œè€Œä¸”å®šæ—¶äº‹ä»¶å’Œæ–‡ä»¶äº‹ä»¶æ˜¯åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­è¿›è¡Œçš„ï¼Œè¿™æ ·è‚¯å®šä¼šå½±å“åˆ°æ–‡ä»¶äº‹ä»¶æ‰§è¡Œã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç³»ç»Ÿé»˜è®¤ä¸€ç§’å®šæ—¶æ‰§è¡Œ 10 æ¬¡ï¼Œä¹Ÿå°±æ˜¯ <code class="highlighter-rouge">hz == 10</code>ã€‚</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

<span class="c"># å®šæ—¶å™¨äº‹ä»¶åˆ·æ–°é¢‘ç‡ 1 &lt; hz &lt; 500ï¼Œé»˜è®¤ 10</span>
hz 10
</code></pre></div></div>

<ul>
  <li>
    <p>å¤šå®šæ—¶ä»»åŠ¡</p>

    <p>äº‹ä»¶é‡Œæœ‰ä¸åŒçš„å®šæ—¶ä»»åŠ¡ï¼Œå®ƒä»¬å®šæ—¶æ‰§è¡Œçš„ä»»åŠ¡æœ‰å¿«æœ‰æ…¢ï¼Œé‚£å¯¹äºå¤šä¸ªå®šæ—¶ä»»åŠ¡ï¼Œåœ¨æ—¶é—´äº‹ä»¶è§¦å‘åï¼Œå®ƒæ˜¯å¦‚ä½•å¤„ç†çš„å‘¢ï¼Ÿ
å¯ä»¥é€šè¿‡å® <code class="highlighter-rouge">run_with_period</code> å¤„ç†ã€‚å½“æ—¶é—´é—´éš” <code class="highlighter-rouge">_ms_</code> å¾ˆå°çš„æ—¶å€™ï¼Œæ¯æ¬¡è§¦å‘æ—¶é—´äº‹ä»¶ï¼Œä»»åŠ¡éƒ½ä¼šæ‰§è¡Œï¼Œå¦åˆ™é€šè¿‡è®°å½•äº‹ä»¶è§¦å‘çš„æ¬¡æ•° <code class="highlighter-rouge">server.cronloops++</code>ï¼Œå½“ <code class="highlighter-rouge">hz</code> è§¦å‘çš„äº‹ä»¶æ—¶é—´é—´éš”ç´¯ç§¯èµ·æ¥è¾¾åˆ°é•¿æ—¶é—´é—´éš”ï¼Œå°±æ‰§è¡Œæ…¢ä»»åŠ¡ã€‚(å‚è€ƒä¸Šå›¾)</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">int</span> <span class="n">cronloops</span><span class="p">;</span>              <span class="cm">/* Number of times the cron function run */</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="cp">#define run_with_period(_ms_) if ((_ms_ &lt;= 1000/server.hz) || !(server.cronloops%((_ms_)/(1000/server.hz))))
</span>
<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// å¿«ä»»åŠ¡ï¼Œæ—¶é—´é—´éš” &lt;= æ—¶é—´äº‹ä»¶è§¦å‘æ—¶é—´é—´éš”ï¼Œæ‰§è¡Œã€‚</span>
    <span class="n">run_with_period</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// æ…¢ä»»åŠ¡ï¼Œå®šæ—¶æ—¶é—´é—´éš”æ¯”è¾ƒé•¿çš„ï¼Œéœ€è¦é€šè¿‡ server.cronloops ç´¯åŠ è¾¾åˆ°é•¿æ—¶é—´é—´éš”ï¼Œæ‰ä¼šæ‰§è¡Œæ…¢ä»»åŠ¡ã€‚</span>
    <span class="n">run_with_period</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
    <span class="p">}</span>

    <span class="c1">// æ¯æ¬¡è§¦å‘å®šæ—¶äº‹ä»¶ï¼Œéƒ½ä¼šæ‰§è¡Œã€‚</span>
    <span class="cm">/* We need to do a few operations on clients asynchronously. */</span>
    <span class="n">clientsCron</span><span class="p">();</span>

    <span class="cm">/* Handle background operations on Redis databases. */</span>
    <span class="n">databasesCron</span><span class="p">();</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">cronloops</span><span class="o">++</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="5-æ€»ç»“">5. æ€»ç»“</h2>

<ul>
  <li>å®šæ—¶å™¨æ˜¯ç”±æ—¶é—´äº‹ä»¶ç»„æˆçš„ï¼Œç›®å‰ï¼Œredis æ ¸å¿ƒçš„å®šæ—¶äº‹ä»¶åªæœ‰ä¸€ä¸ªï¼Œæ ¸å¿ƒé€»è¾‘éƒ½åœ¨ <code class="highlighter-rouge">serverCron</code> å‡½æ•°é‡Œã€‚</li>
  <li>å®šæ—¶å™¨å®šæ—¶è§¦å‘é¢‘ç‡å—é…ç½® <code class="highlighter-rouge">hz</code> å½±å“ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹è¯¥é…ç½®é¡¹ï¼Œè°ƒæ•´å®šæ—¶å¤„ç†é€Ÿåº¦ã€‚</li>
  <li>å¤šå®šæ—¶ä»»åŠ¡ï¼Œå…¶å®åœ¨åŒä¸€ä¸ªå®šæ—¶å™¨æ—¶é—´äº‹ä»¶é‡Œå¤„ç†ã€‚</li>
  <li>å®šæ—¶äº‹ä»¶å’Œæ–‡ä»¶äº‹ä»¶éƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­æ‰§è¡Œï¼Œæ‰€ä»¥è™½ç„¶å®šæ—¶äº‹ä»¶æ—¶é—´ç²¾åº¦æ˜¯æ¯«ç§’ï¼Œä½†æ˜¯ä¸ä¸€å®šä¼šååˆ†ç²¾ç¡®ï¼Œä¼šå—åˆ°æ–‡ä»¶äº‹ä»¶å¤„ç†å½±å“ã€‚</li>
  <li>å®šæ—¶äº‹ä»¶æ‰§è¡Œè¿˜ä¼šå—åˆ°å®šæ—¶å™¨é‡Œçš„ä»»åŠ¡å¤„ç†å½±å“ï¼Œä¾‹å¦‚ç³»ç»Ÿåœ¨ä¸€ä¸ªæ—¶é—´æ®µå†…å¾ˆå¤šè¿‡æœŸæ•°æ®ï¼Œé‚£ä¹ˆç³»ç»Ÿæœ‰å¯èƒ½ä¼šåˆ†é…æ›´å¤šçš„æ—¶é—´ç‰‡å»å¤„ç†ã€‚</li>
  <li>åŸºäº redis ä¸»é€»è¾‘éƒ½åœ¨å•è¿›ç¨‹ä¸»çº¿ç¨‹ä¸­å®ç°ï¼Œæ‰€ä»¥å®šæ—¶ä»»åŠ¡ä¸èƒ½æ‰§è¡Œå¤ªé•¿çš„æ—¶é—´ï¼Œæ‰€ä»¥å¾ˆå¤šå¤æ‚çš„å®šæ—¶ä»»åŠ¡ï¼Œéƒ½ä¼šé™åˆ¶å¤„ç†æ•°é‡å’Œå¤„ç†æ—¶é—´ã€‚ï¼ˆä¾‹å¦‚å­—å…¸ dict çš„æ‰©å®¹å’Œç¼©å®¹ï¼Œmaxmemory æ•°æ®æ·˜æ±°ç­–ç•¥ç­‰ç­‰ã€‚ï¼‰</li>
</ul>

<hr />

<h2 id="7-åè®°">7. åè®°</h2>

<p>é€šè¯»ä¸€ä¸ªçŸ¥è¯†ç‚¹åï¼ŒçŸ¥è¯†åœ¨è„‘æµ·ä¸­æ˜¯æ¨¡ç³Šçš„ï¼Œéœ€è¦é€šè¿‡ä¸åŒæ–¹å¼å»å¼ºåŒ–æ¸…æ™°è¿™ä¸ªè„‘æµ·ä¸­çš„æ˜ åƒã€‚è®©æŠ½è±¡æ€ç»´è½åœ°ï¼Œæˆ‘è‡ªå·±ä¼šç»å¸¸å°†ä¸€äº›çŸ¥è¯†ç‚¹å›¾å½¢åŒ–ï¼Œè¿™æ ·ä¸€ç‚¹ä¸€ç‚¹åœ°å°†çŸ¥è¯†ç¢ç‰‡æ‹¼æ¥èµ·æ¥ã€‚</p>

<p><img src="/images/2020-04-07-11-04-48.png" alt="å¤–æ¥æ˜¾ç¤ºå™¨" data-action="zoom" /></p>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/04/06/ae-timer/">wenfh2020.com</a></p>
</blockquote>
:ET