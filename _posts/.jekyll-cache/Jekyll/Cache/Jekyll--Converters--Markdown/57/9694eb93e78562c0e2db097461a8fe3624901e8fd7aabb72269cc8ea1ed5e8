I"á¹<p>epoll æºç æ¶‰åŠåˆ°å¾ˆå¤šçŸ¥è¯†ç‚¹ï¼šï¼ˆsocketï¼‰ç½‘ç»œé€šä¿¡ï¼Œè¿›ç¨‹è°ƒåº¦ï¼Œç­‰å¾…é˜Ÿåˆ—ï¼Œsocket ä¿¡å·å¤„ç†ï¼ŒVFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œçº¢é»‘æ ‘ç®—æ³•ç­‰ç­‰çŸ¥è¯†ç‚¹ã€‚æœ‰äº›æ¥å£çš„å®ç°ï¼Œè—å¾—å¾ˆæ·±ï¼Œå‚è€ƒäº†ä¸å°‘ç½‘ä¸Šçš„å¸–å­ï¼Œåœ¨æ­¤æ•´ç†ä¸€ä¸‹ã€‚</p>

<blockquote>
  <p>æœ¬æ–‡ä¸»è¦ä¸º ã€Š<a href="https://wenfh2020.com/2020/04/23/epoll-code/">[epoll æºç èµ°è¯»] epoll å®ç°åŸç†</a>ã€‹ï¼Œæä¾›é¢„å¤‡çŸ¥è¯†ã€‚</p>
</blockquote>

<ul id="markdown-toc">
  <li><a href="#1-ç½‘ç»œæ•°æ®ä¼ è¾“æµç¨‹" id="markdown-toc-1-ç½‘ç»œæ•°æ®ä¼ è¾“æµç¨‹">1. ç½‘ç»œæ•°æ®ä¼ è¾“æµç¨‹</a></li>
  <li><a href="#2-å†…æ ¸è¿›ç¨‹è°ƒåº¦" id="markdown-toc-2-å†…æ ¸è¿›ç¨‹è°ƒåº¦">2. å†…æ ¸è¿›ç¨‹è°ƒåº¦</a></li>
  <li><a href="#3-ç­‰å¾…é˜Ÿåˆ—" id="markdown-toc-3-ç­‰å¾…é˜Ÿåˆ—">3. ç­‰å¾…é˜Ÿåˆ—</a></li>
  <li><a href="#4-æ–‡ä»¶æè¿°ç¬¦" id="markdown-toc-4-æ–‡ä»¶æè¿°ç¬¦">4. æ–‡ä»¶æè¿°ç¬¦</a>    <ul>
      <li><a href="#41-åˆ›å»º-socket" id="markdown-toc-41-åˆ›å»º-socket">4.1. åˆ›å»º socket</a></li>
      <li><a href="#42-accept" id="markdown-toc-42-accept">4.2. accept</a></li>
      <li><a href="#43-socket-å…³è”-fdfile" id="markdown-toc-43-socket-å…³è”-fdfile">4.3. socket å…³è” fd/file</a></li>
      <li><a href="#44-socket-å…³è”-sock" id="markdown-toc-44-socket-å…³è”-sock">4.4. socket å…³è” sock</a></li>
    </ul>
  </li>
  <li><a href="#5-fd-å°±ç»ªäº‹ä»¶å›è°ƒå¤„ç†" id="markdown-toc-5-fd-å°±ç»ªäº‹ä»¶å›è°ƒå¤„ç†">5. fd å°±ç»ªäº‹ä»¶å›è°ƒå¤„ç†</a>    <ul>
      <li><a href="#51-poll-æ¥å£" id="markdown-toc-51-poll-æ¥å£">5.1. poll æ¥å£</a></li>
      <li><a href="#52-file_operations" id="markdown-toc-52-file_operations">5.2. file_operations</a></li>
      <li><a href="#53-tcp_poll" id="markdown-toc-53-tcp_poll">5.3. tcp_poll</a></li>
      <li><a href="#54-ep_poll_callback" id="markdown-toc-54-ep_poll_callback">5.4. ep_poll_callback</a></li>
    </ul>
  </li>
  <li><a href="#6-å‚è€ƒ" id="markdown-toc-6-å‚è€ƒ">6. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-ç½‘ç»œæ•°æ®ä¼ è¾“æµç¨‹">1. ç½‘ç»œæ•°æ®ä¼ è¾“æµç¨‹</h2>

<p>ç½‘ç»œæ•°æ®æ˜¯å¦‚ä½•ä»ç½‘å¡ä¼ åˆ°å†…æ ¸ï¼Œå†…æ ¸å¦‚ä½•å°†æ•°æ®ä¼ åˆ°ç”¨æˆ·å±‚çš„ã€‚</p>

<blockquote>
  <p>å‚è€ƒ <a href="https://www.cnblogs.com/zhjh256/p/12227883.html">Linuxç½‘ç»œåŒ…æ”¶å‘æ€»ä½“è¿‡ç¨‹</a></p>

  <p>å‚è€ƒ <a href="https://www.cnblogs.com/diegodu/p/9377535.html">epollæºç åˆ†æ</a></p>
</blockquote>

<hr />

<h2 id="2-å†…æ ¸è¿›ç¨‹è°ƒåº¦">2. å†…æ ¸è¿›ç¨‹è°ƒåº¦</h2>

<p>ç½‘ç»œé€šä¿¡è¿‡ç¨‹ä¸­ï¼Œè¿›ç¨‹ä»€ä¹ˆæ—¶å€™ç¡çœ ï¼Œä»€ä¹ˆæ—¶å€™å”¤é†’ï¼Œä¸€ä¸ª cpu ä¸ºä½•èƒ½è·‘å¤šä¸ªè¿›ç¨‹ï¼Œè¿›ç¨‹æ˜¯å¦‚ä½•è°ƒåº¦çš„ã€‚</p>

<blockquote>
  <p>å‚è€ƒ <a href="https://blog.csdn.net/qq_31967569/article/details/102953756">å½»åº•ç†è§£epoll</a></p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* Used in tsk-&gt;state: */</span>

<span class="c1">// sched.h</span>
<span class="cp">#define TASK_RUNNING            0x0000
#define TASK_INTERRUPTIBLE      0x0001
#define TASK_UNINTERRUPTIBLE    0x0002
</span></code></pre></div></div>

<table>
  <thead>
    <tr>
      <th style="text-align: left">è¿›ç¨‹çŠ¶æ€</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">TASK_RUNNING</td>
      <td style="text-align: left">æ­£åœ¨è¿è¡Œ</td>
    </tr>
    <tr>
      <td style="text-align: left">TASK_INTERRUPTIBLE</td>
      <td style="text-align: left">ç­‰å¾…çŠ¶æ€ã€‚ç­‰å¾…çŠ¶æ€å¯è¢«ä¿¡å·è§£é™¤ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">TASK_UNINTERRUPTIBLE</td>
      <td style="text-align: left">ç­‰å¾…çŠ¶æ€ã€‚ç­‰å¾…çŠ¶æ€ä¸å¯è¢«ä¿¡å·è§£é™¤ã€‚</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="3-ç­‰å¾…é˜Ÿåˆ—">3. ç­‰å¾…é˜Ÿåˆ—</h2>

<p>ä»€ä¹ˆæ˜¯ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›ç¨‹é˜»å¡ç¡çœ åï¼Œå†…æ ¸å¦‚ä½•é€šè¿‡ç­‰å¾…é˜Ÿåˆ—å”¤é†’è¿›ç¨‹å·¥ä½œã€‚</p>

<blockquote>
  <p>å‚è€ƒ <a href="https://blog.csdn.net/u012218309/article/details/81148083">linuxç­‰å¾…é˜Ÿåˆ— wait_queue çš„ä½¿ç”¨</a>ã€‚</p>
</blockquote>

<hr />

<h2 id="4-æ–‡ä»¶æè¿°ç¬¦">4. æ–‡ä»¶æè¿°ç¬¦</h2>

<p>fd æ–‡ä»¶æè¿°ç¬¦æ˜¯ä»€ä¹ˆï¼Œsocket æ˜¯ä»€ä¹ˆï¼ŒLinux ä¸€åˆ‡çš†æ–‡ä»¶ï¼Œå®ƒé€šè¿‡ vfs è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œç®¡ç†ã€‚</p>

<blockquote>
  <p>å‚è€ƒ <a href="https://www.solves.com.cn/news/hlw/2020-03-15/13907.html">Linux è¿›ç¨‹ã€çº¿ç¨‹ã€æ–‡ä»¶æè¿°ç¬¦çš„åº•å±‚åŸç†</a></p>
</blockquote>

<hr />

<h3 id="41-åˆ›å»º-socket">4.1. åˆ›å»º socket</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// socket.c</span>
<span class="kt">int</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆ›å»º socketã€‚</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">sock_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">sock_map_fd</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">O_CLOEXEC</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="42-accept">4.2. accept</h3>

<p>accept åˆ†é… socket èµ„æºã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// socket.c</span>
<span class="kt">int</span> <span class="nf">__sys_accept4_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">file_flags</span><span class="p">,</span>
               <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_sockaddr</span><span class="p">,</span>
               <span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="n">upeer_addrlen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">newfile</span> <span class="o">=</span> <span class="n">sock_alloc_file</span><span class="p">(</span><span class="n">newsock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">);</span>
        <span class="n">put_unused_fd</span><span class="p">(</span><span class="n">newfd</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="43-socket-å…³è”-fdfile">4.3. socket å…³è” fd/file</h3>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// socket.c</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sock_map_fd</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">newfile</span><span class="p">;</span>
    <span class="c1">// åˆ†é…ä¸€ä¸ªç©ºé—²çš„ fd æ–‡ä»¶æè¿°ç¬¦ã€‚</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">get_unused_fd_flags</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// socket ä¸æ–‡ä»¶å»ºç«‹è”ç³»ã€‚</span>
    <span class="n">newfile</span> <span class="o">=</span> <span class="n">sock_alloc_file</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">newfile</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// fd æ–‡ä»¶æè¿°ç¬¦ç»‘å®š file æ–‡ä»¶å¯¹è±¡ã€‚</span>
        <span class="n">fd_install</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">newfile</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">fd</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// socket.c</span>
<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">sock_alloc_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dname</span><span class="p">)</span>
        <span class="n">dname</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span> <span class="o">?</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_prot_creator</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">:</span> <span class="s">""</span><span class="p">;</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">alloc_file_pseudo</span><span class="p">(</span><span class="n">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">sock_mnt</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span>
                <span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">socket_file_ops</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">file</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">sock_release</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">file</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// socket ä¸æ–‡ä»¶å»ºç«‹è”ç³»ã€‚</span>
    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
    <span class="n">stream_open</span><span class="p">(</span><span class="n">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">file</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">file</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="44-socket-å…³è”-sock">4.4. socket å…³è” sock</h3>

<p><code class="highlighter-rouge">sock_init_data</code> å°† socket å…³è” sockã€‚sock ç­‰å¾…é˜Ÿåˆ—æŒ‡å‘ socket ç­‰å¾…é˜Ÿåˆ—ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// socket.c</span>
<span class="kt">int</span> <span class="nf">__sys_socket</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆ›å»º socketã€‚</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">sock_create</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// socket.c</span>
<span class="kt">int</span> <span class="nf">sock_create</span><span class="p">(</span><span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">__sock_create</span><span class="p">(</span><span class="n">current</span><span class="o">-&gt;</span><span class="n">nsproxy</span><span class="o">-&gt;</span><span class="n">net_ns</span><span class="p">,</span> <span class="n">family</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__sock_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="kt">int</span> <span class="n">family</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span>
            <span class="k">struct</span> <span class="n">socket</span> <span class="o">**</span><span class="n">res</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">sock</span> <span class="o">=</span> <span class="n">sock_alloc</span><span class="p">();</span> <span class="c1">// åˆ›å»ºä¼ è¾“å±‚ socketã€‚</span>
    <span class="p">...</span>
    <span class="n">pf</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">net_families</span><span class="p">[</span><span class="n">family</span><span class="p">]);</span>
    <span class="p">...</span>
    <span class="n">err</span> <span class="o">=</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">create</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span> <span class="c1">// inet_create</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// socket.c</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">__rcu</span> <span class="o">*</span><span class="n">net_families</span><span class="p">[</span><span class="n">NPROTO</span><span class="p">]</span> <span class="n">__read_mostly</span><span class="p">;</span>

<span class="c1">// af_inet.c</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_proto_family</span> <span class="n">inet_family_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">family</span> <span class="o">=</span> <span class="n">PF_INET</span><span class="p">,</span>
    <span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">inet_create</span><span class="p">,</span>
    <span class="p">.</span><span class="n">owner</span>    <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="c1">// af_inet.c</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">inet_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">net</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">protocol</span><span class="p">,</span> <span class="kt">int</span> <span class="n">kern</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">sk</span> <span class="o">=</span> <span class="n">sk_alloc</span><span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="n">PF_INET</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">answer_prot</span><span class="p">,</span> <span class="n">kern</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">sock_init_data</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sk</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// socket.c</span>
<span class="kt">void</span> <span class="nf">sock_init_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_type</span>    <span class="o">=</span>    <span class="n">sock</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
        <span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span> <span class="c1">// sock çš„ç­‰å¾…é˜Ÿåˆ—æŒ‡å‘ socket çš„ç­‰å¾…é˜Ÿåˆ—ã€‚</span>
        <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span>    <span class="o">=</span>    <span class="n">sk</span><span class="p">;</span> <span class="c1">// sock ä¸ socket å»ºç«‹è”ç³»ã€‚</span>
        <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_uid</span>    <span class="o">=</span>    <span class="n">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">i_uid</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">RCU_INIT_POINTER</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
        <span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_uid</span>    <span class="o">=</span>    <span class="n">make_kuid</span><span class="p">(</span><span class="n">sock_net</span><span class="p">(</span><span class="n">sk</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">user_ns</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

</code></pre></div></div>

<hr />

<h2 id="5-fd-å°±ç»ªäº‹ä»¶å›è°ƒå¤„ç†">5. fd å°±ç»ªäº‹ä»¶å›è°ƒå¤„ç†</h2>

<p>fd ä¸å›è°ƒ <code class="highlighter-rouge">ep_poll_callback</code> å»ºç«‹è”ç³»ï¼Œå½“ç½‘ç»œäº‹ä»¶åˆ°æ¥ï¼Œè§¦å‘å›è°ƒæ¥ç­›é€‰å‡ºç”¨æˆ·å…³æ³¨çš„äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚</p>

<p><img src="/images/2020-05-12-16-53-50.png" alt="é©±åŠ¨ç²˜åˆè®¾å¤‡å’Œå†…æ ¸" data-action="zoom" /></p>

<hr />

<h3 id="51-poll-æ¥å£">5.1. poll æ¥å£</h3>

<p>å°±ç»ªäº‹ä»¶å¤„ç†æ“ä½œ poll æ¥å£ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">file_operations</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">__poll_t</span> <span class="p">(</span><span class="o">*</span><span class="n">poll</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">__randomize_layout</span><span class="p">;</span>

<span class="c1">// socket.c</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">socket_file_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">sock_poll</span><span class="p">,</span> <span class="c1">// socket çš„å°±ç»ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚</span>
    <span class="p">...</span>
<span class="p">};</span>
</code></pre></div></div>

<hr />

<h3 id="52-file_operations">5.2. file_operations</h3>

<p>file_operations ä¸æ–‡ä»¶å»ºç«‹è”ç³»ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// socket.c</span>
<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">sock_alloc_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dname</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆ›å»ºæ–‡ä»¶ï¼Œç»‘å®šæ–‡ä»¶æ“ä½œæ¥å£ï¼špoll().</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">alloc_file_pseudo</span><span class="p">(</span><span class="n">SOCK_INODE</span><span class="p">(</span><span class="n">sock</span><span class="p">),</span> <span class="n">sock_mnt</span><span class="p">,</span> <span class="n">dname</span><span class="p">,</span>
                <span class="n">O_RDWR</span> <span class="o">|</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">),</span>
                <span class="o">&amp;</span><span class="n">socket_file_ops</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">file</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// file_table.c</span>
<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">alloc_file_pseudo</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vfsmount</span> <span class="o">*</span><span class="n">mnt</span><span class="p">,</span>
                <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
                <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fops</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">alloc_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">path</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">fops</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">file</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// file_table.c</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="nf">alloc_file</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">path</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span>
        <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="o">*</span><span class="n">fop</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">;</span>

    <span class="n">file</span> <span class="o">=</span> <span class="n">alloc_empty_file</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">current_cred</span><span class="p">());</span>
    <span class="p">...</span>
    <span class="c1">// æ“ä½œå¯¹è±¡ä¸æ–‡ä»¶å»ºç«‹å…³ç³»ã€‚</span>
    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span> <span class="o">=</span> <span class="n">fop</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">file</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="53-tcp_poll">5.3. tcp_poll</h3>

<p>socket å°±ç»ªäº‹ä»¶å¤„ç† tcp_pollã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// å°±ç»ªäº‹ä»¶å¤„ç†ç»“æ„ã€‚</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="p">{</span>
    <span class="n">poll_queue_proc</span> <span class="n">_qproc</span><span class="p">;</span> <span class="c1">// å¤„ç†å‡½æ•°ï¼ˆeventpoll.c çš„ ep_ptable_queue_procï¼‰ã€‚</span>
    <span class="n">__poll_t</span> <span class="n">_key</span><span class="p">;</span>          <span class="c1">// äº‹ä»¶ç»„åˆã€‚</span>
<span class="p">}</span> <span class="n">poll_table</span><span class="p">;</span>

<span class="c1">// poll.h</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__poll_t</span> <span class="nf">vfs_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">DEFAULT_POLLMASK</span><span class="p">;</span>
    <span class="c1">// sock_poll</span>
    <span class="k">return</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_op</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__poll_t</span> <span class="nf">sock_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">)</span> <span class="o">|</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// net.h</span>
<span class="k">struct</span> <span class="n">socket</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span> <span class="c1">// åè®®æ“ä½œæŒ‡é’ˆã€‚</span>
    <span class="k">struct</span> <span class="n">socket_wq</span> <span class="n">wq</span><span class="p">;</span>  <span class="c1">// socket ç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹ã€‚</span>
<span class="p">};</span>

<span class="c1">// net.h</span>
<span class="k">struct</span> <span class="n">socket_wq</span> <span class="p">{</span>
    <span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">____cacheline_aligned_in_smp</span><span class="p">;</span>

<span class="c1">// åˆå§‹åŒ– socket.opsï¼ŒæŒ‡å‘ &amp;inet_stream_ops</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">inet_protosw</span> <span class="n">inetsw_array</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span>
        <span class="p">.</span><span class="n">type</span> <span class="o">=</span>       <span class="n">SOCK_STREAM</span><span class="p">,</span>
        <span class="p">.</span><span class="n">protocol</span> <span class="o">=</span>   <span class="n">IPPROTO_TCP</span><span class="p">,</span>
        <span class="p">.</span><span class="n">prot</span> <span class="o">=</span>       <span class="o">&amp;</span><span class="n">tcp_prot</span><span class="p">,</span>
        <span class="p">.</span><span class="n">ops</span> <span class="o">=</span>        <span class="o">&amp;</span><span class="n">inet_stream_ops</span><span class="p">,</span> <span class="c1">// tcp æ•°æ®æµæ“ä½œã€‚</span>
        <span class="p">.</span><span class="n">flags</span> <span class="o">=</span>      <span class="n">INET_PROTOSW_PERMANENT</span> <span class="o">|</span> <span class="n">INET_PROTOSW_ICSK</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// af_inet.c</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">proto_ops</span> <span class="n">inet_stream_ops</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="p">.</span><span class="n">poll</span>          <span class="o">=</span> <span class="n">tcp_poll</span><span class="p">,</span> <span class="c1">// å°±ç»ªäº‹ä»¶å¤„ç†å‡½æ•°ã€‚</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="c1">// tcp.c</span>
<span class="n">__poll_t</span> <span class="nf">tcp_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__poll_t</span> <span class="n">mask</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">sk</span><span class="p">;</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">tcp_sock</span> <span class="o">*</span><span class="n">tp</span> <span class="o">=</span> <span class="n">tcp_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

    <span class="n">sock_poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

    <span class="c1">// æ£€æŸ¥ socket è¯»å†™äº‹ä»¶ã€‚</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">inet_sk_state_load</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">TCP_LISTEN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inet_csk_listen_poll</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// sock.h</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">sock_poll_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">poll_does_not_wait</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">poll_wait</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">.</span><span class="n">wait</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// poll.h</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">poll_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span> <span class="n">filp</span><span class="p">,</span> <span class="n">wait_queue_head_t</span> <span class="o">*</span> <span class="n">wait_address</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">_qproc</span> <span class="o">&amp;&amp;</span> <span class="n">wait_address</span><span class="p">)</span>
        <span class="c1">// ep_ptable_queue_proc å¢åŠ ç­‰å¾…é˜Ÿåˆ—å¹¶å°† socket ä¸ ep_poll_callback å›è°ƒå»ºç«‹è”ç³»ã€‚</span>
        <span class="n">p</span><span class="o">-&gt;</span><span class="n">_qproc</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">wait_address</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="54-ep_poll_callback">5.4. ep_poll_callback</h3>

<p>ç½‘å¡è¯»å†™æ•°æ®ï¼Œé©±åŠ¨é€šçŸ¥å†…æ ¸ï¼Œå†…æ ¸è§¦å‘ ep_poll_callbackã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// net.h</span>
<span class="k">struct</span> <span class="n">socket</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">socket_wq</span> <span class="n">wq</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sock</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">union</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">socket_wq</span> <span class="n">__rcu</span>  <span class="o">*</span><span class="n">sk_wq</span><span class="p">;</span> <span class="c1">// æŒ‡é’ˆæŒ‡å‘ socket çš„ç­‰å¾…é˜Ÿåˆ—ã€‚</span>
        <span class="p">...</span>
    <span class="p">};</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// é©±åŠ¨ä¸­æ–­å›è°ƒï¼Œå”¤é†’ç­‰å¾…é˜Ÿåˆ—å¤„ç†ï¼šep_poll_callback</span>
<span class="c1">// sock.c</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sock_def_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">socket_wq</span> <span class="o">*</span><span class="n">wq</span><span class="p">;</span>

    <span class="n">rcu_read_lock</span><span class="p">();</span>
    <span class="n">wq</span> <span class="o">=</span> <span class="n">rcu_dereference</span><span class="p">(</span><span class="n">sk</span><span class="o">-&gt;</span><span class="n">sk_wq</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">skwq_has_sleeper</span><span class="p">(</span><span class="n">wq</span><span class="p">))</span>
        <span class="c1">// å”¤é†’ç­‰å¾…é˜Ÿåˆ—ã€‚</span>
        <span class="n">wake_up_interruptible_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wq</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
    <span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// wait.h</span>
<span class="cp">#define wake_up(x)      __wake_up(x, TASK_NORMAL, 1, NULL)
#define wake_up_interruptible_all(x)    __wake_up(x, TASK_INTERRUPTIBLE, 0, NULL)
</span>
<span class="c1">// wait.c</span>
<span class="kt">void</span> <span class="nf">__wake_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">wait_queue_head</span> <span class="o">*</span><span class="n">wq_head</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nr_exclusive</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">__wake_up_common_lock</span><span class="p">(</span><span class="n">wq_head</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">nr_exclusive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// wait.c</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__wake_up_common_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">wait_queue_head</span> <span class="o">*</span><span class="n">wq_head</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">nr_exclusive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wake_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">do</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">nr_exclusive</span> <span class="o">=</span> <span class="n">__wake_up_common</span><span class="p">(</span><span class="n">wq_head</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">nr_exclusive</span><span class="p">,</span>
                        <span class="n">wake_flags</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bookmark</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bookmark</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WQ_FLAG_BOOKMARK</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// wait.c</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__wake_up_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">wait_queue_head</span> <span class="o">*</span><span class="n">wq_head</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
            <span class="kt">int</span> <span class="n">nr_exclusive</span><span class="p">,</span> <span class="kt">int</span> <span class="n">wake_flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
            <span class="n">wait_queue_entry_t</span> <span class="o">*</span><span class="n">bookmark</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">wait_queue_entry_t</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="c1">// å¾ªç¯å¤„ç†ç­‰å¾…é˜Ÿåˆ—ç»“ç‚¹ï¼Œå›è°ƒ ep_poll_callback</span>
    <span class="n">list_for_each_entry_safe_from</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wq_head</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="c1">// ep_poll_callback</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">curr</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">wake_flags</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="6-å‚è€ƒ">6. å‚è€ƒ</h2>

<ul>
  <li><a href="https://vcpu.me/socket%E4%BF%A1%E5%8F%B7%E5%A4%84%E7%90%86/">socketä¿¡å·å¤„ç†</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/2020/04/22/epoll_code-prepare/">wenfh2020.com</a></p>
</blockquote>
:ET