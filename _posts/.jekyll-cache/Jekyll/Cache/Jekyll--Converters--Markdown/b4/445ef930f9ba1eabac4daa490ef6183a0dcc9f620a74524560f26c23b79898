I"Œ!<p>è®²çœŸï¼Œè¦æ·±å…¥ç†è§£ printfï¼Œåªèƒ½è‡ªå·±çœ‹æºç ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-ä»ç°è±¡åˆ°æœ¬è´¨" id="markdown-toc-1-ä»ç°è±¡åˆ°æœ¬è´¨">1. ä»ç°è±¡åˆ°æœ¬è´¨</a></li>
  <li><a href="#2-æ€»ç»“" id="markdown-toc-2-æ€»ç»“">2. æ€»ç»“</a></li>
</ul>

<hr />

<h2 id="1-ä»ç°è±¡åˆ°æœ¬è´¨">1. ä»ç°è±¡åˆ°æœ¬è´¨</h2>

<p>å‰äº›æ—¶é—´ï¼Œæœ‹å‹é—®äº†ä¸€ä¸ªé—®é¢˜ï¼š</p>

<p><code class="highlighter-rouge">printf</code> çš„ <code class="highlighter-rouge">%s</code> æ ¼å¼è¾“å‡ºï¼Œå¦‚æœå‚æ•°æ˜¯å…¶å®ƒç±»å‹çš„æ•°æ®å¼ºåˆ¶è½¬æ¢ä¸º <code class="highlighter-rouge">char*</code> çš„ï¼Œç»“æœä¼šæ€ä¹ˆæ ·ï¼Ÿ</p>

<p>æˆ‘æƒ³æœ€å¥½çš„æ–¹æ³•è«è¿‡äºé©¬ä¸ŠåŠ¨æ‰‹æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹ç»“æœã€‚å¦‚æœå†é—®ï¼šprintf æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿâ€¦ é—®é¢˜å¾ˆå¤šï¼Œè¿™äº›éƒ½åªæ˜¯é—®é¢˜çš„è¡¨è±¡ï¼Œè¦ä»ç°è±¡çœ‹æœ¬è´¨ã€‚Linux æ˜¯å¼€æºçš„ï¼Œä½•ä¸çœ‹æºç ç†è§£ç¨‹åºå·¥ä½œåŸç†å‘¢ï¼Ÿ</p>

<hr />

<p>ä»æºç ä¸Šçœ‹ <code class="highlighter-rouge">strnlen</code> æ˜¯é€šè¿‡æŸ¥æ‰¾å†…å­˜çš„ â€˜\0â€™ å­—ç¬¦ä¸²ç»“æŸç¬¦çš„ã€‚å¦‚æœå¼ºåˆ¶è½¬æ¢çš„å†…å­˜æ•°æ®ï¼Œæ²¡æœ‰ â€˜\0â€™ ç»“æŸç¬¦ï¼Œé‚£ <code class="highlighter-rouge">strnlen</code> å°±ä¼šå‡ºç°é—®é¢˜ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* https://github.com/torvalds/linux/blob/master/arch/x86/boot/printf.c */</span>

<span class="kt">int</span> <span class="nf">printf</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="n">printf_buf</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
    <span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">printed</span><span class="p">;</span>

    <span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
    <span class="n">printed</span> <span class="o">=</span> <span class="n">vsprintf</span><span class="p">(</span><span class="n">printf_buf</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>

    <span class="n">puts</span><span class="p">(</span><span class="n">printf_buf</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">printed</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">vsprintf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">va_list</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="k">case</span> <span class="sc">'s'</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
            <span class="n">len</span> <span class="o">=</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">precision</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">LEFT</span><span class="p">))</span>
                <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">field_width</span><span class="o">--</span><span class="p">)</span>
                    <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
                <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span><span class="p">;</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">field_width</span><span class="o">--</span><span class="p">)</span>
                <span class="o">*</span><span class="n">str</span><span class="o">++</span> <span class="o">=</span> <span class="sc">' '</span><span class="p">;</span>
            <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="cm">/* https://github.com/torvalds/linux/blob/master/arch/x86/boot/string.c */</span>

<span class="kt">size_t</span> <span class="nf">strnlen</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">es</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">es</span> <span class="o">&amp;&amp;</span> <span class="n">maxlen</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">es</span><span class="o">++</span><span class="p">;</span>
        <span class="n">maxlen</span><span class="o">--</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">es</span> <span class="o">-</span> <span class="n">s</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="2-æ€»ç»“">2. æ€»ç»“</h2>

<p>ä¸åª <code class="highlighter-rouge">printf</code> çš„å®ç°ï¼Œå¾ˆå¤šåŸºç¡€å‡½æ•°ï¼Œéƒ½èƒ½ä» linux æºç ä¸­æŸ¥çœ‹ã€‚å¯ä»¥ä» <a href="https://github.com/torvalds/linux">github</a> ä¸‹è½½ä¸€ä»½æºç ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚ä¸‹è½½ä¸ª zip æ–‡ä»¶åŒ…å§ï¼Œgit æ–‡ä»¶æœ‰ç‚¹å¤ªå¤§äº†ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* https://github.com/torvalds/linux/blob/master/lib/string.c */</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">strcpy</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="n">dest</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">'\0'</span><span class="p">)</span>
        <span class="cm">/* nothing */</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET