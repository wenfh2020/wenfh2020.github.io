I"T<p>æœ¬ç« é‡ç‚¹èµ°è¯» redis ç½‘ç»œ I/O çš„<strong>å¤šçº¿ç¨‹</strong>éƒ¨åˆ†æºç ã€‚</p>

<p>å“ˆå¸Œè¡¨ + å†…å­˜æ•°æ®åº“ + éé˜»å¡ç³»ç»Ÿè°ƒç”¨ + å¤šè·¯å¤ç”¨ I/O äº‹ä»¶é©±åŠ¨ï¼Œä½¿å¾— redis å•çº¿ç¨‹å¤„ç†ä¸»é€»è¾‘è¶³å¤Ÿé«˜æ•ˆã€‚å½“å¹¶å‘ä¸Šæ¥åï¼Œæ•°æ®çš„é€»è¾‘å¤„ç†è‚¯å®šè¦å ç”¨å¤§é‡æ—¶é—´ï¼Œé‚£æ ·ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯é€šä¿¡å¤„ç†å°±ä¼šå˜å¾—è¿Ÿé’ã€‚æ‰€ä»¥åœ¨åˆé€‚çš„æ—¶å€™ï¼ˆæ ¹æ®ä»»åŠ¡é‡è‡ªé€‚åº”ï¼‰é‡‡ç”¨å¤šçº¿ç¨‹å¤„ç†ï¼Œå……åˆ†åœ°åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ï¼Œåˆ†æ‹…ä¸»çº¿ç¨‹å‹åŠ›ï¼Œä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡æ›´åŠ æ•æ·ã€‚</p>

<hr />

<p>redis 6.0 æ–°å¢å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œ I/Oï¼Œé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦ä¿®æ”¹é…ç½®å¼€å¯ã€‚å¯¹äºè¿™ä¸ªæ–°ç‰¹æ€§ï¼Œredis ä½œè€…å»ºè®®ï¼šå¦‚æœé¡¹ç›®ç¡®å®é‡åˆ°æ€§èƒ½é—®é¢˜ï¼Œå†å¼€å¯å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œè¯»å†™äº‹ä»¶ã€‚å¦åˆ™å¼€å¯æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œè¿˜ä¼šæµªè´¹ CPU èµ„æºã€‚çº¿ç¨‹æ•°é‡ä¸è¦è¶…è¿‡ cpu æ ¸å¿ƒæ•°é‡ - 1ï¼Œé¢„ç•™ä¸€ä¸ªæ ¸å¿ƒã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-é…ç½®" id="markdown-toc-1-é…ç½®">1. é…ç½®</a></li>
  <li><a href="#2-ä¸»çº¿ç¨‹å·¥ä½œæµç¨‹" id="markdown-toc-2-ä¸»çº¿ç¨‹å·¥ä½œæµç¨‹">2. ä¸»çº¿ç¨‹å·¥ä½œæµç¨‹</a></li>
  <li><a href="#3-å¤šçº¿ç¨‹åä½œ" id="markdown-toc-3-å¤šçº¿ç¨‹åä½œ">3. å¤šçº¿ç¨‹åä½œ</a>    <ul>
      <li><a href="#31-ç‰¹ç‚¹" id="markdown-toc-31-ç‰¹ç‚¹">3.1. ç‰¹ç‚¹</a></li>
      <li><a href="#32-å¿™ç­‰" id="markdown-toc-32-å¿™ç­‰">3.2. å¿™ç­‰</a>        <ul>
          <li><a href="#321-æºç å®ç°" id="markdown-toc-321-æºç å®ç°">3.2.1. æºç å®ç°</a></li>
          <li><a href="#322-ä¼˜ç¼ºç‚¹" id="markdown-toc-322-ä¼˜ç¼ºç‚¹">3.2.2. ä¼˜ç¼ºç‚¹</a></li>
        </ul>
      </li>
      <li><a href="#33-æºç åˆ†æ" id="markdown-toc-33-æºç åˆ†æ">3.3. æºç åˆ†æ</a>        <ul>
          <li><a href="#331-æ¦‚è¿°" id="markdown-toc-331-æ¦‚è¿°">3.3.1. æ¦‚è¿°</a></li>
          <li><a href="#332-æºç " id="markdown-toc-332-æºç ">3.3.2. æºç </a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#4-æ•°æ®ç»“æ„" id="markdown-toc-4-æ•°æ®ç»“æ„">4. æ•°æ®ç»“æ„</a></li>
  <li><a href="#5-æµ‹è¯•" id="markdown-toc-5-æµ‹è¯•">5. æµ‹è¯•</a></li>
  <li><a href="#6-æ€»ç»“" id="markdown-toc-6-æ€»ç»“">6. æ€»ç»“</a></li>
  <li><a href="#7-å‚è€ƒ" id="markdown-toc-7-å‚è€ƒ">7. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-é…ç½®">1. é…ç½®</h2>

<p>å¤šçº¿ç¨‹è¿™ä¸¤ä¸ªè®¾ç½®é¡¹ï¼Œé»˜è®¤æ˜¯å…³é—­çš„ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

<span class="c"># é…ç½®å¤šçº¿ç¨‹å¤„ç†çº¿ç¨‹ä¸ªæ•°ï¼Œæ•°é‡æœ€å¥½å°‘äº cpu æ ¸å¿ƒï¼Œé»˜è®¤ 4ã€‚</span>
<span class="c"># io-threads 4</span>
<span class="c">#</span>
<span class="c"># å¤šçº¿ç¨‹æ˜¯å¦å¤„ç†è¯»äº‹ä»¶ï¼Œé»˜è®¤å…³é—­ã€‚</span>
<span class="c"># io-threads-do-reads no</span>
</code></pre></div></div>

<p>redis ä½œè€…å»ºè®®ï¼š</p>

<ul>
  <li>é…ç½®çº¿ç¨‹æ•°é‡ï¼Œæœ€å¥½å°‘äº cpu æ ¸å¿ƒã€‚èµ·ç é¢„ç•™ä¸€ä¸ªç©ºé—²æ ¸å¿ƒå¤„ç†ç³»ç»Ÿå…¶å®ƒä¸šåŠ¡ï¼Œçº¿ç¨‹æ•°é‡è¶…è¿‡ cpu æ ¸å¿ƒå¯¹ redis æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œå› ä¸º redis ä¸»çº¿ç¨‹å¤„ç†ä¸»é€»è¾‘ï¼Œå¦‚æœè¢«ç³»ç»Ÿé¢‘ç¹åˆ‡æ¢ï¼Œæ•ˆç‡ä¼šé™ä½ã€‚</li>
  <li>æä¾›äº†å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œè¯»äº‹ä»¶å¼€å…³ã€‚å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œè¯»äº‹ä»¶ï¼Œå¯¹ redis æ€§èƒ½å½±å“ä¸å¤§ã€‚redis ä½œä¸ºç¼“å­˜ï¼ŒæŸ¥è¯¢æ“ä½œçš„é¢‘ç‡æ¯”è¾ƒå¤§ï¼Œç³»ç»Ÿçš„ç½‘ç»œç“¶é¢ˆä¸€èˆ¬åœ¨æŸ¥è¯¢è¿”å›æ•°æ®ï¼Œæ ¹æ®ç³»ç»Ÿå®é™…åº”ç”¨åœºæ™¯è¿›è¡Œé…ç½®å§ã€‚</li>
</ul>

<hr />

<h2 id="2-ä¸»çº¿ç¨‹å·¥ä½œæµç¨‹">2. ä¸»çº¿ç¨‹å·¥ä½œæµç¨‹</h2>

<p><img src="/images/2020-05-03-12-47-36.png" alt="redis å¤šçº¿ç¨‹I/Oé€šä¿¡æµç¨‹" data-action="zoom" /></p>

<ol>
  <li>ä¸»çº¿ç¨‹é€šè¿‡äº‹ä»¶é©±åŠ¨ä»å†…æ ¸è·å–å°±ç»ªäº‹ä»¶ï¼Œè®°å½•ä¸‹éœ€è¦å»¶æ—¶æ“ä½œçš„å®¢æˆ·ç«¯è¿æ¥ã€‚</li>
  <li>å¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†å»¶æ—¶è¯»äº‹ä»¶ã€‚</li>
  <li>å¤šçº¿ç¨‹å¤„ç†å»¶æ—¶å†™äº‹ä»¶ã€‚</li>
  <li>é‡æ–°æ‰§è¡Œç¬¬ä¸€æ­¥ï¼Œå¾ªç¯æ‰§è¡Œã€‚</li>
</ol>

<hr />

<ul>
  <li>åŠ è½½å¾ªç¯äº‹ä»¶ç®¡ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="n">aeCreateEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxclients</span><span class="o">+</span><span class="n">CONFIG_FDSET_INCR</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">aeSetBeforeSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">beforeSleep</span><span class="p">);</span>
    <span class="n">aeSetAfterSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">afterSleep</span><span class="p">);</span>
    <span class="n">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="n">aeDeleteEventLoop</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>äº‹ä»¶å¾ªç¯ç®¡ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
        <span class="c1">// å‘å†…æ ¸è·å–å°±ç»ªçš„å¯è¯»å¯å†™äº‹ä»¶äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œå¤„ç†æ—¶é’Ÿäº‹ä»¶ã€‚</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è·å–å°±ç»ªäº‹ä»¶å¤„ç†å’Œå¤„ç†æ—¶é’Ÿäº‹ä»¶ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">aeProcessEvents</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// ä»å†…æ ¸ä¸­å–å‡ºå°±ç»ªçš„å¯è¯»å¯å†™äº‹ä»¶ã€‚</span>
    <span class="n">numevents</span> <span class="o">=</span> <span class="n">aeApiPoll</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">tvp</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">)</span>
        <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">aftersleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">numevents</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// å¤„ç†è¯»å†™äº‹ä»¶ã€‚</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// å¤„ç†æ—¶é’Ÿäº‹ä»¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">AE_TIME_EVENTS</span><span class="p">)</span>
        <span class="n">processed</span> <span class="o">+=</span> <span class="n">processTimeEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>è¯»å†™é€»è¾‘å¤„ç†ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">beforeSleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// write</span>
    <span class="n">handleClientsWithPendingWritesUsingThreads</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">afterSleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// read</span>
    <span class="n">handleClientsWithPendingReadsUsingThreads</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-å¤šçº¿ç¨‹åä½œ">3. å¤šçº¿ç¨‹åä½œ</h2>

<p><img src="/images/2020-05-03-12-47-36.png" alt="redis å¤šçº¿ç¨‹I/Oé€šä¿¡æµç¨‹" data-action="zoom" /></p>

<h3 id="31-ç‰¹ç‚¹">3.1. ç‰¹ç‚¹</h3>

<p>ä¸»çº¿ç¨‹å®ç°ä¸»é€»è¾‘ï¼Œå­çº¿ç¨‹è¾…åŠ©å®ç°ä»»åŠ¡ã€‚</p>

<ul>
  <li>redis ä¸»çº¿ç¨‹å®ç°ä¸»é€»è¾‘ã€‚</li>
  <li>ä¸»çº¿ç¨‹ä¸å­çº¿ç¨‹å…±åŒå¤„ç†å»¶æ—¶å®¢æˆ·ç«¯ç½‘ç»œè¯»å†™äº‹ä»¶ã€‚</li>
  <li>ä¸»çº¿ç¨‹æ ¹æ®å†™äº‹ä»¶ç”¨æˆ·é‡å¤§å°ï¼Œå¼€å¯/å…³é—­å¤šçº¿ç¨‹æ¨¡å¼ã€‚</li>
  <li>è™½ç„¶å¤šçº¿ç¨‹æ˜¯å¹¶è¡Œå¤„ç†é€»è¾‘ï¼Œä½†æ˜¯ redis æ•´ä½“å·¥ä½œæµç¨‹æ˜¯ä¸²è¡Œçš„ã€‚</li>
  <li>å½“ä¸»çº¿ç¨‹å¤„ç†å»¶æ—¶è¯»å†™äº‹ä»¶æ—¶ï¼ŒæŠŠä¸€æ¬¡å¤§ä»»åŠ¡è¿›è¡Œå–æ¨¡åˆ‡å‰²æˆå°ä»»åŠ¡ï¼Œå¹³å‡åˆ†é…ç»™ï¼ˆä¸»+å­ï¼‰çº¿ç¨‹å¤„ç†ã€‚è¿™æ ·æ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥è¢«ç‹¬ç«‹çš„ä¸€ä¸ªçº¿ç¨‹å¤„ç†ï¼Œä¸ä¼šå‡ºç°å¤šä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥é€»è¾‘ã€‚</li>
  <li>ä¸»çº¿ç¨‹é™åˆ¶å¤šçº¿ç¨‹å­çº¿ç¨‹åŒä¸€ä¸ªæ—¶é—´æ®µåªèƒ½å¹¶è¡Œå¤„ç†ä¸€ç§ç±»å‹æ“ä½œï¼šè¯»/å†™ã€‚</li>
  <li>ä¸»çº¿ç¨‹å…ˆç­‰å¾…å­çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡äº†ï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå¤„ç†åˆ†é…ç»™è‡ªå·±çš„ç­‰å¾…äº‹ä»¶ã€‚</li>
  <li>ä¸»çº¿ç¨‹åœ¨ç­‰å¾…å­çº¿ç¨‹å¤„ç†ä»»åŠ¡è¿‡ç¨‹ä¸­ï¼Œå®ƒä¸æ˜¯é€šè¿‡ <code class="highlighter-rouge">sleep</code> æŒ‚èµ·çº¿ç¨‹è®©å‡ºä½¿ç”¨æƒï¼Œè€Œæ˜¯é€šè¿‡ <code class="highlighter-rouge">for</code> å¾ªç¯è¿›è¡Œå¿™ç­‰ï¼Œä¸æ–­æ£€æµ‹æ‰€æœ‰å­çº¿ç¨‹å¤„ç†çš„ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆï¼Œå¦‚æœå®Œæˆå†è¿›è¡Œä¸‹ä¸€æ­¥ï¼Œå¤„ç†è‡ªå·±çš„ä»»åŠ¡ã€‚ç›¸å½“äºä¸»çº¿ç¨‹åœ¨ç­‰å¾…è¿‡ç¨‹ä¸­ï¼Œå¹¶æ²¡æœ‰åšå…¶å®ƒä»»åŠ¡ï¼Œåªæ˜¯è®©å¸®æ‰‹å»å¹²æ´»ï¼Œå¸®æ‰‹éƒ½æŠŠæ´»å¹²å®Œäº†ï¼Œå®ƒå†å¹²è‡ªå·±çš„ï¼Œç„¶ååšä¸€äº›å–„åå·¥ä½œã€‚ä¸»çº¿ç¨‹åœ¨è¿™é‡Œçš„è§’è‰²æœ‰ç‚¹åƒä»£ç†å•†æˆ–è€…åŒ…å·¥å¤´ã€‚</li>
  <li>å­çº¿ç¨‹åœ¨å®Œæˆåˆ†é…çš„ä»»åŠ¡åï¼Œä¹Ÿä¼šé€šè¿‡ <code class="highlighter-rouge">for</code> å¾ªç¯å¿™ç­‰ï¼Œæ£€æµ‹ä¸»çº¿ç¨‹çš„å·¥ä½œè°ƒåº¦ï¼Œå¦‚æœä»»åŠ¡å¾ˆå°‘äº†ï¼Œç­‰å¾…ä¸»çº¿ç¨‹é€šè¿‡é”ï¼ŒæŠŠè‡ªå·±æŒ‚èµ·ã€‚</li>
</ul>

<hr />

<h3 id="32-å¿™ç­‰">3.2. å¿™ç­‰</h3>

<p>å¤šçº¿ç¨‹æ¨¡å¼ï¼Œå­˜åœ¨å¿™ç­‰ç°è±¡ï¼Œè¿™ä¸ªå¤„ç†æœ‰ç‚¹è¶…å‡ºäº†å¸¸è§„æ€ç»´ã€‚</p>

<hr />

<h4 id="321-æºç å®ç°">3.2.1. æºç å®ç°</h4>

<ul>
  <li>ä¸»çº¿ç¨‹åˆ†é…å®Œä»»åŠ¡åï¼Œç­‰å¾…æ‰€æœ‰å­çº¿ç¨‹å®Œæˆä»»åŠ¡åï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// write</span>
<span class="kt">int</span> <span class="nf">handleClientsWithPendingWritesUsingThreads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pending</span> <span class="o">+=</span> <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// read</span>
<span class="kt">int</span> <span class="nf">handleClientsWithPendingReadsUsingThreads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pending</span> <span class="o">+=</span> <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å­çº¿ç¨‹å®Œæˆä»»åŠ¡åï¼Œä¿æŒç¹å¿™çŠ¶æ€ï¼Œç­‰å¾…ä¸»çº¿ç¨‹ä¸Šé”æŒ‚èµ·è‡ªå·±ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">IOThreadMain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">myid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
            <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h4 id="322-ä¼˜ç¼ºç‚¹">3.2.2. ä¼˜ç¼ºç‚¹</h4>

<ul>
  <li>
    <p>ä¼˜ç‚¹ï¼š</p>

    <ol>
      <li>å®ç°ç®€å•ï¼Œä¸»çº¿ç¨‹å¯ä»¥é€šè¿‡é”å¼€å¯/æš‚åœå¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼ï¼Œä¸éœ€è¦å¤æ‚çš„é€šä¿¡ã€‚</li>
      <li>redis è¯»å†™äº‹ä»¶å¤„ç†åŸºæœ¬éƒ½æ˜¯å†…å­˜çº§åˆ«æ“ä½œï¼Œè€Œä¸”éé˜»å¡ï¼Œå¤šçº¿ç¨‹å¤„ç†ä»»åŠ¡éå¸¸å¿«ã€‚</li>
      <li>ååº”å¿«ï¼Œæœ‰ä»»åŠ¡èƒ½å®æ—¶å¤„ç†ã€‚</li>
      <li>å®è§‚ä¸Šçœ‹ï¼Œä¸»çº¿ç¨‹æ˜¯ä¸²è¡Œå¤„ç†é€»è¾‘ï¼Œé€»è¾‘æ¸…æ™°ï¼šè¯»å†™é€»è¾‘é¡ºåºå¤„ç†ã€‚ä¸»çº¿ç¨‹æŠŠä¸€æ¬¡å¤§ä»»åŠ¡è¿›è¡Œå–æ¨¡åˆ‡å‰²æˆå°ä»»åŠ¡ï¼Œåˆ†é…ç»™å­çº¿ç¨‹å¤„ç†ã€‚ä¸»çº¿ç¨‹ç­‰å­çº¿ç¨‹å®Œæˆæ‰€æœ‰ä»»åŠ¡åï¼Œå†å®Œæˆè‡ªå·±çš„ä»»åŠ¡ï¼Œå†è¿›è¡Œä¸‹ä¸€æ­¥ã€‚</li>
      <li>å› ä¸ºå¤šçº¿ç¨‹å¤„ç†çš„æ˜¯å®¢æˆ·ç«¯é“¾æ¥çš„å»¶æ—¶è¯»å†™é€»è¾‘ï¼Œredis æœåŠ¡åº”ç”¨åœºæ™¯ä½œä¸ºç¼“å­˜ï¼Œæ¥å…¥å¯¹è±¡ä¸€èˆ¬æ˜¯æœåŠ¡ç«¯çº§åˆ«ï¼Œè€Œä¸æ˜¯é¢å‘æ™®é€šç”¨æˆ·çš„å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥é“¾æ¥ä¸ä¼šå¤ªå¤šã€‚è€Œç­‰å¾…çš„è¯»å†™é“¾æ¥é€šè¿‡å–æ¨¡åˆ†æ•£åˆ°ä¸åŒçš„çº¿ç¨‹å»å¤„ç†ï¼Œé‚£æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„é“¾æ¥å°±ä¼šç›¸å¯¹è¾ƒå°‘ã€‚æ¯ä¸ªçº¿ç¨‹å¤„ç†ä»»åŠ¡ä¹Ÿå¾ˆå¿«ã€‚</li>
    </ol>
  </li>
  <li>
    <p>ç¼ºç‚¹ï¼š</p>

    <p>å¿™ç­‰æœ€å¤§çš„é—®é¢˜æ˜¯ä»¥æµªè´¹ä¸€å®š cpu æ€§èƒ½ä¸ºä»£ä»·ï¼Œå¦‚æœ redis é“¾æ¥å¹¶å‘é‡ä¸æ˜¯å¾ˆé«˜ï¼Œredis ä½œè€…ä¸å»ºè®®å¼€å¯å¤šçº¿ç¨‹æ¨¡å¼ï¼Œæ‰€ä»¥ä¸»é€»è¾‘ä¼šæ ¹æ®å†™äº‹ä»¶é“¾æ¥æ•°é‡å¤§å°æ¥å¼€å¯/æš‚åœå¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼ã€‚</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">stopThreadedIOIfNeeded</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">);</span>

    <span class="c1">// å¦‚æœå•çº¿ç¨‹æ¨¡å¼å°±ç›´æ¥è¿”å›ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_active</span><span class="p">)</span> <span class="n">stopThreadedIO</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="33-æºç åˆ†æ">3.3. æºç åˆ†æ</h3>

<h4 id="331-æ¦‚è¿°">3.3.1. æ¦‚è¿°</h4>

<ul>
  <li>
    <p>ç½‘ç»œè¯»å†™æ ¸å¿ƒæ¥å£ï¼š</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">æ¥å£</th>
          <th style="text-align: left">æè¿°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left">readQueryFromClient</td>
          <td style="text-align: left">æœåŠ¡è¯»å®¢æˆ·ç«¯æ•°æ®ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">writeToClient</td>
          <td style="text-align: left">æœåŠ¡å‘å®¢æˆ·ç«¯å†™æ•°æ®ã€‚</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>å¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼æ ¸å¿ƒæ¥å£(<code class="highlighter-rouge">networking.c</code>)ï¼Œå…¶å®ƒå»¶æ—¶å¤„ç†é€»è¾‘ä¹Ÿæœ‰ä¸€éƒ¨åˆ†æºç ã€‚</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">æ¥å£</th>
          <th style="text-align: left">æè¿°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left">IOThreadMain</td>
          <td style="text-align: left">å­çº¿ç¨‹å¤„ç†é€»è¾‘ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">initThreadedIO</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹åˆ›å»ºæŒ‚èµ·å­çº¿ç¨‹ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">startThreadedIO</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹å¼€å¯å¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">stopThreadedIO</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹æš‚åœå¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">stopThreadedIOIfNeeded</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹æ ¹æ®å†™å¹¶å‘é‡æ˜¯å¦å…³é—­å¤šçº¿ç¨‹å·¥ä½œæ¨¡å¼ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">handleClientsWithPendingWritesUsingThreads</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹å¤šçº¿ç¨‹å¤„ç†å»¶æ—¶å†™äº‹ä»¶ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">handleClientsWithPendingReadsUsingThreads</td>
          <td style="text-align: left">ä¸»çº¿ç¨‹å¤šçº¿ç¨‹å¤„ç†å»¶æ—¶è¯»äº‹ä»¶ã€‚</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <p>å…¶å®ƒå»¶æ—¶å¤„ç†é€»è¾‘ï¼Œçœ‹çœ‹ä¸‹é¢è¿™äº›å˜é‡å’Œå®åœ¨ä»£ç ä¸­çš„é€»è¾‘ï¼Œè¿™é‡Œä¸ä¼šè¯¦ç»†å±•å¼€ã€‚</p>

    <table>
      <thead>
        <tr>
          <th style="text-align: left">å˜é‡/å®</th>
          <th style="text-align: left">æè¿°</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="text-align: left">server.clients_pending_read</td>
          <td style="text-align: left">å»¶æ—¶å¤„ç†è¯»äº‹ä»¶çš„å®¢æˆ·ç«¯è¿æ¥é“¾è¡¨ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">server.clients_pending_write</td>
          <td style="text-align: left">å»¶æ—¶å¤„ç†å†™äº‹ä»¶çš„å®¢æˆ·ç«¯è¿æ¥é“¾è¡¨ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">CLIENT_PENDING_READ</td>
          <td style="text-align: left">å»¶æ—¶å¤„ç†è¯»äº‹ä»¶æ ‡è¯†ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">CLIENT_PENDING_WRITE</td>
          <td style="text-align: left">å»¶æ—¶å¤„ç†å†™äº‹ä»¶æ ‡è¯†ã€‚</td>
        </tr>
        <tr>
          <td style="text-align: left">CLIENT_PENDING_COMMAND</td>
          <td style="text-align: left">å»¶æ—¶å¤„ç†å‘½ä»¤é€»è¾‘æ ‡è¯†ã€‚</td>
        </tr>
      </tbody>
    </table>
  </li>
</ul>

<hr />

<h4 id="332-æºç ">3.3.2. æºç </h4>

<ul>
  <li>
    <p>å˜é‡/å®</p>

    <p><code class="highlighter-rouge">io_threads_mutex</code> äº’æ–¥å˜é‡æ•°ç»„ï¼Œä¸ºäº†æ–¹ä¾¿ä¸»çº¿ç¨‹å”¤é†’/æŒ‚èµ·æ§åˆ¶å­çº¿ç¨‹ã€‚
<code class="highlighter-rouge">io_threads_pending</code> åŸå­å˜é‡ï¼Œæ–¹ä¾¿ä¸»çº¿ç¨‹ç»Ÿè®¡å­çº¿ç¨‹æ˜¯å¦å·²ç»å¤„ç†å®Œæ‰€æœ‰ä»»åŠ¡ã€‚</p>
  </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// æœ€å¤§çº¿ç¨‹ä¸ªæ•°ã€‚</span>
<span class="cp">#define IO_THREADS_MAX_NUM 128
</span>
<span class="c1">// çº¿ç¨‹è¯»æ“ä½œã€‚</span>
<span class="cp">#define IO_THREADS_OP_READ 0
</span>
<span class="c1">// çº¿ç¨‹å†™æ“ä½œã€‚</span>
<span class="cp">#define IO_THREADS_OP_WRITE 1
</span>
<span class="c1">// çº¿ç¨‹æ•°ç»„ã€‚</span>
<span class="n">pthread_t</span> <span class="n">io_threads</span><span class="p">[</span><span class="n">IO_THREADS_MAX_NUM</span><span class="p">];</span>

<span class="c1">// äº’æ–¥å˜é‡æ•°ç»„ï¼Œæä¾›ä¸»çº¿ç¨‹ä¸Šé”å’Œè§£é”å­çº¿ç¨‹å·¥ä½œã€‚</span>
<span class="n">pthread_mutex_t</span> <span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">IO_THREADS_MAX_NUM</span><span class="p">];</span>

<span class="c1">// åŸå­å˜é‡æ•°ç»„ï¼Œåˆ†åˆ«å­˜å‚¨æ¯ä¸ªçº¿ç¨‹è¦å¤„ç†çš„å»¶æ—¶å¤„ç†é“¾æ¥æ•°é‡ã€‚ä¸»çº¿ç¨‹ç”¨æ¥ç»Ÿè®¡çº¿ç¨‹æ˜¯å¦å¤„ç†å®Œç­‰å¾…äº‹ä»¶ï¼Œä»è€Œè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œã€‚</span>
<span class="k">_Atomic</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">IO_THREADS_MAX_NUM</span><span class="p">];</span>

<span class="c1">// æ˜¯å¦å¯åŠ¨äº†å¤šçº¿ç¨‹å¤„ç†æ¨¡å¼ã€‚</span>
<span class="kt">int</span> <span class="n">io_threads_active</span><span class="p">;</span>

<span class="c1">// çº¿ç¨‹æ“ä½œç±»å‹ã€‚å¤šçº¿ç¨‹æ¯æ¬¡åªèƒ½å¤„ç†ä¸€ç§ç±»å‹çš„æ“ä½œï¼šè¯»/å†™ã€‚</span>
<span class="kt">int</span> <span class="n">io_threads_op</span><span class="p">;</span>

<span class="c1">// å­çº¿ç¨‹åˆ—è¡¨ï¼Œå­çº¿ç¨‹ä¸ªæ•°ä¸º IO_THREADS_MAX_NUM - 1ï¼Œå› ä¸ºä¸»çº¿ç¨‹ä¹Ÿä¼šå¤„ç†å»¶æ—¶ä»»åŠ¡ã€‚</span>
<span class="n">list</span> <span class="o">*</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">IO_THREADS_MAX_NUM</span><span class="p">];</span>
</code></pre></div></div>

<hr />

<ul>
  <li>ä¸»çº¿ç¨‹åˆ›å»ºå­çº¿ç¨‹</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">initThreadedIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">io_threads_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* We start with threads not active. */</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="c1">// æ£€æŸ¥é…ç½®çš„çº¿ç¨‹æ•°é‡æ˜¯å¦è¶…å‡ºé™åˆ¶ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span> <span class="o">&gt;</span> <span class="n">IO_THREADS_MAX_NUM</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Fatal: too many I/O threads configured. "</span>
                             <span class="s">"The maximum number is %d."</span><span class="p">,</span> <span class="n">IO_THREADS_MAX_NUM</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// åˆ›å»º server.io_threads_num - 1 ä¸ªå­çº¿ç¨‹ã€‚</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">io_threads_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">listCreate</span><span class="p">();</span>

        <span class="c1">// 0 å·çº¿ç¨‹ä¸åˆ›å»ºï¼Œ0 å·å°±æ˜¯ä¸»çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹ä¹Ÿä¼šå¤„ç†ä»»åŠ¡é€»è¾‘ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// åˆ›å»ºå­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹å…ˆå¯¹å­çº¿ç¨‹ä¸Šé”ï¼ŒæŒ‚èµ·å­çº¿ç¨‹ï¼Œä¸è®©å­çº¿ç¨‹è¿›å…¥å·¥ä½œæ¨¡å¼ã€‚</span>
        <span class="n">pthread_t</span> <span class="n">tid</span><span class="p">;</span>
        <span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tid</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="n">IOThreadMain</span><span class="p">,(</span><span class="kt">void</span><span class="o">*</span><span class="p">)(</span><span class="kt">long</span><span class="p">)</span><span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"Fatal: Can't initialize IO thread."</span><span class="p">);</span>
            <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">io_threads</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tid</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å¼€å¯å¤šçº¿ç¨‹æ¨¡å¼</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">startThreadedIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">serverAssert</span><span class="p">(</span><span class="n">io_threads_active</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="c1">// å­çº¿ç¨‹å› ä¸ºä¸Šé”ç­‰å¾…ä¸»çº¿ç¨‹è§£é”ï¼Œå½“ä¸»çº¿ç¨‹è§£é”å­çº¿ç¨‹ï¼Œå­çº¿ç¨‹é‡æ–°è¿›å…¥å·¥ä½œçŠ¶æ€ã€‚</span>
        <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="n">io_threads_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å­çº¿ç¨‹é€»è¾‘å¤„ç†</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="o">*</span><span class="nf">IOThreadMain</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">myid</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// æ¯ä¸ªçº¿ç¨‹åœ¨åˆ›å»ºçš„æ—¶å€™ä¼šäº§ç”Ÿä¸€ä¸ªä¸šåŠ¡ idã€‚</span>
    <span class="kt">long</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">myid</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// æ›¿ä»£ sleepï¼Œç”¨å¿™ç­‰ï¼Œè¿™æ ·èƒ½å®æ—¶å¤„ç†ä¸šåŠ¡ã€‚ä½†æ˜¯ä¹Ÿä»˜å‡ºäº†è€—è´¹ cpu çš„ä»£ä»·ã€‚</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">1000000</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// ç•™æœºä¼šç»™ä¸»çº¿ç¨‹ä¸Šé”ï¼ŒæŒ‚èµ·å½“å‰å­çº¿ç¨‹ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
            <span class="n">pthread_mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">serverAssert</span><span class="p">(</span><span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

        <span class="c1">// æ ¹æ®æ“ä½œç±»å‹ï¼Œå¤„ç†å¯¹åº”çš„è¯»/å†™é€»è¾‘ã€‚</span>
        <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
        <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="n">listRewind</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">id</span><span class="p">],</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_WRITE</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">writeToClient</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_op</span> <span class="o">==</span> <span class="n">IO_THREADS_OP_READ</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">readQueryFromClient</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">serverPanic</span><span class="p">(</span><span class="s">"io_threads_op value is unknown"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">listEmpty</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
        <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æ˜¯å¦éœ€è¦åœæ­¢å¤šçº¿ç¨‹æ¨¡å¼</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">stopThreadedIOIfNeeded</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">pending</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">);</span>

    <span class="c1">// å¦‚æœå•çº¿ç¨‹æ¨¡å¼å°±ç›´æ¥è¿”å›ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">io_threads_active</span><span class="p">)</span> <span class="n">stopThreadedIO</span><span class="p">();</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æš‚åœå¤šçº¿ç¨‹å¤„ç†æ¨¡å¼</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">stopThreadedIO</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// åœ¨åœæ­¢çº¿ç¨‹å‰ï¼Œä»ç„¶æœ‰ç­‰å¾…å¤„ç†çš„å»¶æ—¶è¯»æ•°æ®å¤„ç†ï¼Œéœ€è¦å…ˆå¤„ç†å†åœæ­¢çº¿ç¨‹ã€‚</span>
    <span class="n">handleClientsWithPendingReadsUsingThreads</span><span class="p">();</span>

    <span class="n">serverAssert</span><span class="p">(</span><span class="n">io_threads_active</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

    <span class="c1">// ä¸»ç»™å­çº¿ç¨‹ä¸Šé”ï¼ŒæŒ‚èµ·å­çº¿ç¨‹ã€‚</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">io_threads_mutex</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
    <span class="n">io_threads_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å¤„ç†å»¶æ—¶çš„è¯»äº‹ä»¶</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">handleClientsWithPendingReadsUsingThreads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_threads_active</span> <span class="o">||</span> <span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">io_threads_do_reads</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_read</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">processed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// å°†ç­‰å¾…å¤„ç†çš„é“¾æ¥ï¼Œé€šè¿‡å–æ¨¡æ”¾è¿›ä¸åŒçš„é˜Ÿåˆ—ä¸­å»ã€‚</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_read</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">item_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
        <span class="kt">int</span> <span class="n">target_id</span> <span class="o">=</span> <span class="n">item_id</span> <span class="o">%</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span>
        <span class="n">listAddNodeTail</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">target_id</span><span class="p">],</span><span class="n">c</span><span class="p">);</span>
        <span class="n">item_id</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// åˆ†åˆ«ç»Ÿè®¡æ¯ä¸ªé˜Ÿåˆ—è¦å¤„ç†é“¾æ¥çš„ä¸ªæ•°ã€‚</span>
    <span class="n">io_threads_op</span> <span class="o">=</span> <span class="n">IO_THREADS_OP_READ</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¸»çº¿ç¨‹å¤„ç†ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ã€‚</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
        <span class="c1">// è¯»å®¢æˆ·ç«¯å‘é€çš„æ•°æ®åˆ°ç¼“å­˜ã€‚</span>
        <span class="n">readQueryFromClient</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">listEmpty</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="c1">// ä¸»çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡åï¼Œå¿™ç­‰å…¶å®ƒçº¿ç¨‹ï¼Œå…¨éƒ¨çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡åï¼Œå†å¤„ç†å‘½ä»¤å®ç°é€»è¾‘ã€‚</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pending</span> <span class="o">+=</span> <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* ä¸»çº¿ç¨‹å¤„ç†å‘½ä»¤é€»è¾‘ï¼Œå› ä¸ºé“¾æ¥éƒ½æ ‡è¯†äº†ç­‰å¾…çŠ¶æ€ï¼Œè¯»å®Œæ•°æ®åå‘½ä»¤å¯¹åº”çš„ä¸šåŠ¡é€»è¾‘è¿˜æ²¡æœ‰è¢«å¤„ç†ã€‚
     * è¿™é‡Œå»æ‰ç­‰å¾…æ ‡è¯†ï¼Œå¤„ç†å‘½ä»¤ä¸šåŠ¡é€»è¾‘ã€‚*/</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_read</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLIENT_PENDING_READ</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span> <span class="n">CLIENT_PENDING_COMMAND</span><span class="p">;</span>
            <span class="c1">// è¯»å–æ•°æ®ï¼Œè§£æåè®®å–å‡ºå‘½ä»¤å‚æ•°ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œå¡«å……å›å¤ç¼“å†²åŒºã€‚</span>
            <span class="n">processCommandAndResetClient</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// ç»§ç»­è§£æåè®®ï¼Œå–å‡ºå‘½ä»¤å‚æ•°ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œå¡«å……å›å¤ç¼“å†²åŒºã€‚</span>
        <span class="n">processInputBufferAndReplicate</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">listEmpty</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_read</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>å¤„ç†å»¶æ—¶çš„å†™äº‹ä»¶</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">handleClientsWithPendingWritesUsingThreads</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">processed</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">processed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// å¦‚æœå»¶æ—¶å†™äº‹ä»¶å¯¹åº”çš„ client é“¾æ¥å¾ˆå°‘ï¼Œå…³é—­å¤šçº¿ç¨‹æ¨¡å¼ï¼Œç”¨ä¸»çº¿ç¨‹å¤„ç†å¼‚æ­¥é€»è¾‘ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">stopThreadedIOIfNeeded</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// å¤„ç†å»¶æ—¶å†™äº‹ä»¶ã€‚</span>
        <span class="k">return</span> <span class="n">handleClientsWithPendingWrites</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">io_threads_active</span><span class="p">)</span> <span class="n">startThreadedIO</span><span class="p">();</span>

    <span class="c1">// å°†ç­‰å¾…å¤„ç†çš„é“¾æ¥ï¼Œé€šè¿‡å–æ¨¡æ”¾è¿›ä¸åŒçš„é˜Ÿåˆ—ä¸­å»ï¼Œå»æ‰å»¶è¿Ÿå†™æ ‡è¯†ã€‚</span>
    <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>
    <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">item_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CLIENT_PENDING_WRITE</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">target_id</span> <span class="o">=</span> <span class="n">item_id</span> <span class="o">%</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span>
        <span class="n">listAddNodeTail</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">target_id</span><span class="p">],</span><span class="n">c</span><span class="p">);</span>
        <span class="n">item_id</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// çº¿ç¨‹å¤„ç†å†™äº‹ä»¶ã€‚</span>
    <span class="n">io_threads_op</span> <span class="o">=</span> <span class="n">IO_THREADS_OP_WRITE</span><span class="p">;</span>

    <span class="c1">// åˆ†åˆ«ç»Ÿè®¡æ¯ä¸ªé˜Ÿåˆ—è¦å¤„ç†é“¾æ¥çš„ä¸ªæ•°ã€‚</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">listLength</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
        <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// ä¸»çº¿ç¨‹å¤„ç†ç¬¬ä¸€ä¸ªé˜Ÿåˆ—ã€‚</span>
    <span class="n">listRewind</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>
        <span class="c1">// å†™æ•°æ®ï¼Œå‘é€ç»™å›å¤ç»™å®¢æˆ·ç«¯ã€‚</span>
        <span class="n">writeToClient</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">listEmpty</span><span class="p">(</span><span class="n">io_threads_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

    <span class="c1">// ä¸»çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡åï¼Œå¿™ç­‰å…¶å®ƒçº¿ç¨‹ï¼Œå…¨éƒ¨çº¿ç¨‹å¤„ç†å®Œä»»åŠ¡åï¼Œå†å¤„ç†å‘½ä»¤å®ç°é€»è¾‘ã€‚</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">io_threads_num</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
            <span class="n">pending</span> <span class="o">+=</span> <span class="n">io_threads_pending</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
    <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
        <span class="n">client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">listNodeValue</span><span class="p">(</span><span class="n">ln</span><span class="p">);</span>

        <span class="c1">// å¦‚æœç¼“å­˜ä¸­è¿˜æœ‰æ²¡æœ‰å‘é€å®Œçš„æ•°æ®ï¼Œç»§ç»­å‘é€æˆ–è€…ä¸‹æ¬¡ç»§ç»­å‘ï¼Œå¦åˆ™ä»äº‹ä»¶é©±åŠ¨åˆ é™¤ fd æ³¨å†Œçš„å¯å†™äº‹ä»¶ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clientHasPendingReplies</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="o">&amp;&amp;</span> <span class="n">connSetWriteHandler</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">conn</span><span class="p">,</span> <span class="n">sendReplyToClient</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">freeClientAsync</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">listEmpty</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">clients_pending_write</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">processed</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-æ•°æ®ç»“æ„">4. æ•°æ®ç»“æ„</h2>

<p><code class="highlighter-rouge">redisServer</code> å’Œ <code class="highlighter-rouge">client</code> åˆ†åˆ« redis æ˜¯æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯çš„æ•°æ®ç»“æ„ï¼Œç†è§£ç»“æ„çš„æˆå‘˜ä½œç”¨æ˜¯èµ°è¯»æºç é€»è¾‘çš„å…³é”®ã€‚æœ‰å…´è¶£çš„æœ‹å‹ä¸‹ä¸ªæ–­ç‚¹è·‘ä¸‹é€»è¾‘ï¼Œç»†èŠ‚å°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚</p>

<blockquote>
  <p><a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a></p>
</blockquote>

<ul>
  <li>å®¢æˆ·ç«¯ç»“æ„</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// server.h</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">client</span> <span class="p">{</span>
    <span class="kt">uint64_t</span> <span class="n">id</span><span class="p">;</span>            <span class="cm">/* Client incremental unique ID. */</span>
    <span class="n">connection</span> <span class="o">*</span><span class="n">conn</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="n">sds</span> <span class="n">querybuf</span><span class="p">;</span>           <span class="cm">/* Buffer we use to accumulate client queries. */</span>
    <span class="kt">size_t</span> <span class="n">qb_pos</span><span class="p">;</span>          <span class="cm">/* The position we have read in querybuf. */</span>
    <span class="kt">int</span> <span class="n">argc</span><span class="p">;</span>               <span class="cm">/* Num of arguments of current command. */</span>
    <span class="n">robj</span> <span class="o">**</span><span class="n">argv</span><span class="p">;</span>            <span class="cm">/* Arguments of current command. */</span>
    <span class="k">struct</span> <span class="n">redisCommand</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="o">*</span><span class="n">lastcmd</span><span class="p">;</span>  <span class="cm">/* Last command executed. */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">reply</span><span class="p">;</span>            <span class="cm">/* List of reply objects to send to the client. */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">reply_bytes</span><span class="p">;</span> <span class="cm">/* Tot bytes of objects in reply list. */</span>
    <span class="p">...</span>
    <span class="cm">/* Response buffer */</span>
    <span class="kt">int</span> <span class="n">bufpos</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">PROTO_REPLY_CHUNK_BYTES</span><span class="p">];</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>æœåŠ¡ç«¯ç»“æ„</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients</span><span class="p">;</span>              <span class="cm">/* List of active clients */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_to_close</span><span class="p">;</span>     <span class="cm">/* Clients to close asynchronously */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_pending_write</span><span class="p">;</span> <span class="cm">/* There is to write or install handler. */</span>
    <span class="n">list</span> <span class="o">*</span><span class="n">clients_pending_read</span><span class="p">;</span>  <span class="cm">/* Client has pending read socket buffers. */</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="5-æµ‹è¯•">5. æµ‹è¯•</h2>

<p>8 æ ¸å¿ƒï¼Œ16G å†…å­˜ï¼Œ mac book æœ¬åœ°æµ‹è¯•ã€‚</p>

<p>redis æœåŠ¡é»˜è®¤å¼€ 4 çº¿ç¨‹ï¼Œå‹æµ‹å·¥å…·å¼€ 2 çº¿ç¨‹ã€‚æœ‰å‰©ä½™æ ¸å¿ƒå¤„ç†æœºå™¨çš„å…¶å®ƒä¸šåŠ¡ï¼Œè¿™æ ·ä¸å½±å“ redis å·¥ä½œã€‚</p>

<blockquote>
  <p>Linux ç³»ç»Ÿï¼Œå¦‚æœå®‰è£…ä¸äº† redis æœ€æ–°ç‰ˆæœ¬ï¼Œè¯·å‡çº§ç³»ç»Ÿ <code class="highlighter-rouge">gcc</code> ç‰ˆæœ¬ã€‚</p>
</blockquote>

<ul>
  <li>é…ç½®ï¼Œå¤šçº¿ç¨‹æ¨¡å¼æµ‹è¯•ï¼Œå¼€å¯è¯»å†™ä¸¤ä¸ªé€‰é¡¹ï¼›å•çº¿ç¨‹æ¨¡å¼æµ‹è¯•åˆ™ä¼šå…³é—­ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>

io-threads 4
io-threads-do-reads <span class="nb">yes</span>
</code></pre></div></div>

<ul>
  <li>å‹æµ‹å‘½ä»¤ï¼Œä¼šé’ˆå¯¹å®¢æˆ·ç«¯é“¾æ¥æ•°/æµ‹è¯•åŒ…ä½“å¤§å°è¿›è¡Œæµ‹è¯•ã€‚</li>
</ul>

<blockquote>
  <p>å‘½ä»¤é€»è¾‘å·²æ•´ç†æˆè„šæœ¬ï¼Œæ”¾åˆ° <a href="https://github.com/wenfh2020/shell/blob/master/redis/benchmark.sh">github</a>ï¼Œé¡ºæ‰‹å½•åˆ¶äº†æµ‹è¯•è§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1r5411t7QF/">å‹åŠ›æµ‹è¯• redis å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œ I/O</a>ã€‚</p>
</blockquote>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># å‹æµ‹å·¥å…·ä¼šæ¨¡æ‹Ÿå¤šä¸ªç»ˆç«¯ï¼Œé˜²æ­¢è¶…å‡ºé™åˆ¶ï¼Œè¢«åœæ­¢ã€‚</span>
<span class="nb">ulimit</span> <span class="nt">-n</span> 16384

<span class="c"># å¯ä»¥è®¾ç½®å¯¹åº”çš„é“¾æ¥æ•°/åŒ…ä½“å¤§å°è¿›è¡Œæµ‹è¯•ã€‚</span>
./redis-benchmark <span class="nt">-c</span> xxxx <span class="nt">-r</span> 1000000 <span class="nt">-n</span> 100000 <span class="nt">-t</span> <span class="nb">set</span>,get <span class="nt">-q</span> <span class="nt">--threads</span> 2  <span class="nt">-d</span> yyyy
</code></pre></div></div>

<ul>
  <li>å‹æµ‹ç»“æœ</li>
</ul>

<p>åœ¨ mac book ä¸Šæµ‹è¯•ï¼Œä»æµ‹è¯•ç»“æœçœ‹ï¼Œ<strong>å¤šçº¿ç¨‹æ²¡æœ‰å•çº¿ç¨‹å¥½</strong>ã€‚çœ‹åˆ°ç½‘ä¸Šå¾ˆå¤šåŒå­¦ç”¨å‹æµ‹å·¥å…·æµ‹è¯•ï¼Œæ€§èƒ½æœ‰å¾ˆå¤§çš„æå‡ï¼Œæœ‰æ—¶é—´ç”¨å…¶å®ƒæœºå™¨è·‘ä¸‹ã€‚å¯èƒ½æ˜¯æœºå™¨é…ç½®ä¸ä¸€æ ·ï¼Œä½†æ˜¯è‡³å°‘ä¸€ç‚¹ï¼Œè¿™ä¸ªå¤šçº¿ç¨‹åŠŸèƒ½ç›®å‰è¿˜æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ï¼Œæ‰€ä»¥æ–°ç‰¹æ€§ï¼Œè¿˜éœ€è¦æ”¾åˆ°çœŸå®ç¯å¢ƒä¸­æµ‹è¯•è¿‡ï¼Œæ‰èƒ½æŠ•äº§ã€‚</p>

<p><img src="/images/2020-04-21-14-19-22.png" alt="redis å‹æµ‹è¿‡ç¨‹" data-action="zoom" /></p>

<hr />

<h2 id="6-æ€»ç»“">6. æ€»ç»“</h2>

<ul>
  <li>å¤šçº¿ç¨‹æ¨¡å¼ä½¿å¾—ç½‘ç»œè¯»å†™å¿«é€Ÿå¤„ç†ã€‚</li>
  <li>å¤šçº¿ç¨‹æ¨¡å¼ä¼šæµªè´¹ä¸€å®š cpuï¼Œå¹¶å‘é‡ä¸é«˜ä¸å»ºè®®å¼€å¯å¤šçº¿ç¨‹æ¨¡å¼ã€‚</li>
  <li>ä¸»çº¿ç¨‹å®ç°ä¸»é€»è¾‘ï¼Œå­çº¿ç¨‹è¾…åŠ©å®Œæˆä»»åŠ¡ã€‚</li>
  <li>redis å³ä¾¿å¼€å¯å¤šçº¿ç¨‹æ¨¡å¼å¤„ç†ç½‘ç»œè¯»å†™äº‹ä»¶ï¼Œå®è§‚é€»è¾‘è¿˜æ˜¯ä¸²è¡Œçš„ã€‚</li>
  <li>å®è·µæ˜¯æ£€éªŒçœŸç†çš„è¯•é‡‘çŸ³ï¼Œå‹æµ‹è¿‡ç¨‹ä¸­ï¼Œå•çº¿ç¨‹æ¯”å¤šçº¿ç¨‹ä¼˜ç§€ï¼Œæ²¡æœ‰ä½“ç°å‡ºå¤šçº¿ç¨‹åº”æœ‰çš„æ€§èƒ½æå‡ï¼Œå…¶å®ƒå°šå¾…éªŒè¯ã€‚</li>
</ul>

<hr />

<h2 id="7-å‚è€ƒ">7. å‚è€ƒ</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/01/05/redis-gdb/">ç”¨ gdb è°ƒè¯• redis</a></li>
  <li><a href="https://wenfh2020.com/2020/04/14/epoll-workflow/">epoll å¤šè·¯å¤ç”¨ I/Oå·¥ä½œæµç¨‹</a></li>
  <li><a href="https://wenfh2020.com/2020/04/09/redis-ae-file/">[redis æºç èµ°è¯»] äº‹ä»¶ - æ–‡ä»¶äº‹ä»¶</a></li>
  <li><a href="https://wenfh2020.com/2020/04/06/ae-timer/">[redis æºç èµ°è¯»] äº‹ä»¶ - å®šæ—¶å™¨</a></li>
  <li><a href="https://redis.io/topics/benchmarks">How fast is Redis?</a></li>
  <li><a href="https://github.com/wenfh2020/shell/blob/master/redis/benchmark.sh">redis å‹åŠ›æµ‹è¯•å¤šçº¿ç¨‹è¯»å†™è„šæœ¬</a></li>
  <li><a href="https://www.bilibili.com/video/BV1r5411t7QF/">å‹åŠ›æµ‹è¯• redis å¤šçº¿ç¨‹å¤„ç†ç½‘ç»œ I/O</a></li>
  <li><a href="https://blog.csdn.net/wfx15502104112/article/details/96508940">yum æ›´æ–° gcc åˆ°ç‰ˆæœ¬ 8</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET