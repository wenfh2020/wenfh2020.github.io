I"ş<p>redis å¯èƒ½å­˜åœ¨å¤§é‡è¿‡æœŸæ•°æ®ï¼Œä¸€æ¬¡æ€§éå†æ£€æŸ¥ä¸å¤ªç°å®ã€‚redis æœ‰ä¸°å¯Œçš„æ•°æ®ç»“æ„ï¼Œ<code class="highlighter-rouge">key-value</code>ï¼Œ <code class="highlighter-rouge">value</code> æ•°æ®ç»“æ„å¯¹è±¡(<code class="highlighter-rouge">redisObj</code>)å¯èƒ½å­˜å‚¨å¤§é‡æ•°æ®ï¼Œ<code class="highlighter-rouge">key</code> è¿‡æœŸäº†ï¼Œ<code class="highlighter-rouge">value</code> ä¹Ÿä¸å»ºè®®åœ¨è¿›ç¨‹ä¸­å®æ—¶å›æ”¶ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿé«˜æ€§èƒ½ï¼Œæ¯æ¬¡å¤„ç†ä¸€ç‚¹ç‚¹ï¼Œé€æ¸å®Œæˆå¤§ä»»åŠ¡ï¼Œâ€œåˆ†è€Œæ²»ä¹‹â€è¿™æ˜¯ redis å¤„ç†å¤§ä»»åŠ¡çš„ä¸€è´¯ä½œé£ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-æµç¨‹" id="markdown-toc-1-æµç¨‹">1. æµç¨‹</a></li>
  <li><a href="#2-ç­–ç•¥æ¦‚è¿°" id="markdown-toc-2-ç­–ç•¥æ¦‚è¿°">2. ç­–ç•¥æ¦‚è¿°</a>    <ul>
      <li><a href="#21-è¿‡æœŸæ£€æŸ¥" id="markdown-toc-21-è¿‡æœŸæ£€æŸ¥">2.1. è¿‡æœŸæ£€æŸ¥</a></li>
      <li><a href="#22-æ•°æ®å›æ”¶" id="markdown-toc-22-æ•°æ®å›æ”¶">2.2. æ•°æ®å›æ”¶</a>        <ul>
          <li><a href="#221-åŒæ­¥" id="markdown-toc-221-åŒæ­¥">2.2.1. åŒæ­¥</a></li>
          <li><a href="#222-å¼‚æ­¥" id="markdown-toc-222-å¼‚æ­¥">2.2.2. å¼‚æ­¥</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#3-æ£€æŸ¥å…·ä½“ç­–ç•¥" id="markdown-toc-3-æ£€æŸ¥å…·ä½“ç­–ç•¥">3. æ£€æŸ¥å…·ä½“ç­–ç•¥</a>    <ul>
      <li><a href="#31-è®¿é—®æ£€æŸ¥" id="markdown-toc-31-è®¿é—®æ£€æŸ¥">3.1. è®¿é—®æ£€æŸ¥</a>        <ul>
          <li><a href="#311-expireifneeded" id="markdown-toc-311-expireifneeded">3.1.1. expireIfNeeded</a></li>
          <li><a href="#312-ä¿®æ”¹åˆ é™¤è¿‡æœŸ-key" id="markdown-toc-312-ä¿®æ”¹åˆ é™¤è¿‡æœŸ-key">3.1.2. ä¿®æ”¹/åˆ é™¤è¿‡æœŸ key</a></li>
          <li><a href="#313-maxmemory-æ·˜æ±°" id="markdown-toc-313-maxmemory-æ·˜æ±°">3.1.3. maxmemory æ·˜æ±°</a></li>
        </ul>
      </li>
      <li><a href="#32-äº‹ä»¶è§¦å‘" id="markdown-toc-32-äº‹ä»¶è§¦å‘">3.2. äº‹ä»¶è§¦å‘</a></li>
      <li><a href="#33-å®šæœŸæ£€æŸ¥" id="markdown-toc-33-å®šæœŸæ£€æŸ¥">3.3. å®šæœŸæ£€æŸ¥</a></li>
    </ul>
  </li>
  <li><a href="#4-æ€»ç»“" id="markdown-toc-4-æ€»ç»“">4. æ€»ç»“</a></li>
  <li><a href="#5-å‚è€ƒ" id="markdown-toc-5-å‚è€ƒ">5. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-æµç¨‹">1. æµç¨‹</h2>

<p>ä¸»æœåŠ¡æ£€æŸ¥è¿‡æœŸ/åˆ é™¤è¿‡æœŸé€»è¾‘ -&gt; åˆ é™¤è¿‡æœŸé”®å€¼ -&gt; å¼‚æ­¥/åŒæ­¥åˆ é™¤æ•°æ® -&gt; ä¸»ä»åŒæ­¥ã€‚</p>

<p><img src="/images/2020-02-29-11-37-42.png" alt="æµç¨‹" data-action="zoom" /></p>

<p>redis æ•°æ®åº“ï¼Œæ•°æ®å†…å®¹å’Œè¿‡æœŸæ—¶é—´æ˜¯åˆ†å¼€ä¿å­˜ã€‚<code class="highlighter-rouge">expires</code> ä¿å­˜äº†é”®å€¼å¯¹åº”çš„è¿‡æœŸæ—¶é—´ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">redisDb</span> <span class="p">{</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">dict</span><span class="p">;</span>                 <span class="cm">/* The keyspace for this DB */</span>
    <span class="n">dict</span> <span class="o">*</span><span class="n">expires</span><span class="p">;</span>              <span class="cm">/* Timeout of keys with a timeout set */</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">redisDb</span><span class="p">;</span>
</code></pre></div></div>

<hr />

<h2 id="2-ç­–ç•¥æ¦‚è¿°">2. ç­–ç•¥æ¦‚è¿°</h2>

<h3 id="21-è¿‡æœŸæ£€æŸ¥">2.1. è¿‡æœŸæ£€æŸ¥</h3>

<p>è¿‡æœŸæ•°æ®æ£€æŸ¥æœ‰ä¸‰ä¸ªç­–ç•¥ï¼š</p>

<ol>
  <li>è®¿é—®é”®å€¼è§¦å‘æ£€æŸ¥ã€‚è®¿é—®åŒ…æ‹¬å¤–éƒ¨è¯»å†™å‘½ä»¤ï¼Œå†…éƒ¨é€»è¾‘è°ƒç”¨ã€‚
    <blockquote>
      <p>ä¸å¯èƒ½æ¯ä¸ªè¿‡æœŸé”®éƒ½èƒ½å®æ—¶è¢«è®¿é—®è§¦å‘ï¼Œæ‰€ä»¥è¦ç»“åˆå…¶å®ƒç­–ç•¥ã€‚</p>
    </blockquote>
  </li>
  <li>äº‹ä»¶é©±åŠ¨å¤„ç†äº‹ä»¶å‰è§¦å‘å¿«é€Ÿæ£€æŸ¥ã€‚
    <blockquote>
      <p>å°†è¿‡æœŸæ£€æŸ¥è´Ÿè½½ä¸€ç‚¹ç‚¹åˆ†æ‘Šåˆ°æ¯ä¸ªäº‹ä»¶å¤„ç†ä¸­ã€‚</p>
    </blockquote>
  </li>
  <li>æ—¶é’Ÿå®šæœŸæ…¢é€Ÿæ£€æŸ¥ã€‚</li>
</ol>

<hr />

<h3 id="22-æ•°æ®å›æ”¶">2.2. æ•°æ®å›æ”¶</h3>

<p>æ•°æ®å›æ”¶æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥è®¾ç½®ï¼Œä¸€èˆ¬é»˜è®¤å¼‚æ­¥å›æ”¶æ•°æ®ã€‚</p>

<p>å¼‚æ­¥æ•°æ®å›æ”¶æœ‰ä¸¤ä¸ªç­–ç•¥ï¼š</p>

<ol>
  <li>å°æ•°æ®å®æ—¶å›æ”¶ã€‚</li>
  <li>å¤§æ•°æ®æ”¾åˆ°ä»»åŠ¡é˜Ÿåˆ—ï¼Œåå°çº¿ç¨‹å¤„ç†ä»»åŠ¡é˜Ÿåˆ—å¼‚æ­¥å›æ”¶å†…å­˜ã€‚
    <blockquote>
      <p>å¯ä»¥çœ‹çœ‹ <code class="highlighter-rouge">bio.c</code> çš„å®ç°ã€‚</p>
    </blockquote>
  </li>
</ol>

<h4 id="221-åŒæ­¥">2.2.1. åŒæ­¥</h4>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">dbSyncDelete</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Deleting an entry from the expires dict will not free the sds of
     * the key, because it is shared with the main dictionary. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dictSize</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">dictDelete</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dictDelete</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">DICT_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span>
            <span class="n">slotToKeyDel</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="222-å¼‚æ­¥">2.2.2. å¼‚æ­¥</h4>

<p>unlink é€»è¾‘åˆ é™¤ keyï¼Œæ•°æ®æ”¾åœ¨ bio çº¿ç¨‹å¼‚æ­¥åˆ é™¤ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define LAZYFREE_THRESHOLD 64
</span>
<span class="kt">int</span> <span class="nf">dbAsyncDelete</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">dictSize</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">dictDelete</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">,</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>

    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span> <span class="o">=</span> <span class="n">dictUnlink</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">,</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">robj</span> <span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">dictGetVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="kt">size_t</span> <span class="n">free_effort</span> <span class="o">=</span> <span class="n">lazyfreeGetFreeEffort</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">free_effort</span> <span class="o">&gt;</span> <span class="n">LAZYFREE_THRESHOLD</span> <span class="o">&amp;&amp;</span> <span class="n">val</span><span class="o">-&gt;</span><span class="n">refcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">atomicIncr</span><span class="p">(</span><span class="n">lazyfree_objects</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
            <span class="c1">// åˆ é™¤æ•°æ®å¯¹è±¡ï¼Œè¦æ³¨æ„å¯¹è±¡è®¡æ•°ï¼ŒdecrRefCount åˆ é™¤ã€‚</span>
            <span class="n">bioCreateBackgroundJob</span><span class="p">(</span><span class="n">BIO_LAZY_FREE</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
            <span class="n">dictSetVal</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">,</span><span class="n">de</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">dictFreeUnlinkedEntry</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">dict</span><span class="p">,</span><span class="n">de</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">cluster_enabled</span><span class="p">)</span> <span class="n">slotToKeyDel</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-æ£€æŸ¥å…·ä½“ç­–ç•¥">3. æ£€æŸ¥å…·ä½“ç­–ç•¥</h2>

<h3 id="31-è®¿é—®æ£€æŸ¥">3.1. è®¿é—®æ£€æŸ¥</h3>

<h4 id="311-expireifneeded">3.1.1. expireIfNeeded</h4>

<p>å¤–éƒ¨è¯»å†™å‘½ä»¤/å†…éƒ¨é€»è¾‘è°ƒç”¨ï¼ŒåŸºæœ¬æ‰€æœ‰çš„é”®å€¼è¯»å†™æ“ä½œéƒ½ä¼šè§¦å‘ <code class="highlighter-rouge">expireIfNeeded</code> è¿‡æœŸæ£€æŸ¥ã€‚</p>

<p><code class="highlighter-rouge">db.c</code></p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">expireIfNeeded</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keyIsExpired</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">key</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">masterhost</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">server</span><span class="p">.</span><span class="n">stat_expiredkeys</span><span class="o">++</span><span class="p">;</span>
    <span class="c1">// ä¼ æ’­æ•°æ®æ›´æ–°ï¼Œä¼ æ’­åˆ°é›†ç¾¤ä¸­å»ï¼Œå¦‚æœæ•°æ®åº“æ˜¯ `aof` æ ¼å¼å­˜å‚¨ï¼Œæ›´æ–°è½åœ° `aof` æ–‡ä»¶ã€‚</span>
    <span class="n">propagateExpire</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">lazyfree_lazy_expire</span><span class="p">);</span>
    <span class="n">notifyKeyspaceEvent</span><span class="p">(</span><span class="n">NOTIFY_EXPIRED</span><span class="p">,</span> <span class="s">"expired"</span><span class="p">,</span><span class="n">key</span><span class="p">,</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">server</span><span class="p">.</span><span class="n">lazyfree_lazy_expire</span> <span class="o">?</span> <span class="n">dbAsyncDelete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">key</span><span class="p">)</span> <span class="o">:</span>
                                         <span class="n">dbSyncDelete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">key</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">propagateExpire</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">robj</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lazy</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">robj</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

    <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lazy</span> <span class="o">?</span> <span class="n">shared</span><span class="p">.</span><span class="n">unlink</span> <span class="o">:</span> <span class="n">shared</span><span class="p">.</span><span class="n">del</span><span class="p">;</span>
    <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
    <span class="n">incrRefCount</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">incrRefCount</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

    <span class="c1">// aof å­˜å‚¨ï¼Œdel/unlink å‘½ä»¤å…¥åº“</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">!=</span> <span class="n">AOF_OFF</span><span class="p">)</span>
        <span class="n">feedAppendOnlyFile</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">delCommand</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="c1">// åŒæ­¥ del/unlink å‘½ä»¤åˆ°ä»åº“</span>
    <span class="n">replicationFeedSlaves</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">slaves</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

    <span class="n">decrRefCount</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">decrRefCount</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>
</code></pre></div></div>

<h4 id="312-ä¿®æ”¹åˆ é™¤è¿‡æœŸ-key">3.1.2. ä¿®æ”¹/åˆ é™¤è¿‡æœŸ key</h4>

<p>éƒ¨åˆ†å‘½ä»¤ä¼šä¿®æ”¹æˆ–åˆ é™¤è¿‡æœŸæ—¶é—´ã€‚</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å‘½ä»¤</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">del</td>
      <td style="text-align: left">åˆ é™¤æŒ‡å®š key ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">unlink</td>
      <td style="text-align: left">é€»è¾‘åˆ é™¤æŒ‡å®š keyï¼Œæ•°æ®åœ¨çº¿ç¨‹å¼‚æ­¥åˆ é™¤ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">set</td>
      <td style="text-align: left">è®¾ç½®ä¸€ä¸ªé”®çš„å€¼ï¼Œex é€‰é¡¹å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´</td>
    </tr>
    <tr>
      <td style="text-align: left">persist</td>
      <td style="text-align: left">ç§»é™¤ key çš„è¿‡æœŸæ—¶é—´</td>
    </tr>
    <tr>
      <td style="text-align: left">rename</td>
      <td style="text-align: left">é‡å‘½å keyï¼Œä¼šåˆ é™¤åŸæ¥ key çš„è¿‡æœŸæ—¶é—´ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">flushdb</td>
      <td style="text-align: left">æ¸…ç©ºå½“å‰æ•°æ®åº“ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">flushall</td>
      <td style="text-align: left">æ¸…ç©ºæ‰€æœ‰æ•°æ®ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">expire</td>
      <td style="text-align: left">è®¾ç½® key çš„è¿‡æœŸæ—¶é—´ç§’æ•°ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">expireat</td>
      <td style="text-align: left">è®¾ç½®ä¸€ä¸ª UNIX æ—¶é—´æˆ³çš„è¿‡æœŸæ—¶é—´ã€‚</td>
    </tr>
    <tr>
      <td style="text-align: left">pexpireat</td>
      <td style="text-align: left">è®¾ç½®keyåˆ°æœŸ UNIX æ—¶é—´æˆ³ï¼Œä»¥æ¯«ç§’ä¸ºå•ä½ã€‚</td>
    </tr>
  </tbody>
</table>

<h4 id="313-maxmemory-æ·˜æ±°">3.1.3. maxmemory æ·˜æ±°</h4>

<p>è¶…å‡ºæœ€å¤§å†…å­˜ <code class="highlighter-rouge">maxmemory</code>ï¼Œè§¦å‘æ•°æ®æ·˜æ±°ã€‚æ·˜æ±°åˆé€‚çš„æ•°æ®ï¼Œå¯ä»¥å‚è€ƒ<a href="https://wenfh2020.com/2020/03/06/max-memory/">[redis æºç èµ°è¯»] maxmemory æ•°æ®æ·˜æ±°ç­–ç•¥
</a>ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span> <span class="n">redisObject</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">unsigned</span> <span class="n">lru</span><span class="o">:</span><span class="n">LRU_BITS</span><span class="p">;</span> <span class="cm">/* LRU time (relative to global lru_clock) or
                            * LFU data (least significant 8 bits frequency
                            * and most significant 16 bits access time). */</span>
    <span class="p">...</span>
<span class="p">}</span> <span class="n">robj</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">processCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">maxmemory</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">lua_timedout</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">out_of_memory</span> <span class="o">=</span> <span class="n">freeMemoryIfNeededAndSafe</span><span class="p">()</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">;</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">freeMemoryIfNeededAndSafe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">lua_timedout</span> <span class="o">||</span> <span class="n">server</span><span class="p">.</span><span class="n">loading</span><span class="p">)</span> <span class="k">return</span> <span class="n">C_OK</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">freeMemoryIfNeeded</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="32-äº‹ä»¶è§¦å‘">3.2. äº‹ä»¶è§¦å‘</h3>

<p>åœ¨äº‹ä»¶æ¨¡å‹ä¸­ï¼Œå¤„ç†äº‹ä»¶å‰ï¼Œè§¦å‘å¿«é€Ÿæ£€æŸ¥ã€‚å°†è¿‡æœŸæ£€æŸ¥è´Ÿè½½åˆ†æ•£åˆ°å„ä¸ªäº‹ä»¶ä¸­å»ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">aeSetBeforeSleepProc</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span><span class="n">beforeSleep</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="n">aeMain</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">aeMain</span><span class="p">(</span><span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
            <span class="n">eventLoop</span><span class="o">-&gt;</span><span class="n">beforesleep</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">);</span>
        <span class="n">aeProcessEvents</span><span class="p">(</span><span class="n">eventLoop</span><span class="p">,</span> <span class="n">AE_ALL_EVENTS</span><span class="o">|</span><span class="n">AE_CALL_AFTER_SLEEP</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">beforeSleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">active_expire_enabled</span> <span class="o">&amp;&amp;</span> <span class="n">server</span><span class="p">.</span><span class="n">masterhost</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="n">activeExpireCycle</span><span class="p">(</span><span class="n">ACTIVE_EXPIRE_CYCLE_FAST</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="33-å®šæœŸæ£€æŸ¥">3.3. å®šæœŸæ£€æŸ¥</h3>

<p>é€šè¿‡æ—¶é’Ÿå®ç°ï¼Œå®šæœŸæ£€æŸ¥è¿‡æœŸé”®å€¼ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// åˆ›å»ºæ—¶é’Ÿäº‹ä»¶</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">aeCreateTimeEvent</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">serverCron</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">AE_ERR</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">serverPanic</span><span class="p">(</span><span class="s">"Can't create event loop timers."</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">databasesCron</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// ä¸»åº“ä¸­æ£€æŸ¥å³å¯ï¼Œä¸»åº“ä¼šåŒæ­¥ç»“æœåˆ°ä»åº“ã€‚</span>
<span class="kt">void</span> <span class="nf">databasesCron</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">active_expire_enabled</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">masterhost</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// ä¸»åº“æ…¢é€Ÿæ£€æŸ¥</span>
            <span class="n">activeExpireCycle</span><span class="p">(</span><span class="n">ACTIVE_EXPIRE_CYCLE_SLOW</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// ä»åº“å¦‚æœè®¾ç½®äº†å¯å†™åŠŸèƒ½ã€‚</span>
            <span class="n">expireSlaveKeys</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<p>redis ä¸»é€»è¾‘åœ¨å•è¿›ç¨‹ä¸»çº¿ç¨‹ä¸­å®ç°ï¼Œè¦ä¿è¯ä¸èƒ½å½±å“ä¸»ä¸šåŠ¡å‰æä¸‹ï¼Œæ£€æŸ¥è¿‡æœŸæ•°æ®ï¼Œä¸èƒ½å¤ªå½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ä¸»è¦ä¸‰æ–¹é¢è¿›è¡Œé™åˆ¶ï¼š</p>

<ol>
  <li>æ£€æŸ¥æ—¶é—´é™åˆ¶ã€‚</li>
  <li>è¿‡æœŸæ•°æ®æ£€æŸ¥æ•°é‡é™åˆ¶ã€‚</li>
  <li>è¿‡æœŸæ•°æ®æ˜¯å¦è¾¾åˆ°å¯æ¥å—æ¯”ä¾‹ã€‚</li>
</ol>

<p>è¢«æ£€æŸ¥çš„æ•°æ®åˆ°æœŸäº†ï¼Œç³»ç»Ÿä¼šæŠŠè¯¥é”®å€¼ä»å­—å…¸ä¸­é€»è¾‘åˆ é™¤ï¼Œåˆ‡æ–­æ•°æ®ä¸ä¸»é€»è¾‘è”ç³»ã€‚é”®å€¼å¯¹åº”çš„æ•°æ®ï¼Œæ”¾åˆ°çº¿ç¨‹é˜Ÿåˆ—ï¼Œåå°çº¿ç¨‹è¿›è¡Œå¼‚æ­¥å›æ”¶ï¼ˆå¦‚æœé…ç½®è®¾ç½®äº†å¼‚æ­¥å›æ”¶ï¼‰ã€‚</p>

<hr />

<p><code class="highlighter-rouge">activeExpireCycle</code> æ£€æŸ¥æœ‰â€œå¿«é€Ÿâ€å’Œâ€œæ…¢é€Ÿâ€ä¸¤ç§ï¼Œæ—¶é’Ÿå®šæœŸæ£€æŸ¥å±äºæ…¢é€Ÿç±»å‹ã€‚æ…¢é€Ÿæ£€æŸ¥è¢«åˆ†é…æ›´å¤šçš„æ£€æŸ¥æ—¶é—´ã€‚åœ¨ä¸€ä¸ªæ—¶é—´èŒƒå›´å†…ï¼Œåˆ°æœŸæ•°æ®æœ€å¥½ä¸è¦å¤ªå¯†é›†ï¼Œå› ä¸ºç³»ç»Ÿå‘ç°åˆ°æœŸæ•°æ®å¾ˆå¤šï¼Œä¼šè¿«åˆ‡å¸Œæœ›å°½å¿«å¤„ç†æ‰è¿™äº›è¿‡æœŸæ•°æ®ï¼Œæ‰€ä»¥æ¯æ¬¡æ£€æŸ¥éƒ½è¦è€—å°½åˆ†é…çš„æ—¶é—´ç‰‡ï¼Œç›´åˆ°åˆ°æœŸæ•°æ®åˆ°è¾¾ä¸€ä¸ªå¯æ¥å—çš„å¯†åº¦æ¯”ä¾‹ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define CRON_DBS_PER_CALL 16 </span><span class="cm">/* æ¯æ¬¡æ£€æŸ¥çš„æ•°æ®åº“ä¸ªæ•° */</span><span class="cp">
</span>
<span class="cp">#define ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP 20 </span><span class="cm">/* Keys for each DB loop. */</span><span class="cp">
#define ACTIVE_EXPIRE_CYCLE_FAST_DURATION 1000 </span><span class="cm">/* Microseconds. */</span><span class="cp">
#define ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC 25 </span><span class="cm">/* Max % of CPU to use. */</span><span class="cp">
#define ACTIVE_EXPIRE_CYCLE_ACCEPTABLE_STALE 10 </span><span class="cm">/* % of stale keys after which
                                                   we do extra efforts. */</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">activeExpireCycle</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span> <span class="p">{</span>
    <span class="cm">/* Adjust the running parameters according to the configured expire
     * effort. The default effort is 1, and the maximum configurable effort
     * is 10. */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>
    <span class="c1">// åŠªåŠ›åŠ›åº¦ï¼Œé»˜è®¤ 1ï¼Œä¹Ÿå°±æ˜¯éå†è¿‡æœŸå­—å…¸çš„åŠ›åº¦ï¼ŒåŠ›åº¦è¶Šå¤§ï¼Œéå†æ•°é‡è¶Šå¤šï¼Œä½†æ˜¯æ€§èƒ½æŸè€—æ›´å¤šã€‚</span>
    <span class="n">effort</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">active_expire_effort</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="cm">/* Rescale from 0 to 9. */</span>
    <span class="c1">// æ¯æ¬¡å¾ªç¯éå†é”®å€¼ä¸ªæ•°ã€‚åŠ›åº¦è¶Šå¤§ï¼Œéå†ä¸ªæ•°è¶Šå¤šã€‚</span>
    <span class="n">config_keys_per_loop</span> <span class="o">=</span> <span class="n">ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP</span> <span class="o">+</span>
                           <span class="n">ACTIVE_EXPIRE_CYCLE_KEYS_PER_LOOP</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">effort</span><span class="p">,</span>
    <span class="c1">// å¿«é€Ÿéå†æ—¶é—´èŒƒå›´ï¼ŒåŠ›åº¦è¶Šå¤§ï¼Œç»™äºˆéå†æ—¶é—´è¶Šå¤šã€‚</span>
    <span class="n">config_cycle_fast_duration</span> <span class="o">=</span> <span class="n">ACTIVE_EXPIRE_CYCLE_FAST_DURATION</span> <span class="o">+</span>
                                 <span class="n">ACTIVE_EXPIRE_CYCLE_FAST_DURATION</span><span class="o">/</span><span class="mi">4</span><span class="o">*</span><span class="n">effort</span><span class="p">,</span>
    <span class="c1">// æ…¢é€Ÿéå†æ£€æŸ¥æ—¶é—´ç‰‡</span>
    <span class="n">config_cycle_slow_time_perc</span> <span class="o">=</span> <span class="n">ACTIVE_EXPIRE_CYCLE_SLOW_TIME_PERC</span> <span class="o">+</span>
                                  <span class="mi">2</span><span class="o">*</span><span class="n">effort</span><span class="p">,</span>
    <span class="c1">// å·²ç»åˆ°æœŸæ•°æ® / æ£€æŸ¥æ•°æ® æ¯”ä¾‹ã€‚è¾¾åˆ°å¯ä»¥æ¥å—çš„æ¯”ä¾‹ã€‚</span>
    <span class="n">config_cycle_acceptable_stale</span> <span class="o">=</span> <span class="n">ACTIVE_EXPIRE_CYCLE_ACCEPTABLE_STALE</span><span class="o">-</span>
                                    <span class="n">effort</span><span class="p">;</span>

    <span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">current_db</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Last DB tested. */</span>
    <span class="c1">// æ£€æŸ¥æ˜¯å¦å·²ç»è¶…æ—¶ã€‚</span>
    <span class="k">static</span> <span class="kt">int</span> <span class="n">timelimit_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* Time limit hit in previous call? */</span>
    <span class="c1">// ä¸Šä¸€æ¬¡å¿«é€Ÿæ£€æŸ¥æ•°æ®èµ·å§‹æ—¶é—´ã€‚</span>
    <span class="k">static</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">last_fast_cycle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* When last fast cycle ran. */</span>

    <span class="c1">// iteration è¿­ä»£æ£€æŸ¥ä¸ªæ•°ï¼Œæ¯ 16 æ¬¡å¾ªç¯éå†ï¼Œç¡®è®¤ä¸€ä¸‹æ˜¯å¦æ£€æŸ¥è¶…æ—¶ã€‚</span>
    <span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// æ¯æ¬¡å‘¨æœŸæ£€æŸ¥çš„æ•°æ®åº“ä¸ªæ•°ã€‚redis é»˜è®¤æœ‰ 16 ä¸ªåº“ã€‚</span>
    <span class="kt">int</span> <span class="n">dbs_per_call</span> <span class="o">=</span> <span class="n">CRON_DBS_PER_CALL</span><span class="p">;</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ustime</span><span class="p">(),</span> <span class="n">timelimit</span><span class="p">,</span> <span class="n">elapsed</span><span class="p">;</span>

    <span class="cm">/* å¦‚æœé“¾æ¥å·²ç»åœæ­¢äº†ï¼Œé‚£ä¹ˆè¦ä¿ç•™ç°åœºï¼Œä¸å…è®¸ä¿®æ”¹æ•°æ®ï¼Œä¹Ÿä¸å…è®¸åˆ°æœŸæ·˜æ±°æ•°æ®ã€‚
     * ä½¿ç”¨å‘½ä»¤ â€˜pauseâ€™ æš‚åœ redis å·¥ä½œæˆ–è€…ä¸»æœåŠ¡æ­£åœ¨è¿›è¡Œä»æœåŠ¡çš„æ•…éšœè½¬ç§»ã€‚*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">clientsArePaused</span><span class="p">())</span> <span class="k">return</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACTIVE_EXPIRE_CYCLE_FAST</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* æ£€æŸ¥è¿˜æ²¡è¶…æ—¶ï¼Œä½†æ˜¯åˆ°æœŸæ•°æ®å¯†é›†åº¦å·²ç»è¾¾åˆ°äº†å¯ä»¥æ¥å—çš„èŒƒå›´ï¼Œä¸è¦å¿«é€Ÿæ£€æŸ¥äº†ï¼Œ
           æ¯•ç«Ÿå®ƒæ˜¯å¿«é€Ÿçš„ï¼Œç•™ç»™å…¶å®ƒæ–¹å¼çš„æ£€æŸ¥ã€‚*/</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timelimit_exit</span> <span class="o">&amp;&amp;</span>
            <span class="n">server</span><span class="p">.</span><span class="n">stat_expired_stale_perc</span> <span class="o">&lt;</span> <span class="n">config_cycle_acceptable_stale</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="cm">/* é™åˆ¶å¿«é€Ÿæ£€æŸ¥é¢‘æ¬¡ï¼Œåœ¨ä¸¤ä¸ª config_cycle_fast_duration å†…ï¼Œåªèƒ½æ‰§è¡Œä¸€æ¬¡å¿«é€Ÿæ£€æŸ¥ã€‚ */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">last_fast_cycle</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">config_cycle_fast_duration</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span><span class="p">;</span>

        <span class="n">last_fast_cycle</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">dbs_per_call</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span> <span class="o">||</span> <span class="n">timelimit_exit</span><span class="p">)</span>
        <span class="n">dbs_per_call</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span><span class="p">;</span>

    <span class="cm">/* æ£€æŸ¥è¿‡æœŸæ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½å¤ªæŸè€—èµ„æºï¼Œå¾—æœ‰ä¸ªé™åˆ¶ã€‚server.hz é»˜è®¤ä¸º 10
       hz æ˜¯æ‰§è¡Œåå°ä»»åŠ¡çš„é¢‘ç‡ï¼Œè¶Šå¤§è¡¨æ˜æ‰§è¡Œçš„æ¬¡æ•°è¶Šé¢‘ç¹ï¼Œä¸€èˆ¬ç”¨é»˜è®¤å€¼ 10 */</span>
    <span class="n">timelimit</span> <span class="o">=</span> <span class="n">config_cycle_slow_time_perc</span><span class="o">*</span><span class="mi">1000000</span><span class="o">/</span><span class="n">server</span><span class="p">.</span><span class="n">hz</span><span class="o">/</span><span class="mi">100</span><span class="p">;</span>
    <span class="n">timelimit_exit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">timelimit</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">timelimit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// å¦‚æœæ˜¯å¿«é€Ÿæ¨¡å¼ï¼Œæ›´æ”¹æ£€æŸ¥å‘¨æœŸæ—¶é—´ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ACTIVE_EXPIRE_CYCLE_FAST</span><span class="p">)</span>
        <span class="n">timelimit</span> <span class="o">=</span> <span class="n">config_cycle_fast_duration</span><span class="p">;</span> <span class="cm">/* in microseconds. */</span>

    <span class="cm">/* è¿‡æœŸæ•°æ®ä¸€èˆ¬æ˜¯å¼‚æ­¥æ–¹å¼ï¼Œæ£€æŸ¥åˆ°è¿‡æœŸæ•°æ®ï¼Œéƒ½æ˜¯ä»å­—å…¸ä¸­ç§»é™¤é”®å€¼ä¿¡æ¯ï¼Œ
     * é¿å…å†æ¬¡ä½¿ç”¨ï¼Œä½†æ˜¯æ•°æ®å›æ”¶æ”¾åœ¨åå°å›æ”¶ï¼Œä¸æ˜¯å®æ—¶çš„ï¼Œæœ‰æ•°æ®æœ‰å¯èƒ½è¿˜å­˜åœ¨æ•°æ®åº“é‡Œã€‚*/</span>

    <span class="c1">// æ£€æŸ¥æ•°æ®ä¸ªæ•°ã€‚</span>
    <span class="kt">long</span> <span class="n">total_sampled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// æ£€æŸ¥æ•°æ®ï¼Œæ•°æ®å·²ç»è¿‡æœŸçš„ä¸ªæ•°ã€‚</span>
    <span class="kt">long</span> <span class="n">total_expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">dbs_per_call</span> <span class="o">&amp;&amp;</span> <span class="n">timelimit_exit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expired</span><span class="p">,</span> <span class="n">sampled</span><span class="p">;</span>
        <span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">db</span><span class="o">+</span><span class="p">(</span><span class="n">current_db</span> <span class="o">%</span> <span class="n">server</span><span class="p">.</span><span class="n">dbnum</span><span class="p">);</span>
        <span class="n">current_db</span><span class="o">++</span><span class="p">;</span>

        <span class="c1">// éå†æ•°æ®åº“æ£€æŸ¥è¿‡æœŸæ•°æ®ï¼Œç›´åˆ°è¶…å‡ºæ£€æŸ¥å‘¨æœŸæ—¶é—´ï¼Œæˆ–è€…è¿‡æœŸæ•°æ®æ¯”ä¾‹å·²ç»å¾ˆå°‘äº†ã€‚</span>
        <span class="k">do</span> <span class="p">{</span>
            <span class="c1">// num æ•°æ®é‡ï¼Œslots å“ˆå¸Œè¡¨å¤§å°ï¼ˆå­—å…¸æ•°æ®å¦‚æœæ­£åœ¨è¿ç§»ï¼ŒåŒè¡¨å¤§å°ï¼‰</span>
            <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">num</span><span class="p">,</span> <span class="n">slots</span><span class="p">;</span>
            <span class="kt">long</span> <span class="kt">long</span> <span class="n">now</span><span class="p">,</span> <span class="n">ttl_sum</span><span class="p">;</span>
            <span class="kt">int</span> <span class="n">ttl_samples</span><span class="p">;</span>
            <span class="n">iteration</span><span class="o">++</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">num</span> <span class="o">=</span> <span class="n">dictSize</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">db</span><span class="o">-&gt;</span><span class="n">avg_ttl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">slots</span> <span class="o">=</span> <span class="n">dictSlots</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">);</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">mstime</span><span class="p">();</span>

            <span class="cm">/* è¿‡æœŸå­˜å‚¨æ•°æ®ç»“æ„æ˜¯å­—å…¸ï¼Œæ•°æ®ç»è¿‡å¤„ç†åï¼Œå­—å…¸å­˜å‚¨çš„æ•°æ®å¯èƒ½å·²ç»å¾ˆå°‘ï¼Œ
             * ä½†æ˜¯å­—å…¸è¿˜æ˜¯å¤§å­—å…¸ï¼Œè¿™æ ·éå†æ•°æ®æœ‰æ•ˆå‘½ä¸­ç‡ä¼šå¾ˆä½ï¼Œå¤„ç†èµ·æ¥ä¼šæµªè´¹èµ„æºï¼Œ
             * åé¢çš„è®¿é—®ä¼šå¾ˆå¿«è§¦å‘å­—å…¸çš„ç¼©å®¹ï¼Œç¼©å®¹åå†è¿›è¡Œå¤„ç†æ•ˆç‡æ›´é«˜ã€‚*/</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">slots</span> <span class="o">&gt;</span> <span class="n">DICT_HT_INITIAL_SIZE</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">num</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">slots</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>

            <span class="c1">// è¿‡æœŸçš„æ•°æ®ä¸ªæ•°ã€‚</span>
            <span class="n">expired</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// æ£€æŸ¥çš„æ•°æ®ä¸ªæ•°ã€‚</span>
            <span class="n">sampled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// æ²¡æœ‰è¿‡æœŸçš„æ•°æ®æ—¶é—´å·®ä¹‹å’Œã€‚</span>
            <span class="n">ttl_sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="c1">// æ²¡æœ‰è¿‡æœŸçš„æ•°æ®ä¸ªæ•°ã€‚</span>
            <span class="n">ttl_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="c1">// æ¯æ¬¡æ£€æŸ¥çš„æ•°æ®é™åˆ¶ã€‚</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="n">config_keys_per_loop</span><span class="p">)</span>
                <span class="n">num</span> <span class="o">=</span> <span class="n">config_keys_per_loop</span><span class="p">;</span>

            <span class="cm">/* å“ˆå¸Œè¡¨æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå¯èƒ½æœ‰é”®å€¼ç¢°æ’çš„æ•°æ®ï¼Œç”¨é“¾è¡¨å°†ç¢°æ’æ•°æ®ä¸²è”èµ·æ¥ï¼Œ
             * æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸‹æ ‡ä¸‹ï¼Œä¹Ÿå°±æ˜¯æ”¾åœ¨å“ˆå¸Œè¡¨çš„ä¸€ä¸ªæ¡¶é‡Œã€‚max_buckets æ˜¯æœ€å¤§èƒ½æ£€æŸ¥çš„æ¡¶ä¸ªæ•°ã€‚
             * è·³è¿‡ç©ºæ¡¶ï¼Œä¸å¤„ç†ã€‚*/</span>
            <span class="kt">long</span> <span class="n">max_buckets</span> <span class="o">=</span> <span class="n">num</span><span class="o">*</span><span class="mi">20</span><span class="p">;</span>
            <span class="c1">// å½“å‰å·²ç»æ£€æŸ¥å“ˆå¸Œè¡¨æ¡¶çš„ä¸ªæ•°ã€‚</span>
            <span class="kt">long</span> <span class="n">checked_buckets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

            <span class="c1">// ä¸€ä¸ªæ¡¶ä¸Šæœ‰å¯èƒ½æœ‰å¤šä¸ªæ•°æ®ã€‚æ‰€ä»¥æ£€æŸ¥ä»ä¸¤æ–¹é¢é™åˆ¶ï¼šä¸€ä¸ªæ˜¯æ•°æ®é‡ï¼Œä¸€ä¸ªæ˜¯æ¡¶çš„æ•°é‡ã€‚</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">sampled</span> <span class="o">&lt;</span> <span class="n">num</span> <span class="o">&amp;&amp;</span> <span class="n">checked_buckets</span> <span class="o">&lt;</span> <span class="n">max_buckets</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">table</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">table</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// å¦‚æœ dict æ²¡æœ‰æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œä¸éœ€è¦æ£€æŸ¥å®ƒçš„ç¬¬äºŒå¼ è¡¨äº†ã€‚</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">table</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dictIsRehashing</span><span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">))</span> <span class="k">break</span><span class="p">;</span>

                    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">expires_cursor</span><span class="p">;</span>
                    <span class="n">idx</span> <span class="o">&amp;=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">[</span><span class="n">table</span><span class="p">].</span><span class="n">sizemask</span><span class="p">;</span>
                    <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span> <span class="o">=</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">expires</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">[</span><span class="n">table</span><span class="p">].</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
                    <span class="kt">long</span> <span class="kt">long</span> <span class="n">ttl</span><span class="p">;</span>

                    <span class="n">checked_buckets</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">while</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">dictEntry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">de</span><span class="p">;</span>
                        <span class="n">de</span> <span class="o">=</span> <span class="n">de</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

                        <span class="c1">// æ£€æŸ¥æ•°æ®æ˜¯å¦å·²ç»è¶…æ—¶ã€‚</span>
                        <span class="n">ttl</span> <span class="o">=</span> <span class="n">dictGetSignedIntegerVal</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">-</span><span class="n">now</span><span class="p">;</span>

                        <span class="c1">// å¦‚æœæ•°æ®è¿‡æœŸäº†ï¼Œè¿›è¡Œå›æ”¶å¤„ç†ã€‚</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">activeExpireCycleTryExpire</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">now</span><span class="p">))</span> <span class="n">expired</span><span class="o">++</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">ttl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                            <span class="cm">/* We want the average TTL of keys yet
                             * not expired. */</span>
                            <span class="n">ttl_sum</span> <span class="o">+=</span> <span class="n">ttl</span><span class="p">;</span>
                            <span class="n">ttl_samples</span><span class="o">++</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="n">sampled</span><span class="o">++</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="n">db</span><span class="o">-&gt;</span><span class="n">expires_cursor</span><span class="o">++</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">total_expired</span> <span class="o">+=</span> <span class="n">expired</span><span class="p">;</span>
            <span class="n">total_sampled</span> <span class="o">+=</span> <span class="n">sampled</span><span class="p">;</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ttl_samples</span><span class="p">)</span> <span class="p">{</span>
                <span class="kt">long</span> <span class="kt">long</span> <span class="n">avg_ttl</span> <span class="o">=</span> <span class="n">ttl_sum</span><span class="o">/</span><span class="n">ttl_samples</span><span class="p">;</span>

                <span class="cm">/* Do a simple running average with a few samples.
                 * We just use the current estimate with a weight of 2%
                 * and the previous estimate with a weight of 98%. */</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">avg_ttl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">avg_ttl</span> <span class="o">=</span> <span class="n">avg_ttl</span><span class="p">;</span>
                <span class="c1">// å¯¹æ²¡è¿‡æœŸçš„æ•°æ®ï¼Œå¹³å‡è¿‡æœŸæ—¶é—´è¿›è¡Œé‡‡æ ·ï¼Œä¸Šä¸€æ¬¡ç»Ÿè®¡çš„å¹³å‡æ—¶é—´å  98 %ï¼Œæœ¬æ¬¡å  2%ã€‚</span>
                <span class="n">db</span><span class="o">-&gt;</span><span class="n">avg_ttl</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">avg_ttl</span><span class="o">/</span><span class="mi">50</span><span class="p">)</span><span class="o">*</span><span class="mi">49</span> <span class="o">+</span> <span class="p">(</span><span class="n">avg_ttl</span><span class="o">/</span><span class="mi">50</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="cm">/* é¿å…æ£€æŸ¥å‘¨æœŸå¤ªé•¿ï¼Œå½“å‰æ•°æ®åº“æ¯ 16 æ¬¡å¾ªç¯è¿­ä»£æ£€æŸ¥ï¼Œæ£€æŸ¥æ˜¯å¦è¶…æ—¶ï¼Œè¶…æ—¶é€€å‡ºã€‚*/</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">iteration</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* check once every 16 iterations. */</span>
                <span class="n">elapsed</span> <span class="o">=</span> <span class="n">ustime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;</span> <span class="n">timelimit</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">timelimit_exit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                    <span class="n">server</span><span class="p">.</span><span class="n">stat_expired_time_cap_reached_count</span><span class="o">++</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="cm">/* å½“å‰æ•°æ®åº“ï¼Œå¦‚æœæ²¡æœ‰æ£€æŸ¥åˆ°æ•°æ®ï¼Œæˆ–è€…è¿‡æœŸæ•°æ®å·²ç»è¾¾åˆ°å¯æ¥å—æ¯”ä¾‹
             * å°±é€€å‡ºè¯¥æ•°æ®åº“æ£€æŸ¥ï¼Œè¿›å…¥åˆ°ä¸‹ä¸€ä¸ªæ•°æ®åº“æ£€æŸ¥ã€‚*/</span>
        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">sampled</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
                 <span class="p">(</span><span class="n">expired</span><span class="o">*</span><span class="mi">100</span><span class="o">/</span><span class="n">sampled</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">config_cycle_acceptable_stale</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// æ·»åŠ ç»Ÿè®¡ä¿¡æ¯</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">ustime</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">;</span>
    <span class="n">server</span><span class="p">.</span><span class="n">stat_expire_cycle_time_used</span> <span class="o">+=</span> <span class="n">elapsed</span><span class="p">;</span>
    <span class="n">latencyAddSampleIfNeeded</span><span class="p">(</span><span class="s">"expire-cycle"</span><span class="p">,</span><span class="n">elapsed</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>

    <span class="kt">double</span> <span class="n">current_perc</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">total_sampled</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">current_perc</span> <span class="o">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">total_expired</span><span class="o">/</span><span class="n">total_sampled</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span>
        <span class="n">current_perc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="c1">// é€šè¿‡ç´¯åŠ æ¯æ¬¡æ£€æŸ¥çš„è¿‡æœŸæ¦‚ç‡å½±å“ï¼Œä¿å­˜è¿‡æœŸæ•°æ®å æ•°æ®æ¯”ä¾‹ã€‚</span>
    <span class="n">server</span><span class="p">.</span><span class="n">stat_expired_stale_perc</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_perc</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mo">05</span><span class="p">)</span><span class="o">+</span>
                                     <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">stat_expired_stale_perc</span><span class="o">*</span><span class="mi">0</span><span class="p">.</span><span class="mi">95</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>åˆ é™¤è¿‡æœŸæ•°æ®</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">activeExpireCycleTryExpire</span><span class="p">(</span><span class="n">redisDb</span> <span class="o">*</span><span class="n">db</span><span class="p">,</span> <span class="n">dictEntry</span> <span class="o">*</span><span class="n">de</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">now</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">t</span> <span class="o">=</span> <span class="n">dictGetSignedIntegerVal</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">now</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">sds</span> <span class="n">key</span> <span class="o">=</span> <span class="n">dictGetKey</span><span class="p">(</span><span class="n">de</span><span class="p">);</span>
        <span class="n">robj</span> <span class="o">*</span><span class="n">keyobj</span> <span class="o">=</span> <span class="n">createStringObject</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">sdslen</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

        <span class="n">propagateExpire</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">keyobj</span><span class="p">,</span><span class="n">server</span><span class="p">.</span><span class="n">lazyfree_lazy_expire</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">lazyfree_lazy_expire</span><span class="p">)</span>
            <span class="n">dbAsyncDelete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">keyobj</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">dbSyncDelete</span><span class="p">(</span><span class="n">db</span><span class="p">,</span><span class="n">keyobj</span><span class="p">);</span>
        <span class="n">notifyKeyspaceEvent</span><span class="p">(</span><span class="n">NOTIFY_EXPIRED</span><span class="p">,</span> <span class="s">"expired"</span><span class="p">,</span> <span class="n">keyobj</span><span class="p">,</span> <span class="n">db</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
        <span class="n">trackingInvalidateKey</span><span class="p">(</span><span class="n">keyobj</span><span class="p">);</span>
        <span class="n">decrRefCount</span><span class="p">(</span><span class="n">keyobj</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">stat_expiredkeys</span><span class="o">++</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-æ€»ç»“">4. æ€»ç»“</h2>

<ul>
  <li>è¦ç†Ÿæ‚‰å­—å…¸ <code class="highlighter-rouge">dict</code> çš„å®ç°åŸç†ï¼Œ<code class="highlighter-rouge">dict</code> æ˜¯ redis å¸¸ç”¨çš„å‡ ä¸ªåŸºç¡€æ•°æ®ç»“æ„ä¹‹ä¸€ã€‚</li>
  <li>çœ‹äº†å‡ å¤©æºç ï¼Œå¤§è‡´ç†è§£äº†é”®å€¼è¿‡æœŸå¤„ç†ç­–ç•¥ã€‚å¾ˆå¤šç»†èŠ‚ï¼Œæ„Ÿè§‰ç†è§£è¿˜æ˜¯ä¸å¤Ÿæ·±åˆ»ï¼Œä»¥åè¿˜æ˜¯è¦ç»“åˆå®æˆ˜å¤šæ€è€ƒã€‚</li>
  <li>redis ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„é«˜æ€§èƒ½ï¼Œé‡‡å–äº†å¾ˆå¤šå·§å¦™çš„â€œåˆ†æ²»ç­–ç•¥â€ï¼Œä¾‹å¦‚é”®å€¼è¿‡æœŸæ£€æŸ¥ã€‚è¿‡æœŸæ•°æ®æ£€æŸ¥å’Œå¤„ç†æµç¨‹çœ‹ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå®æ—¶çš„æ“ä½œï¼Œæœ‰ä¸€å®šçš„å»¶æ—¶ï¼Œè¿™æ ·ç³»ç»Ÿä¸èƒ½å¾ˆå¥½åœ°ä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚æœ‰å¾—å¿…æœ‰å¤±ã€‚</li>
  <li>ä»å®šæœŸå›æ”¶ç­–ç•¥çš„æ…¢é€Ÿæ£€æŸ¥ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œredis å¤„ç†åˆ°æœŸæ•°æ®ï¼Œé€šè¿‡é‡‡æ ·ï¼Œåˆ¤æ–­åˆ°æœŸæ•°æ®çš„å¯†é›†åº¦ã€‚åˆ°æœŸæ•°æ®è¶Šå¯†é›†ï¼Œå¤„ç†æ—¶é—´è¶Šå¤šã€‚æˆ‘ä»¬ä½¿ç”¨ä¸­ï¼Œä¸åº”è¯¥æŠŠå¤§é‡æ•°æ®è®¾ç½®åœ¨åŒä¸€ä¸ªæ—¶é—´æ®µåˆ°æœŸã€‚</li>
  <li><code class="highlighter-rouge">redis.conf</code> é…ç½®é‡Œé¢æœ‰æ¯”è¾ƒè¯¦ç»†çš„è¿‡æœŸé”®å¤„ç†ç­–ç•¥æè¿°ã€‚å¾ˆå¤šç»†èŠ‚ï¼Œå¯ä»¥å‚è€ƒæºç æ³¨é‡Šå’Œæ–‡æ¡£ã€‚æ–‡æ¡£æå…¶è¯¦ç»†ï¼Œredis ä½œè€…çš„è€å¿ƒï¼Œåœ¨å¼€æºé¡¹ç›®ä¸­ï¼Œæ˜¯æ¯”è¾ƒå°‘è§çš„ ğŸ‘ã€‚ä¾‹å¦‚ï¼š</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">############################# LAZY FREEING ####################################</span>

<span class="c"># Redis has two primitives to delete keys. One is called DEL and is a blocking</span>
<span class="c"># deletion of the object. It means that the server stops processing new commands</span>
<span class="c"># in order to reclaim all the memory associated with an object in a synchronous</span>
<span class="c"># way. If the key deleted is associated with a small object, the time needed</span>
<span class="c"># in order to execute the DEL command is very small and comparable to most other</span>
<span class="c"># O(1) or O(log_N) commands in Redis. However if the key is associated with an</span>
<span class="c"># aggregated value containing millions of elements, the server can block for</span>
<span class="c"># a long time (even seconds) in order to complete the operation.</span>
<span class="c">#</span>
<span class="c"># For the above reasons Redis also offers non blocking deletion primitives</span>
<span class="c"># such as UNLINK (non blocking DEL) and the ASYNC option of FLUSHALL and</span>
<span class="c"># FLUSHDB commands, in order to reclaim memory in background. Those commands</span>
<span class="c"># are executed in constant time. Another thread will incrementally free the</span>
<span class="c"># object in the background as fast as possible.</span>
<span class="c">#</span>
<span class="c"># DEL, UNLINK and ASYNC option of FLUSHALL and FLUSHDB are user-controlled.</span>
<span class="c"># It's up to the design of the application to understand when it is a good</span>
<span class="c"># idea to use one or the other. However the Redis server sometimes has to</span>
<span class="c"># delete keys or flush the whole database as a side effect of other operations.</span>
<span class="c"># Specifically Redis deletes objects independently of a user call in the</span>
<span class="c"># following scenarios:</span>
<span class="c">#</span>
<span class="c"># 1) On eviction, because of the maxmemory and maxmemory policy configurations,</span>
<span class="c">#    in order to make room for new data, without going over the specified</span>
<span class="c">#    memory limit.</span>
<span class="c"># 2) Because of expire: when a key with an associated time to live (see the</span>
<span class="c">#    EXPIRE command) must be deleted from memory.</span>
<span class="c"># 3) Because of a side effect of a command that stores data on a key that may</span>
<span class="c">#    already exist. For example the RENAME command may delete the old key</span>
<span class="c">#    content when it is replaced with another one. Similarly SUNIONSTORE</span>
<span class="c">#    or SORT with STORE option may delete existing keys. The SET command</span>
<span class="c">#    itself removes any old content of the specified key in order to replace</span>
<span class="c">#    it with the specified string.</span>
<span class="c"># 4) During replication, when a replica performs a full resynchronization with</span>
<span class="c">#    its master, the content of the whole database is removed in order to</span>
<span class="c">#    load the RDB file just transferred.</span>
<span class="c">#</span>
<span class="c"># In all the above cases the default is to delete objects in a blocking way,</span>
<span class="c"># like if DEL was called. However you can configure each case specifically</span>
<span class="c"># in order to instead release memory in a non-blocking way like if UNLINK</span>
<span class="c"># was called, using the following configuration directives:</span>

lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no
</code></pre></div></div>

<hr />

<h2 id="5-å‚è€ƒ">5. å‚è€ƒ</h2>

<ul>
  <li><a href="https://wenfh2020.com/2020/01/12/redis-dict/">[redis æºç èµ°è¯»] å­—å…¸(dict)</a></li>
  <li>ã€Šredis è®¾è®¡ä¸å®ç°ã€‹</li>
  <li><a href="https://blog.csdn.net/alex_xfboy/article/details/88959647">redis è¿‡æœŸç­–ç•¥åŠå†…å­˜å›æ”¶æœºåˆ¶</a></li>
  <li><a href="https://www.zhangshengrong.com/p/Z9a28xkVXV/">redis3.2é…ç½®æ–‡ä»¶redis.confè¯¦ç»†è¯´æ˜</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET