I"<p>çˆ¶è¿›ç¨‹ fork å­è¿›ç¨‹åï¼Œå­è¿›ç¨‹é€šè¿‡ <code class="highlighter-rouge">copy-on-write</code> æ¨¡å¼è·å¾—çˆ¶è¿›ç¨‹å†…å­˜ï¼Œä¹Ÿå°±æ˜¯å­è¿›ç¨‹å…±ç”¨äº†å¤§éƒ¨åˆ†çˆ¶è¿›ç¨‹å†…å­˜ï¼Œåªæœ‰å½“å­è¿›ç¨‹åœ¨ä¿®æ”¹è‡ªå·±è¿›ç¨‹å†…å­˜åï¼Œå…±äº«éƒ¨åˆ†ï¼Œæ‰ä¼šæŠŠé‚£äº›ä¿®æ”¹çš„æ‹·è´å‡ºæ¥ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœç³»ç»Ÿå¤§é‡å†…å­˜åˆ†é…ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-ç³»ç»Ÿ" id="markdown-toc-1-ç³»ç»Ÿ">1. ç³»ç»Ÿ</a></li>
  <li><a href="#2-æµ‹è¯•" id="markdown-toc-2-æµ‹è¯•">2. æµ‹è¯•</a></li>
  <li><a href="#3-æµ‹è¯•æºç " id="markdown-toc-3-æµ‹è¯•æºç ">3. æµ‹è¯•æºç </a></li>
  <li><a href="#4-æµ‹è¯•ç»“æœ" id="markdown-toc-4-æµ‹è¯•ç»“æœ">4. æµ‹è¯•ç»“æœ</a></li>
  <li><a href="#5-å‚è€ƒ" id="markdown-toc-5-å‚è€ƒ">5. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-ç³»ç»Ÿ">1. ç³»ç»Ÿ</h2>

<p>macos</p>

<hr />

<h2 id="2-æµ‹è¯•">2. æµ‹è¯•</h2>

<p>æµ‹è¯•å¯¹è±¡ç”³è¯·ä¸€å—å†…å­˜ï¼Œä¸»è¿›ç¨‹ fork å­è¿›ç¨‹åç›‘æµ‹å­è¿›ç¨‹å¯¹å†…å­˜æ•°æ®ä¿®æ”¹å‰åçŠ¶å†µã€‚</p>

<p><img src="/images/2020-03-11-10-09-06.png" alt="å­è¿›ç¨‹æ•°æ®ä¿®æ”¹å‰" data-action="zoom" /></p>

<p><img src="/images/2020-03-11-10-09-21.png" alt="å­è¿›ç¨‹æ•°æ®ä¿®æ”¹å" data-action="zoom" /></p>

<blockquote>
  <p>æµ‹è¯•è¿›ç¨‹è·‘å¾—æ¯”è¾ƒå¿«ï¼Œè·‘äº†ä¸¤æ¬¡å»æŠ“å›¾ï¼Œæ‰€ä»¥ä¸¤æ¬¡æŠ“å›¾çš„è¿›ç¨‹ä¸ä¸€æ ·ã€‚æ„Ÿå…´è¶£çš„æœ‹å‹å¯ä»¥æ‹¿<a href="https://github.com/wenfh2020/c_test/blob/master/normal/proc.cpp">æºç </a>æµ‹è¯•ä¸‹ã€‚</p>
</blockquote>

<hr />

<h2 id="3-æµ‹è¯•æºç ">3. æµ‹è¯•æºç </h2>

<p><a href="https://github.com/wenfh2020/c_test/blob/master/normal/proc.cpp">æºç </a></p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">alloc_data</span> <span class="n">g_data</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">pid_t</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"child pid: %d, data ptr: %#lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
               <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_data</span><span class="p">);</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>  <span class="c1">// update data before</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"child pid: %d, reset data:</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
        <span class="n">g_data</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>  <span class="c1">// update data later</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"parent pid: %d, data ptr: %#lx</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">(),</span>
               <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">g_data</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"fork fail</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"parent end, pid: %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">getpid</span><span class="p">());</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-æµ‹è¯•ç»“æœ">4. æµ‹è¯•ç»“æœ</h2>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>alloc, data ptr: 0x602140, array ptr: 0x602148
parent pid: 29118, data ptr: 0x602140
child pid: 29126, data ptr: 0x602140
child pid: 29126, reset data:
reset data, data ptr: 0x602140, array ptr: 0x602148
delete data, pid: 29126
child 29126 terminated normally with <span class="nb">exit </span>status <span class="o">=</span> 0
sig_child_handler end, errno: 0
parent end, pid: 29118
delete data, pid: 29118
</code></pre></div></div>

<ol>
  <li>å­è¿›ç¨‹æ‹·è´çˆ¶è¿›ç¨‹çš„æ•°æ®ï¼Œæ•°æ®åœ°å€ï¼ˆè™šæ‹Ÿåœ°å€ï¼‰æ˜¯ä¸€æ ·çš„ã€‚</li>
  <li>çˆ¶è¿›ç¨‹ alloc äº†ä¸€æ¬¡æ•°æ®ï¼Œdelete äº†ä¸¤æ¬¡æ•°æ®ï¼Œå­è¿›ç¨‹åªæ˜¯æ‹·è´äº†çˆ¶è¿›ç¨‹æ•°æ®ï¼Œæ²¡æœ‰è·‘çˆ¶è¿›ç¨‹ fork å‰çš„ä»£ç é€»è¾‘ã€‚
3.å­è¿›ç¨‹æœ‰è‡ªå·±çš„ç‹¬ç«‹ç©ºé—´ï¼Œ å­è¿›ç¨‹ä¿®æ”¹æ•°æ®åï¼Œcopy-on-writeï¼Œå­è¿›ç¨‹ç©ºé—´å°†åˆ†é…æ–°çš„æ•°æ®ç©ºé—´å­˜å‚¨æ–°æ•°æ®ï¼ˆtop æŸ¥çœ‹è¿›ç¨‹è´Ÿè½½æƒ…å†µï¼‰ã€‚</li>
</ol>

<hr />

<h2 id="5-å‚è€ƒ">5. å‚è€ƒ</h2>

<ul>
  <li>ã€Šæ·±å…¥ç†è§£è®¡ç®—æœºç³»ç»Ÿã€‹ç¬¬äºŒéƒ¨åˆ†ï¼Œ8.4 ç«  è¿›ç¨‹æ§åˆ¶</li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET