I"ã;<p>é€šè¿‡ gdb æŸ¥çœ‹ç¨‹åºçš„æ±‡ç¼–ä»£ç ï¼Œç†è§£å®å‡½æ•°å’Œå‡½æ•°çš„å·¥ä½œåŸç†ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-ç¨‹åº" id="markdown-toc-1-ç¨‹åº">1. ç¨‹åº</a></li>
  <li><a href="#2-æ±‡ç¼–çŸ¥è¯†" id="markdown-toc-2-æ±‡ç¼–çŸ¥è¯†">2. æ±‡ç¼–çŸ¥è¯†</a>    <ul>
      <li><a href="#21-å¯„å­˜å™¨" id="markdown-toc-21-å¯„å­˜å™¨">2.1. å¯„å­˜å™¨</a></li>
      <li><a href="#22-æ±‡ç¼–æŒ‡ä»¤" id="markdown-toc-22-æ±‡ç¼–æŒ‡ä»¤">2.2. æ±‡ç¼–æŒ‡ä»¤</a></li>
    </ul>
  </li>
  <li><a href="#3-å‚è€ƒ" id="markdown-toc-3-å‚è€ƒ">3. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-ç¨‹åº">1. ç¨‹åº</h2>

<p><img src="/images/2020-02-20-15-05-17.png" alt="æºç åæ±‡ç¼–" data-action="zoom" /></p>

<p>ä¾‹å­ä¸­çš„æœ€å¤§å€¼å®ç°ï¼Œå®å‡½æ•°å’Œå‡½æ•°é€»è¾‘åŸºæœ¬ç›¸åŒã€‚å®åœ¨æºç é¢„ç¼–è¯‘é˜¶æ®µï¼Œè¢«æ›¿æ¢ä¸ºä»£ç ï¼Œå¢åŠ äº†ä»£ç çš„ä½“ç§¯ï¼›è€Œå‡½æ•°è°ƒç”¨å¤šäº†å‚æ•°ä¼ é€’ï¼Œå‡½æ•°è¿›æ ˆå’Œå‡ºæ ˆç­‰é€»è¾‘ï¼Œè‡ªç„¶èµ„æºæ¶ˆè€—è¦æ¯”å®å¤šã€‚</p>

<ul>
  <li>æµ‹è¯•ä»£ç </li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define _max(x, y) (x) &gt; (y) ? (x) : (y)
</span>
<span class="kt">int</span> <span class="nf">max_func</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">aaa</span><span class="p">,</span> <span class="n">bbb</span><span class="p">,</span> <span class="n">ccc</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">mmm</span><span class="p">;</span>

    <span class="n">aaa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bbb</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">eee</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">mmm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="n">max_func</span><span class="p">(</span><span class="n">aaa</span><span class="p">,</span> <span class="n">bbb</span><span class="p">);</span>
    <span class="n">ddd</span> <span class="o">=</span> <span class="n">_max</span><span class="p">(</span><span class="n">aaa</span><span class="p">,</span> <span class="n">bbb</span><span class="p">);</span>
    <span class="n">eee</span> <span class="o">=</span> <span class="n">ddd</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>é¢„ç¼–è¯‘åï¼Œå®è¢«æ›¿æ¢ä¸ºæºç ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-E</span> test.cpp <span class="nt">-o</span> test.i
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">max_func</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="n">y</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">y</span> <span class="o">?</span> <span class="n">x</span> <span class="o">:</span> <span class="n">y</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kt">int</span> <span class="n">aaa</span><span class="p">,</span> <span class="n">bbb</span><span class="p">,</span> <span class="n">ccc</span><span class="p">,</span> <span class="n">ddd</span><span class="p">,</span> <span class="n">eee</span><span class="p">,</span> <span class="n">mmm</span><span class="p">;</span>

    <span class="n">aaa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">bbb</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">eee</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
    <span class="n">mmm</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">ccc</span> <span class="o">=</span> <span class="n">max_func</span><span class="p">(</span><span class="n">aaa</span><span class="p">,</span> <span class="n">bbb</span><span class="p">);</span>
    <span class="n">ddd</span> <span class="o">=</span> <span class="p">(</span><span class="n">aaa</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">bbb</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">aaa</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">bbb</span><span class="p">);</span>
    <span class="n">eee</span> <span class="o">=</span> <span class="n">ddd</span><span class="p">;</span>
<span class="p">}</span>

</code></pre></div></div>

<ul>
  <li>ç¼–è¯‘æºç ä¸º elf æ–‡ä»¶è¿›è¡Œ gdb è°ƒè¯•</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gcc <span class="nt">-g</span> test.cpp <span class="nt">-o</span> <span class="nb">test</span>
</code></pre></div></div>

<ul>
  <li>é€šè¿‡ gdb å‘½ä»¤æŸ¥çœ‹ç¨‹åºæ±‡ç¼–ä»£ç </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>layout asm
</code></pre></div></div>
<hr />

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>0x4004ed &lt;max_func<span class="o">(</span>int, int<span class="o">)&gt;</span>           push   %rbp
0x4004ee &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+1&gt;         mov    %rsp,%rbp
0x4004f1 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+4&gt;         mov    %edi,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
0x4004f4 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+7&gt;         mov    %esi,-0x8<span class="o">(</span>%rbp<span class="o">)</span>
0x4004f7 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+10&gt;        mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x4004fa &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+13&gt;        cmp    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x4004fd &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+16&gt;        jle    0x400504 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+23&gt;
0x4004ff &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+18&gt;        mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400502 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+21&gt;        jmp    0x400507 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+26&gt;
0x400504 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+23&gt;        mov    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400507 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+26&gt;        pop    %rbp
0x400508 &lt;max_func<span class="o">(</span>int, int<span class="o">)</span>+27&gt;        retq
0x400509 &lt;main<span class="o">()&gt;</span>                       push   %rbp
0x40050a &lt;main<span class="o">()</span>+1&gt;                     mov    %rsp,%rbp
0x40050d &lt;main<span class="o">()</span>+4&gt;                     sub    <span class="nv">$0x20</span>,%rsp
0x400511 &lt;main<span class="o">()</span>+8&gt;                     movl   <span class="nv">$0x1</span>,-0x4<span class="o">(</span>%rbp<span class="o">)</span>
0x400518 &lt;main<span class="o">()</span>+15&gt;                    movl   <span class="nv">$0x2</span>,-0x8<span class="o">(</span>%rbp<span class="o">)</span>
0x40051f &lt;main<span class="o">()</span>+22&gt;                    movl   <span class="nv">$0x3</span>,-0xc<span class="o">(</span>%rbp<span class="o">)</span>
0x400526 &lt;main<span class="o">()</span>+29&gt;                    movl   <span class="nv">$0x4</span>,-0x10<span class="o">(</span>%rbp<span class="o">)</span>
0x40052d &lt;main<span class="o">()</span>+36&gt;                    mov    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%edx
0x400530 &lt;main<span class="o">()</span>+39&gt;                    mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400533 &lt;main<span class="o">()</span>+42&gt;                    mov    %edx,%esi
0x400535 &lt;main<span class="o">()</span>+44&gt;                    mov    %eax,%edi
0x400537 &lt;main<span class="o">()</span>+46&gt;                    callq  0x4004ed &lt;max_func<span class="o">(</span>int, int<span class="o">)&gt;</span>
0x40053c &lt;main<span class="o">()</span>+51&gt;                    mov    %eax,-0x14<span class="o">(</span>%rbp<span class="o">)</span>
0x40053f &lt;main<span class="o">()</span>+54&gt;                    mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400542 &lt;main<span class="o">()</span>+57&gt;                    cmp    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400545 &lt;main<span class="o">()</span>+60&gt;                    jle    0x40054c &lt;main<span class="o">()</span>+67&gt;
0x400547 &lt;main<span class="o">()</span>+62&gt;                    mov    <span class="nt">-0x4</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x40054a &lt;main<span class="o">()</span>+65&gt;                    jmp    0x40054f &lt;main<span class="o">()</span>+70&gt;
0x40054c &lt;main<span class="o">()</span>+67&gt;                    mov    <span class="nt">-0x8</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x40054f &lt;main<span class="o">()</span>+70&gt;                    mov    %eax,-0x18<span class="o">(</span>%rbp<span class="o">)</span>
0x400552 &lt;main<span class="o">()</span>+73&gt;                    mov    <span class="nt">-0x18</span><span class="o">(</span>%rbp<span class="o">)</span>,%eax
0x400555 &lt;main<span class="o">()</span>+76&gt;                    mov    %eax,-0xc<span class="o">(</span>%rbp<span class="o">)</span>
0x400558 &lt;main<span class="o">()</span>+79&gt;                    mov    <span class="nv">$0x0</span>,%eax
0x40055d &lt;main<span class="o">()</span>+84&gt;                    leaveq
0x40055e &lt;main<span class="o">()</span>+85&gt;                    retq
</code></pre></div></div>

<hr />

<h2 id="2-æ±‡ç¼–çŸ¥è¯†">2. æ±‡ç¼–çŸ¥è¯†</h2>

<p>æµ‹è¯•ä¸­å‡ºç°çš„æ±‡ç¼–çŸ¥è¯†ã€‚</p>

<h3 id="21-å¯„å­˜å™¨">2.1. å¯„å­˜å™¨</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å¯„å­˜å™¨</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">rbp</td>
      <td style="text-align: left">64 bit æ ˆåŸºå€å¯„å­˜å™¨â€”æŒ‡å‘æ ˆåº•é¡¶</td>
    </tr>
    <tr>
      <td style="text-align: left">ebp</td>
      <td style="text-align: left">32 bit æ ˆåŸºå€å¯„å­˜å™¨â€”æŒ‡å‘æ ˆåº•</td>
    </tr>
    <tr>
      <td style="text-align: left">bp</td>
      <td style="text-align: left">16 bit æ ˆåŸºå€å¯„å­˜å™¨â€”æŒ‡å‘æ ˆåº•</td>
    </tr>
    <tr>
      <td style="text-align: left">rsp</td>
      <td style="text-align: left">64 bit æ ˆå¯„å­˜å™¨â€”æŒ‡å‘æ ˆé¡¶</td>
    </tr>
    <tr>
      <td style="text-align: left">esp</td>
      <td style="text-align: left">32 bit æ ˆå¯„å­˜å™¨â€”æŒ‡å‘æ ˆé¡¶</td>
    </tr>
    <tr>
      <td style="text-align: left">sp</td>
      <td style="text-align: left">16 bit æ ˆå¯„å­˜å™¨â€”æŒ‡å‘æ ˆé¡¶</td>
    </tr>
    <tr>
      <td style="text-align: left">eax</td>
      <td style="text-align: left">32 bit é€šç”¨å¯„å­˜å™¨</td>
    </tr>
    <tr>
      <td style="text-align: left">rip</td>
      <td style="text-align: left">64 bit åœ°å€åç§»å¯„å­˜å™¨</td>
    </tr>
  </tbody>
</table>

<h3 id="22-æ±‡ç¼–æŒ‡ä»¤">2.2. æ±‡ç¼–æŒ‡ä»¤</h3>

<table>
  <thead>
    <tr>
      <th style="text-align: left">å‘½ä»¤</th>
      <th style="text-align: left">æè¿°</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">jmp</td>
      <td style="text-align: left">æ— æ¡ä»¶æ®µå†…ç›´æ¥è½¬ç§»æŒ‡ä»¤</td>
    </tr>
    <tr>
      <td style="text-align: left">sub</td>
      <td style="text-align: left">å‡æ³•æŒ‡ä»¤</td>
    </tr>
    <tr>
      <td style="text-align: left">jle</td>
      <td style="text-align: left"><a href="https://zhidao.baidu.com/question/284101534.html">æ¡ä»¶è½¬ç§»æŒ‡ä»¤</a></td>
    </tr>
    <tr>
      <td style="text-align: left">mov</td>
      <td style="text-align: left">ä¼ é€æŒ‡ä»¤  (movl 32ä½, movw 16ä½, movb 8ä½)</td>
    </tr>
    <tr>
      <td style="text-align: left">cmp</td>
      <td style="text-align: left">æ¯”è¾ƒæŒ‡ä»¤</td>
    </tr>
    <tr>
      <td style="text-align: left">push</td>
      <td style="text-align: left">è¿›æ ˆæŒ‡ä»¤</td>
    </tr>
    <tr>
      <td style="text-align: left">pop</td>
      <td style="text-align: left">å‡ºæ ˆæŒ‡ä»¤</td>
    </tr>
    <tr>
      <td style="text-align: left">ret</td>
      <td style="text-align: left">æ®µå†…è¿‡ç¨‹è¿”å›æŒ‡ä»¤ï¼Œä½¿å­ç¨‹åºç»“æŸï¼Œç»§ç»­æ‰§è¡Œä¸»ç¨‹åº</td>
    </tr>
    <tr>
      <td style="text-align: left">callq</td>
      <td style="text-align: left">ç›¸å½“äº pushq %ripï¼›   jmpq addr</td>
    </tr>
    <tr>
      <td style="text-align: left">leaveq</td>
      <td style="text-align: left">ç›¸å½“äº movq %rbpï¼›    %rsp popq %rbp</td>
    </tr>
    <tr>
      <td style="text-align: left">retq</td>
      <td style="text-align: left">ç›¸å½“äº popq %rip</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>callqï¼Œleaveqï¼Œretq ä¸­çš„qæ˜¯æŒ‡64ä½æ“ä½œæ•°</p>
</blockquote>

<hr />

<h2 id="3-å‚è€ƒ">3. å‚è€ƒ</h2>

<ul>
  <li><a href="https://blog.csdn.net/linuxheik/article/details/49277041?t=1488286725179">hook leaveq retq</a></li>
  <li><a href="https://github.com/zhangyachen/zhangyachen.github.io/issues/134">GDB å•æ­¥è°ƒè¯•æ±‡ç¼–</a></li>
  <li><a href="https://blog.csdn.net/qq_36982160/article/details/82950848">æ±‡ç¼–å¸¸ç”¨æŒ‡ä»¤</a></li>
  <li><a href="https://www.cnblogs.com/daryl-blog/p/11369588.html">é€šç”¨32ä½CPU å¸¸ç”¨å¯„å­˜å™¨åŠå…¶ä½œç”¨</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET