I"¼<p>rdb æ–‡ä»¶æ˜¯ä¸€ä¸ªç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ˜¯ redis æŒä¹…åŒ–æ–¹å¼ä¹‹ä¸€ã€‚æœ¬ç« ä¸»è¦è®² rdb åº”ç”¨åœºæ™¯ã€‚</p>

<ul id="markdown-toc">
  <li><a href="#1-é…ç½®" id="markdown-toc-1-é…ç½®">1. é…ç½®</a></li>
  <li><a href="#2-å¼‚æ­¥æŒä¹…åŒ–" id="markdown-toc-2-å¼‚æ­¥æŒä¹…åŒ–">2. å¼‚æ­¥æŒä¹…åŒ–</a></li>
  <li><a href="#3-åº”ç”¨åœºæ™¯" id="markdown-toc-3-åº”ç”¨åœºæ™¯">3. åº”ç”¨åœºæ™¯</a>    <ul>
      <li><a href="#31-æœåŠ¡å¯åŠ¨åŠ è½½æ•°æ®" id="markdown-toc-31-æœåŠ¡å¯åŠ¨åŠ è½½æ•°æ®">3.1. æœåŠ¡å¯åŠ¨åŠ è½½æ•°æ®</a></li>
      <li><a href="#32-å‘½ä»¤" id="markdown-toc-32-å‘½ä»¤">3.2. å‘½ä»¤</a></li>
      <li><a href="#33-æ•°æ®å®šæœŸæŒä¹…åŒ–" id="markdown-toc-33-æ•°æ®å®šæœŸæŒä¹…åŒ–">3.3. æ•°æ®å®šæœŸæŒä¹…åŒ–</a></li>
      <li><a href="#34-é‡å†™-aof-æ–‡ä»¶" id="markdown-toc-34-é‡å†™-aof-æ–‡ä»¶">3.4. é‡å†™ aof æ–‡ä»¶</a></li>
      <li><a href="#35-ä¿¡å·ç»ˆæ­¢è¿›ç¨‹" id="markdown-toc-35-ä¿¡å·ç»ˆæ­¢è¿›ç¨‹">3.5. ä¿¡å·ç»ˆæ­¢è¿›ç¨‹</a></li>
      <li><a href="#36-ä¸»ä»å¤åˆ¶" id="markdown-toc-36-ä¸»ä»å¤åˆ¶">3.6. ä¸»ä»å¤åˆ¶</a></li>
    </ul>
  </li>
  <li><a href="#4-æ€»ç»“" id="markdown-toc-4-æ€»ç»“">4. æ€»ç»“</a></li>
  <li><a href="#5-å‚è€ƒ" id="markdown-toc-5-å‚è€ƒ">5. å‚è€ƒ</a></li>
</ul>

<hr />

<h2 id="1-é…ç½®">1. é…ç½®</h2>

<p>redis æœ‰ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ï¼Œåˆ†åˆ«ä¸ºï¼šaof å’Œ rdbï¼Œé»˜è®¤å¼€å¯ rdbï¼Œæœ¬ç« é‡ç‚¹è®² rdbã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
appendonly no
</code></pre></div></div>

<hr />

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">standardConfig</span> <span class="n">configs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">...</span>
   <span class="n">createBoolConfig</span><span class="p">(</span><span class="s">"appendonly"</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MODIFIABLE_CONFIG</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">updateAppendonly</span><span class="p">),</span>
   <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">aof_enabled</span> <span class="o">?</span> <span class="n">AOF_ON</span> <span class="o">:</span> <span class="n">AOF_OFF</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="2-å¼‚æ­¥æŒä¹…åŒ–">2. å¼‚æ­¥æŒä¹…åŒ–</h2>

<p>redis ä¸»é€»è¾‘æ˜¯åœ¨å•è¿›ç¨‹ï¼Œå•çº¿ç¨‹é‡Œå®ç°çš„ã€‚åƒæŒä¹…åŒ–è¿™ç§è€—å¤§é‡æ€§èƒ½çš„æ“ä½œï¼Œä¸»è¿›ç¨‹ä¸€èˆ¬ä¼šé€šè¿‡ fork å­è¿›ç¨‹å¼‚æ­¥è¿›è¡Œã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// ä¸»è¿›ç¨‹ fork å­è¿›ç¨‹å­˜ç›˜</span>
<span class="kt">int</span> <span class="nf">rdbSaveBackground</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">rdbSaveInfo</span> <span class="o">*</span><span class="n">rsi</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">childpid</span> <span class="o">=</span> <span class="n">redisFork</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="cm">/* Child */</span>
        <span class="n">retval</span> <span class="o">=</span> <span class="n">rdbSave</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">rsi</span><span class="p">);</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="3-åº”ç”¨åœºæ™¯">3. åº”ç”¨åœºæ™¯</h2>

<p><img src="/images/2020-03-19-13-08-31.png" alt="å¿«ç…§åº”ç”¨åœºæ™¯" data-action="zoom" /></p>

<h3 id="31-æœåŠ¡å¯åŠ¨åŠ è½½æ•°æ®">3.1. æœåŠ¡å¯åŠ¨åŠ è½½æ•°æ®</h3>

<p>redis ç¨‹åºå¯åŠ¨ï¼Œä»ç£ç›˜ rdb æ–‡ä»¶åŠ è½½æ•°æ®åˆ°å†…å­˜ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">sentinel_mode</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">loadDataFromDisk</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* flags on the purpose of rdb save or load */</span>
<span class="cp">#define RDBFLAGS_NONE 0
#define RDBFLAGS_AOF_PREAMBLE (1&lt;&lt;0)
#define RDBFLAGS_REPLICATION (1&lt;&lt;1)
</span>
<span class="cm">/* Function called at startup to load RDB or AOF file in memory. */</span>
<span class="kt">void</span> <span class="nf">loadDataFromDisk</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ustime</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_state</span> <span class="o">==</span> <span class="n">AOF_ON</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">loadAppendOnlyFile</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_filename</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span>
            <span class="p">...</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">rdbSaveInfo</span> <span class="n">rsi</span> <span class="o">=</span> <span class="n">RDB_SAVE_INFO_INIT</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbLoad</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">,</span><span class="n">RDBFLAGS_NONE</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="32-å‘½ä»¤">3.2. å‘½ä»¤</h3>

<ul>
  <li><code class="highlighter-rouge">SAVE</code> å‘½ä»¤åŒæ­¥å­˜ç›˜ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">saveCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rdbSave</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">ok</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">addReply</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">shared</span><span class="p">.</span><span class="n">err</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">BGSAVE</code> å‘½ä»¤ï¼Œä¸»è¿›ç¨‹é€šè¿‡ <code class="highlighter-rouge">fork</code> å­è¿›ç¨‹è¿›è¡Œå¼‚æ­¥å­˜ç›˜ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">bgsaveCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyError</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background save already in progress"</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hasActiveChildProcess</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">schedule</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">server</span><span class="p">.</span><span class="n">rdb_bgsave_scheduled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="n">addReplyStatus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background saving scheduled"</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveBackground</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">addReplyStatus</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="s">"Background saving started"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">FLUSHALL</code> æ¸…ç©ºæ•°æ®åº“åå­˜ç›˜ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">flushallCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">flushAllDataAndResetRDB</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="cm">/* Flushes the whole server data set. */</span>
<span class="kt">void</span> <span class="nf">flushAllDataAndResetRDB</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">server</span><span class="p">.</span><span class="n">dirty</span> <span class="o">+=</span> <span class="n">emptyDb</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">flags</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">killRDBChild</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">saveparamslen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* Normally rdbSave() will reset dirty, but we don't want this here
         * as otherwise FLUSHALL will not be replicated nor put into the AOF. */</span>
        <span class="kt">int</span> <span class="n">saved_dirty</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">dirty</span><span class="p">;</span>
        <span class="n">rdbSaveInfo</span> <span class="n">rsi</span><span class="p">,</span> <span class="o">*</span><span class="n">rsiptr</span><span class="p">;</span>
        <span class="n">rsiptr</span> <span class="o">=</span> <span class="n">rdbPopulateSaveInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">);</span>
        <span class="n">rdbSave</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">dirty</span> <span class="o">=</span> <span class="n">saved_dirty</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">server</span><span class="p">.</span><span class="n">dirty</span><span class="o">++</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li><code class="highlighter-rouge">SHUTDOWN</code> å‘½ä»¤å…³é—­æœåŠ¡ã€‚
æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯é€šè¿‡å®šæœŸç­–ç•¥å¯¹å†…å­˜æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œå†…å­˜æ•°æ®å’ŒæŒä¹…åŒ–æ–‡ä»¶æ•°æ®ä¸åŒæ­¥çš„ï¼Œæ‰€ä»¥å½“æœåŠ¡æ­£å¸¸é€€å‡ºæˆ–è€…é‡å¯ï¼Œéœ€è¦å°†å†…å­˜æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">shutdownCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">prepareForShutdown</span><span class="p">(</span><span class="n">flags</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">prepareForShutdown</span><span class="p">(</span><span class="kt">int</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* Create a new RDB file before exiting. */</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">server</span><span class="p">.</span><span class="n">saveparamslen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">nosave</span><span class="p">)</span> <span class="o">||</span> <span class="n">save</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">rdbSaveInfo</span> <span class="n">rsi</span><span class="p">,</span> <span class="o">*</span><span class="n">rsiptr</span><span class="p">;</span>
        <span class="n">rsiptr</span> <span class="o">=</span> <span class="n">rdbPopulateSaveInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSave</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="33-æ•°æ®å®šæœŸæŒä¹…åŒ–">3.3. æ•°æ®å®šæœŸæŒä¹…åŒ–</h3>

<p>rdb æŒä¹…åŒ–æ˜¯æœ‰æ¡ä»¶é™åˆ¶çš„ï¼š</p>

<ol>
  <li>æ•°æ®ä¿®æ”¹ä¸ªæ•°ã€‚</li>
  <li>å­˜ç›˜æ—¶é—´é—´éš”ã€‚</li>
</ol>

<ul>
  <li>é»˜è®¤é…ç½®
ä»é»˜è®¤é…ç½®çœ‹ï¼Œrdb æŒä¹…åŒ–ä¸æ˜¯å®æ—¶çš„ã€‚æ—¶é—´é—´éš”ï¼Œæœ€å¤§ 900 ç§’ï¼ˆ15 åˆ†é’Ÿï¼‰ï¼Œæœ€å° 60 ç§’ï¼ˆ1åˆ†é’Ÿï¼‰ï¼Œæ‰€ä»¥ç”¨ rdb åšæŒä¹…åŒ–ä¸¢å¤±æ•°æ®é£é™©æ¯”è¾ƒå¤§ã€‚</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
<span class="c">################################ SNAPSHOTTING  ################################</span>
<span class="c">#</span>
<span class="c"># Save the DB on disk:</span>
<span class="c">#</span>
<span class="c">#   save &lt;seconds&gt; &lt;changes&gt;</span>
<span class="c">#</span>
<span class="c">#   Will save the DB if both the given number of seconds and the given</span>
<span class="c">#   number of write operations against the DB occurred.</span>
<span class="c">#</span>
<span class="c">#   In the example below the behaviour will be to save:</span>
<span class="c">#   after 900 sec (15 min) if at least 1 key changed</span>
<span class="c">#   after 300 sec (5 min) if at least 10 keys changed</span>
<span class="c">#   after 60 sec if at least 10000 keys changed</span>
<span class="c">#</span>
<span class="c">#   Note: you can disable saving completely by commenting out all "save" lines.</span>
<span class="c">#</span>
<span class="c">#   It is also possible to remove all the previously configured save</span>
<span class="c">#   points by adding a save directive with a single empty string argument</span>
<span class="c">#   like in the following example:</span>
<span class="c">#</span>
<span class="c">#   save ""</span>

save 900 1
save 300 10
save 60 10000
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// rdb å®šæœŸå­˜ç›˜å‚æ•°</span>
<span class="k">struct</span> <span class="n">saveparam</span> <span class="p">{</span>
    <span class="kt">time_t</span> <span class="n">seconds</span><span class="p">;</span> <span class="c1">// æ—¶é—´é—´éš”</span>
    <span class="kt">int</span> <span class="n">changes</span><span class="p">;</span>    <span class="c1">// ä¿®æ”¹æ¬¡æ•°</span>
<span class="p">};</span>
</code></pre></div></div>

<ul>
  <li>æ—¶é’Ÿå®šæœŸæ£€æŸ¥å°†å†…å­˜æ•°æ®è¿›è¡Œ rdb æŒä¹…åŒ–ã€‚</li>
</ul>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#define CONFIG_BGSAVE_RETRY_DELAY 5 </span><span class="cm">/* Wait a few secs before trying again. */</span><span class="cp">
</span>
<span class="k">struct</span> <span class="n">redisServer</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">long</span> <span class="kt">long</span> <span class="n">dirty</span><span class="p">;</span>                <span class="cm">/* Changes to DB from the last save */</span>
    <span class="kt">time_t</span> <span class="n">lastsave</span><span class="p">;</span>                <span class="cm">/* Unix time of last successful save */</span>
    <span class="kt">time_t</span> <span class="n">lastbgsave_try</span><span class="p">;</span>          <span class="cm">/* Unix time of last attempted bgsave */</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">hasActiveChildProcess</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">server</span><span class="p">.</span><span class="n">rdb_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
           <span class="n">server</span><span class="p">.</span><span class="n">aof_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span>
           <span class="n">server</span><span class="p">.</span><span class="n">module_child_pid</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hasActiveChildProcess</span><span class="p">()</span> <span class="o">||</span> <span class="n">ldbPendingChildren</span><span class="p">())</span> <span class="p">{</span>
        <span class="c1">// å¦‚æœåå°æœ‰å­è¿›ç¨‹æ­£åœ¨è¿›è¡Œæ´»åŠ¨ï¼Œæ£€æŸ¥è¿›ç¨‹æ˜¯å¦å·²ç»ç»ˆæ­¢ã€‚</span>
        <span class="n">checkChildrenDone</span><span class="p">();</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">server</span><span class="p">.</span><span class="n">saveparamslen</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">struct</span> <span class="n">saveparam</span> <span class="o">*</span><span class="n">sp</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">saveparams</span><span class="o">+</span><span class="n">j</span><span class="p">;</span>

            <span class="c1">// éœ€è¦æ»¡è¶³é»˜è®¤æ•°æ®ä¿å­˜é¢‘ç‡æ¡ä»¶ã€‚</span>
            <span class="c1">// å¦‚æœä¸Šæ¬¡å­˜ç›˜å¤±è´¥åï¼Œéœ€è¦å»¶æ—¶ CONFIG_BGSAVE_RETRY_DELAY å†è¿›è¡Œæ“ä½œã€‚</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">dirty</span> <span class="o">&gt;=</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">changes</span> <span class="o">&amp;&amp;</span>
                <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="o">-</span><span class="n">server</span><span class="p">.</span><span class="n">lastsave</span> <span class="o">&gt;</span> <span class="n">sp</span><span class="o">-&gt;</span><span class="n">seconds</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="o">-</span><span class="n">server</span><span class="p">.</span><span class="n">lastbgsave_try</span> <span class="o">&gt;</span>
                 <span class="n">CONFIG_BGSAVE_RETRY_DELAY</span> <span class="o">||</span>
                 <span class="n">server</span><span class="p">.</span><span class="n">lastbgsave_status</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_NOTICE</span><span class="p">,</span><span class="s">"%d changes in %d seconds. Saving..."</span><span class="p">,</span>
                    <span class="n">sp</span><span class="o">-&gt;</span><span class="n">changes</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">seconds</span><span class="p">);</span>
                <span class="n">rdbSaveInfo</span> <span class="n">rsi</span><span class="p">,</span> <span class="o">*</span><span class="n">rsiptr</span><span class="p">;</span>
                <span class="n">rsiptr</span> <span class="o">=</span> <span class="n">rdbPopulateSaveInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">);</span>
                <span class="n">rdbSaveBackground</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
    <span class="c1">// æˆ‘ä»¬åœ¨æ‰§è¡Œ BGSAVE å‘½ä»¤æ—¶ï¼Œå½“æ—¶æœ‰å…¶å®ƒå­è¿›ç¨‹æ­£åœ¨è¿›è¡Œå·¥ä½œï¼Œæ‰€ä»¥è¯¥å‘½ä»¤è¢«å®‰æ’å»¶åå¤„ç†ã€‚</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasActiveChildProcess</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
        <span class="n">server</span><span class="p">.</span><span class="n">rdb_bgsave_scheduled</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">unixtime</span><span class="o">-</span><span class="n">server</span><span class="p">.</span><span class="n">lastbgsave_try</span> <span class="o">&gt;</span> <span class="n">CONFIG_BGSAVE_RETRY_DELAY</span> <span class="o">||</span>
         <span class="n">server</span><span class="p">.</span><span class="n">lastbgsave_status</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="n">rdbSaveInfo</span> <span class="n">rsi</span><span class="p">,</span> <span class="o">*</span><span class="n">rsiptr</span><span class="p">;</span>
        <span class="n">rsiptr</span> <span class="o">=</span> <span class="n">rdbPopulateSaveInfo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsi</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveBackground</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span>
            <span class="n">server</span><span class="p">.</span><span class="n">rdb_bgsave_scheduled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="34-é‡å†™-aof-æ–‡ä»¶">3.4. é‡å†™ aof æ–‡ä»¶</h3>

<p>aof æ–‡ä»¶åœ¨é‡å†™è¿‡ç¨‹ä¸­ï¼Œä¸ºäº†å¿«é€Ÿå°†æ•°æ®è½åœ°ï¼Œä¹Ÿä¼šå°†æ–‡ä»¶ä¿å­˜æˆ rdb æ–‡ä»¶ï¼Œrdb æ–‡ä»¶é‡Œä¼šä¿å­˜ aof æ ‡è¯†è¿›è¡Œè¯†åˆ«ã€‚</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># redis.conf</span>
<span class="c">#</span>
<span class="c"># When rewriting the AOF file, Redis is able to use an RDB preamble in the</span>
<span class="c"># AOF file for faster rewrites and recoveries. When this option is turned</span>
<span class="c"># on the rewritten AOF file is composed of two different stanzas:</span>
<span class="c">#</span>
<span class="c">#   [RDB file][AOF tail]</span>
<span class="c">#</span>
<span class="c"># When loading Redis recognizes that the AOF file starts with the "REDIS"</span>
<span class="c"># string and loads the prefixed RDB file, and continues loading the AOF</span>
<span class="c"># tail.</span>
aof-use-rdb-preamble <span class="nb">yes</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// é‡å†™ aof æ–‡ä»¶</span>
<span class="kt">int</span> <span class="nf">rewriteAppendOnlyFile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">startSaving</span><span class="p">(</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">aof_use_rdb_preamble</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">error</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbSaveRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">aof</span><span class="p">,</span><span class="o">&amp;</span><span class="n">error</span><span class="p">,</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_ERR</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">errno</span> <span class="o">=</span> <span class="n">error</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">werr</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="c1">// åŠ è½½ aof æ–‡ä»¶</span>
<span class="kt">int</span> <span class="nf">loadAppendOnlyFile</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="kt">char</span> <span class="n">sig</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span> <span class="cm">/* "REDIS" */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fread</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="n">fp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span><span class="s">"REDIS"</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="cm">/* No RDB preamble, seek back at 0 offset. */</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fseek</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">SEEK_SET</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">goto</span> <span class="n">readerr</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="c1">// ä» rdb æ–‡ä»¶åŠ è½½ aof éœ€è¦çš„æ•°æ®ã€‚</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rdbLoadRio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rdb</span><span class="p">,</span><span class="n">RDBFLAGS_AOF_PREAMBLE</span><span class="p">,</span><span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">C_OK</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="35-ä¿¡å·ç»ˆæ­¢è¿›ç¨‹">3.5. ä¿¡å·ç»ˆæ­¢è¿›ç¨‹</h3>

<p>æœåŠ¡è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯é€šè¿‡å®šæœŸç­–ç•¥å¯¹å†…å­˜æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œå†…å­˜æ•°æ®å’ŒæŒä¹…åŒ–æ–‡ä»¶æ•°æ®ä¸åŒæ­¥çš„ï¼Œæ‰€ä»¥å½“æœåŠ¡æ­£å¸¸é€€å‡ºæˆ–è€…é‡å¯ï¼Œéœ€è¦å°†å†…å­˜æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ã€‚</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">initServer</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">setupSignalHandlers</span><span class="p">();</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="cp">#define SIGINT  2       </span><span class="cm">/* interrupt */</span><span class="cp">
#define SIGTERM 15      </span><span class="cm">/* software termination signal from kill */</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">setupSignalHandlers</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">struct</span> <span class="n">sigaction</span> <span class="n">act</span><span class="p">;</span>

    <span class="cm">/* When the SA_SIGINFO flag is set in sa_flags then sa_sigaction is used.
     * Otherwise, sa_handler is used. */</span>
    <span class="n">sigemptyset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act</span><span class="p">.</span><span class="n">sa_mask</span><span class="p">);</span>
    <span class="n">act</span><span class="p">.</span><span class="n">sa_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">act</span><span class="p">.</span><span class="n">sa_handler</span> <span class="o">=</span> <span class="n">sigShutdownHandler</span><span class="p">;</span>
    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">sigaction</span><span class="p">(</span><span class="n">SIGINT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">act</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sigShutdownHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="n">server</span><span class="p">.</span><span class="n">shutdown_asap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">serverCron</span><span class="p">(</span><span class="k">struct</span> <span class="n">aeEventLoop</span> <span class="o">*</span><span class="n">eventLoop</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">clientData</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* We received a SIGTERM, shutting down here in a safe way, as it is
     * not ok doing so inside the signal handler. */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">shutdown_asap</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">prepareForShutdown</span><span class="p">(</span><span class="n">SHUTDOWN_NOFLAGS</span><span class="p">)</span> <span class="o">==</span> <span class="n">C_OK</span><span class="p">)</span> <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
        <span class="n">serverLog</span><span class="p">(</span><span class="n">LL_WARNING</span><span class="p">,</span><span class="s">"SIGTERM received but errors trying to shut down the server, check the logs for more information"</span><span class="p">);</span>
        <span class="n">server</span><span class="p">.</span><span class="n">shutdown_asap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h3 id="36-ä¸»ä»å¤åˆ¶">3.6. ä¸»ä»å¤åˆ¶</h3>

<p>ä¸»ä»å¤åˆ¶ï¼Œå…¨é‡åŒæ­¥æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ rdb æ–‡ä»¶ä¼ è¾“ã€‚rdb æ–‡ä»¶å¯ä»¥é‡‡ç”¨ç¡¬ç›˜å¤‡ä»½æ–¹å¼ï¼›ä¹Ÿå¯ä»¥æ— ç›˜å¤‡ä»½ï¼Œæ•°æ®ä¸å­˜ç›˜ï¼Œç›´æ¥é€šè¿‡ socket å‘é€ç»™å…¶å®ƒæœåŠ¡ã€‚</p>

<p>ä»æœåŠ¡åˆšå¯åŠ¨æˆ–å› ç½‘ç»œåŸå› ï¼Œä¸ä¸»æœåŠ¡é•¿æ—¶é—´æ–­å¼€ï¼Œé‡è¿åå‘ç°ä¸»ä»æ•°æ®å·²ç»ä¸¥é‡ä¸åŒ¹é…äº†ï¼Œä¸»æœåŠ¡éœ€è¦å°†å†…å­˜æ•°æ®ä¿å­˜æˆ rdb äºŒè¿›åˆ¶å‹ç¼©æ–‡ä»¶ï¼Œä¼ é€ç»™è¿™äº›é‡æ–°é“¾æ¥çš„æœåŠ¡ã€‚</p>

<blockquote>
  <p>ä¸€ä¸»å¤šä»æ¶æ„ï¼Œå¦‚æœå‡ºç°ç½‘ç»œé—®é¢˜ï¼Œæç«¯æƒ…å†µï¼Œä¸»æœåŠ¡è¦ç»™å¤šä¸ªä»æœåŠ¡å‘é€ rdb æ–‡ä»¶æ•°æ®ï¼Œæ•°æ®é‡å¤§çš„è¯ï¼Œå¯èƒ½ä¼šé€ æˆç½‘ç»œæ‹¥å µï¼Œæ‰€ä»¥ä»æœåŠ¡å°½é‡å°‘å§ã€‚å¦‚æœåº”ç”¨åœºæ™¯ç¡®å®éœ€è¦ï¼Œå¯ä»¥å¯ç”¨å¤šçº§ä»æœåŠ¡ï¼ˆchained slaves (slaves of slaves)ï¼‰ï¼Œé¿å…ä¸»æœåŠ¡å‡ºç°è¿‡è½½é—®é¢˜ã€‚</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/* State of slaves from the POV of the master. Used in client-&gt;replstate.
 * In SEND_BULK and ONLINE state the slave receives new updates
 * in its output queue. In the WAIT_BGSAVE states instead the server is waiting
 * to start the next background saving in order to send updates to it. */</span>
<span class="cp">#define SLAVE_STATE_WAIT_BGSAVE_START 6 </span><span class="cm">/* We need to produce a new RDB file. */</span><span class="cp">
#define SLAVE_STATE_WAIT_BGSAVE_END 7 </span><span class="cm">/* Waiting RDB file creation to finish. */</span><span class="cp">
#define SLAVE_STATE_SEND_BULK 8 </span><span class="cm">/* Sending RDB file to slave. */</span><span class="cp">
#define SLAVE_STATE_ONLINE 9 </span><span class="cm">/* RDB file transmitted, sending just updates. */</span><span class="cp">
</span>
<span class="kt">void</span> <span class="nf">syncCommand</span><span class="p">(</span><span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* Setup the slave as one waiting for BGSAVE to start. The following code
     * paths will change the state if we handle the slave differently. */</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">replstate</span> <span class="o">=</span> <span class="n">SLAVE_STATE_WAIT_BGSAVE_START</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">replicationCron</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="cm">/* å¦‚æœä½¿ç”¨æ— ç¡¬ç›˜å¤‡ä»½ï¼Œä¸»æœåŠ¡ä¼šåœ¨å¼€å§‹ä¼ é€å‰ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼ˆrepl_diskless_sync_delayï¼‰ï¼Œ
    è¿™è¿‡ç¨‹ä¸­å¯èƒ½æœ‰å¤šä¸ªæœåŠ¡é“¾æ¥ä¸Šæ¥éœ€è¦å…¨é‡åŒæ­¥æ•°æ®çš„ï¼Œé‚£ä¹ˆä¸€èµ·åŒæ­¥ã€‚*/</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hasActiveChildProcess</span><span class="p">())</span> <span class="p">{</span>
        <span class="kt">time_t</span> <span class="n">idle</span><span class="p">,</span> <span class="n">max_idle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">slaves_waiting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">mincapa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="n">listNode</span> <span class="o">*</span><span class="n">ln</span><span class="p">;</span>
        <span class="n">listIter</span> <span class="n">li</span><span class="p">;</span>

        <span class="c1">// éå†ä»æœåŠ¡ï¼Œç¡®è®¤æ˜¯å¦éœ€è¦ä¸»ä»å¤åˆ¶ã€‚</span>
        <span class="n">listRewind</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">slaves</span><span class="p">,</span><span class="o">&amp;</span><span class="n">li</span><span class="p">);</span>
        <span class="k">while</span><span class="p">((</span><span class="n">ln</span> <span class="o">=</span> <span class="n">listNext</span><span class="p">(</span><span class="o">&amp;</span><span class="n">li</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">client</span> <span class="o">*</span><span class="n">slave</span> <span class="o">=</span> <span class="n">ln</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">replstate</span> <span class="o">==</span> <span class="n">SLAVE_STATE_WAIT_BGSAVE_START</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">idle</span> <span class="o">=</span> <span class="n">server</span><span class="p">.</span><span class="n">unixtime</span> <span class="o">-</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">lastinteraction</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">idle</span> <span class="o">&gt;</span> <span class="n">max_idle</span><span class="p">)</span> <span class="n">max_idle</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
                <span class="n">slaves_waiting</span><span class="o">++</span><span class="p">;</span>
                <span class="n">mincapa</span> <span class="o">=</span> <span class="p">(</span><span class="n">mincapa</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_capa</span> <span class="o">:</span>
                                            <span class="p">(</span><span class="n">mincapa</span> <span class="o">&amp;</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">slave_capa</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">slaves_waiting</span> <span class="o">&amp;&amp;</span>
            <span class="p">(</span><span class="o">!</span><span class="n">server</span><span class="p">.</span><span class="n">repl_diskless_sync</span> <span class="o">||</span>
             <span class="n">max_idle</span> <span class="o">&gt;</span> <span class="n">server</span><span class="p">.</span><span class="n">repl_diskless_sync_delay</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">startBgsaveForReplication</span><span class="p">(</span><span class="n">mincapa</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">startBgsaveForReplication</span><span class="p">(</span><span class="kt">int</span> <span class="n">mincapa</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">rsiptr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">socket_target</span><span class="p">)</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">rdbSaveToSlavesSockets</span><span class="p">(</span><span class="n">rsiptr</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="n">rdbSaveBackground</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">rdb_filename</span><span class="p">,</span><span class="n">rsiptr</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h2 id="4-æ€»ç»“">4. æ€»ç»“</h2>

<p>rdb ä½œä¸ºæŒä¹…åŒ–æ–¹å¼çš„ä¸€ç§ï¼Œå®ƒæ˜¯ä¸€ç§ç»è¿‡å‹ç¼©çš„äºŒè¿›åˆ¶æ•°æ®ã€‚</p>

<ul>
  <li>
    <p>ä¼˜ç‚¹ï¼šæŒä¹…åŒ–è¿‡ç¨‹ä¸­ï¼Œé€Ÿåº¦å¿«ï¼Œæ–‡ä»¶ä½“ç§¯å°ã€‚æ–¹ä¾¿æ•°æ®å¿«é€Ÿè½åœ°ï¼Œæˆ–è€…é€šè¿‡ç½‘ç»œä¼ è¾“æ•°æ®ã€‚</p>
  </li>
  <li>
    <p>ç¼ºç‚¹ï¼š</p>
    <ol>
      <li>redis åªæ˜¯å°† rdb æ–‡ä»¶ä½œä¸ºä¸€ä¸ªå¤‡ä»½æ–‡ä»¶è€Œå·²ï¼ŒåŠŸèƒ½ç®€å•ï¼Œå¹¶ä¸èƒ½ä»æ–‡ä»¶ä¸­åšä¸€äº›æ•°æ®æŸ¥è¯¢åŠŸèƒ½æ“ä½œã€‚</li>
      <li>å¤‡ä»½å¸¸ç”¨æ–¹å¼æ˜¯é€šè¿‡æ—¶é’Ÿæ§åˆ¶ï¼Œä¸æ˜¯å®æ—¶çš„ï¼Œå¼‚å¸¸æƒ…å†µä¸¢å¤±æ•°æ®ä¼šæ¯”è¾ƒå¤šã€‚å¦‚æœæŠŠå®ƒä½œä¸ºä¸€ä¸ªæ•°æ®åº“æ¥åº”ç”¨ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚</li>
    </ol>
  </li>
</ul>

<hr />

<p>rdb è¿™ä¸€å—å†…å®¹æŒºå¤šçš„ï¼Œä¸€ç« èŠ‚å¤ªé•¿äº†ï¼Œæ‰€ä»¥åˆ†å¼€äº†ä¸¤ç« ï¼Œæœ¬ç« ä¸»è¦è®²åº”ç”¨åœºæ™¯ï¼Œæ–‡ä»¶ç»“æ„è¯·å‚è€ƒä¸‹ä¸€ç«  <a href="https://wenfh2020.com/2020/03/19/redis-rdb-struct/">rdb æŒä¹…åŒ– - æ–‡ä»¶ç»“æ„</a></p>

<hr />

<h2 id="5-å‚è€ƒ">5. å‚è€ƒ</h2>

<ul>
  <li><a href="https://github.com/menwengit/redis_source_annotation">redis 3.2.8 çš„æºç æ³¨é‡Š</a></li>
  <li><a href="https://blog.csdn.net/mishifangxiangdefeng/article/details/50032357">redisé…ç½®æ–‡ä»¶æ ·ä¾‹(äºŒ)</a></li>
</ul>

<hr />

<blockquote>
  <p>ğŸ”¥æ–‡ç« æ¥æºï¼š<a href="https://wenfh2020.com/">wenfh2020.com</a></p>
</blockquote>
:ET