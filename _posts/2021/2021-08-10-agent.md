---
layout: post
title:  "ç®€å•çš„ http é€šä¿¡æ ¡éªŒï¼ˆgolangï¼‰"
categories: network golang
tags: aes æ•°å­—ç­¾å åŠ å¯†
author: wenfh2020
---

é€šè¿‡ http å®ç°ç®€å•çš„ç»ˆç«¯å’ŒæœåŠ¡çš„é€šä¿¡æ ¡éªŒã€‚æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯æºç é€šè¿‡ golang å®ç°ã€‚




* content
{:toc}

---

## 1. åè®®

| åè®®  | æ–¹æ³•  | æ•°æ®æ ¼å¼ |                 url                 |
| :---: | :---: | :------: | :---------------------------------: |
| http  | post  |   json   | http://xxxx.com/product/agent/check |

* request

```c
{
    "client": {
        "level": "23424343", /* ç”¨æˆ·ç­‰çº§ã€‚ */
        "type": "fdsfdsfa",  /* ç”¨æˆ·ç±»å‹ã€‚ */
    },
    "device" : {
        "mac": "dhsjfhjasfhjadfhjdasf", /* è®¾å¤‡ mac åœ°å€ï¼Œaes åŠ å¯†çš„å¯†æ–‡ã€‚ */
        "version": "12.34.4354"         /* è®¾å¤‡ç‰ˆæœ¬ä¿¡æ¯ã€‚ */
    },
    "time": "2010-03-13 10:00:11",       /* æ—¶é—´ï¼Œç”¨äºå®‰å…¨æ ¡éªŒã€‚ */
    "sign": "fhkdsahfjashfjkdshfjkdafda" /* æ•°å­—ç­¾åï¼Œç”¨äºå®‰å…¨æ ¡éªŒã€‚ */
}
```

* response

```c
{
    "errno": 0,      /* é”™è¯¯ç ï¼Œé»˜è®¤ 0 æ˜¯æ²¡æœ‰é”™è¯¯ã€‚ */
    "errstr": "xxx", /* é”™è¯¯æç¤ºï¼Œä¸é”™è¯¯ç å¯¹åº”ã€‚ */
    "device" : {
        "mac": "dhsjfhjasfhjadfhjdasf", /* è®¾å¤‡ mac åœ°å€ï¼Œaes åŠ å¯†çš„å¯†æ–‡ã€‚ã€‚ */
        "version": "12.34.4354"         /* è®¾å¤‡ç‰ˆæœ¬ä¿¡æ¯ã€‚ */
    },
    "activation": "ewruhfdjdsahfjkhfjsirewure", /* æ¿€æ´»ç ï¼Œaes åŠ å¯†çš„å¯†æ–‡ã€‚ */
    "time": "2010-03-14 10:00:11",              /* æ—¶é—´ï¼Œç”¨äºå®‰å…¨æ ¡éªŒã€‚ */
    "sign": "fdhsjfhdasjfhjasdfhjka"            /* æ•°å­—ç­¾åï¼Œç”¨äºå®‰å…¨æ ¡éªŒã€‚ */
}
```

---

## 2. å®‰å…¨

* é€šä¿¡å®‰å…¨ï¼Œé€šè¿‡ **æ•°å­—ç­¾å** ä¿è¯é€šä¿¡å®‰å…¨ï¼ˆé¿å…é€šä¿¡æ•°æ®åœ¨é€šä¿¡è¿‡ç¨‹ä¸­è¢«æˆªè·çªœæ”¹ï¼‰ã€‚
* æ•°æ®å®‰å…¨ï¼Œé€šè¿‡ aes å¯¹ç§°åŠ å¯†æ•°æ®ï¼Œé¿å…æ˜æ–‡ä¼ è¾“ï¼Œä¿è¯æ•°æ®å®‰å…¨ã€‚

---

### 2.1. aes åŠ å¯†

mac ä¿¡æ¯å’Œæ¿€æ´»ç éƒ½æ˜¯é€šè¿‡ aes å¯¹ç§°åŠ å¯†çš„ï¼Œå¯†åŒ™ç”±å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±åŒçº¦å®šã€‚åè®®ä¼ è¾“çš„è¿™ä¸¤ä¸ªæ•°æ®éƒ½æ˜¯å¯†æ–‡ï¼Œè¦è·å¾—æ˜æ–‡ï¼Œéœ€è¦é€šè¿‡ aes è§£å¯†ã€‚

```shell
å¯†æ–‡ = base64_encode(aes_encrypt(æ˜æ–‡ï¼Œå¯†åŒ™))
æ˜æ–‡ = base64_decode(aes_decrypt(å¯†æ–‡ï¼Œå¯†åŒ™))
```

---

### 2.2. æ•°å­—ç­¾åï¼ˆsignï¼‰

æ•°å­—ç­¾åæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ç»„åˆçš„æ ¡éªŒã€‚é€šè¿‡å¯¹ç»„åˆæ•°æ®çš„å¤„ç†ç»“æœï¼Œå¯¹æ¯”åè®®ä¼ è¿‡æ¥çš„ sign æ•°å­—ç­¾åæ˜¯å¦ä¸€æ ·ã€‚

```shell
sign = base64(sha1(md5(mac å¯†æ–‡å­—ç¬¦ä¸² + ç›å­—ç¬¦ä¸² + æ—¶é—´å­—ç¬¦ä¸²)))
```

---

## 3. æ•°æ®åº“

```sql
CREATE DATABASE IF NOT EXISTS lhl_product DEFAULT CHARSET utf8mb4 COLLATE utf8mb4_general_ci;

CREATE TABLE `device_info` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `device_mac` varchar(64) NOT NULL COMMENT 'è®¾å¤‡ç½‘å¡ mac åœ°å€',
  `device_version` varchar(64) NOT NULL COMMENT 'è¯·æ±‚æµæ°´ id',
  `activation` varchar(128) COMMENT 'è®¾å¤‡æ¿€æ´»ç ',
  `client_type` varchar(64) NOT NULL COMMENT 'ç”¨æˆ·ç±»å‹',
  `client_level` varchar(64) NOT NULL COMMENT 'ç”¨æˆ·ç­‰çº§',
  `status` tinyint(1) unsigned DEFAULT '1' COMMENT 'æ•°æ®çŠ¶æ€ï¼Œé»˜è®¤ 1 æœ‰æ•ˆï¼Œ0 æ— æ•ˆ',
  `active_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'æ¿€æ´»æ—¶é—´',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `mac` (`device_mac`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4;
```

---

## 4. æºç 

golang å®ç°çš„è½»é‡çº§ http æœåŠ¡ï¼Œæºç å·²æ”¾åœ¨ [github](https://github.com/wenfh2020/agent)ã€‚

æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ï¼š

* http é€šä¿¡åŠŸèƒ½ã€‚
* client / server æµ‹è¯•åŠŸèƒ½ï¼ˆ[client åŠŸèƒ½](https://github.com/wenfh2020/agent/blob/master/client/client.go)ï¼Œ[serveré€»è¾‘åŠŸèƒ½](https://github.com/wenfh2020/agent/blob/master/proto/proto.go)ï¼‰ã€‚
* [åŠ å¯†è§£å¯†åŠŸèƒ½](https://github.com/wenfh2020/agent/blob/master/common/crypto.go)ã€‚
* yaml é…ç½®æ–‡ä»¶è®¿é—®åŠŸèƒ½ã€‚
* log4go æ—¥å¿—åŠŸèƒ½ã€‚
* å®ç°ç®€å•çš„ gorm çš„ mysql è¿æ¥æ± åŠŸèƒ½ã€‚
* ä»£ç ç‰‡æ®µæµ‹è¯•åŠŸèƒ½ã€‚

```go
func main() {
    if err := initConfig(); err != nil {
        panic(err)
    }

    runtime.GOMAXPROCS(viper.GetInt("base.maxproc"))

    log.LoadConfiguration(viper.GetString("base.log"))
    defer log.Close()

    if err := initHTTP(); err != nil {
        panic(err)
    }

    if err := initDb(); err != nil {
        panic(err)
    }

    common.InitSignal()
}
```

---

## 5. åè®°

å¾ˆé•¿ä¸€æ®µæ—¶é—´æ²¡ä½¿ç”¨ **GO** (golang) äº†ï¼Œéƒ½æ˜¯è¾¹å†™è¾¹æŸ¥ï¼Œè™½ç„¶æ¯”è¾ƒç†Ÿæ‚‰ c/c++ï¼Œç°åœ¨å¤„ç†ä¸€äº›å°åŠŸèƒ½ï¼Œç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„è§£å†³æ–¹æ¡ˆæ˜¯ **GO**ã€‚

**GO** çš„ç”Ÿæ€å¼ºå¤§ï¼Œé«˜è´¨é‡çš„è½®å­å®åœ¨å¤ªå¤šå•¦ ğŸ˜¸ï¼è¯­æ³•ç®€æ´ï¼Œæˆ‘é™¤äº†ä¸çˆ½å®ƒçš„**å¤§å°å†™é™åˆ¶**ï¼Œå…¶å®ƒæ„Ÿè§‰è¿˜å¥½ã€‚

å¯¹äºæˆ‘ï¼Œæœ€é‡è¦çš„æ˜¯ï¼š<font color=red>èƒ½å°‘å†™å¾ˆå¤šä»£ç  ğŸ¥°ï¼</font>ç¡®è®¤è¿‡çœ¼ç¥ï¼Œç®€æ´é«˜æ•ˆï¼Œå¼ºå¤§ç”Ÿæ€ï¼Œæ–‡æ¡£å¥å…¨çš„è¯­è¨€ï¼š**GO** ç¡®å®æ˜¯æˆ‘çš„èœ~
