---
layout: post
title:  "简单的通信检验"
categories: network
tags: aes 数字签名 加密
author: wenfh2020
---

简单的终端和服务的校验逻辑。




* content
{:toc}

---

## 1. 协议

| 协议  | 方法  | 数据格式 |                 url                 |
| :---: | :---: | :------: | :---------------------------------: |
| http  | post  |   json   | http://xxxx.com/product/agent/check |

* request

```c
{
    "client": {
        "level": "23424343", /* 用户等级。 */
        "type": "fdsfdsfa",  /* 用户类型。 */
    },
    "device" : {
        "mac": "dhsjfhjasfhjadfhjdasf", /* 设备 mac 地址，aes 加密的密文。 */
        "version": "12.34.4354"         /* 设备版本信息。 */
    },
    "time": "2010-03-13 10:00:11",       /* 时间，用于安全校验。 */
    "sign": "fhkdsahfjashfjkdshfjkdafda" /* 数字签名，用于安全校验。 */
}
```

* response

```c
{
    "errno": 0,      /* 错误码，默认 0 是没有错误。 */
    "errstr": "xxx", /* 错误提示，与错误码对应。 */
    "device" : {
        "mac": "dhsjfhjasfhjadfhjdasf", /* 设备 mac 地址，aes 加密的密文。。 */
        "version": "12.34.4354"         /* 设备版本信息。 */
    },
    "activation": "ewruhfdjdsahfjkhfjsirewure", /* 激活码，aes 加密的密文。 */
    "time": "2010-03-14 10:00:11",              /* 时间，用于安全校验。 */
    "sign": "fdhsjfhdasjfhjasdfhjka"            /* 数字签名，用于安全校验。 */
}
```

---

## 2. 安全

* 通过 数字签名 保证通信安全（避免通信数据在通信过程中被截获窜改）。
* 通过 aes 对称加密数据，避免明文传输，保证数据安全。

---

### 2.1. 数字签名（sign）

数字签名是一个字符串组合的校验。通过对组合数据的处理结果，对比协议传过来的 sign 数字签名是否一样。

```shell
sign = base64(md5(mac 密文字符串 + 盐字符串 + 时间字符串))
```

---

### 2.2. aes 加密

mac 信息和激活码都是通过 aes 对称加密的，密匙由客户端和服务端共同约定。协议传输的这两个数据都是密文，要获得明文，需要通过 aes 解密。

```shell
明文 = aes（密匙，密文）
```
