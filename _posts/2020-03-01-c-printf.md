---
layout: post
title:  "printf ä»ç°è±¡åˆ°æœ¬è´¨"
categories: c/c++
tags: printf
author: wenfh2020
---

è®²çœŸï¼Œè¦æ·±å…¥ç†è§£ printfï¼Œåªèƒ½è‡ªå·±çœ‹æºç ã€‚



* content
{:toc}

---

## 1. ä»ç°è±¡åˆ°æœ¬è´¨

å‰äº›æ—¶é—´ï¼Œæœ‹å‹é—®äº†ä¸€ä¸ªé—®é¢˜ï¼š

`printf` çš„ `%s` æ ¼å¼è¾“å‡ºï¼Œå¦‚æœå‚æ•°æ˜¯å…¶å®ƒç±»å‹çš„æ•°æ®å¼ºåˆ¶è½¬æ¢ä¸º `char*` çš„ï¼Œç»“æœä¼šæ€ä¹ˆæ ·ï¼Ÿ

æˆ‘æƒ³æœ€å¥½çš„æ–¹æ³•è«è¿‡äºé©¬ä¸ŠåŠ¨æ‰‹æµ‹è¯•ä¸€ä¸‹ï¼Œçœ‹çœ‹ç»“æœã€‚å¦‚æœå†é—®ï¼šprintf æ˜¯çº¿ç¨‹å®‰å…¨çš„å—ï¼Ÿ... é—®é¢˜å¾ˆå¤šï¼Œè¿™äº›éƒ½åªæ˜¯é—®é¢˜çš„è¡¨è±¡ï¼Œè¦ä»ç°è±¡çœ‹æœ¬è´¨ã€‚Linux æ˜¯å¼€æºçš„ï¼Œä½•ä¸çœ‹æºç ç†è§£ç¨‹åºå·¥ä½œåŸç†å‘¢ï¼Ÿ

---

ä»æºç ä¸Šçœ‹ `strnlen` æ˜¯é€šè¿‡æŸ¥æ‰¾å†…å­˜çš„ â€˜\0â€™ å­—ç¬¦ä¸²ç»“æŸç¬¦çš„ã€‚å¦‚æœå¼ºåˆ¶è½¬æ¢çš„å†…å­˜æ•°æ®ï¼Œæ²¡æœ‰ â€˜\0â€™ ç»“æŸç¬¦ï¼Œé‚£ `strnlen` å°±ä¼šå‡ºç°é—®é¢˜ã€‚

```c
/* https://github.com/torvalds/linux/blob/master/arch/x86/boot/printf.c */

int printf(const char *fmt, ...) {
    char printf_buf[1024];
    va_list args;
    int printed;

    va_start(args, fmt);
    printed = vsprintf(printf_buf, fmt, args);
    va_end(args);

    puts(printf_buf);

    return printed;
}

int vsprintf(char *buf, const char *fmt, va_list args) {
    ...
    switch (*fmt) {
        ...
        case 's':
            s = va_arg(args, char *);
            len = strnlen(s, precision);

            if (!(flags & LEFT))
                while (len < field_width--)
                    *str++ = ' ';
            for (i = 0; i < len; ++i)
                *str++ = *s++;
            while (len < field_width--)
                *str++ = ' ';
            continue;
    }
    ...
}

/* https://github.com/torvalds/linux/blob/master/arch/x86/boot/string.c */

size_t strnlen(const char *s, size_t maxlen) {
    const char *es = s;
    while (*es && maxlen) {
        es++;
        maxlen--;
    }

    return (es - s);
}
```

---

## 2. æ€»ç»“

ä¸åª `printf` çš„å®ç°ï¼Œå¾ˆå¤šåŸºç¡€å‡½æ•°ï¼Œéƒ½èƒ½ä» linux æºç ä¸­æŸ¥çœ‹ã€‚å¯ä»¥ä» [github](https://github.com/torvalds/linux) ä¸‹è½½ä¸€ä»½æºç ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚ä¸‹è½½ä¸ª zip æ–‡ä»¶åŒ…å§ï¼Œgit æ–‡ä»¶æœ‰ç‚¹å¤ªå¤§äº†ã€‚

```c
/* https://github.com/torvalds/linux/blob/master/lib/string.c */

char *strcpy(char *dest, const char *src) {
    char *tmp = dest;

    while ((*dest++ = *src++) != '\0')
        /* nothing */;
    return tmp;
}
```

---

> ğŸ”¥ æ–‡ç« æ¥æºï¼š[wenfh2020.com](https://wenfh2020.com/)
>
> ğŸ‘ å¤§å®¶è§‰å¾—æ–‡ç« å¯¹ä½ æœ‰äº›ä½œç”¨ï¼ å¦‚æœæƒ³ <font color=green>èµèµ</font>ï¼Œå¯ä»¥ç”¨å¾®ä¿¡æ‰«æä¸‹é¢çš„äºŒç»´ç ï¼Œæ„Ÿè°¢!
<div align=center><img src="/images/2020-08-06-15-49-47.png" width="120"/></div>
